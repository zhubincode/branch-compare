<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      .header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .header h1 {
        margin: 0 0 10px 0;
        color: #333;
      }
      .meta-info {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
      }
      .branch-legend {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        padding: 5px 10px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .legend-icon {
        margin-right: 8px;
        font-size: 18px;
      }
      .timeline {
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 20px 0;
        max-width: 800px;
        margin: 0 auto;
      }
      .commit-row {
        display: flex;
        margin-bottom: 30px;
        position: relative;
        width: 100%;
      }
      .commit-container {
        max-width: 80%;
        position: relative;
      }
      .commit-container.source {
        align-self: flex-start;
        margin-right: auto;
      }
      .commit-container.target {
        align-self: flex-end;
        margin-left: auto;
      }
      .commit-container.both {
        align-self: center;
        max-width: 95%;
        margin: 0 auto;
      }
      .commit-container.both .commit {
        border-top: 4px solid #28a745;
        border-left: none;
        border-right: none;
        border-radius: 8px;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        background-color: #f0fff4;
      }
      .commit-container.both .commit.matched-by-message {
        background-color: #e6f7ff11;
        border-top: 4px solid #1890ff;
      }

      .commit {
        display: flex;
        flex-direction: column;
        padding: 20px 15px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .commit-container.source .commit {
        border-left: 4px solid #28a745; /* green */
        border-top-left-radius: 0;
        background-color: rgba(40, 167, 69, 0.05); /* light green background */
      }
      .commit-container.target .commit {
        border-right: 4px solid #ff9800; /* orange */
        border-top-right-radius: 0;
        background-color: rgba(255, 152, 0, 0.05); /* light orange background */
      }
      .commit-badge {
        position: absolute;
        top: -10px;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 2;
      }
      .commit-container.source .commit-badge {
        left: 10px;
        background-color: #28a745; /* green */
      }
      .commit-container.target .commit-badge {
        right: 10px;
        background-color: #ff9800; /* orange */
      }
      .commit-container.both .commit-badge {
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745;
        padding: 3px 15px;
      }
      .commit-container.both .commit-badge.message-matched {
        background-color: #0ea5e9 !important; /* sky blue */
      }
      .commit-time {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
        margin-top: 15px;
        display: flex;
        align-items: center;
      }
      .commit-container.source .commit-time {
        justify-content: flex-start;
      }
      .commit-container.target .commit-time {
        justify-content: flex-end;
      }
      .commit-container.both .commit-time {
        justify-content: center;
      }
      .commit-info {
        flex-grow: 1;
      }
      .commit-message {
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .commit-details {
        display: flex;
        flex-wrap: wrap;
        font-size: 13px;
        color: #666;
        gap: 8px;
        margin-bottom: 8px;
      }
      .commit-author {
        margin-right: 8px;
      }
      .commit-container.target .commit-details {
        justify-content: flex-end;
      }
      .commit-hash {
        font-family: monospace;
        cursor: pointer;
        background: #f1f1f1;
        padding: 2px 6px;
        border-radius: 3px;
        height: 20px;
        display: inline-flex;
        align-items: center;
      }
      .commit-hash:hover {
        background: #e1e4e8;
      }
      .commit-indicator {
        width: 50px;
        text-align: center;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ignore-button,
      .remark-button,
      .vscode-button,
      .view-changes-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        vertical-align: middle;
        margin: 0 4px;
      }
      .ignore-button,
      .remark-button {
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.8;
      }
      .ignore-button {
        background: #dc3545;
        color: white;
      }
      .remark-button {
        background: #0ea5e9 !important; /* sky blue */
        color: white;
      }
      .ignore-button:hover,
      .remark-button:hover {
        opacity: 1;
      }
      .remark-button {
        background: #17a2b8;
      }
      .ignored {
        opacity: 0.5;
        background: #f8f9fa;
      }
      .commit-ignored::after {
        content: "(Ignored)";
      }
      .ignored::after {
        content: "(Ignored)";
        color: #dc3545;
        margin-left: 8px;
        font-size: 12px;
      }
      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }
      .filter-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .filter-button {
        padding: 5px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }
      .sub-filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 10px 0;
        padding-left: 5px;
        transition: all 0.3s ease;
        max-height: 50px;
        overflow: hidden;
      }
      .sub-filter-section.hidden {
        max-height: 0;
        margin: 0;
        opacity: 0;
      }
      .filter-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .filter-checkbox input {
        margin-right: 5px;
      }
      .command-section {
        margin-top: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
      }
      .command-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 15px;
      }

      .command-tab {
        background: none;
        border: none;
        padding: 8px 15px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        position: relative;
        transition: all 0.2s ease;
      }

      .command-tab:hover {
        background-color: #f8f8f8;
      }

      .command-tab.active {
        color: #007bff;
        font-weight: bold;
        border-bottom: 2px solid #007bff;
      }
      .command-content {
        display: none;
      }
      .command-content.active {
        display: block;
      }
      .command-content pre {
        background: #2d2d2d;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0;
      }
      .copy-button {
        background: #0366d6;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }
      .copy-button:hover {
        background: #0256b9;
      }
      .tooltip {
        position: fixed;
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }
      .success-toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: #333;
        font-size: 18px;
      }

      .reason-list {
        margin: 16px 0;
        max-height: 300px;
        overflow-y: auto;
      }

      .reason-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .reason-option:hover {
        background: #f8f9fa;
        border-color: #aaa;
      }

      .reason-option.selected {
        background: #e3f2fd;
        border-color: #2196f3;
      }

      .reason-option input[type="radio"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
      }

      .reason-option label {
        flex: 1;
        padding: 5px 0;
        cursor: pointer;
      }

      .custom-reason {
        display: none;
        margin-top: 16px;
      }

      .custom-reason.show {
        display: block;
      }

      .custom-reason input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
      }

      .modal-button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }

      .modal-button:hover {
        opacity: 0.9;
      }

      .modal-button.confirm {
        background: #2196f3;
        color: white;
      }

      .modal-button.cancel {
        background: #f1f1f1;
        color: #333;
      }

      .ignore-reason,
      .commit-remark {
        font-size: 13px;
        color: #666;
        margin: 8px 0 0 0;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 4px;
        line-height: 1.4;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .ignore-reason {
        border-left: 3px solid #dc3545;
      }

      .commit-remark {
        border-left: 3px solid #17a2b8;
      }

      .ignore-reason-title,
      .commit-remark-title {
        font-weight: 500;
        color: #555;
        margin-right: 6px;
      }

      .ignore-reason-content,
      .commit-remark-content {
        display: block;
        padding-left: 24px;
      }
      .remark-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .remark-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 80%;
        max-width: 420px;
        box-sizing: border-box;
      }
      .remark-modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: 500;
      }
      .remark-textarea {
        width: 100%;
        min-height: 120px;
        margin: 10px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        resize: vertical;
        font-size: 14px;
        line-height: 1.5;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        color: #333;
      }
      .remark-textarea:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }
      .remark-modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
      }
      .remark-modal-button {
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 14px;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .remark-modal-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .remark-save {
        background: #28a745;
        color: white;
      }
      .remark-cancel {
        background: #f1f1f1;
        color: #333;
      }
      .remark-delete {
        background: #dc3545;
        color: white;
        margin-right: auto;
      }
      @media (max-width: 768px) {
        .commit {
          flex-direction: column;
        }
        .commit-time {
          width: 100%;
          margin-bottom: 10px;
        }
        .commit-indicator {
          width: 100%;
          margin-top: 10px;
        }
      }
      /* Ê∑ªÂä†ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆÊ†∑Âºè */
      .back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }

      /* Ê∑ªÂä†Êó∂Èó¥ËΩ¥Âõæ‰æãÊ†∑Âºè */
      .timeline-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .timeline-legend .legend-item {
        display: flex;
        align-items: center;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        /* box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); */
      }

      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }

      .legend-dot.source {
        background-color: #28a745; /* Êîπ‰∏∫ÁªøËâ≤ */
      }

      .legend-dot.target {
        background-color: #ff9800; /* Êîπ‰∏∫Ê©ôËâ≤ */
      }

      .legend-dot.both {
        background-color: #28a745;
      }

      /* ÂØπÊèê‰∫§ÂìàÂ∏åÁöÑÂ±ïÁ§∫Â¢ûÂº∫ÔºåÊòæÁ§∫ÂèåÂàÜÊîØÂìàÂ∏å */
      .commit-hash-container {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .commit-hash-pair {
        display: flex;
        flex-direction: column;
        gap: 3px;
        background: #f5f5f5;
        padding: 5px;
        border-radius: 4px;
        margin-top: 5px;
      }

      .commit-hash-branch {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      /* ÂØπÊØîÂàÜÊîØÊ†∑Âºè */
      .commit-hash-branch:last-child {
        background-color: rgba(255, 152, 0, 0.1); /* Ê∑°Ê©ôËâ≤ËÉåÊôØ */
        border: 1px solid rgba(255, 152, 0, 0.2);
      }

      .commit-hash-branch:last-child .branch-label {
        color: #ff9800; /* Ê©ôËâ≤ÊñáÂ≠ó */
        font-weight: 600;
      }

      .branch-label {
        min-width: 100px;
        display: inline-block;
      }

      .commit-hash-pair {
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .theme-switcher {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        border-radius: 24px;
        padding: 4px;
      }

      .theme-button {
        border: none;
        background: none;
        color: #666;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .theme-button.active {
        background-color: #0366d6;
        color: white;
      }

      /* Add CSS for the flat layout */
      .timeline.flat-layout .commit-row {
        justify-content: center;
      }

      .timeline.flat-layout .commit-container {
        max-width: 90%;
        width: 90%;
        margin: 0 auto;
        align-self: center;
      }

      .timeline.flat-layout .commit-container.both {
        max-width: 90%;
      }

      .timeline.flat-layout .commit {
        display: flex;
        flex-direction: column;
      }

      .timeline.flat-layout .commit-indicator {
        position: absolute;
        left: 15px;
        top: 15px;
        font-size: 16px;
      }

      /* Add branch indicator for flat layout */
      .timeline.flat-layout .branch-indicator {
        position: absolute;
        top: 10px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .timeline.flat-layout .commit-container.source .branch-indicator {
        right: 10px; /* Êîπ‰∏∫right */
        left: auto; /* Ê∏ÖÈô§left */
        background-color: #28a745;
      }

      .timeline.flat-layout .commit-container.target .branch-indicator {
        left: 10px;
        background-color: #ff9800;
      }

      .timeline.flat-layout .commit-container.both .branch-indicator {
        background: linear-gradient(
          135deg,
          #28a745 50%,
          #ff9800 50%
        ); /* Êîπ‰∏∫ÁªøËâ≤ÂíåÊ©ôËâ≤ */
      }

      /* Adjust content padding in flat layout */
      .timeline.flat-layout .commit-time,
      .timeline.flat-layout .commit-info {
        padding-left: 25px;
      }

      /* Add styling for the search box */
      .search-section {
        margin-top: 10px;
        padding: 0 5px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .search-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .search-checkbox {
        display: flex;
        align-items: center;
        margin-right: 10px;
      }

      .search-checkbox label {
        margin-left: 5px;
        font-size: 13px;
        color: #666;
      }

      .highlight {
        background-color: #ffffc0;
        border-radius: 2px;
        padding: 0 2px;
      }

      /* Add a clear button for the search input */
      .search-container {
        position: relative;
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      /* Set width for search input to make room for checkboxes */
      .search-container .search-input {
        width: calc(100% - 320px);
        margin-bottom: 0;
        margin-right: 10px;
      }

      /* Place checkboxes on the same line */
      .search-container .search-options {
        flex: 1;
        margin: 0;
        justify-content: flex-end;
      }

      .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #999;
        cursor: pointer;
        font-size: 16px;
        display: none;
      }

      .clear-search.visible {
        display: block;
      }

      /* Add VS Code icon button styles */
      .vscode-button {
        width: 20px;
        background: #0066b8;
        color: white;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        padding: 0;
      }

      .vscode-button:hover {
        background: #005ca3;
        transform: translateY(-1px);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
      }

      .vscode-button svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* Add tooltip for VS Code buttons */
      .vscode-button::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 8px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .vscode-button:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: calc(100% + 5px);
      }

      /* Add style for compare buttons for matched commits */
      .compare-in-vscode {
        background: #0066b8;
        color: white;
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 5px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .compare-in-vscode:hover {
        background: #005ca3;
        transform: translateY(-1px);
      }

      .compare-in-vscode svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* Êü•ÁúãÊèê‰∫§ÂèòÊõ¥ÊåâÈíÆÊ†∑Âºè */
      .view-changes-btn {
        padding: 2px 8px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        color: #333;
      }

      .view-changes-btn:hover {
        background-color: #e0e0e0;
      }

      /* Â∑ÆÂºÇÊü•ÁúãÂô®Ê†∑Âºè */
      .diff-viewer {
        width: 100%;
        max-height: 80vh;
        overflow: auto;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
        line-height: 1.5;
        margin-top: 15px;
      }

      .diff-file {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }

      .diff-file-header {
        background-color: #f1f1f1;
        padding: 10px;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
      }

      .diff-hunk-header {
        background-color: #e8eaed;
        padding: 5px 10px;
        color: #666;
        border-bottom: 1px solid #ddd;
      }

      .diff-line {
        padding: 0 5px;
        white-space: pre;
      }

      .diff-line-addition {
        background-color: #e6ffed;
        border-left: 4px solid #34d058;
      }

      .diff-line-deletion {
        background-color: #ffeef0;
        border-left: 4px solid #d73a49;
      }

      .diff-line-context {
        background-color: #fff;
        border-left: 4px solid transparent;
      }

      .diff-line-num {
        display: inline-block;
        width: 40px;
        color: #999;
        text-align: right;
        padding-right: 10px;
        user-select: none;
      }

      .diff-empty-msg {
        padding: 20px;
        color: #666;
        text-align: center;
      }

      .diff-stats {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
        font-size: 14px;
      }

      .diff-stats-additions {
        color: #28a745;
        margin-right: 15px;
      }

      .diff-stats-deletions {
        color: #d73a49;
      }

      .diff-loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* ‰øÆÊîπÂÖ±ÂêåÊèê‰∫§ÁöÑÊåâÈíÆÂ∏ÉÂ±Ä */
      .commit-container.both .commit-details {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* Ë∞ÉÊï¥ÊåâÈíÆÊ†∑ÂºèÔºåËÆ©ÂÆÉ‰ª¨Âú®Âêå‰∏ÄË°å */
      .ignore-button,
      .remark-button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        margin: 0;
        opacity: 0.8;
        display: inline-flex;
        align-items: center;
        height: 20px;
      }

      /* ÂëΩ‰ª§Â§çÂà∂ÊåâÈíÆ */
      .copy-button {
        background-color: #f1f1f1;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 3px 8px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 12px;
        color: #666;
      }

      .copy-line-button {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-radius: 3px;
        padding: 2px 6px;
        font-size: 11px;
        color: #666;
        cursor: pointer;
        margin-left: 8px;
        transition: all 0.2s ease;
      }

      .copy-line-button:hover {
        background-color: #e6e6e6;
        color: #333;
      }

      .command-line {
        display: flex;
        align-items: center;
        margin: 2px 0;
      }

      .command-line pre {
        margin: 0;
        flex-grow: 1;
        font-family: monospace;
        white-space: pre-wrap;
        overflow-x: auto;
      }
      /* Back to top button styles */
      .back-to-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }
      /* Timeline legend styles */
      .legend-source {
        background-color: #28a745; /* green */
      }
      .legend-target {
        background-color: #ff9800; /* orange */
      }
      /* Enhanced commit hash display for dual branch hashes */
      .dual-hash {
        display: flex;
        justify-content: space-between;
      }
      /* Branch comparison styles */
      .branch-comparison {
        background-color: rgba(255, 152, 0, 0.1); /* light orange background */
      }
      .branch-name {
        color: #ff9800; /* orange text */
      }
      /* View commit changes button styles */
      .view-changes-btn {
        /* styles */
      }
      /* Diff viewer styles */
      .diff-viewer {
        /* styles */
      }
      /* Common commit button layout */
      .common-commit-btn {
        /* styles */
      }
      .target-branch-info {
        right: 10px; /* align right */
        left: auto; /* clear left */
      }
      .gradient-background {
        background: linear-gradient(
          to right,
          #28a745,
          #ff9800
        ); /* green to orange */
      }
    </style>
  </head>
  <body data-layout="flat">
    <!-- Ê∑ªÂä†ÂøΩÁï•ÂéüÂõ†ÈÄâÊã©ÂºπÁ™ó -->
    <div id="ignoreModal" class="modal">
      <div class="modal-content">
        <h3>ÈÄâÊã©ÂøΩÁï•ÂéüÂõ†</h3>
        <div class="reason-list" id="reasonList">
          <!-- ÂéüÂõ†ÈÄâÈ°πÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÊ∑ªÂä† -->
        </div>
        <div id="customReasonInput" class="custom-reason">
          <input
            type="text"
            placeholder="ËØ∑ËæìÂÖ•ÂøΩÁï•ÂéüÂõ†"
            id="customReasonText"
          />
        </div>
        <div class="modal-buttons">
          <button class="modal-button cancel" onclick="closeIgnoreModal()">
            ÂèñÊ∂à
          </button>
          <button class="modal-button confirm" onclick="confirmIgnore()">
            Á°ÆËÆ§
          </button>
        </div>
      </div>
    </div>

    <!-- Ê∑ªÂä†Â§áÊ≥®ÂºπÁ™ó -->
    <div id="remarkModal" class="remark-modal">
      <div class="remark-modal-content">
        <h3>ÁºñËæëÂ§áÊ≥®</h3>
        <textarea
          id="remarkText"
          class="remark-textarea"
          placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®ÂÜÖÂÆπ..."
        ></textarea>
        <div class="remark-modal-buttons">
          <button
            class="remark-modal-button remark-delete"
            id="deleteRemarkBtn"
            onclick="deleteRemark()"
          >
            Âà†Èô§Â§áÊ≥®
          </button>
          <button
            class="remark-modal-button remark-cancel"
            onclick="closeRemarkModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="remark-modal-button remark-save"
            onclick="confirmRemark()"
          >
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>

    <!-- Ê∑ªÂä†loadingË¶ÜÁõñÂ±Ç -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- Ê∑ªÂä†ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ -->
    <div id="backToTop" class="back-to-top">‚Üë</div>

    <div class="container">
      <div class="header">
        <div>
          <h1>ÂàÜÊîØÊèê‰∫§ÂØπÊØî</h1>
          <div class="meta-info">
            <div>ÁîüÊàêÊó∂Èó¥: {{generatedTime}}</div>
            <div id="authorInfo" style="display: none">Êèê‰∫§ËÄÖ: {{author}}</div>
            <div id="timeRangeInfo" style="display: none">
              Êó∂Èó¥ËåÉÂõ¥: {{timeRange}}
            </div>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="legend-item">
            <span class="legend-dot source"></span> {{sourceBranch}} (Âü∫ÂáÜÂàÜÊîØ)
          </div>
          <div class="legend-item">
            <span class="legend-dot target"></span> {{targetBranch}}
          </div>
          <div class="legend-item">
            <span
              class="legend-dot both"
              style="background-color: #1890ff"
            ></span>
            Ê∂àÊÅØÁõ∏ÂêåÁöÑÂÖ±ÂêåÊèê‰∫§
          </div>
        </div>

        <div class="theme-switcher">
          <button
            id="chatLayoutBtn"
            class="theme-button"
            onclick="switchLayout('chat')"
          >
            <span>ËÅäÂ§©Â∏ÉÂ±Ä</span>
            <span class="layout-icon">üí¨</span>
          </button>
          <button
            id="flatLayoutBtn"
            class="theme-button active"
            onclick="switchLayout('flat')"
          >
            <span>ÂàóË°®Â∏ÉÂ±Ä</span>
            <span class="layout-icon">üìë</span>
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-buttons">
          <button
            class="filter-button active"
            data-filter="all"
            onclick="filterCommits('all')"
          >
            ÂÖ®ÈÉ®Êèê‰∫§
          </button>
          <button
            class="filter-button"
            data-filter="source"
            onclick="filterCommits('source')"
          >
            ‰ªÖ{{sourceBranch}}ÂàÜÊîØ
          </button>
          <button
            class="filter-button"
            data-filter="target"
            onclick="filterCommits('target')"
          >
            ‰ªÖ{{targetBranch}}ÂàÜÊîØ
          </button>
          <button
            class="filter-button"
            data-filter="common"
            onclick="filterCommits('common')"
          >
            ÂÖ±ÂêåÊèê‰∫§
          </button>
          <button
            class="filter-button"
            data-filter="ignored"
            onclick="filterCommits('ignored')"
          >
            Â∑≤ÂøΩÁï•Êèê‰∫§
          </button>
        </div>

        <div class="sub-filter-section" id="subFilterSection">
          <label class="filter-checkbox">
            <input
              type="checkbox"
              id="hideIgnoredCommits"
              checked
              onchange="applySubFilters()"
            />
            <span>ÈöêËóèÂ∑≤ÂøΩÁï•Êèê‰∫§</span>
          </label>
          <label class="filter-checkbox">
            <input
              type="checkbox"
              id="hideCommonCommits"
              onchange="applySubFilters()"
            />
            <span>ÈöêËóèÂÖ±ÂêåÊèê‰∫§</span>
          </label>
        </div>

        <div class="search-section">
          <div class="search-container">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="ÊêúÁ¥¢Êèê‰∫§‰ø°ÊÅØ„ÄÅ‰ΩúËÄÖÊàñÂìàÂ∏å..."
              oninput="searchCommits()"
            />
            <button
              class="clear-search"
              id="clearSearch"
              onclick="clearSearch()"
            >
              ‚úï
            </button>
            <div class="search-options">
              <label class="search-checkbox">
                <input
                  type="checkbox"
                  id="searchMessage"
                  checked
                  onchange="searchCommits()"
                />
                <span>Êèê‰∫§‰ø°ÊÅØ</span>
              </label>
              <label class="search-checkbox">
                <input
                  type="checkbox"
                  id="searchAuthor"
                  checked
                  onchange="searchCommits()"
                />
                <span>‰ΩúËÄÖ</span>
              </label>
              <label class="search-checkbox">
                <input
                  type="checkbox"
                  id="searchHash"
                  onchange="searchCommits()"
                />
                <span>ÂìàÂ∏å</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="timeline" id="timeline"></div>

      <div class="command-section">
        <div class="command-tabs">
          <button
            class="command-tab active"
            data-command="source-to-target"
            onclick="switchCommandTab('source-to-target')"
          >
            {{sourceBranch}} ‚Üí {{targetBranch}}
          </button>
          <button
            class="command-tab"
            data-command="target-to-source"
            onclick="switchCommandTab('target-to-source')"
          >
            {{targetBranch}} ‚Üí {{sourceBranch}}
          </button>
        </div>

        <div id="source-to-target-content" class="command-content active">
          <h3>
            Cherry-pick Êåá‰ª§ ({{sourceBranch}} ‚Üí {{targetBranch}})
            <button
              class="copy-button copy-source-to-target-button"
              onclick="copyCommandBlock('source-to-target')"
            >
              Â§çÂà∂ÂÖ®ÈÉ®
            </button>
          </h3>
          <div id="source-to-target-commands-container"></div>
          <pre
            style="display: none"
          ><code id="source-to-target-commands"></code></pre>
        </div>

        <div id="target-to-source-content" class="command-content">
          <h3>
            Cherry-pick Êåá‰ª§ ({{targetBranch}} ‚Üí {{sourceBranch}})
            <button
              class="copy-button copy-target-to-source-button"
              onclick="copyCommandBlock('target-to-source')"
            >
              Â§çÂà∂ÂÖ®ÈÉ®
            </button>
          </h3>
          <div id="target-to-source-commands-container"></div>
          <pre
            style="display: none"
          ><code id="target-to-source-commands"></code></pre>
        </div>
      </div>
    </div>

    <script>
      // Ëé∑ÂèñÂä®ÊÄÅÁ´ØÂè£
      const PORT = '{{port}}';
      const API_BASE = `http://localhost:${PORT}`;

      // Âä†ËΩΩÂøΩÁï•ÁöÑÊèê‰∫§
      async function loadIgnoredCommits() {
        try {
          const response = await fetch(`${API_BASE}/ignored-commits`);
          const data = await response.json();
          return data.ignoredCommits || [];
        } catch (error) {
          console.error('Failed to load ignored commits:', error);
          return [];
        }
      }

      // ‰øùÂ≠òÂøΩÁï•ÁöÑÊèê‰∫§
      async function saveIgnoredCommits(commits) {
        try {
          const response = await fetch(`${API_BASE}/ignore-commit`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ignoredCommits: commits })
          });
          return response.ok;
        } catch (error) {
          console.error('Failed to save ignored commits:', error);
          return false;
        }
      }

      // Âä†ËΩΩÊèê‰∫§Â§áÊ≥®
      async function loadCommitRemarks() {
        try {
          const response = await fetch(`${API_BASE}/commit-remarks`);
          const data = await response.json();
          return data.commitRemarks || {};
        } catch (error) {
          console.error('Failed to load commit remarks:', error);
          return {};
        }
      }

      // ‰øùÂ≠òÊèê‰∫§Â§áÊ≥®
      async function saveCommitRemarks(remarks) {
        try {
          const response = await fetch(`${API_BASE}/commit-remarks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ commitRemarks: remarks })
          });
          return response.ok;
        } catch (error) {
          console.error('Failed to save commit remarks:', error);
          return false;
        }
      }

      // Create a global variable to track current filter state correctly placed at the top
      // Create a global variable at the beginning of the script
      let currentFilterState = {
        mainFilter: 'all',
        hideIgnored: true,
        hideCommon: false,
        searchText: '',
        searchMessage: true,
        searchAuthor: true,
        searchHash: false
      };

      // ÂàùÂßãÂåñÊï∞ÊçÆ
      const commits = {{commits}};
      const sourceBranch = {{sourceBranch}};
      const targetBranch = {{targetBranch}};
      let ignoredCommits = {{ignoredCommits}} || [];  // Á°Æ‰øùÊúâÈªòËÆ§ÂÄº

      // Ê£ÄÊü•ÂàÜÊîØÊòØÂê¶ÂÆåÊï¥
      if (!sourceBranch || !targetBranch) {
        document.body.innerHTML = `
          <div style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            background: #fff3f3;
            border: 1px solid #dc3545;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          ">
            <h2 style="color: #dc3545; margin-bottom: 10px;">‚ö†Ô∏è Error</h2>
            <p style="color: #666; margin-bottom: 15px;">Missing required branch information for comparison.</p>
            <p style="color: #666;">Please ensure both source and target branches are specified.</p>
          </div>
        `;
        // ÈòªÊ≠¢ÂêéÁª≠‰ª£Á†ÅÊâßË°å
        throw new Error('Missing branch information');
      }

      // Á°Æ‰øùÂ§áÊ≥®Êï∞ÊçÆÊòØÊï∞ÁªÑÊ†ºÂºè
      let commitRemarks = [];
      try {
        const rawRemarks = {{commitRemarks}};
        if (Array.isArray(rawRemarks)) {
          // Â∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè
          commitRemarks = rawRemarks;
          console.log('ÂàùÂßãÂåñ: Â§áÊ≥®Êï∞ÊçÆÂ∑≤ÁªèÊòØÊï∞ÁªÑÊ†ºÂºè, Êù°Êï∞:', commitRemarks.length);
        } else if (typeof rawRemarks === 'object' && rawRemarks !== null) {
          // ËΩ¨Êç¢ÂØπË±°Ê†ºÂºè‰∏∫Êï∞ÁªÑ
          for (const hash in rawRemarks) {
            commitRemarks.push({
              hash: hash,
              content: rawRemarks[hash],
              timestamp: new Date().toISOString()
            });
          }
          console.log('ÂàùÂßãÂåñ: Â∑≤Â∞ÜÂØπË±°Ê†ºÂºèÂ§áÊ≥®ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ, Êù°Êï∞:', commitRemarks.length);
        } else {
          console.warn('ÂàùÂßãÂåñ: Êó†ÊïàÁöÑÂ§áÊ≥®Êï∞ÊçÆÊ†ºÂºè, ‰ΩøÁî®Á©∫Êï∞ÁªÑ');
        }
      } catch (e) {
        console.error('ÂàùÂßãÂåñÂ§áÊ≥®Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
      }

      const author = {{author}};
      const timeRange = {{timeRange}};

      // ÂøΩÁï•ÂéüÂõ†ÈÄâÈ°π
      const IGNORE_REASONS = [
        'Manually Merged',
        'Merge Not Required',
        'Conflicts Exist',
        'Needs Further Review',
        'Other Reasons'
      ];

      let currentIgnoreHash = null;
      let currentIgnoreElement = null;
      let currentCommitHash = null;

      // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤ÂøΩÁï•Êèê‰∫§ÂíåÂ§áÊ≥®
      async function loadIgnoredCommits() {
        console.log('Loading ignored commits and remarks data...');
        try {
          // Handle each request separately to avoid one failure affecting the other
          try {
            const ignoreResponse = await fetch('http://localhost:3000/ignored-commits');
            if (ignoreResponse.ok) {
              const ignoreData = await ignoreResponse.json();
              if (Array.isArray(ignoreData.ignoredCommits)) {
                ignoredCommits = ignoreData.ignoredCommits;
                console.log('Successfully loaded ignored commits, count:', ignoredCommits.length);
              }
            } else {
              console.error('Failed to load ignored commits:', ignoreResponse.status);
            }
          } catch (ignoreError) {
            console.error('Error getting ignored commits:', ignoreError);
          }

          // Load remarks data
          try {
            console.log('Starting to load remarks data...');
            const remarkResponse = await fetch('http://localhost:3000/commit-remarks');
            if (remarkResponse.ok) {
              const remarkData = await remarkResponse.json();
              console.log('Received remarks data response:', remarkData);

              if (remarkData.commitRemarks) {
                if (Array.isArray(remarkData.commitRemarks)) {
                  commitRemarks = remarkData.commitRemarks;
                  console.log('Successfully loaded remarks data (array format), count:', commitRemarks.length);

                  if (commitRemarks.length > 0) {
                    console.log('Remarks examples:');
                    commitRemarks.slice(0, 3).forEach((remark) => {
                      console.log(`- Hash: ${remark.hash}, Content: ${remark.content}`);
                    });
                  }
                } else {
                  console.warn('Server returned non-array format remarks, converting...');
                  const tempArray = [];
                  for (const hash in remarkData.commitRemarks) {
                    tempArray.push({
                      hash: hash,
                      content: remarkData.commitRemarks[hash],
                      timestamp: new Date().toISOString()
                    });
                  }
                  commitRemarks = tempArray;
                  console.log('Successfully converted object format remarks to array, count:', commitRemarks.length);
                }
              } else {
                console.warn('No commitRemarks field in server response');
              }
            } else {
              console.error('Failed to load remarks data:', remarkResponse.status);
            }
          } catch (remarkError) {
            console.error('Error getting remarks:', remarkError);
          }

          // ÈáçÊñ∞Ê∏≤ÊüìÊèê‰∫§ÂàóË°®
                renderCommits(false); // Don't save filter state on initial load
          console.log('Êèê‰∫§ÂàóË°®Ê∏≤ÊüìÂÆåÊàê');

                // Initialize filter state after data is loaded
                initializeFilterState();
        } catch (error) {
          console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
          // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÂàùÂßãÊï∞ÊçÆ
                renderCommits(false);
        }
      }

      // ÊòæÁ§∫‰ΩúËÄÖÂíåÊó∂Èó¥ËåÉÂõ¥‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
      if (author) {
        document.getElementById('authorInfo').style.display = 'block';
      }
      if (timeRange) {
        document.getElementById('timeRangeInfo').style.display = 'block';
      }

      // ÊòæÁ§∫ÂøΩÁï•ÂéüÂõ†ÈÄâÊã©ÂºπÁ™ó
      function showIgnoreModal(hash, element) {
        currentIgnoreHash = hash;
        currentIgnoreElement = element;

              // ÁîüÊàêÂøΩÁï•ÂéüÂõ†ÈÄâÈ°π
              const reasonListElement = document.getElementById('reasonList');
              reasonListElement.innerHTML = '';

              IGNORE_REASONS.forEach((reason, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'reason-option';

                // ÂàõÂª∫radioËæìÂÖ•
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `reason-${index}`;
                radioInput.name = 'ignoreReason';
                radioInput.value = reason;
                if (index === 0) {
                  radioInput.checked = true;
                }

                // ÂàõÂª∫label
                const label = document.createElement('label');
                label.htmlFor = `reason-${index}`;
                label.textContent = reason;

                // Ê∑ªÂä†Âà∞ÈÄâÈ°πÂÖÉÁ¥†
                optionElement.appendChild(radioInput);
                optionElement.appendChild(label);

                // ‰ΩøÊï¥‰∏™ÈÄâÈ°πÂèØÁÇπÂáª
                optionElement.addEventListener('click', function(e) {
                  if (e.target !== radioInput) {
                    radioInput.checked = true;

                    // Â§ÑÁêÜËá™ÂÆö‰πâÂéüÂõ†ËæìÂÖ•Ê°ÜÊòæÁ§∫ÈÄªËæë
                    if (reason === 'Other Reasons') {
                      document.getElementById('customReasonInput').classList.add('show');
                    } else {
                      document.getElementById('customReasonInput').classList.remove('show');
                    }

                    // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†∑Âºè
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                  }
                });

                // ÁâπÊÆäÂ§ÑÁêÜËá™ÂÆö‰πâÂéüÂõ†ÈÄâÈ°π
                if (reason === 'Other Reasons') {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.add('show');
                    // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†∑Âºè
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                } else {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.remove('show');
                    // Êõ¥Êñ∞ÈÄâ‰∏≠Ê†∑Âºè
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                }

                reasonListElement.appendChild(optionElement);
              });

              // ÈáçÁΩÆËá™ÂÆö‰πâÂéüÂõ†ËæìÂÖ•Ê°Ü
              document.getElementById('customReasonText').value = '';
              document.getElementById('customReasonInput').classList.remove('show');

              // ÊòæÁ§∫ÂºπÁ™ó
              document.getElementById('ignoreModal').style.display = 'block';
      }

      // Ëé∑ÂèñÂ§áÊ≥®ÂÜÖÂÆπ
      function getRemarkContent(hash) {
        const remark = commitRemarks.find(r => r.hash === hash);
        return remark ? remark.content : '';
      }

      // Âà§Êñ≠ÊòØÂê¶ÊúâÂ§áÊ≥®
      function hasRemark(hash) {
        return commitRemarks.some(r => r.hash === hash);
      }

            // Ëé∑ÂèñÊèê‰∫§ÁöÑÂ§áÊ≥®ÂØπË±°
            function getCommitRemark(hash) {
              return commitRemarks.find(r => r.hash === hash);
      }

      // ‰øùÂ≠òÂ§áÊ≥®Âà∞ÊúçÂä°Âô®
      async function saveCommitRemarks() {
        try {
          console.log('ÂáÜÂ§á‰øùÂ≠òÂ§áÊ≥®Êï∞ÊçÆ, Â§áÊ≥®ÊÄªÊï∞:', commitRemarks.length);

          // Á°Æ‰øùcommitRemarksÊòØÊï∞ÁªÑ
          if (!Array.isArray(commitRemarks)) {
            console.error('ERROR: commitRemarks‰∏çÊòØÊï∞ÁªÑ!', typeof commitRemarks, commitRemarks);
                  // ÈáçÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ
                  commitRemarks = [];
                  console.warn('Â∑≤Â∞ÜcommitRemarksÈáçÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ');
                }

                // È™åËØÅÂπ∂Ê∏ÖÁêÜÂ§áÊ≥®Êï∞ÊçÆ
                const validRemarks = commitRemarks.filter(remark =>
                  remark &&
                  remark.hash &&
                  typeof remark.hash === 'string' &&
                  remark.hash.trim().length > 0
                );

                if (validRemarks.length !== commitRemarks.length) {
                  console.warn(`ËøáÊª§‰∫Ü ${commitRemarks.length - validRemarks.length} Êù°Êó†ÊïàÂ§áÊ≥®`);
                  commitRemarks = validRemarks;
                }

                // ÊâìÂç∞Â§áÊ≥®ÂÜÖÂÆπ
          if (commitRemarks.length === 0) {
            console.log('Ê≤°ÊúâÂ§áÊ≥®ÈúÄË¶Å‰øùÂ≠ò');
          } else {
                  console.log('Â§áÊ≥®ËØ¶ÊÉÖ:');
            for (const remark of commitRemarks) {
                    console.log(`- ÂìàÂ∏å: ${remark.hash}, ÂÜÖÂÆπ: ${remark.content || '(Êó†ÂÜÖÂÆπ)'}`);
            }
          }

          console.log('ÂèëÈÄÅPOSTËØ∑Ê±ÇÂà∞/commit-remarks...');
          const postData = { commitRemarks: commitRemarks };
                console.log('POSTÊï∞ÊçÆÊ†ºÂºèÊ£ÄÊü•:',
                  'ÊòØÊï∞ÁªÑ:', Array.isArray(commitRemarks),
                  'ÈïøÂ∫¶:', commitRemarks.length);

                // Ê∑ªÂä†ÈáçËØïÈÄªËæë
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;
                let lastError = null;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
          const response = await fetch('http://localhost:3000/commit-remarks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(postData),
                      cache: 'no-cache' // Á¶ÅÁî®ÁºìÂ≠ò
          });

          if (!response.ok) {
            const errorText = await response.text();
                      console.error(`Â∞ùËØï ${attempts}/${maxAttempts} Â§±Ë¥•:`, response.status, errorText);
                      lastError = new Error(`ÊúçÂä°Âô®ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`);

                      if (attempts < maxAttempts) {
                        // Âª∂Ëøü‰∏ÄÁÇπÂÜçÈáçËØï
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      } else {
                        throw lastError;
                      }
          }

          // ËØªÂèñÂìçÂ∫î
          const data = await response.json();
          console.log('ÊúçÂä°Âô®‰øùÂ≠òÂ§áÊ≥®ÊàêÂäü, ÂìçÂ∫î:', data);

          if (data.count) {
            console.log(`ÊúçÂä°Âô®Á°ÆËÆ§‰øùÂ≠ò‰∫Ü ${data.count} Êù°Â§áÊ≥®`);
          }

                    success = true;

          // ÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞Â§áÊ≥®
          console.log('Ê≠£Âú®ÈáçÊñ∞Âä†ËΩΩÊúÄÊñ∞Â§áÊ≥®...');
          await loadLatestRemarks();

          return data;
                  } catch (attemptError) {
                    console.error(`Â∞ùËØï ${attempts}/${maxAttempts} Âá∫Èîô:`, attemptError);
                    lastError = attemptError;

                    // Âª∂Ëøü‰∏ÄÁÇπÂÜçÈáçËØï
                    if (attempts < maxAttempts) {
                      await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                    }
                  }
                }

                if (!success && lastError) {
                  console.error('‰øùÂ≠òÂ§áÊ≥®Â§±Ë¥•ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞');
                  alert('‰øùÂ≠òÂ§áÊ≥®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•Âøó');
                  throw lastError;
                }

                return null;
        } catch (error) {
          console.error('‰øùÂ≠òÂ§áÊ≥®Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÂ§áÊ≥®Â§±Ë¥•: ' + error.message);
          throw error;
        }
      }

      // ÂçïÁã¨Âä†ËΩΩÊúÄÊñ∞Â§áÊ≥®
      async function loadLatestRemarks() {
        try {
          console.log('ÂºÄÂßãÂä†ËΩΩÊúÄÊñ∞Â§áÊ≥®...');

                // Ê∑ªÂä†ÈáçËØïÈÄªËæë
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
                    const response = await fetch('http://localhost:3000/commit-remarks', {
                      cache: 'no-store', // Âº∫Âà∂‰∏ç‰ΩøÁî®ÁºìÂ≠ò
                      headers: {
                        'X-Requested-With': 'fetch',
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                      }
                    });

          if (!response.ok) {
                      console.error(`Âä†ËΩΩÂ§áÊ≥®Â∞ùËØï ${attempts}/${maxAttempts} Â§±Ë¥•:`, response.status);
                      if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      }
                      throw new Error(`Êó†Ê≥ïËé∑ÂèñÂ§áÊ≥®: ${response.status} ${response.statusText}`);
                    }

                    // Ëß£ÊûêÂìçÂ∫îÊï∞ÊçÆ
          const data = await response.json();
                    console.log('Ëé∑ÂèñÂ§áÊ≥®ÂìçÂ∫î:', data);

                    // Â§ÑÁêÜÂ§áÊ≥®Êï∞ÊçÆ
          if (data.commitRemarks) {
            // Á°Æ‰øùcommitRemarksÊòØÊï∞ÁªÑ
            if (Array.isArray(data.commitRemarks)) {
              commitRemarks = data.commitRemarks;
              console.log('Âà∑Êñ∞Â§áÊ≥®Êï∞ÊçÆÊàêÂäü, Êï∞ÁªÑÈïøÂ∫¶:', commitRemarks.length);
                        if (commitRemarks.length > 0) {
                          console.log('Â§áÊ≥®ÂÜÖÂÆπÁ§∫‰æã:');
                          for (let i = 0; i < Math.min(3, commitRemarks.length); i++) {
                            const remark = commitRemarks[i];
                            console.log(`- ÂìàÂ∏å: ${remark.hash}, ÂÜÖÂÆπ: ${remark.content || '(Êó†ÂÜÖÂÆπ)'}`);
                          }
              }
            } else {
              console.error('ÊúçÂä°Âô®ËøîÂõûÁöÑÂ§áÊ≥®‰∏çÊòØÊï∞ÁªÑÊ†ºÂºè!', data.commitRemarks);

                        if (typeof data.commitRemarks === 'object' && data.commitRemarks !== null) {
                const tempArray = [];
                for (const hash in data.commitRemarks) {
                            if (Object.prototype.hasOwnProperty.call(data.commitRemarks, hash)) {
                  tempArray.push({
                    hash: hash,
                                content: data.commitRemarks[hash] || '',
                    timestamp: new Date().toISOString()
                  });
                            }
                }
                commitRemarks = tempArray;
                console.log('Â∑≤ËΩ¨Êç¢ÂØπË±°Ê†ºÂºè‰∏∫Êï∞ÁªÑ, ÈïøÂ∫¶:', commitRemarks.length);
                        } else {
                          console.warn('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÊó†Ê≥ïÂ§ÑÁêÜÁöÑÂ§áÊ≥®Ê†ºÂºèÔºå‰ΩøÁî®Á©∫Êï∞ÁªÑ');
                          commitRemarks = [];
              }
            }
          } else {
            console.warn('ÊúçÂä°Âô®ËøîÂõûÁöÑÊï∞ÊçÆ‰∏≠Ê≤°ÊúâcommitRemarksÂ≠óÊÆµ');
                      commitRemarks = [];
                    }

                    // Êõ¥Êñ∞UI
                    updateAllRemarkUI();

                    success = true;
                    return true;
                  } catch (attemptError) {
                    console.error(`Âä†ËΩΩÂ§áÊ≥®Â∞ùËØï ${attempts}/${maxAttempts} Âá∫Èîô:`, attemptError);
                    if (attempts >= maxAttempts) {
                      throw attemptError;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                  }
                }

                if (!success) {
                  console.error('Âä†ËΩΩÂ§áÊ≥®Â§±Ë¥•ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞');
                  return false;
                }

          return true;
        } catch (error) {
                console.error('Âä†ËΩΩÂ§áÊ≥®Â§±Ë¥•:', error);
          return false;
        }
      }

      // ÊòæÁ§∫Â§áÊ≥®ÂºπÁ™ó
      function showRemarkModal(hash, element) {
        currentCommitHash = hash;
        currentCommitElement = element;

        const remarkText = document.getElementById('remarkText');
        remarkText.value = getRemarkContent(hash);

              // Ê†πÊçÆÊòØÂê¶ÊúâÂ§áÊ≥®ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
              const deleteButton = document.getElementById('deleteRemarkBtn');
              if (hasRemark(hash)) {
                deleteButton.style.display = 'block';
              } else {
                deleteButton.style.display = 'none';
              }

        document.getElementById('remarkModal').style.display = 'block';
      }

      // ÂÖ≥Èó≠Â§áÊ≥®ÂºπÁ™ó
      function closeRemarkModal() {
        document.getElementById('remarkModal').style.display = 'none';
        currentCommitHash = null;
        currentCommitElement = null;
      }

            // Ê∑ªÂä†ÊòæÁ§∫ÂíåÈöêËóèloadingÁöÑÂáΩÊï∞
            function showLoading() {
              document.getElementById('loadingOverlay').classList.add('show');
            }

            function hideLoading() {
              document.getElementById('loadingOverlay').classList.remove('show');
            }

            // ‰øÆÊîπÁ°ÆËÆ§Â§áÊ≥®ÂáΩÊï∞ÔºåÊ∑ªÂä†loading
      async function confirmRemark() {
        const remarkText = document.getElementById('remarkText').value.trim();
        console.log('ÂºÄÂßã‰øùÂ≠òÂ§áÊ≥®ÔºåÂìàÂ∏åÂÄº:', currentCommitHash, 'ÂÜÖÂÆπ:', remarkText);

        try {
                showLoading(); // ÊòæÁ§∫loading

                // Save current filter state before operation
                saveCurrentFilterState();

          // Êü•ÊâæÁé∞ÊúâÂ§áÊ≥®
          const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

          if (remarkText) {
            // ÊúâÂ§áÊ≥®ÂÜÖÂÆπÂàôÊõ¥Êñ∞ÊàñÊ∑ªÂä†
            if (existingIndex >= 0) {
              // Êõ¥Êñ∞Áé∞ÊúâÂ§áÊ≥®
              commitRemarks[existingIndex].content = remarkText;
              commitRemarks[existingIndex].timestamp = new Date().toISOString();
              console.log('Â∑≤Êõ¥Êñ∞Áé∞ÊúâÂ§áÊ≥®');
            } else {
              // Ê∑ªÂä†Êñ∞Â§áÊ≥®
              commitRemarks.push({
                hash: currentCommitHash,
                content: remarkText,
                timestamp: new Date().toISOString()
              });
              console.log('Â∑≤Ê∑ªÂä†Êñ∞Â§áÊ≥®');
            }
            console.log('ÂΩìÂâçÂ§áÊ≥®ÊÄªÊï∞:', commitRemarks.length);
          } else if (existingIndex >= 0) {
            // Êó†Â§áÊ≥®ÂÜÖÂÆπ‰∏îÂ≠òÂú®Â§áÊ≥®ÂàôÂà†Èô§
            commitRemarks.splice(existingIndex, 1);
            console.log('Â∑≤Âà†Èô§Â§áÊ≥®');
          }

          // ‰øùÂ≠òÂ§áÊ≥®Âà∞ÊúçÂä°Âô®
          console.log('Ê≠£Âú®ÂêëÊúçÂä°Âô®‰øùÂ≠òÊâÄÊúâÂ§áÊ≥®...');
          await saveCommitRemarks();
          console.log('ÊúçÂä°Âô®‰øùÂ≠òÂ§áÊ≥®ÂÆåÊàê');

          // ÂÖ≥Èó≠Â§áÊ≥®ÂºπÁ™ó
          closeRemarkModal();

          // ÈáçÊñ∞Ê∏≤ÊüìÊèê‰∫§ÂàóË°®‰ª•ÊòæÁ§∫Êñ∞Â§áÊ≥®
          renderCommits();
          console.log('Êèê‰∫§ÂàóË°®ÈáçÊñ∞Ê∏≤ÊüìÂÆåÊàê');

                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showSuccessMessage('Â§áÊ≥®Â∑≤‰øùÂ≠ò');
        } catch (error) {
          console.error('‰øùÂ≠òÂ§áÊ≥®Êìç‰ΩúÂ§±Ë¥•:', error);
          alert('‰øùÂ≠òÂ§áÊ≥®Â§±Ë¥•: ' + error.message);
              } finally {
                hideLoading(); // ÈöêËóèloading
              }
            }

            // ‰øÆÊîπÂà†Èô§Â§áÊ≥®ÂáΩÊï∞ÔºåÊ∑ªÂä†loading
            async function deleteRemark() {
              if (!currentCommitHash) return;

              try {
                showLoading(); // ÊòæÁ§∫loading

                // Save current filter state before operation
                saveCurrentFilterState();

                // Êü•ÊâæÁé∞ÊúâÂ§áÊ≥®
                const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

                if (existingIndex >= 0) {
                  // ‰ªéÊï∞ÁªÑ‰∏≠Âà†Èô§Â§áÊ≥®
                  commitRemarks.splice(existingIndex, 1);
                  console.log('Â∑≤Âà†Èô§Â§áÊ≥®');

                  // ‰øùÂ≠òÂà∞ÊúçÂä°Âô®
                  await saveCommitRemarks();

                  // Êõ¥Êñ∞UI
                  closeRemarkModal();
                  renderCommits();

                  // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                  showSuccessMessage('Â§áÊ≥®Â∑≤Âà†Èô§');
                }
              } catch (error) {
                console.error('Âà†Èô§Â§áÊ≥®Â§±Ë¥•:', error);
                alert('Âà†Èô§Â§áÊ≥®Â§±Ë¥•: ' + error.message);
              } finally {
                hideLoading(); // ÈöêËóèloading
              }
            }

            // ‰øÆÊîπÁ°ÆËÆ§ÂøΩÁï•ÂáΩÊï∞ÔºåÊ∑ªÂä†loading
            async function confirmIgnore() {
              const selectedReason = document.querySelector('input[name="ignoreReason"]:checked').value;
              const customReason = document.getElementById('customReasonText').value.trim();
              const finalReason = selectedReason === 'Other Reasons' ? customReason : selectedReason;

              if (selectedReason === 'Other Reasons' && !customReason) {
                alert('Please enter a custom ignore reason');
                return;
              }

              showLoading(); // ÊòæÁ§∫loading

              // Save current filter state before operation
              saveCurrentFilterState();

              try {
                const commitElement = currentIgnoreElement.closest('.commit');

                // Êõ¥Êñ∞ÂøΩÁï•ÂàóË°®
                const index = ignoredCommits.findIndex(item => item.hash === currentIgnoreHash);
                if (index === -1) {
                  ignoredCommits.push({
                    hash: currentIgnoreHash,
                    reason: finalReason,
                    timestamp: new Date().toISOString()
                  });
                  commitElement.classList.add('ignored');
                  currentIgnoreElement.textContent = 'ÂèñÊ∂àÂøΩÁï•';

                  // ÁßªÈô§Áé∞ÊúâÂøΩÁï•ÂéüÂõ†ÂÖÉÁ¥†ÔºàÂ¶ÇÊûúÊúâÔºâ
                  const existingReason = commitElement.querySelector('.ignore-reason');
                  if (existingReason) {
                    existingReason.remove();
                  }

                  // Ê∑ªÂä†Êñ∞ÁöÑÂøΩÁï•ÂéüÂõ†Â±ïÁ§∫
                  const detailsElement = currentIgnoreElement.closest('.commit-info');
                  const reasonElement = document.createElement('div');
                  reasonElement.className = 'ignore-reason';
                  reasonElement.innerHTML = `
                    <span class="ignore-reason-title">üö´ ÂøΩÁï•ÂéüÂõ†</span>
                    <span class="ignore-reason-content">${finalReason}</span>
                  `;

                  // ÊèíÂÖ•Âà∞Ê≠£Á°ÆÁöÑ‰ΩçÁΩÆ
                  const remarkElement = detailsElement.querySelector('.commit-remark');
                  if (remarkElement) {
                    detailsElement.insertBefore(reasonElement, remarkElement);
                  } else {
                    detailsElement.appendChild(reasonElement);
                  }
                }

                // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞
                await saveIgnoredCommits();
                await loadIgnoredCommits(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        updateCherryPickCommands();
                closeIgnoreModal();

                // Ê∑ªÂä†ÊàêÂäüÊèêÁ§∫
                showSuccessMessage('ÂøΩÁï•Êèê‰∫§ÊàêÂäü');
              } catch (error) {
                console.error('‰øùÂ≠òÂøΩÁï•Êèê‰∫§Â§±Ë¥•:', error);
                alert('‰øùÂ≠òÂøΩÁï•Êèê‰∫§Â§±Ë¥•: ' + error.message);
              } finally {
                hideLoading(); // ÈöêËóèloading
              }
            }

            // ‰øÆÊîπÂèñÊ∂àÂøΩÁï•ÊµÅÁ®ãÔºåÊ∑ªÂä†loading
            function toggleIgnoreCommit(hash, element) {
              const index = ignoredCommits.findIndex(item => item.hash === hash);

              if (index === -1) {
                // ÊòæÁ§∫ÂøΩÁï•ÂéüÂõ†ÈÄâÊã©ÂºπÁ™ó
                showIgnoreModal(hash, element);
              } else {
                // ÂèñÊ∂àÂøΩÁï•
                showLoading(); // ÊòæÁ§∫loading

                // Save current filter state before operation
                saveCurrentFilterState();

                const commitElement = element.closest('.commit');
                ignoredCommits.splice(index, 1);
                commitElement.classList.remove('ignored');
                element.textContent = 'ÂøΩÁï•';

                // ÁßªÈô§ÂøΩÁï•ÂéüÂõ†ÊòæÁ§∫
                const reasonElement = commitElement.querySelector('.ignore-reason');
                if (reasonElement) {
                  reasonElement.remove();
                }

                // ‰øùÂ≠òÂπ∂Êõ¥Êñ∞
                saveIgnoredCommits()
                  .then(() => {
                    loadIgnoredCommits();
                    updateCherryPickCommands();

                    // Ê∑ªÂä†ÊàêÂäüÊèêÁ§∫
                    showSuccessMessage('ÂèñÊ∂àÂøΩÁï•ÊàêÂäü');
                  })
                  .catch(error => {
                    console.error('‰øùÂ≠òÂøΩÁï•Êèê‰∫§Â§±Ë¥•:', error);
                    alert('‰øùÂ≠òÂøΩÁï•Êèê‰∫§Â§±Ë¥•: ' + error.message);
                  })
                  .finally(() => {
                    hideLoading(); // ÈöêËóèloading
                  });
              }
            }

            // ‰øÆÊîπcherry-pickÂëΩ‰ª§ÁöÑÁîüÊàêÈÄªËæëÔºåÊîØÊåÅÂèåÂêëÂëΩ‰ª§
            function updateCherryPickCommands() {
              // Ê∫êÂàÜÊîØÂà∞ÁõÆÊ†áÂàÜÊîØÁöÑÂëΩ‰ª§ÔºàÂè™ÂåÖÂê´Ê∫êÂàÜÊîØÁã¨ÊúâÁöÑÊèê‰∫§Ôºâ
              const sourceOnlyCommits = commits.filter(commit =>
                commit.status === 'source' && !ignoredCommits.some(item => item.hash === commit.hash)
              );

              // ÁõÆÊ†áÂàÜÊîØÂà∞Ê∫êÂàÜÊîØÁöÑÂëΩ‰ª§ÔºàÂè™ÂåÖÂê´ÁõÆÊ†áÂàÜÊîØÁã¨ÊúâÁöÑÊèê‰∫§Ôºâ
              const targetOnlyCommits = commits.filter(commit =>
                commit.status === 'target' && !ignoredCommits.some(item => item.hash === commit.hash)
              );

              // Ê∫êÂàÜÊîØÂà∞ÁõÆÊ†áÂàÜÊîØÁöÑÂëΩ‰ª§
              updateDirectionalCommands(sourceOnlyCommits, sourceBranch, targetBranch, 'source-to-target');

              // ÁõÆÊ†áÂàÜÊîØÂà∞Ê∫êÂàÜÊîØÁöÑÂëΩ‰ª§
              updateDirectionalCommands(targetOnlyCommits, targetBranch, sourceBranch, 'target-to-source');
            }

            // ÁîüÊàêÁâπÂÆöÊñπÂêëÁöÑcherry-pickÂëΩ‰ª§
            function updateDirectionalCommands(directionCommits, fromBranch, toBranch, direction) {
              // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂ∫è
              directionCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              // Êõ¥Êñ∞ÂëΩ‰ª§
              let commands = '';
              let commandsArray = [];

              // Ê∑ªÂä†ÂàáÊç¢ÂàÜÊîØÂëΩ‰ª§
              commandsArray.push(`# ÂàáÊç¢Âà∞ ${toBranch} ÂàÜÊîØ`);
              commandsArray.push(`git checkout ${toBranch}`);
              commandsArray.push('');  // Á©∫Ë°å
              commandsArray.push(`# Cherry-pick ‰ªé ${fromBranch} ÂàÜÊîØÁöÑÊèê‰∫§`);

              // Ê∑ªÂä†ÊØè‰∏™Êèê‰∫§ÁöÑÂëΩ‰ª§
              directionCommits.forEach(commit => {
                commandsArray.push(`git cherry-pick ${commit.hash}  # ${commit.message}`);
              });

              // Â∞ÜÂëΩ‰ª§Êï∞ÁªÑËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤Áî®‰∫é"Â§çÂà∂ÂÖ®ÈÉ®"ÂäüËÉΩ
              commands = commandsArray.join('\n');

              // Êõ¥Êñ∞HTMLÊòæÁ§∫ÔºåÊ∑ªÂä†ÂçïË°åÂ§çÂà∂ÊåâÈíÆ
              const commandsContainer = document.getElementById(`${direction}-commands-container`);
              commandsContainer.innerHTML = '';

              commandsArray.forEach(cmd => {
                const cmdLine = document.createElement('div');
                cmdLine.className = 'command-line';

                const cmdText = document.createElement('pre');
                cmdText.textContent = cmd;
                cmdLine.appendChild(cmdText);

                // Âè™‰∏∫ÈùûÁ©∫Ë°å‰∏î‰∏çÊòØÊ≥®ÈáäÁöÑË°åÊ∑ªÂä†Â§çÂà∂ÊåâÈíÆ
                if (cmd && !cmd.startsWith('#')) {
                  const copyBtn = document.createElement('button');
                  copyBtn.className = 'copy-line-button';
                  copyBtn.innerHTML = 'Â§çÂà∂';
                  copyBtn.onclick = function() {
                    copyToClipboard(cmd, this);
                  };
                  cmdLine.appendChild(copyBtn);
                }

                commandsContainer.appendChild(cmdLine);
              });

              // ‰øùÂ≠òÂà∞ÂÖÉÁ¥†Áî®‰∫é"Â§çÂà∂ÂÖ®ÈÉ®"ÂäüËÉΩ
              document.getElementById(`${direction}-commands`).textContent = commands;
            }

            // ... existing code ...

      function getCommitIndicator(commit) {
        if (commit.status === 'both') return 'üî¥üîµ';
        return commit.status === 'source' ? 'üî¥' : 'üîµ';
      }

      function copyCommandBlock(type) {
        const textContent = document.getElementById(`${type}-commands`).textContent;
        copyToClipboard(textContent, document.querySelector(`.copy-${type}-button`));
      }

      function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.textContent = 'Â∑≤Â§çÂà∂!';
          document.body.appendChild(tooltip);

          const rect = element.getBoundingClientRect();
          tooltip.style.top = rect.top - 30 + 'px';
          tooltip.style.left = rect.left + 'px';
          tooltip.style.opacity = '1';

          setTimeout(() => {
            tooltip.style.opacity = '0';
            setTimeout(() => tooltip.remove(), 200);
          }, 1000);
        });
      }

      function filterCommits(type) {
              const commitRows = document.querySelectorAll('.commit-row');
        const buttons = document.querySelectorAll('.filter-button');

        buttons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

              // Save the current filter type as a data attribute on the body
              document.body.setAttribute('data-current-filter', type);

              // Update our filter state
              currentFilterState.mainFilter = type;

              // Toggle visibility of sub-filters only for "all" filter
              const subFilterSection = document.getElementById('subFilterSection');
              if (type === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply both main filter and sub-filters
              applyFilters(type);

              // Update URL with filter state
              updateURLParams();
            }

            function applyFilters(type) {
              const commitRows = document.querySelectorAll('.commit-row');
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;

              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const status = commitElement.getAttribute('data-status');
                const hash = commitElement.getAttribute('data-hash');
          const isIgnored = ignoredCommits.some(item => item.hash === hash);
                const isCommon = status === 'both';

                // First apply the main filter
                let shouldShow = false;

          switch(type) {
            case 'all':
                    shouldShow = true;
              break;
            case 'source':
                    shouldShow = status === 'source';
              break;
            case 'target':
                    shouldShow = status === 'target';
              break;
            case 'common':
                    shouldShow = status === 'both';
              break;
            case 'ignored':
                    shouldShow = isIgnored;
              break;
          }

                // Then apply sub-filters
                if (shouldShow) {
                  // Hide based on ignored status
                  if (hideIgnored && isIgnored && type !== 'ignored') {
                    shouldShow = false;
                  }

                  // Hide based on common status
                  if (hideCommon && isCommon && type !== 'common') {
                    shouldShow = false;
                  }
                }

                row.style.display = shouldShow ? '' : 'none';
              });
            }

            function applySubFilters() {
              // Get the current main filter
              const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
              applyFilters(currentFilter);

              // Update URL with filter state
              updateURLParams();
      }

      function switchCommandTab(tab) {
        document.querySelectorAll('.command-tab').forEach(item => {
          item.classList.toggle('active', item.getAttribute('data-command') === tab);
        });
        document.querySelectorAll('.command-content').forEach(item => {
          item.classList.toggle('active', item.id === `${tab}-content`);
        });
      }

      // ‰øùÂ≠òÂøΩÁï•ÁöÑÊèê‰∫§Âà∞ÊúçÂä°Âô®
      async function saveIgnoredCommits() {
        try {
          const response = await fetch('http://localhost:3000/ignore-commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ignoredCommits })
          });

          if (!response.ok) {
            throw new Error('Failed to save ignored commits');
          }
        } catch (error) {
          console.error('‰øùÂ≠òÂøΩÁï•Êèê‰∫§Â§±Ë¥•:', error);
          throw error;
        }
      }

            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫ÁöÑÂáΩÊï∞
            function showSuccessMessage(message) {
              const successToast = document.createElement('div');
              successToast.className = 'success-toast';
              successToast.textContent = message;
              document.body.appendChild(successToast);

              // ÊòæÁ§∫ÂºπÁ™ó
              setTimeout(() => {
                successToast.classList.add('show');
              }, 100);

              // 2ÁßíÂêéÈöêËóè
              setTimeout(() => {
                successToast.classList.remove('show');
                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§DOM
                setTimeout(() => successToast.remove(), 500);
              }, 2000);
            }

            // Êõ¥Êñ∞ÊâÄÊúâÂ§áÊ≥®ÁöÑUI
            function updateAllRemarkUI() {
              // Ëé∑ÂèñÊâÄÊúâÊèê‰∫§ÂÖÉÁ¥†
              document.querySelectorAll('.commit').forEach(commitEl => {
                const hash = commitEl.getAttribute('data-hash');
                if (hash) {
                  // Êõ¥Êñ∞Â§áÊ≥®UI
                  updateRemarkUI(hash);
                }
              });
            }

            // Êõ¥Êñ∞Âçï‰∏™Êèê‰∫§ÁöÑÂ§áÊ≥®UI
            function updateRemarkUI(hash) {
              const remarkElement = document.querySelector(`.remark-content[data-hash="${hash}"]`);
              if (!remarkElement) return;

              const remark = getCommitRemark(hash);

              // Êõ¥Êñ∞Â§áÊ≥®ÂÜÖÂÆπ
              if (remark && remark.content) {
                remarkElement.value = remark.content;
                remarkElement.classList.add('has-content');

                // Êõ¥Êñ∞Êó∂Èó¥Êà≥ÊòæÁ§∫
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl && remark.timestamp) {
                  const date = new Date(remark.timestamp);
                  timestampEl.textContent = `Êõ¥Êñ∞‰∫é: ${date.toLocaleString()}`;
                  timestampEl.style.display = 'block';
                }
        } else {
                remarkElement.value = '';
                remarkElement.classList.remove('has-content');

                // ÈöêËóèÊó∂Èó¥Êà≥
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl) {
                  timestampEl.style.display = 'none';
                }
              }
            }

            // ÂÖ≥Èó≠ÂøΩÁï•ÂéüÂõ†ÂºπÁ™ó
            function closeIgnoreModal() {
              document.getElementById('ignoreModal').style.display = 'none';
              currentIgnoreHash = null;
              currentIgnoreElement = null;
            }

            // Ê∏≤ÊüìÊèê‰∫§ÂàóË°® - ‰ΩøÁî®ËÅäÂ§©ÂºèÂ∏ÉÂ±Ä
            function renderCommits(shouldRestoreState = true) {
              // Remember current filter state before rendering if requested
              if (shouldRestoreState) {
                saveCurrentFilterState();
              }

              const timeline = document.getElementById('timeline');
              timeline.innerHTML = '';

              // Get current layout
              const currentLayout = document.body.getAttribute('data-layout') || 'chat';

              // ÊåâÁÖßÊó∂Èó¥ÊéíÂ∫èÔºà‰ªéÊñ∞Âà∞ÊóßÔºâ
              sortedCommitsArray = [...commits].sort((a, b) =>
                new Date(b.date || b.dateIso) - new Date(a.date || a.dateIso)
              );

              // ‰∏∫ÊØè‰∏™Êèê‰∫§ÂàõÂª∫Ë°å
              sortedCommitsArray.forEach((commit, index) => {
                const isIgnored = ignoredCommits.some(item => item.hash === commit.hash);
                const ignoredCommit = ignoredCommits.find(item => item.hash === commit.hash);
                const hasRemarkForCommit = hasRemark(commit.hash);
                const remarkContent = getRemarkContent(commit.hash);
                const isMatchedByMessage = commit.matchedByMessage === true;

                // ÂàõÂª∫Êèê‰∫§Ë°å
                const commitRow = document.createElement('div');
                commitRow.className = 'commit-row';

                // ÂàõÂª∫Êèê‰∫§ÂÆπÂô®
                const commitContainer = document.createElement('div');

                // Ê†πÊçÆÊèê‰∫§Áä∂ÊÄÅÁ°ÆÂÆöÁ±ªÂûãÂíå‰ΩçÁΩÆ
                if (commit.status === 'both') {
                  commitContainer.className = 'commit-container both';
                } else if (commit.status === 'source') {
                  commitContainer.className = 'commit-container source';
                } else {
                  commitContainer.className = 'commit-container target';
                }

                // ÂàõÂª∫Ê†áÂøóÊñáÊú¨ - Â¢ûÂº∫ÂÖ±ÂêåÊèê‰∫§ÊòæÁ§∫
                let badgeText;
                let badgeClass = '';

                if (commit.status === 'both') {
                  badgeText = isMatchedByMessage ? 'Â∑≤ÂêåÊ≠•(commit Ê∂àÊÅØÂåπÈÖç)' : 'ÂÖ±ÂêåÊèê‰∫§';
                  if (isMatchedByMessage) {
                    badgeClass = 'message-matched';
                  }
                } else if (commit.status === 'source') {
                  badgeText = sourceBranch;
                } else {
                  badgeText = targetBranch;
                }

                // ÂàõÂª∫Êèê‰∫§ÂÜÖÂÆπÔºå‰∏∫Ê∂àÊÅØÂåπÈÖçÁöÑÊèê‰∫§Ê∑ªÂä†ÁâπÊÆäCSSÁ±ª
                let commitClasses = `commit${isIgnored ? ' ignored' : ''}`;
                if (isMatchedByMessage) {
                  commitClasses += ' matched-by-message';
                }

                let hashContent = '';

                // VS CodeÂõæÊ†áSVG
                const vscodeIconSvg = `<svg t="1742888482761" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1654" width="16" height="16"><path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#FFFFFF" p-id="1655"></path><path d="M708.82304 161.9968l137.46176 67.24608c20.81792 10.62912 23.7056 18.28864 23.7056 29.29664l0.60416 506.23488c0 13.50656-7.30112 18.82112-27.42272 30.1568l-133.8368 67.08224c-5.5808 2.60096-10.04544 5.76512-43.47904 5.76512 0 0 28.93824 0.24576 28.93824-22.87616v-662.87616a25.15968 25.15968 0 0 0-24.13568-25.76384c29.6448 0 38.16448 5.7344 38.16448 5.7344z" fill="#4B9AE9" p-id="1656"></path><path d="M163.34848 613.02784a29.21472 29.21472 0 0 0 0 38.98368s35.11296 32.62464 45.4656 41.984 25.7024 5.12 35.64544-2.37568 450.29376-343.64416 450.29376-343.64416v-165.94944a25.06752 25.06752 0 0 0-24.13568-25.76384 18.11456 18.11456 0 0 0-12.3392 5.376z" fill="#2A63A4" p-id="1657"></path><path d="M208.92672 331.74528a23.17312 23.17312 0 0 1 32.45056 0l453.4272 343.61344v169.55392c0 23.25504-28.9792 22.8352-28.9792 22.8352a17.00864 17.00864 0 0 1-10.11712-5.53984l-495.77984-454.13376a22.31296 22.31296 0 0 1 0-31.54944z" fill="#3478C6" p-id="1658"></path></svg>`;

                // ‰∏∫Êèê‰∫§ÂìàÂ∏åÊ∑ªÂä†"Êü•ÁúãÂèòÊõ¥"ÊåâÈíÆ
                function getHashWithViewChangesButton(hash) {
                  const shortHash = hash.substring(0, 7);  // Âè™ÊòæÁ§∫Ââç7‰Ωç
                  return `
                    <span class="commit-hash" onclick="copyToClipboard('${hash}', this)" title="${hash}">${shortHash}</span>
                    <button class="vscode-button" data-tooltip="Âú®VS Code‰∏≠Êü•ÁúãÊ≠§Êèê‰∫§" onclick="openInVSCode('${hash}')">
                      ${vscodeIconSvg}
                    </button>
                    <button class="view-changes-btn" onclick="event.stopPropagation(); viewCommitChanges('${hash}', '${commit.message}')">
                      Êü•ÁúãÂèòÊõ¥
                    </button>
                  `;
                }

                // ‰∏∫Ê∂àÊÅØÂåπÈÖçÁöÑÊèê‰∫§ÊòæÁ§∫‰∏§‰∏™ÂàÜÊîØÁöÑÂìàÂ∏åÂÄºÂπ∂Ê∑ªÂä†ÊåâÈíÆ
                if (isMatchedByMessage && commit.targetHash) {
                  hashContent = `
                    <div class="commit-hash-pair">
                      <div class="commit-hash-branch">
                        <span class="branch-label">${sourceBranch}:</span>
                        ${getHashWithViewChangesButton(commit.hash)}
                      </div>
                      <div class="commit-hash-branch">
                        <span class="branch-label">${targetBranch}:</span>
                        ${getHashWithViewChangesButton(commit.targetHash)}
                      </div>
                      <button class="compare-in-vscode" onclick="compareCommitsInVSCode('${commit.hash}', '${commit.targetHash}')">
                        ${vscodeIconSvg} Âú®VS Code‰∏≠ÊØîËæÉ‰∏§‰∏™Êèê‰∫§
                      </button>
                    </div>
                  `;
                } else {
                  hashContent = getHashWithViewChangesButton(commit.hash);
                }

                // Ê∑ªÂä†ÂàÜÊîØÊåáÁ§∫Âô®Ôºà‰ªÖÂπ≥Èì∫Â∏ÉÂ±Ä‰ΩøÁî®Ôºâ
                const branchIndicator = `<div class="branch-indicator ${badgeClass}"></div>`;

                // ÂàõÂª∫Êèê‰∫§ÂÜÖÂÆπ
                commitContainer.innerHTML = `
                  <div class="${commitClasses}" data-hash="${commit.hash}" data-status="${commit.status}">
                    ${currentLayout === 'flat' ? branchIndicator : ''}
                    <span class="commit-badge ${badgeClass}">${badgeText}</span>
                    <div class="commit-time">${commit.formattedDate}</div>
                    <div class="commit-info">
                      <div class="commit-message" onclick="copyToClipboard('${commit.message}', this)">${commit.message}</div>
                      <div class="commit-details">
                        <span class="commit-author">‰ΩúËÄÖ: ${commit.authorName}</span>
                        ${hashContent}
                        <button class="ignore-button" onclick="toggleIgnoreCommit('${commit.hash}', this)">
                          ${isIgnored ? 'ÂèñÊ∂àÂøΩÁï•' : 'ÂøΩÁï•'}
                        </button>
                        <button class="remark-button" onclick="showRemarkModal('${commit.hash}', this)">
                          ${hasRemarkForCommit ? 'ÁºñËæëÂ§áÊ≥®' : 'Ê∑ªÂä†Â§áÊ≥®'}
                        </button>
                      </div>
                      ${isIgnored && ignoredCommit ? `
                        <div class="ignore-reason">
                          <span class="ignore-reason-title">üö´ ÂøΩÁï•ÂéüÂõ†</span>
                          <span class="ignore-reason-content">${ignoredCommit.reason}</span>
                        </div>` : ''}
                      ${remarkContent ? `
                        <div class="commit-remark">
                          <span class="commit-remark-title">üìù Â§áÊ≥®</span>
                          <span class="commit-remark-content">${remarkContent}</span>
                        </div>` : ''}
                    </div>
                  </div>
                `;

                // Â∞ÜÊèê‰∫§ÂÆπÂô®Ê∑ªÂä†Âà∞Ë°å‰∏≠
                commitRow.appendChild(commitContainer);

                // Â∞ÜË°åÊ∑ªÂä†Âà∞Êó∂Èó¥ËΩ¥‰∏≠
                timeline.appendChild(commitRow);
              });

              updateCherryPickCommands();

              // Restore filter state after rendering if requested
              if (shouldRestoreState) {
                restoreFilterState();
              }
            }

            // Helper function to save current filter state
            function saveCurrentFilterState() {
              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl) {
                console.warn('Some filter DOM elements not found, skipping state save');
                return;
              }

              currentFilterState = {
                mainFilter: document.body.getAttribute('data-current-filter') || 'all',
                hideIgnored: hideIgnoredEl.checked,
                hideCommon: hideCommonEl.checked,
                searchText: searchInputEl.value.trim(),
                searchMessage: searchMessageEl.checked,
                searchAuthor: searchAuthorEl.checked,
                searchHash: searchHashEl.checked
              };

              // Log filter state for debugging
              console.log('Saved filter state:', currentFilterState);
            }

            // Helper function to restore filter state after operations
            function restoreFilterState() {
              console.log('Restoring filter state:', currentFilterState);

              if (!currentFilterState) {
                console.warn('No filter state to restore');
                return;
              }

              // First set the main filter active state in UI
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Set body attribute
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');
              const clearButton = document.getElementById('clearSearch');
              const subFilterSection = document.getElementById('subFilterSection');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl ||
                  !clearButton || !subFilterSection) {
                console.warn('Some filter DOM elements not found, skipping state restore');
                return;
              }

              // Set the checkbox states
              hideIgnoredEl.checked = currentFilterState.hideIgnored;
              hideCommonEl.checked = currentFilterState.hideCommon;

              // Set the search input and options
              searchInputEl.value = currentFilterState.searchText;
              searchMessageEl.checked = currentFilterState.searchMessage;
              searchAuthorEl.checked = currentFilterState.searchAuthor;
              searchHashEl.checked = currentFilterState.searchHash;

              // Show or hide the clear button based on search text
              if (currentFilterState.searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // Set sub-filter visibility based on main filter
              if (currentFilterState.mainFilter === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply the saved filters
              if (currentFilterState.searchText) {
                // If there's search text, apply search filter
                searchCommits(false); // Pass false to prevent saving state again
              } else {
                // Otherwise apply normal filters
                applyFilters(currentFilterState.mainFilter);
              }
            }

            // Initialize the filter state
            function initializeFilterState() {
              // Get state from URL params
              const urlParams = getURLParams();

              // Set initial filter state from URL or defaults
              currentFilterState = {
                mainFilter: urlParams.filter,
                hideIgnored: urlParams.hideIgnored,
                hideCommon: urlParams.hideCommon,
                searchText: '',
                searchMessage: true,
                searchAuthor: true,
                searchHash: false
              };

              // Update UI elements to match URL state
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Update filter buttons
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Update checkboxes
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              if (hideIgnoredEl) hideIgnoredEl.checked = currentFilterState.hideIgnored;
              if (hideCommonEl) hideCommonEl.checked = currentFilterState.hideCommon;

              // Set sub-filter visibility
              const subFilterSection = document.getElementById('subFilterSection');
              if (subFilterSection) {
                if (currentFilterState.mainFilter === 'all') {
                  subFilterSection.classList.remove('hidden');
                } else {
                  subFilterSection.classList.add('hidden');
                }
              }

              // Apply the filters based on URL state
              applyFilters(currentFilterState.mainFilter);

              console.log('Initialized filter state from URL:', currentFilterState);
            }

            // Add function to switch between layouts
            function switchLayout(layout) {
              // Update layout buttons
              document.getElementById('chatLayoutBtn').classList.toggle('active', layout === 'chat');
              document.getElementById('flatLayoutBtn').classList.toggle('active', layout === 'flat');

              // Update timeline class
              const timeline = document.getElementById('timeline');
              if (layout === 'flat') {
                timeline.classList.add('flat-layout');
              } else {
                timeline.classList.remove('flat-layout');
              }

              // Store current layout
              document.body.setAttribute('data-layout', layout);

              // Re-render commits with new layout
              renderCommits();

              // Save preference to localStorage
              localStorage.setItem('preferredLayout', layout);
            }

            // Add code to initialize layout from localStorage
            function initializeLayout() {
              const savedLayout = localStorage.getItem('preferredLayout') || 'flat';
              switchLayout(savedLayout);
            }

            // Modify the initialization code to include layout initialization
            // ÂàùÂßãÂåñÈ°µÈù¢
            loadIgnoredCommits();
            initializeLayout();

            // Add search functionality
            function searchCommits(saveState = true) {
              const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
              const searchMessage = document.getElementById('searchMessage').checked;
              const searchAuthor = document.getElementById('searchAuthor').checked;
              const searchHash = document.getElementById('searchHash').checked;
              const clearButton = document.getElementById('clearSearch');

              // Save the filter state if requested
              if (saveState) {
                currentFilterState.searchText = searchText;
                currentFilterState.searchMessage = searchMessage;
                currentFilterState.searchAuthor = searchAuthor;
                currentFilterState.searchHash = searchHash;

                // Update URL params (we don't add search to URL as it's temporary)
                updateURLParams();
              }

              // Toggle clear button visibility
              if (searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // If no search text, show all commits based on current filter
              if (!searchText) {
                // Reapply current filter
                const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
                applyFilters(currentFilter);
          return;
        }

              // Get all commit rows
              const commitRows = document.querySelectorAll('.commit-row');

              // Reset highlights
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const messageElement = commitElement.querySelector('.commit-message');
                const authorElement = commitElement.querySelector('.commit-author');
                const hashElements = commitElement.querySelectorAll('.commit-hash');

                // Remove existing highlights
                if (messageElement) {
                  messageElement.innerHTML = messageElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                if (authorElement) {
                  authorElement.innerHTML = authorElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                hashElements.forEach(el => {
                  el.innerHTML = el.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                });
              });

              // For each commit, check if it matches the search criteria
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                let matches = false;

                // Check commit message if enabled
                if (searchMessage) {
                  const messageElement = commitElement.querySelector('.commit-message');
                  if (messageElement && messageElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(messageElement, searchText);
                  }
                }

                // Check author if enabled
                if (searchAuthor && !matches) {
                  const authorElement = commitElement.querySelector('.commit-author');
                  if (authorElement && authorElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(authorElement, searchText);
                  }
                }

                // Check hash if enabled
                if (searchHash && !matches) {
                  const hashElements = commitElement.querySelectorAll('.commit-hash');
                  hashElements.forEach(hashElement => {
                    if (hashElement.textContent.toLowerCase().includes(searchText)) {
                      matches = true;
                      // Highlight the matching text
                      highlightText(hashElement, searchText);
                    }
                  });
                }

                // Show/hide based on search match
                row.style.display = matches ? '' : 'none';
              });
            }

            // Helper function to highlight search text
            function highlightText(element, searchText) {
              // Only add highlight if not already highlighted
              if (!element.innerHTML.includes('<span class="highlight">')) {
                const innerHTML = element.innerHTML;
                const index = innerHTML.toLowerCase().indexOf(searchText.toLowerCase());
                if (index >= 0) {
                  const highlighted = innerHTML.substring(0, index) +
                                     '<span class="highlight">' +
                                     innerHTML.substring(index, index + searchText.length) +
                                     '</span>' +
                                     innerHTML.substring(index + searchText.length);
                  element.innerHTML = highlighted;
                }
              }
            }

            // Function to clear search
            function clearSearch() {
              document.getElementById('searchInput').value = '';
              // Reset highlights
              document.querySelectorAll('.highlight').forEach(el => {
                const parent = el.parentNode;
                parent.textContent = parent.textContent;
              });
              // Reapply current filter
              searchCommits();
              document.getElementById('clearSearch').classList.remove('visible');
            }

            // Modify the initialization code to set initial sub-filter visibility
      // ÂàùÂßãÂåñÈ°µÈù¢
      loadIgnoredCommits();
            initializeLayout();

            // Set initial sub-filter visibility
            const initialFilter = document.body.getAttribute('data-current-filter') || 'all';
            const subFilterSection = document.getElementById('subFilterSection');
            if (initialFilter !== 'all') {
              subFilterSection.classList.add('hidden');
            }

            // Initialize with correct filter state
            window.addEventListener('DOMContentLoaded', function() {
              // Check if URL has any parameters
              const urlParams = new URLSearchParams(window.location.search);
              if (!urlParams.has('filter') && !urlParams.has('hideIgnored') && !urlParams.has('hideCommon')) {
                // Set default URL parameters
                const url = new URL(window.location.href);
                url.searchParams.set('filter', 'all');
                url.searchParams.set('hideIgnored', '0');
                url.searchParams.set('hideCommon', '1');
                window.history.replaceState({}, '', url.toString());
              }

              // Set up initial filter state tracking
              saveCurrentFilterState();
            });

            // Restore the back to top functionality
            window.addEventListener('scroll', function() {
              const backToTopButton = document.getElementById('backToTop');
              if (backToTopButton) {
                if (window.scrollY > 300) {
                  backToTopButton.classList.add('show');
                } else {
                  backToTopButton.classList.remove('show');
                }
              }
            });

            document.getElementById('backToTop').addEventListener('click', function() {
              window.scrollTo({
                top: 0,
                behavior: 'smooth'
              });
            });

            // Add function to update URL parameters with filter state
            function updateURLParams() {
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;
              const mainFilter = document.body.getAttribute('data-current-filter') || 'all';

              const url = new URL(window.location.href);
              url.searchParams.set('filter', mainFilter);
              url.searchParams.set('hideIgnored', hideIgnored ? '1' : '0');
              url.searchParams.set('hideCommon', hideCommon ? '1' : '0');

              // Don't add search parameters to URL as they're typically temporary

              // Update browser history without refreshing the page
              window.history.replaceState({}, '', url.toString());
            }

            // Add function to get URL parameters
            function getURLParams() {
              const urlParams = new URLSearchParams(window.location.search);
              return {
                filter: urlParams.get('filter') || 'all',
                hideIgnored: urlParams.get('hideIgnored') === '1',
                hideCommon: urlParams.get('hideCommon') === '1'
              };
            }

            // Ê∑ªÂä†Âú®VS Code/ÁªàÁ´Ø‰∏≠Êü•ÁúãÊèê‰∫§ÁöÑÂáΩÊï∞
            function openInVSCode(commitHash) {
              // ÂàõÂª∫‰∏Ä‰∏™ÊèêÁ§∫Ê°ÜÔºåÊèê‰æõGitÂëΩ‰ª§‰æõÂ§çÂà∂
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = 'Êü•ÁúãÊèê‰∫§ÁöÑGitÂëΩ‰ª§';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              content.appendChild(title);

              // Êèê‰æõ‰∏çÂêåÁöÑGitÂëΩ‰ª§ÈÄâÈ°π
              const commands = [
                {
                  name: 'Êü•ÁúãÊèê‰∫§ËØ¶ÊÉÖ',
                  command: `git show ${commitHash}`
                },
                {
                  name: 'Êü•ÁúãÊèê‰∫§Êõ¥ÊîπÁöÑÊñá‰ª∂',
                  command: `git show --name-only ${commitHash}`
                },
                {
                  name: 'Êü•ÁúãÊèê‰∫§ÁöÑÂÆåÊï¥Â∑ÆÂºÇ',
                  command: `git show --color-words ${commitHash}`
                }
              ];

              // ‰∏∫ÊØè‰∏™ÂëΩ‰ª§ÂàõÂª∫‰∏Ä‰∏™ÂèØÂ§çÂà∂ÁöÑÂå∫Âüü
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Â§çÂà∂';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = 'Â∑≤Â§çÂà∂';
                    setTimeout(() => {
                      copyBtn.textContent = 'Â§çÂà∂';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // Êèê‰æõVSCodeÁâπÂÆöÂª∫ËÆÆ
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code ‰ΩøÁî®ÊèêÁ§∫';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                'Âú®VS Code‰∏≠ÔºåÂèØ‰ª•ÈÄöËøáCtrl+Shift+P (Windows/Linux) Êàñ Cmd+Shift+P (Mac) ÊâìÂºÄÂëΩ‰ª§Èù¢Êùø',
                'ËæìÂÖ• "Git: Show Commit" Âπ∂ÈÄâÊã©ÔºåÁÑ∂ÂêéÁ≤òË¥¥Ê≠§Êèê‰∫§ÂìàÂ∏å',
                'ÂØπ‰∫éGitLensÁî®Êà∑: ÂëΩ‰ª§Èù¢Êùø‰∏≠ËæìÂÖ• "GitLens: Show Commit" ÂèØ‰ª•Êü•ÁúãÊõ¥ËØ¶ÁªÜÁöÑÊèê‰∫§‰ø°ÊÅØ',
                'ÂØπ‰∫éGit HistoryÁî®Êà∑: ÂëΩ‰ª§Èù¢Êùø‰∏≠ËæìÂÖ• "Git: View History" ÂèØ‰ª•Êü•ÁúãÊèê‰∫§ÂéÜÂè≤'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
              const closeButton = document.createElement('button');
              closeButton.textContent = 'ÂÖ≥Èó≠';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // ÂÖ≥Èó≠Êó∂‰πüÂèØ‰ª•ÁÇπÂáªËÉåÊôØ
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // Ê∑ªÂä†ÊØîËæÉ‰∏§‰∏™Êèê‰∫§ÁöÑÂáΩÊï∞
            function compareCommitsInVSCode(sourceHash, targetHash) {
              // ÂàõÂª∫‰∏Ä‰∏™ÊèêÁ§∫Ê°ÜÔºåÊèê‰æõGitÂëΩ‰ª§‰æõÂ§çÂà∂
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = 'ÊØîËæÉ‰∏§‰∏™Êèê‰∫§ÁöÑGitÂëΩ‰ª§';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              const subtitle = document.createElement('p');
              subtitle.innerHTML = `ÊØîËæÉ <code>${sourceHash.substring(0, 7)}</code> Âíå <code>${targetHash.substring(0, 7)}</code>`;
              subtitle.style.marginBottom = '20px';
              subtitle.style.color = '#666';

              content.appendChild(title);
              content.appendChild(subtitle);

              // Êèê‰æõ‰∏çÂêåÁöÑGitÂëΩ‰ª§ÈÄâÈ°π
              const commands = [
                {
                  name: 'ÊòæÁ§∫‰∏§‰∏™Êèê‰∫§‰πãÈó¥ÁöÑÂ∑ÆÂºÇ',
                  command: `git diff ${sourceHash} ${targetHash}`
                },
                {
                  name: 'Êü•ÁúãÊõ¥ÊîπÁöÑÊñá‰ª∂ÂàóË°®',
                  command: `git diff --name-only ${sourceHash} ${targetHash}`
                },
                {
                  name: 'Êü•ÁúãÊ±áÊÄªÁªüËÆ°‰ø°ÊÅØ',
                  command: `git diff --stat ${sourceHash} ${targetHash}`
                },
                {
                  name: 'Êü•Áúã‰∏§‰∏™Êèê‰∫§‰πãÈó¥ÁöÑÊâÄÊúâÊèê‰∫§',
                  command: `git log --oneline ${sourceHash}...${targetHash}`
                }
              ];

              // ‰∏∫ÊØè‰∏™ÂëΩ‰ª§ÂàõÂª∫‰∏Ä‰∏™ÂèØÂ§çÂà∂ÁöÑÂå∫Âüü
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Â§çÂà∂';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = 'Â∑≤Â§çÂà∂';
                    setTimeout(() => {
                      copyBtn.textContent = 'Â§çÂà∂';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // Êèê‰æõVSCodeÁâπÂÆöÂª∫ËÆÆ
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code ‰ΩøÁî®ÊèêÁ§∫';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                'Âú®VS CodeÈõÜÊàêÁªàÁ´Ø‰∏≠ËøêË°å‰∏äËø∞ÂëΩ‰ª§‰ª•Êü•ÁúãÂ∑ÆÂºÇ',
                'GitLensÁî®Êà∑: ‰ΩøÁî®ÂëΩ‰ª§Èù¢Êùø(Ctrl/Cmd+Shift+P)ÊâßË°å"GitLens: Compare Commits"',
                'Git GraphÊâ©Â±ï: Êèê‰æõÂèØËßÜÂåñÊØîËæÉÁïåÈù¢ÔºåÊé®ËçêÂÆâË£Ö',
                'Â§çÂà∂Êèê‰∫§ÂìàÂ∏åÂêéÔºåÂèØ‰ª•Âú®VS CodeÁöÑÊ∫ê‰ª£Á†ÅÁÆ°ÁêÜËßÜÂõæ‰∏≠Âè≥ÈîÆÈÄâÊã©"Compare with Selected"'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
              const closeButton = document.createElement('button');
              closeButton.textContent = 'ÂÖ≥Èó≠';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // ÂÖ≥Èó≠Êó∂‰πüÂèØ‰ª•ÁÇπÂáªËÉåÊôØ
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // Êü•ÁúãÂçï‰∏™Êèê‰∫§ÁöÑÂèòÊõ¥ÂÜÖÂÆπÔºàÁ±ª‰ººgit showÔºâ
            function viewCommitChanges(commitHash, commitMessage) {
              console.log('Êü•ÁúãÊèê‰∫§ÂèòÊõ¥:', commitHash, commitMessage);

              // ‰øùÂ≠òÊµèËßà‰ΩçÁΩÆ
              savedScrollPosition = window.scrollY;

              // Á¶ÅÁî®bodyÊªöÂä®
              const originalBodyStyle = document.body.style.cssText;
              document.body.style.overflow = 'hidden';
              document.body.style.paddingRight = '15px'; // Èò≤Ê≠¢ÊªöÂä®Êù°Ê∂àÂ§±ÂØºËá¥È°µÈù¢ÊäñÂä®

              // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              // ÂàõÂª∫ÂÜÖÂÆπÂÆπÂô®
              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '90%';
              content.style.width = '90%';
              content.style.maxHeight = '90vh'; // Ê∑ªÂä†ÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂
              content.style.height = 'auto'; // È´òÂ∫¶Ëá™ÈÄÇÂ∫î
              content.style.display = 'flex';
              content.style.flexDirection = 'column';
              content.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';

              // Ê∑ªÂä†Ê†áÈ¢òÂíåÂ§¥ÈÉ®Âå∫Âüü
              const header = document.createElement('div');
              header.style.display = 'flex';
              header.style.justifyContent = 'space-between';
              header.style.alignItems = 'center';
              header.style.marginBottom = '10px';
              header.style.borderBottom = '1px solid #e1e4e8';
              header.style.paddingBottom = '10px';
              header.style.flexShrink = '0'; // Èò≤Ê≠¢Â§¥ÈÉ®Ë¢´ÂéãÁº©

              const titleArea = document.createElement('div');

              // Ê∑ªÂä†Ê†áÈ¢ò
              const title = document.createElement('h3');
              title.textContent = 'Êèê‰∫§ËØ¶ÊÉÖ';
              title.style.margin = '0 0 5px 0';
              title.style.fontSize = '18px';

              // Ê∑ªÂä†Êèê‰∫§‰ø°ÊÅØ
              const subtitle = document.createElement('p');
              subtitle.innerHTML = `<code style="font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace; background-color: #f1f1f1; padding: 2px 4px; border-radius: 3px;">${commitHash}</code> - ${commitMessage}`;
              subtitle.style.margin = '0';
              subtitle.style.color = '#586069';
              subtitle.style.fontSize = '14px';

              titleArea.appendChild(title);
              titleArea.appendChild(subtitle);

              // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆÂà∞Â§¥ÈÉ®
              const closeIcon = document.createElement('button');
              closeIcon.innerHTML = '&times;';
              closeIcon.style.background = 'none';
              closeIcon.style.border = 'none';
              closeIcon.style.fontSize = '24px';
              closeIcon.style.cursor = 'pointer';
              closeIcon.style.color = '#586069';
              closeIcon.style.width = '30px';
              closeIcon.style.height = '30px';
              closeIcon.style.lineHeight = '30px';
              closeIcon.style.textAlign = 'center';
              closeIcon.style.marginLeft = '15px';

              // ÂÖ≥Èó≠ÂºπÁ™óÂíåÊÅ¢Â§çÊªöÂä®
              const closeModal = () => {
                document.body.removeChild(modal);
                document.body.style.cssText = originalBodyStyle; // ÊÅ¢Â§çbodyÂéüÂßãÊ†∑Âºè
                document.removeEventListener('keydown', handleKeyDown);
              };

              closeIcon.addEventListener('click', closeModal);

              header.appendChild(titleArea);
              header.appendChild(closeIcon);

              content.appendChild(header);

              // Ê∑ªÂä†Â∑ÆÂºÇÊü•ÁúãÂô®ÂÆπÂô® - ÂèØÊªöÂä®ÈÉ®ÂàÜ
              const diffContainer = document.createElement('div');
              diffContainer.style.flex = '1';
              diffContainer.style.overflow = 'auto'; // Ëøô‰∏™ÂÆπÂô®ÂèØ‰ª•ÊªöÂä®
              diffContainer.style.minHeight = '0'; // Á°Æ‰øùflexÂ∏ÉÂ±ÄÊ≠£Â∏∏Â∑•‰Ωú
              diffContainer.style.maxHeight = 'calc(90vh - 150px)'; // ËÆæÁΩÆÊúÄÂ§ßÈ´òÂ∫¶ÔºåÂáèÂéªheaderÂíåpaddingÁöÑÈ´òÂ∫¶
              diffContainer.style.paddingRight = '5px'; // ÁªôÊªöÂä®Êù°ÁïôÂá∫Á©∫Èó¥

              // Ê∑ªÂä†Â∑ÆÂºÇÊü•ÁúãÂô®
              const diffViewer = document.createElement('div');
              diffViewer.className = 'diff-viewer';
              diffViewer.style.fontFamily = 'SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace';
              diffViewer.style.fontSize = '12px';
              diffViewer.style.lineHeight = '1.5';
              diffViewer.style.width = '100%';
              diffViewer.innerHTML = '<div style="padding: 20px; text-align: center; color: #586069;">Ê≠£Âú®Âä†ËΩΩÂèòÊõ¥Êï∞ÊçÆ...</div>';

              diffContainer.appendChild(diffViewer);
              content.appendChild(diffContainer);

              // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  closeModal();
                }
              });

              // Ê∑ªÂä†ESCÈîÆÁõò‰∫ã‰ª∂ÂÖ≥Èó≠ÂºπÁ™ó
              const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                  closeModal();
                }
              };

              document.addEventListener('keydown', handleKeyDown);

              modal.appendChild(content);
              document.body.appendChild(modal);

              // Ëé∑ÂèñGitÂ∑ÆÂºÇÊï∞ÊçÆ - ‰ΩøÁî®‰∏é‰øùÂ≠òÂ§áÊ≥®Áõ∏ÂêåÁöÑÊúçÂä°ÈÄö‰ø°ÊñπÂºè
              // Áõ¥Êé•‰ΩøÁî®Â∑≤ÂêØÂä®ÁöÑ3000Á´ØÂè£ÊúçÂä°
              fetch(`http://localhost:3000/git/show?hash=${encodeURIComponent(commitHash)}`, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                }
              })
              .then(response => {
                console.log('ÊúçÂä°Âô®ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                if (!response.ok) {
                  throw new Error(`ÊúçÂä°Âô®ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then(responseObj => {
                console.log('Ëé∑ÂèñÂà∞ÊúçÂä°Âô®ÂìçÂ∫î:', responseObj);

                // Ê£ÄÊü•ÂìçÂ∫îÊ†ºÂºè
                if (!responseObj.success) {
                  throw new Error(responseObj.message || 'ÊúçÂä°Âô®ËøîÂõûÈîôËØØ');
                }

                // Ëé∑ÂèñÊï∞ÊçÆÈÉ®ÂàÜ
                const data = responseObj.data;
                console.log('ÊèêÂèñÂìçÂ∫îÊï∞ÊçÆ:', data);

                // Ê∏≤ÊüìÂ∑ÆÂºÇÊï∞ÊçÆ
                renderDiffData(data, diffViewer);
              })
              .catch(error => {
                console.error('Ëé∑ÂèñÊèê‰∫§ÂèòÊõ¥Êï∞ÊçÆÂ§±Ë¥•:', error);
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #cb2431; background-color: #ffeef0; border-radius: 6px;">
                    <p style="margin: 0 0 10px 0;"><strong>Ëé∑ÂèñÊèê‰∫§ÂèòÊõ¥Êï∞ÊçÆÂ§±Ë¥•</strong></p>
                    <p style="margin: 0; font-size: 12px;">${error.message}</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px;">ËØ∑Á°Æ‰øùÊúçÂä°Âô®Â∑≤ÂêØÂä®Âπ∂ÊîØÊåÅËé∑ÂèñGitÂ∑ÆÂºÇÊï∞ÊçÆ„ÄÇ</p>
                  </div>
                `;
              });
            }

            // Ê∏≤ÊüìÂ∑ÆÂºÇÊï∞ÊçÆÂà∞Â∑ÆÂºÇÊü•ÁúãÂô® - GitHubÈ£éÊ†º
            function renderDiffData(data, diffViewer) {
              console.log('Ê∏≤ÊüìÂ∑ÆÂºÇÊï∞ÊçÆ:', data);

              if (!data || !data.diff || data.diff.trim() === '') {
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    Ê≠§Êèê‰∫§Ê≤°ÊúâÊñá‰ª∂ÂèòÊõ¥ÊàñÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ
                  </div>
                `;
                return;
              }

              // Ëß£ÊûêGitÂ∑ÆÂºÇÊï∞ÊçÆ
              const diffText = data.diff;

              // ÂàÜÂâ≤‰∏∫Êñá‰ª∂Âùó
              const fileBlocks = parseDiffToFileBlocks(diffText);

              // ÊûÑÂª∫GitHubÈ£éÊ†ºÁöÑÂ∑ÆÂºÇËßÜÂõæHTML
              let html = '';

              // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñá‰ª∂ÂèòÊõ¥
              if (fileBlocks.length === 0) {
                html = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    Ê≠§Êèê‰∫§Ê≤°ÊúâÊñá‰ª∂ÂèòÊõ¥
                  </div>
                `;
              } else {
                // ‰∏∫ÊØè‰∏™Êñá‰ª∂ÂùóÂàõÂª∫Â∑ÆÂºÇËßÜÂõæ
                fileBlocks.forEach(fileBlock => {
                  html += createGitHubStyleDiffHTML(fileBlock);
                });
              }

              diffViewer.innerHTML = html;
            }

            // Â∞ÜGitÂ∑ÆÂºÇÊñáÊú¨Ëß£Êûê‰∏∫Êñá‰ª∂Âùó
            function parseDiffToFileBlocks(diffText) {
              // ÂàÜÂâ≤‰∏∫Ë°å
              const lines = diffText.split('\n');
              const fileBlocks = [];
              let currentFile = null;
              let inFileHeader = false;
              let currentHunk = null;
              let currentHunkContent = [];

              // ÈÅçÂéÜÊØè‰∏ÄË°å
              lines.forEach(line => {
                // Ê£ÄÊµãÊñá‰ª∂Â§¥
                if (line.startsWith('diff --git ')) {
                  // Â¶ÇÊûúÂ∑≤ÁªèÊúâ‰∏Ä‰∏™ÂΩìÂâçÊñá‰ª∂ÔºåÂ∞ÜÂÖ∂Ê∑ªÂä†Âà∞Êñá‰ª∂ÂùóÂàóË°®
                  if (currentFile) {
                    if (currentHunk) {
                      currentFile.hunks.push({
                        header: currentHunk,
                        content: currentHunkContent
                      });
                    }
                    fileBlocks.push(currentFile);
                  }

                  // ÂºÄÂßãÊñ∞Êñá‰ª∂
                  currentFile = {
                    header: line,
                    path: extractFilePath(line),
                    hunks: []
                  };
                  inFileHeader = true;
                  currentHunk = null;
                  currentHunkContent = [];
                }
                // Ê£ÄÊµãÊñá‰ª∂Ë∑ØÂæÑÂèòÊõ¥‰ø°ÊÅØ
                else if (inFileHeader && (line.startsWith('--- ') || line.startsWith('+++ '))) {
                  if (currentFile) {
                    currentFile.header += '\n' + line;
                  }
                }
                // Ê£ÄÊµãÂ∑ÆÂºÇÂùóÂ§¥
                else if (line.startsWith('@@ ')) {
                  inFileHeader = false;
                  // Â¶ÇÊûúÂ∑≤ÁªèÊúâ‰∏Ä‰∏™ÂΩìÂâçÂ∑ÆÂºÇÂùóÔºåÂ∞ÜÂÖ∂Ê∑ªÂä†Âà∞ÂΩìÂâçÊñá‰ª∂ÁöÑÂ∑ÆÂºÇÂùóÂàóË°®
                  if (currentHunk && currentFile) {
                    currentFile.hunks.push({
                      header: currentHunk,
                      content: currentHunkContent
                    });
                  }

                  // ÂºÄÂßãÊñ∞Â∑ÆÂºÇÂùó
                  currentHunk = line;
                  currentHunkContent = [];
                }
                // ÂÖ∂‰ªñË°åÂ±û‰∫éÂΩìÂâçÂ∑ÆÂºÇÂùóÂÜÖÂÆπ
                else if (currentFile) {
                  if (inFileHeader) {
                    // ËøòÂú®Êñá‰ª∂Â§¥ÈÉ®
                    currentFile.header += '\n' + line;
                  } else if (currentHunk) {
                    // Â∑ÆÂºÇÂùóÂÜÖÂÆπ
                    currentHunkContent.push(line);
                  }
                }
              });

              // Ê∑ªÂä†ÊúÄÂêé‰∏Ä‰∏™Â∑ÆÂºÇÂùóÂíåÊñá‰ª∂
              if (currentFile && currentHunk) {
                currentFile.hunks.push({
                  header: currentHunk,
                  content: currentHunkContent
                });
                fileBlocks.push(currentFile);
              }

              return fileBlocks;
            }

            // ‰ªédiff --gitË°åÊèêÂèñÊñá‰ª∂Ë∑ØÂæÑ
            function extractFilePath(diffGitLine) {
              try {
                // Ê†ºÂºèÈÄöÂ∏∏ÊòØ "diff --git a/path/to/file b/path/to/file"
                const parts = diffGitLine.split(' ');
                if (parts.length >= 4) {
                  // Ëé∑Âèñb/path/to/fileÂπ∂ÁßªÈô§ÂºÄÂ§¥ÁöÑ"b/"
                  let path = parts[3];
                  if (path.startsWith('b/')) {
                    path = path.substring(2);
                  }
                  return path;
                }
              } catch (e) {
                console.error('ÊèêÂèñÊñá‰ª∂Ë∑ØÂæÑÂ§±Ë¥•:', e);
              }
              return 'unknown-file';
            }

            // ÂàõÂª∫GitHubÈ£éÊ†ºÁöÑÂ∑ÆÂºÇHTML
            function createGitHubStyleDiffHTML(fileBlock) {
              const filePath = fileBlock.path;
              const fileExtension = filePath.split('.').pop().toLowerCase();

              // ÊûÑÂª∫Êñá‰ª∂Â§¥HTML
              let html = `
                <div style="margin-bottom: 16px;">
                  <div style="background-color: #f6f8fa; border: 1px solid #e1e4e8; border-bottom: none; border-top-left-radius: 6px; border-top-right-radius: 6px; padding: 8px 16px; font-weight: 600;">
                    ${escapeHtml(filePath)}
                  </div>
              `;

              // Ê∑ªÂä†Êñá‰ª∂Â∑ÆÂºÇÂùó
              fileBlock.hunks.forEach(hunk => {
                html += `
                  <div style="background-color: #f8fafd; color: #586069; padding: 4px 10px; border: 1px solid #e1e4e8; border-bottom: none; font-size: 12px;">
                    ${escapeHtml(hunk.header)}
                  </div>
                  <div style="border: 1px solid #e1e4e8; border-bottom-left-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; border-bottom-right-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; overflow: hidden;">
                    <table style="border-collapse: collapse; width: 100%; tab-size: 4;">
                      <tbody>
        `;

                  // Ê∑ªÂä†Â∑ÆÂºÇË°å
                  hunk.content.forEach(line => {
                    let lineClass = '';
                    let lineStyle = '';
                    let prefix = '';

                    if (line.startsWith('+')) {
                      lineClass = 'addition';
                      lineStyle = 'background-color: #e6ffed;';
                      prefix = '+';
                    } else if (line.startsWith('-')) {
                      lineClass = 'deletion';
                      lineStyle = 'background-color: #ffeef0;';
                      prefix = '-';
                    } else {
                      lineClass = 'context';
                      lineStyle = '';
                      prefix = ' ';
                    }

                    const lineContent = line.substring(1); // ÁßªÈô§ÂâçÁºÄ

                    html += `
                      <tr class="${lineClass}" style="${lineStyle}">
                        <td style="width: 1%; padding: 0 10px; text-align: right; color: #bbb; border-right: 1px solid #e1e4e8; user-select: none;">${prefix}</td>
                        <td style="padding: 0 10px; white-space: pre-wrap; word-break: break-all;">${escapeHtml(lineContent)}</td>
                      </tr>
                    `;
                  });

                  html += `
                        </tbody>
                      </table>
                    </div>
                  `;
                });

                html += `</div>`;

                return html;
              }

              // ËΩ¨‰πâHTMLÁâπÊÆäÂ≠óÁ¨¶ÁöÑËæÖÂä©ÂáΩÊï∞
              function escapeHtml(str) {
                if (!str) return '';
                return str
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
              }
    </script>
  </body>
</html>
