<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      .header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .header h1 {
        margin: 0 0 10px 0;
        color: #333;
      }
      .meta-info {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
      }
      .branch-legend {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        padding: 5px 10px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .legend-icon {
        margin-right: 8px;
        font-size: 18px;
      }
      .timeline {
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 20px 0;
        max-width: 800px;
        margin: 0 auto;
      }
      .commit-row {
        display: flex;
        margin-bottom: 30px;
        position: relative;
        width: 100%;
      }
      .commit-container {
        max-width: 80%;
        position: relative;
      }
      .commit-container.source {
        align-self: flex-start;
        margin-right: auto;
      }
      .commit-container.target {
        align-self: flex-end;
        margin-left: auto;
      }
      .commit-container.both {
        align-self: center;
        max-width: 95%;
        margin: 0 auto;
      }
      .commit-container.both .commit {
        border-top: 4px solid #28a745;
        border-left: none;
        border-right: none;
        border-radius: 8px;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        background-color: #f0fff4;
      }
      .commit-container.both .commit.matched-by-message {
        background-color: #e6f7ff11;
        border-top: 4px solid #1890ff;
      }

      .commit {
        display: flex;
        flex-direction: column;
        padding: 20px 15px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .commit-container.source .commit {
        border-left: 4px solid #28a745; /* æ”¹ä¸ºç»¿è‰² */
        border-top-left-radius: 0;
        background-color: rgba(40, 167, 69, 0.05); /* æ·¡ç»¿è‰²èƒŒæ™¯ */
      }
      .commit-container.target .commit {
        border-right: 4px solid #ff9800; /* æ”¹ä¸ºæ©™è‰² */
        border-top-right-radius: 0;
        background-color: rgba(255, 152, 0, 0.05); /* æ·¡æ©™è‰²èƒŒæ™¯ */
      }
      .commit-badge {
        position: absolute;
        top: -10px;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 2;
      }
      .commit-container.source .commit-badge {
        left: 10px;
        background-color: #28a745; /* æ”¹ä¸ºç»¿è‰² */
      }
      .commit-container.target .commit-badge {
        right: 10px;
        background-color: #ff9800; /* æ”¹ä¸ºæ©™è‰² */
      }
      .commit-container.both .commit-badge {
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745;
        padding: 3px 15px;
      }
      .commit-container.both .commit-badge.message-matched {
        background-color: #1890ff !important;
      }
      .commit-time {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
        margin-top: 15px;
        display: flex;
        align-items: center;
      }
      .commit-container.source .commit-time {
        justify-content: flex-start;
      }
      .commit-container.target .commit-time {
        justify-content: flex-end;
      }
      .commit-container.both .commit-time {
        justify-content: center;
      }
      .commit-info {
        flex-grow: 1;
      }
      .commit-message {
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .commit-details {
        display: flex;
        flex-wrap: wrap;
        font-size: 13px;
        color: #666;
        gap: 8px;
        margin-bottom: 8px;
      }
      .commit-author {
        margin-right: 8px;
      }
      .commit-container.target .commit-details {
        justify-content: flex-end;
      }
      .commit-hash {
        font-family: monospace;
        cursor: pointer;
        background: #f1f1f1;
        padding: 2px 6px;
        border-radius: 3px;
        height: 20px;
        display: inline-flex;
        align-items: center;
      }
      .commit-hash:hover {
        background: #e1e4e8;
      }
      .commit-indicator {
        width: 50px;
        text-align: center;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ignore-button,
      .remark-button,
      .vscode-button,
      .view-changes-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        vertical-align: middle;
        margin: 0 4px;
      }
      .ignore-button,
      .remark-button {
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.8;
      }
      .ignore-button {
        background: #dc3545;
        color: white;
      }
      .remark-button {
        background: #0ea5e9 !important; /* ä½¿ç”¨å¤©è“è‰² */
        color: white;
      }
      .ignore-button:hover,
      .remark-button:hover {
        opacity: 1;
      }
      .remark-button {
        background: #17a2b8;
      }
      .ignored {
        opacity: 0.5;
        background: #f8f9fa;
      }
      /* .ignored::after {
        content: '(å·²å¿½ç•¥)';
        color: #dc3545;
        margin-left: 8px;
        font-size: 12px;
      } */
      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }
      .filter-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .filter-button {
        padding: 5px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }
      .sub-filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 10px 0;
        padding-left: 5px;
        transition: all 0.3s ease;
        max-height: 50px;
        overflow: hidden;
      }
      .sub-filter-section.hidden {
        max-height: 0;
        margin: 0;
        opacity: 0;
      }
      .filter-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .filter-checkbox input {
        margin-right: 5px;
      }
      .command-section {
        margin-top: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
      }
      .command-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .command-tab {
        padding: 5px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .command-tab.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }
      .command-content {
        display: none;
      }
      .command-content.active {
        display: block;
      }
      .command-content pre {
        background: #2d2d2d;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0;
      }
      .copy-button {
        background: #0366d6;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }
      .copy-button:hover {
        background: #0256b9;
      }
      .tooltip {
        position: fixed;
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }
      .success-toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 450px;
      }
      .modal h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: #333;
        font-size: 18px;
      }
      .reason-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
      }
      .reason-option {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 8px;
        position: relative;
      }
      .reason-option:hover {
        background: #f8f9fa;
        border-color: #aaa;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .reason-option.selected {
        background: #e3f2fd;
        border-color: #2196f3;
      }
      .reason-option input[type='radio'] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
      }
      .reason-option label {
        flex: 1;
        padding: 5px 0;
        cursor: pointer;
      }
      .custom-reason {
        display: none;
        margin-top: 16px;
      }
      .custom-reason.show {
        display: block;
      }
      .custom-reason input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
      }
      .modal-button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      .modal-button:hover {
        opacity: 0.9;
      }
      .modal-button.confirm {
        background: #2196f3;
        color: white;
      }
      .modal-button.cancel {
        background: #f1f1f1;
        color: #333;
      }
      .ignore-reason,
      .commit-remark {
        font-size: 13px;
        color: #666;
        margin: 8px 0 0 0;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 4px;
        line-height: 1.4;
      }

      /* .ignore-reason {
        border-left: 3px solid #dc3545;
      }

      .commit-remark {
        border-left: 3px solid #17a2b8;
      } */

      .ignore-reason-title,
      .commit-remark-title {
        font-weight: 500;
        color: #555;
        margin-right: 6px;
      }

      .ignore-reason-content,
      .commit-remark-content {
        display: block;
        margin-top: 4px;
        padding-left: 24px;
      }

      .remark-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .remark-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 80%;
        max-width: 420px;
        box-sizing: border-box;
      }
      .remark-modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: 500;
      }
      .remark-textarea {
        width: 100%;
        min-height: 120px;
        margin: 10px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        resize: vertical;
        font-size: 14px;
        line-height: 1.5;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #333;
      }
      .remark-textarea:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }
      .remark-modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
      }
      .remark-modal-button {
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 14px;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .remark-modal-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .remark-save {
        background: #28a745;
        color: white;
      }
      .remark-cancel {
        background: #f1f1f1;
        color: #333;
      }
      .remark-delete {
        background: #dc3545;
        color: white;
        margin-right: auto;
      }
      @media (max-width: 768px) {
        .commit {
          flex-direction: column;
        }
        .commit-time {
          width: 100%;
          margin-bottom: 10px;
        }
        .commit-indicator {
          width: 100%;
          margin-top: 10px;
        }
      }
      /* æ·»åŠ è¿”å›é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
      .back-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: #0366d6;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        font-size: 24px;
        z-index: 999;
      }

      .back-to-top.show {
        opacity: 1;
        visibility: visible;
      }

      .back-to-top:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* æ·»åŠ æ—¶é—´è½´å›¾ä¾‹æ ·å¼ */
      .timeline-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .timeline-legend .legend-item {
        display: flex;
        align-items: center;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        /* box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); */
      }

      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }

      .legend-dot.source {
        background-color: #28a745; /* æ”¹ä¸ºç»¿è‰² */
      }

      .legend-dot.target {
        background-color: #ff9800; /* æ”¹ä¸ºæ©™è‰² */
      }

      .legend-dot.both {
        background-color: #28a745;
      }

      /* å¯¹æäº¤å“ˆå¸Œçš„å±•ç¤ºå¢å¼ºï¼Œæ˜¾ç¤ºåŒåˆ†æ”¯å“ˆå¸Œ */
      .commit-hash-container {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .commit-hash-pair {
        display: flex;
        flex-direction: column;
        gap: 3px;
        background: #f5f5f5;
        padding: 5px;
        border-radius: 4px;
        margin-top: 5px;
      }

      .commit-hash-branch {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      /* å¯¹æ¯”åˆ†æ”¯æ ·å¼ */
      .commit-hash-branch:last-child {
        background-color: rgba(255, 152, 0, 0.1); /* æ·¡æ©™è‰²èƒŒæ™¯ */
        border: 1px solid rgba(255, 152, 0, 0.2);
      }

      .commit-hash-branch:last-child .branch-label {
        color: #ff9800; /* æ©™è‰²æ–‡å­— */
        font-weight: 600;
      }

      .branch-label {
        min-width: 100px;
        display: inline-block;
      }

      .commit-hash-pair {
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* Add styling for the theme switcher */
      .theme-switcher {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        border-radius: 24px;
        padding: 4px;
        margin-top: 10px;
      }

      .theme-button {
        border: none;
        background: none;
        color: #666;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .theme-button.active {
        background-color: #0366d6;
        color: white;
      }

      /* Add CSS for the flat layout */
      .timeline.flat-layout .commit-row {
        justify-content: center;
      }

      .timeline.flat-layout .commit-container {
        max-width: 90%;
        width: 90%;
        margin: 0 auto;
        align-self: center;
      }

      .timeline.flat-layout .commit-container.both {
        max-width: 90%;
      }

      .timeline.flat-layout .commit {
        display: flex;
        flex-direction: column;
      }

      .timeline.flat-layout .commit-indicator {
        position: absolute;
        left: 15px;
        top: 15px;
        font-size: 16px;
      }

      /* Add branch indicator for flat layout */
      .timeline.flat-layout .branch-indicator {
        position: absolute;
        top: 10px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .timeline.flat-layout .commit-container.source .branch-indicator {
        right: 10px; /* æ”¹ä¸ºright */
        left: auto; /* æ¸…é™¤left */
        background-color: #28a745;
      }

      .timeline.flat-layout .commit-container.target .branch-indicator {
        left: 10px;
        background-color: #ff9800;
      }

      .timeline.flat-layout .commit-container.both .branch-indicator {
        background: linear-gradient(135deg, #28a745 50%, #ff9800 50%); /* æ”¹ä¸ºç»¿è‰²å’Œæ©™è‰² */
      }

      /* Adjust content padding in flat layout */
      .timeline.flat-layout .commit-time,
      .timeline.flat-layout .commit-info {
        padding-left: 25px;
      }

      /* Add styling for the search box */
      .search-section {
        margin-top: 10px;
        padding: 0 5px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .search-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .search-checkbox {
        display: flex;
        align-items: center;
        margin-right: 10px;
      }

      .search-checkbox label {
        margin-left: 5px;
        font-size: 13px;
        color: #666;
      }

      .highlight {
        background-color: #ffffc0;
        border-radius: 2px;
        padding: 0 2px;
      }

      /* Add a clear button for the search input */
      .search-container {
        position: relative;
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      /* Set width for search input to make room for checkboxes */
      .search-container .search-input {
        width: calc(100% - 320px);
        margin-bottom: 0;
        margin-right: 10px;
      }

      /* Place checkboxes on the same line */
      .search-container .search-options {
        flex: 1;
        margin: 0;
        justify-content: flex-end;
      }

      .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #999;
        cursor: pointer;
        font-size: 16px;
        display: none;
      }

      .clear-search.visible {
        display: block;
      }

      /* Add VS Code icon button styles */
      .vscode-button {
        width: 20px;
        background: #0066b8;
        color: white;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        padding: 0;
      }

      .vscode-button:hover {
        background: #005ca3;
        transform: translateY(-1px);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
      }

      .vscode-button svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* Add tooltip for VS Code buttons */
      .vscode-button::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 8px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .vscode-button:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: calc(100% + 5px);
      }

      /* Add style for compare buttons for matched commits */
      .compare-in-vscode {
        background: #0066b8;
        color: white;
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 5px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .compare-in-vscode:hover {
        background: #005ca3;
        transform: translateY(-1px);
      }

      .compare-in-vscode svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* æŸ¥çœ‹æäº¤å˜æ›´æŒ‰é’®æ ·å¼ */
      .view-changes-btn {
        padding: 2px 8px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        color: #333;
      }

      .view-changes-btn:hover {
        background-color: #e0e0e0;
      }

      /* å·®å¼‚æŸ¥çœ‹å™¨æ ·å¼ */
      .diff-viewer {
        width: 100%;
        max-height: 80vh;
        overflow: auto;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
        line-height: 1.5;
        margin-top: 15px;
      }

      .diff-file {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }

      .diff-file-header {
        background-color: #f1f1f1;
        padding: 10px;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
      }

      .diff-hunk-header {
        background-color: #e8eaed;
        padding: 5px 10px;
        color: #666;
        border-bottom: 1px solid #ddd;
      }

      .diff-line {
        padding: 0 5px;
        white-space: pre;
      }

      .diff-line-addition {
        background-color: #e6ffed;
        border-left: 4px solid #34d058;
      }

      .diff-line-deletion {
        background-color: #ffeef0;
        border-left: 4px solid #d73a49;
      }

      .diff-line-context {
        background-color: #fff;
        border-left: 4px solid transparent;
      }

      .diff-line-num {
        display: inline-block;
        width: 40px;
        color: #999;
        text-align: right;
        padding-right: 10px;
        user-select: none;
      }

      .diff-empty-msg {
        padding: 20px;
        color: #666;
        text-align: center;
      }

      .diff-stats {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
        font-size: 14px;
      }

      .diff-stats-additions {
        color: #28a745;
        margin-right: 15px;
      }

      .diff-stats-deletions {
        color: #d73a49;
      }

      .diff-loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* ä¿®æ”¹å…±åŒæäº¤çš„æŒ‰é’®å¸ƒå±€ */
      .commit-container.both .commit-details {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* è°ƒæ•´æŒ‰é’®æ ·å¼ï¼Œè®©å®ƒä»¬åœ¨åŒä¸€è¡Œ */
      .ignore-button,
      .remark-button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        margin: 0;
        opacity: 0.8;
        display: inline-flex;
        align-items: center;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <!-- æ·»åŠ å¿½ç•¥åŸå› é€‰æ‹©å¼¹çª— -->
    <div id="ignoreModal" class="modal">
      <div class="modal-content">
        <h3>é€‰æ‹©å¿½ç•¥åŸå› </h3>
        <div class="reason-list" id="reasonList">
          <!-- åŸå› é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
        </div>
        <div id="customReasonInput" class="custom-reason">
          <input type="text" placeholder="è¯·è¾“å…¥å¿½ç•¥åŸå› " id="customReasonText" />
        </div>
        <div class="modal-buttons">
          <button class="modal-button cancel" onclick="closeIgnoreModal()">å–æ¶ˆ</button>
          <button class="modal-button confirm" onclick="confirmIgnore()">ç¡®è®¤</button>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¤‡æ³¨å¼¹çª— -->
    <div id="remarkModal" class="remark-modal">
      <div class="remark-modal-content">
        <h3>ç¼–è¾‘å¤‡æ³¨</h3>
        <textarea id="remarkText" class="remark-textarea" placeholder="è¯·è¾“å…¥å¤‡æ³¨å†…å®¹..."></textarea>
        <div class="remark-modal-buttons">
          <button class="remark-modal-button remark-delete" id="deleteRemarkBtn" onclick="deleteRemark()">åˆ é™¤å¤‡æ³¨</button>
          <button class="remark-modal-button remark-cancel" onclick="closeRemarkModal()">å–æ¶ˆ</button>
          <button class="remark-modal-button remark-save" onclick="confirmRemark()">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ loadingè¦†ç›–å±‚ -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- æ·»åŠ è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <div id="backToTop" class="back-to-top">â†‘</div>

    <div class="container">
      <div class="header">
        <div>
          <h1>åˆ†æ”¯æäº¤å¯¹æ¯”</h1>
          <div class="meta-info">
            <div>ç”Ÿæˆæ—¶é—´: {{generatedTime}}</div>
            <div id="authorInfo" style="display: none">æäº¤è€…: {{author}}</div>
            <div id="timeRangeInfo" style="display: none">æ—¶é—´èŒƒå›´: {{timeRange}}</div>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="legend-item"><span class="legend-dot source"></span> {{sourceBranch}} (åŸºå‡†åˆ†æ”¯)</div>
          <div class="legend-item"><span class="legend-dot target"></span> {{targetBranch}}</div>
          <div class="legend-item"><span class="legend-dot both" style="background-color: #1890ff"></span> æ¶ˆæ¯ç›¸åŒçš„å…±åŒæäº¤</div>
        </div>

        <div class="theme-switcher">
          <button id="chatLayoutBtn" class="theme-button active" onclick="switchLayout('chat')">
            <span>èŠå¤©å¸ƒå±€</span>
            <span class="layout-icon">ğŸ’¬</span>
          </button>
          <button id="flatLayoutBtn" class="theme-button" onclick="switchLayout('flat')">
            <span>åˆ—è¡¨å¸ƒå±€</span>
            <span class="layout-icon">ğŸ“‘</span>
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-buttons">
          <button class="filter-button active" data-filter="all" onclick="filterCommits('all')">å…¨éƒ¨æäº¤</button>
          <button class="filter-button" data-filter="source" onclick="filterCommits('source')">ä»…{{sourceBranch}}åˆ†æ”¯</button>
          <button class="filter-button" data-filter="target" onclick="filterCommits('target')">ä»…{{targetBranch}}åˆ†æ”¯</button>
          <button class="filter-button" data-filter="common" onclick="filterCommits('common')">å…±åŒæäº¤</button>
          <button class="filter-button" data-filter="ignored" onclick="filterCommits('ignored')">å·²å¿½ç•¥æäº¤</button>
        </div>

        <div class="sub-filter-section" id="subFilterSection">
          <label class="filter-checkbox">
            <input type="checkbox" id="hideIgnoredCommits" checked onchange="applySubFilters()" />
            <span>éšè—å·²å¿½ç•¥æäº¤</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="hideCommonCommits" onchange="applySubFilters()" />
            <span>éšè—å…±åŒæäº¤</span>
          </label>
        </div>

        <div class="search-section">
          <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æäº¤ä¿¡æ¯ã€ä½œè€…æˆ–å“ˆå¸Œ..." oninput="searchCommits()" />
            <button class="clear-search" id="clearSearch" onclick="clearSearch()">âœ•</button>
            <div class="search-options">
              <label class="search-checkbox">
                <input type="checkbox" id="searchMessage" checked onchange="searchCommits()" />
                <span>æäº¤ä¿¡æ¯</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchAuthor" checked onchange="searchCommits()" />
                <span>ä½œè€…</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchHash" onchange="searchCommits()" />
                <span>å“ˆå¸Œ</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="timeline" id="timeline"></div>

      <div class="command-section">
        <div class="command-tabs">
          <button class="command-tab active" data-command="basic" onclick="switchCommandTab('basic')">åŸºç¡€å‘½ä»¤</button>
          <button class="command-tab" data-command="optimized" onclick="switchCommandTab('optimized')">ä¼˜åŒ–å‘½ä»¤</button>
        </div>

        <div id="basic-content" class="command-content active">
          <h3>
            Cherry-pick åŸºç¡€æŒ‡ä»¤
            <button class="copy-button copy-basic-button" onclick="copyCommandBlock('basic')">å¤åˆ¶å…¨éƒ¨</button>
          </h3>
          <pre><code id="basic-commands"></code></pre>
        </div>

        <div id="optimized-content" class="command-content">
          <h3>
            Cherry-pick ä¼˜åŒ–æŒ‡ä»¤
            <button class="copy-button copy-optimized-button" onclick="copyCommandBlock('optimized')">å¤åˆ¶å…¨éƒ¨</button>
          </h3>
          <pre><code id="optimized-commands"></code></pre>
        </div>
      </div>
    </div>

    <script>
            // Create a global variable to track current filter state correctly placed at the top
            // Create a global variable at the beginning of the script
            let currentFilterState = {
              mainFilter: 'all',
              hideIgnored: true,
              hideCommon: false,
              searchText: '',
              searchMessage: true,
              searchAuthor: true,
              searchHash: false
            };

      // åˆå§‹åŒ–æ•°æ®
      const commits = {{commits}};
      const sourceBranch = {{sourceBranch}};
      const targetBranch = {{targetBranch}};
      let ignoredCommits = {{ignoredCommits}} || [];  // ç¡®ä¿æœ‰é»˜è®¤å€¼

      // ç¡®ä¿å¤‡æ³¨æ•°æ®æ˜¯æ•°ç»„æ ¼å¼
      let commitRemarks = [];
      try {
        const rawRemarks = {{commitRemarks}};
        if (Array.isArray(rawRemarks)) {
          // å·²ç»æ˜¯æ•°ç»„æ ¼å¼
          commitRemarks = rawRemarks;
          console.log('åˆå§‹åŒ–: å¤‡æ³¨æ•°æ®å·²ç»æ˜¯æ•°ç»„æ ¼å¼, æ¡æ•°:', commitRemarks.length);
        } else if (typeof rawRemarks === 'object' && rawRemarks !== null) {
          // è½¬æ¢å¯¹è±¡æ ¼å¼ä¸ºæ•°ç»„
          for (const hash in rawRemarks) {
            commitRemarks.push({
              hash: hash,
              content: rawRemarks[hash],
              timestamp: new Date().toISOString()
            });
          }
          console.log('åˆå§‹åŒ–: å·²å°†å¯¹è±¡æ ¼å¼å¤‡æ³¨è½¬æ¢ä¸ºæ•°ç»„, æ¡æ•°:', commitRemarks.length);
        } else {
          console.warn('åˆå§‹åŒ–: æ— æ•ˆçš„å¤‡æ³¨æ•°æ®æ ¼å¼, ä½¿ç”¨ç©ºæ•°ç»„');
        }
      } catch (e) {
        console.error('åˆå§‹åŒ–å¤‡æ³¨æ•°æ®æ—¶å‡ºé”™:', e);
      }

      const author = {{author}};
      const timeRange = {{timeRange}};

      // å¿½ç•¥åŸå› é€‰é¡¹
      const IGNORE_REASONS = [
        'å·²æ‰‹åŠ¨åˆå¹¶',
        'ä¸éœ€è¦åˆå¹¶',
        'å­˜åœ¨å†²çª',
        'å¾…è¿›ä¸€æ­¥ç¡®è®¤',
        'å…¶ä»–åŸå› '
      ];

      let currentIgnoreHash = null;
      let currentIgnoreElement = null;
      let currentCommitHash = null;

      // é¡µé¢åŠ è½½æ—¶è·å–æœ€æ–°çš„å·²å¿½ç•¥æäº¤å’Œå¤‡æ³¨
      async function loadIgnoredCommits() {
        console.log('æ­£åœ¨åŠ è½½å·²å¿½ç•¥æäº¤å’Œå¤‡æ³¨æ•°æ®...');
        try {
          // å•ç‹¬å¤„ç†æ¯ä¸ªè¯·æ±‚ï¼Œé¿å…ä¸€ä¸ªå¤±è´¥å½±å“å¦ä¸€ä¸ª
          try {
            const ignoreResponse = await fetch('http://localhost:3000/ignored-commits');
            if (ignoreResponse.ok) {
              const ignoreData = await ignoreResponse.json();
              if (Array.isArray(ignoreData.ignoredCommits)) {
                ignoredCommits = ignoreData.ignoredCommits;
                console.log('å·²å¿½ç•¥æäº¤åŠ è½½æˆåŠŸ, æ•°é‡:', ignoredCommits.length);
              }
            } else {
              console.error('åŠ è½½å·²å¿½ç•¥æäº¤å¤±è´¥:', ignoreResponse.status);
            }
          } catch (ignoreError) {
            console.error('è·å–å·²å¿½ç•¥æäº¤å‡ºé”™:', ignoreError);
          }

          // åŠ è½½å¤‡æ³¨æ•°æ®
          try {
            console.log('å¼€å§‹åŠ è½½å¤‡æ³¨æ•°æ®...');
            const remarkResponse = await fetch('http://localhost:3000/commit-remarks');
            if (remarkResponse.ok) {
              const remarkData = await remarkResponse.json();
              console.log('æ”¶åˆ°å¤‡æ³¨æ•°æ®å“åº”:', remarkData);

              if (remarkData.commitRemarks) {
                if (Array.isArray(remarkData.commitRemarks)) {
                  commitRemarks = remarkData.commitRemarks;
                  console.log('å¤‡æ³¨æ•°æ®åŠ è½½æˆåŠŸ(æ•°ç»„æ ¼å¼), æ•°é‡:', commitRemarks.length);

                  if (commitRemarks.length > 0) {
                    console.log('å¤‡æ³¨å†…å®¹ç¤ºä¾‹:');
                    commitRemarks.slice(0, 3).forEach((remark) => {
                      console.log(`- å“ˆå¸Œ: ${remark.hash}, å†…å®¹: ${remark.content}`);
                    });
                  }
                } else {
                  console.warn('æœåŠ¡å™¨è¿”å›çš„å¤‡æ³¨ä¸æ˜¯æ•°ç»„æ ¼å¼, æ­£åœ¨è½¬æ¢...');
                  const tempArray = [];
                  for (const hash in remarkData.commitRemarks) {
                    tempArray.push({
                      hash: hash,
                      content: remarkData.commitRemarks[hash],
                      timestamp: new Date().toISOString()
                    });
                  }
                  commitRemarks = tempArray;
                  console.log('å¯¹è±¡æ ¼å¼å¤‡æ³¨è½¬æ¢ä¸ºæ•°ç»„æˆåŠŸ, æ•°é‡:', commitRemarks.length);
                }
              } else {
                console.warn('æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰commitRemarkså­—æ®µ');
              }
            } else {
              console.error('åŠ è½½å¤‡æ³¨æ•°æ®å¤±è´¥:', remarkResponse.status);
            }
          } catch (remarkError) {
            console.error('è·å–å¤‡æ³¨å‡ºé”™:', remarkError);
          }

          // é‡æ–°æ¸²æŸ“æäº¤åˆ—è¡¨
                renderCommits(false); // Don't save filter state on initial load
          console.log('æäº¤åˆ—è¡¨æ¸²æŸ“å®Œæˆ');

                // Initialize filter state after data is loaded
                initializeFilterState();
        } catch (error) {
          console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
          // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åˆå§‹æ•°æ®
                renderCommits(false);
        }
      }

      // æ˜¾ç¤ºä½œè€…å’Œæ—¶é—´èŒƒå›´ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
      if (author) {
        document.getElementById('authorInfo').style.display = 'block';
      }
      if (timeRange) {
        document.getElementById('timeRangeInfo').style.display = 'block';
      }

      // æ˜¾ç¤ºå¿½ç•¥åŸå› é€‰æ‹©å¼¹çª—
      function showIgnoreModal(hash, element) {
        currentIgnoreHash = hash;
        currentIgnoreElement = element;

              // ç”Ÿæˆå¿½ç•¥åŸå› é€‰é¡¹
              const reasonListElement = document.getElementById('reasonList');
              reasonListElement.innerHTML = '';

              IGNORE_REASONS.forEach((reason, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'reason-option';

                // åˆ›å»ºradioè¾“å…¥
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `reason-${index}`;
                radioInput.name = 'ignoreReason';
                radioInput.value = reason;
                if (index === 0) {
                  radioInput.checked = true;
                }

                // åˆ›å»ºlabel
                const label = document.createElement('label');
                label.htmlFor = `reason-${index}`;
                label.textContent = reason;

                // æ·»åŠ åˆ°é€‰é¡¹å…ƒç´ 
                optionElement.appendChild(radioInput);
                optionElement.appendChild(label);

                // ä½¿æ•´ä¸ªé€‰é¡¹å¯ç‚¹å‡»
                optionElement.addEventListener('click', function(e) {
                  if (e.target !== radioInput) {
                    radioInput.checked = true;

                    // å¤„ç†è‡ªå®šä¹‰åŸå› è¾“å…¥æ¡†æ˜¾ç¤ºé€»è¾‘
                    if (reason === 'å…¶ä»–åŸå› ') {
                      document.getElementById('customReasonInput').classList.add('show');
                    } else {
                      document.getElementById('customReasonInput').classList.remove('show');
                    }

                    // æ›´æ–°é€‰ä¸­æ ·å¼
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                  }
                });

                // ç‰¹æ®Šå¤„ç†è‡ªå®šä¹‰åŸå› é€‰é¡¹
                if (reason === 'å…¶ä»–åŸå› ') {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.add('show');
                    // æ›´æ–°é€‰ä¸­æ ·å¼
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                } else {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.remove('show');
                    // æ›´æ–°é€‰ä¸­æ ·å¼
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                }

                reasonListElement.appendChild(optionElement);
              });

              // é‡ç½®è‡ªå®šä¹‰åŸå› è¾“å…¥æ¡†
              document.getElementById('customReasonText').value = '';
              document.getElementById('customReasonInput').classList.remove('show');

              // æ˜¾ç¤ºå¼¹çª—
              document.getElementById('ignoreModal').style.display = 'block';
      }

      // è·å–å¤‡æ³¨å†…å®¹
      function getRemarkContent(hash) {
        const remark = commitRemarks.find(r => r.hash === hash);
        return remark ? remark.content : '';
      }

      // åˆ¤æ–­æ˜¯å¦æœ‰å¤‡æ³¨
      function hasRemark(hash) {
        return commitRemarks.some(r => r.hash === hash);
      }

            // è·å–æäº¤çš„å¤‡æ³¨å¯¹è±¡
            function getCommitRemark(hash) {
              return commitRemarks.find(r => r.hash === hash);
      }

      // ä¿å­˜å¤‡æ³¨åˆ°æœåŠ¡å™¨
      async function saveCommitRemarks() {
        try {
          console.log('å‡†å¤‡ä¿å­˜å¤‡æ³¨æ•°æ®, å¤‡æ³¨æ€»æ•°:', commitRemarks.length);

          // ç¡®ä¿commitRemarksæ˜¯æ•°ç»„
          if (!Array.isArray(commitRemarks)) {
            console.error('ERROR: commitRemarksä¸æ˜¯æ•°ç»„!', typeof commitRemarks, commitRemarks);
                  // é‡ç½®ä¸ºç©ºæ•°ç»„
                  commitRemarks = [];
                  console.warn('å·²å°†commitRemarksé‡ç½®ä¸ºç©ºæ•°ç»„');
                }

                // éªŒè¯å¹¶æ¸…ç†å¤‡æ³¨æ•°æ®
                const validRemarks = commitRemarks.filter(remark =>
                  remark &&
                  remark.hash &&
                  typeof remark.hash === 'string' &&
                  remark.hash.trim().length > 0
                );

                if (validRemarks.length !== commitRemarks.length) {
                  console.warn(`è¿‡æ»¤äº† ${commitRemarks.length - validRemarks.length} æ¡æ— æ•ˆå¤‡æ³¨`);
                  commitRemarks = validRemarks;
                }

                // æ‰“å°å¤‡æ³¨å†…å®¹
          if (commitRemarks.length === 0) {
            console.log('æ²¡æœ‰å¤‡æ³¨éœ€è¦ä¿å­˜');
          } else {
                  console.log('å¤‡æ³¨è¯¦æƒ…:');
            for (const remark of commitRemarks) {
                    console.log(`- å“ˆå¸Œ: ${remark.hash}, å†…å®¹: ${remark.content || '(æ— å†…å®¹)'}`);
            }
          }

          console.log('å‘é€POSTè¯·æ±‚åˆ°/commit-remarks...');
          const postData = { commitRemarks: commitRemarks };
                console.log('POSTæ•°æ®æ ¼å¼æ£€æŸ¥:',
                  'æ˜¯æ•°ç»„:', Array.isArray(commitRemarks),
                  'é•¿åº¦:', commitRemarks.length);

                // æ·»åŠ é‡è¯•é€»è¾‘
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;
                let lastError = null;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
          const response = await fetch('http://localhost:3000/commit-remarks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(postData),
                      cache: 'no-cache' // ç¦ç”¨ç¼“å­˜
          });

          if (!response.ok) {
            const errorText = await response.text();
                      console.error(`å°è¯• ${attempts}/${maxAttempts} å¤±è´¥:`, response.status, errorText);
                      lastError = new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);

                      if (attempts < maxAttempts) {
                        // å»¶è¿Ÿä¸€ç‚¹å†é‡è¯•
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      } else {
                        throw lastError;
                      }
          }

          // è¯»å–å“åº”
          const data = await response.json();
          console.log('æœåŠ¡å™¨ä¿å­˜å¤‡æ³¨æˆåŠŸ, å“åº”:', data);

          if (data.count) {
            console.log(`æœåŠ¡å™¨ç¡®è®¤ä¿å­˜äº† ${data.count} æ¡å¤‡æ³¨`);
          }

                    success = true;

          // é‡æ–°è·å–æœ€æ–°å¤‡æ³¨
          console.log('æ­£åœ¨é‡æ–°åŠ è½½æœ€æ–°å¤‡æ³¨...');
          await loadLatestRemarks();

          return data;
                  } catch (attemptError) {
                    console.error(`å°è¯• ${attempts}/${maxAttempts} å‡ºé”™:`, attemptError);
                    lastError = attemptError;

                    // å»¶è¿Ÿä¸€ç‚¹å†é‡è¯•
                    if (attempts < maxAttempts) {
                      await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                    }
                  }
                }

                if (!success && lastError) {
                  console.error('ä¿å­˜å¤‡æ³¨å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                  alert('ä¿å­˜å¤‡æ³¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
                  throw lastError;
                }

                return null;
        } catch (error) {
          console.error('ä¿å­˜å¤‡æ³¨å¤±è´¥:', error);
                alert('ä¿å­˜å¤‡æ³¨å¤±è´¥: ' + error.message);
          throw error;
        }
      }

      // å•ç‹¬åŠ è½½æœ€æ–°å¤‡æ³¨
      async function loadLatestRemarks() {
        try {
          console.log('å¼€å§‹åŠ è½½æœ€æ–°å¤‡æ³¨...');

                // æ·»åŠ é‡è¯•é€»è¾‘
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
                    const response = await fetch('http://localhost:3000/commit-remarks', {
                      cache: 'no-store', // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜
                      headers: {
                        'X-Requested-With': 'fetch',
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                      }
                    });

          if (!response.ok) {
                      console.error(`åŠ è½½å¤‡æ³¨å°è¯• ${attempts}/${maxAttempts} å¤±è´¥:`, response.status);
                      if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      }
                      throw new Error(`æ— æ³•è·å–å¤‡æ³¨: ${response.status} ${response.statusText}`);
                    }

                    // è§£æå“åº”æ•°æ®
          const data = await response.json();
                    console.log('è·å–å¤‡æ³¨å“åº”:', data);

                    // å¤„ç†å¤‡æ³¨æ•°æ®
          if (data.commitRemarks) {
            // ç¡®ä¿commitRemarksæ˜¯æ•°ç»„
            if (Array.isArray(data.commitRemarks)) {
              commitRemarks = data.commitRemarks;
              console.log('åˆ·æ–°å¤‡æ³¨æ•°æ®æˆåŠŸ, æ•°ç»„é•¿åº¦:', commitRemarks.length);
                        if (commitRemarks.length > 0) {
                          console.log('å¤‡æ³¨å†…å®¹ç¤ºä¾‹:');
                          for (let i = 0; i < Math.min(3, commitRemarks.length); i++) {
                            const remark = commitRemarks[i];
                            console.log(`- å“ˆå¸Œ: ${remark.hash}, å†…å®¹: ${remark.content || '(æ— å†…å®¹)'}`);
                          }
              }
            } else {
              console.error('æœåŠ¡å™¨è¿”å›çš„å¤‡æ³¨ä¸æ˜¯æ•°ç»„æ ¼å¼!', data.commitRemarks);

                        if (typeof data.commitRemarks === 'object' && data.commitRemarks !== null) {
                const tempArray = [];
                for (const hash in data.commitRemarks) {
                            if (Object.prototype.hasOwnProperty.call(data.commitRemarks, hash)) {
                  tempArray.push({
                    hash: hash,
                                content: data.commitRemarks[hash] || '',
                    timestamp: new Date().toISOString()
                  });
                            }
                }
                commitRemarks = tempArray;
                console.log('å·²è½¬æ¢å¯¹è±¡æ ¼å¼ä¸ºæ•°ç»„, é•¿åº¦:', commitRemarks.length);
                        } else {
                          console.warn('æœåŠ¡å™¨è¿”å›äº†æ— æ³•å¤„ç†çš„å¤‡æ³¨æ ¼å¼ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                          commitRemarks = [];
              }
            }
          } else {
            console.warn('æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰commitRemarkså­—æ®µ');
                      commitRemarks = [];
                    }

                    // æ›´æ–°UI
                    updateAllRemarkUI();

                    success = true;
                    return true;
                  } catch (attemptError) {
                    console.error(`åŠ è½½å¤‡æ³¨å°è¯• ${attempts}/${maxAttempts} å‡ºé”™:`, attemptError);
                    if (attempts >= maxAttempts) {
                      throw attemptError;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                  }
                }

                if (!success) {
                  console.error('åŠ è½½å¤‡æ³¨å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                  return false;
                }

          return true;
        } catch (error) {
                console.error('åŠ è½½å¤‡æ³¨å¤±è´¥:', error);
          return false;
        }
      }

      // æ˜¾ç¤ºå¤‡æ³¨å¼¹çª—
      function showRemarkModal(hash, element) {
        currentCommitHash = hash;
        currentCommitElement = element;

        const remarkText = document.getElementById('remarkText');
        remarkText.value = getRemarkContent(hash);

              // æ ¹æ®æ˜¯å¦æœ‰å¤‡æ³¨å†³å®šæ˜¯å¦æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
              const deleteButton = document.getElementById('deleteRemarkBtn');
              if (hasRemark(hash)) {
                deleteButton.style.display = 'block';
              } else {
                deleteButton.style.display = 'none';
              }

        document.getElementById('remarkModal').style.display = 'block';
      }

      // å…³é—­å¤‡æ³¨å¼¹çª—
      function closeRemarkModal() {
        document.getElementById('remarkModal').style.display = 'none';
        currentCommitHash = null;
        currentCommitElement = null;
      }

            // æ·»åŠ æ˜¾ç¤ºå’Œéšè—loadingçš„å‡½æ•°
            function showLoading() {
              document.getElementById('loadingOverlay').classList.add('show');
            }

            function hideLoading() {
              document.getElementById('loadingOverlay').classList.remove('show');
            }

            // ä¿®æ”¹ç¡®è®¤å¤‡æ³¨å‡½æ•°ï¼Œæ·»åŠ loading
      async function confirmRemark() {
        const remarkText = document.getElementById('remarkText').value.trim();
        console.log('å¼€å§‹ä¿å­˜å¤‡æ³¨ï¼Œå“ˆå¸Œå€¼:', currentCommitHash, 'å†…å®¹:', remarkText);

        try {
                showLoading(); // æ˜¾ç¤ºloading

                // Save current filter state before operation
                saveCurrentFilterState();

          // æŸ¥æ‰¾ç°æœ‰å¤‡æ³¨
          const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

          if (remarkText) {
            // æœ‰å¤‡æ³¨å†…å®¹åˆ™æ›´æ–°æˆ–æ·»åŠ 
            if (existingIndex >= 0) {
              // æ›´æ–°ç°æœ‰å¤‡æ³¨
              commitRemarks[existingIndex].content = remarkText;
              commitRemarks[existingIndex].timestamp = new Date().toISOString();
              console.log('å·²æ›´æ–°ç°æœ‰å¤‡æ³¨');
            } else {
              // æ·»åŠ æ–°å¤‡æ³¨
              commitRemarks.push({
                hash: currentCommitHash,
                content: remarkText,
                timestamp: new Date().toISOString()
              });
              console.log('å·²æ·»åŠ æ–°å¤‡æ³¨');
            }
            console.log('å½“å‰å¤‡æ³¨æ€»æ•°:', commitRemarks.length);
          } else if (existingIndex >= 0) {
            // æ— å¤‡æ³¨å†…å®¹ä¸”å­˜åœ¨å¤‡æ³¨åˆ™åˆ é™¤
            commitRemarks.splice(existingIndex, 1);
            console.log('å·²åˆ é™¤å¤‡æ³¨');
          }

          // ä¿å­˜å¤‡æ³¨åˆ°æœåŠ¡å™¨
          console.log('æ­£åœ¨å‘æœåŠ¡å™¨ä¿å­˜æ‰€æœ‰å¤‡æ³¨...');
          await saveCommitRemarks();
          console.log('æœåŠ¡å™¨ä¿å­˜å¤‡æ³¨å®Œæˆ');

          // å…³é—­å¤‡æ³¨å¼¹çª—
          closeRemarkModal();

          // é‡æ–°æ¸²æŸ“æäº¤åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°å¤‡æ³¨
          renderCommits();
          console.log('æäº¤åˆ—è¡¨é‡æ–°æ¸²æŸ“å®Œæˆ');

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccessMessage('å¤‡æ³¨å·²ä¿å­˜');
        } catch (error) {
          console.error('ä¿å­˜å¤‡æ³¨æ“ä½œå¤±è´¥:', error);
          alert('ä¿å­˜å¤‡æ³¨å¤±è´¥: ' + error.message);
              } finally {
                hideLoading(); // éšè—loading
              }
            }

            // ä¿®æ”¹åˆ é™¤å¤‡æ³¨å‡½æ•°ï¼Œæ·»åŠ loading
            async function deleteRemark() {
              if (!currentCommitHash) return;

              try {
                showLoading(); // æ˜¾ç¤ºloading

                // Save current filter state before operation
                saveCurrentFilterState();

                // æŸ¥æ‰¾ç°æœ‰å¤‡æ³¨
                const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

                if (existingIndex >= 0) {
                  // ä»æ•°ç»„ä¸­åˆ é™¤å¤‡æ³¨
                  commitRemarks.splice(existingIndex, 1);
                  console.log('å·²åˆ é™¤å¤‡æ³¨');

                  // ä¿å­˜åˆ°æœåŠ¡å™¨
                  await saveCommitRemarks();

                  // æ›´æ–°UI
                  closeRemarkModal();
                  renderCommits();

                  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                  showSuccessMessage('å¤‡æ³¨å·²åˆ é™¤');
                }
              } catch (error) {
                console.error('åˆ é™¤å¤‡æ³¨å¤±è´¥:', error);
                alert('åˆ é™¤å¤‡æ³¨å¤±è´¥: ' + error.message);
              } finally {
                hideLoading(); // éšè—loading
              }
            }

            // ä¿®æ”¹ç¡®è®¤å¿½ç•¥å‡½æ•°ï¼Œæ·»åŠ loading
            async function confirmIgnore() {
              const selectedReason = document.querySelector('input[name="ignoreReason"]:checked').value;
              const customReason = document.getElementById('customReasonText').value.trim();
              const finalReason = selectedReason === 'å…¶ä»–åŸå› ' ? customReason : selectedReason;

              if (selectedReason === 'å…¶ä»–åŸå› ' && !customReason) {
                alert('è¯·è¾“å…¥è‡ªå®šä¹‰çš„å¿½ç•¥åŸå› ');
                return;
              }

              showLoading(); // æ˜¾ç¤ºloading

              // Save current filter state before operation
              saveCurrentFilterState();

              try {
                const commitElement = currentIgnoreElement.closest('.commit');

                // æ›´æ–°å¿½ç•¥åˆ—è¡¨
                const index = ignoredCommits.findIndex(item => item.hash === currentIgnoreHash);
                if (index === -1) {
                  ignoredCommits.push({
                    hash: currentIgnoreHash,
                    reason: finalReason,
                    timestamp: new Date().toISOString()
                  });
                  commitElement.classList.add('ignored');
                  currentIgnoreElement.textContent = 'å–æ¶ˆå¿½ç•¥';

                  // ç§»é™¤ç°æœ‰å¿½ç•¥åŸå› å…ƒç´ ï¼ˆå¦‚æœæœ‰ï¼‰
                  const existingReason = commitElement.querySelector('.ignore-reason');
                  if (existingReason) {
                    existingReason.remove();
                  }

                  // æ·»åŠ æ–°çš„å¿½ç•¥åŸå› å±•ç¤º
                  const detailsElement = currentIgnoreElement.closest('.commit-info');
                  const reasonElement = document.createElement('div');
                  reasonElement.className = 'ignore-reason';
                  reasonElement.innerHTML = `
                    <span class="ignore-reason-title">ğŸš« å¿½ç•¥åŸå› </span>
                    <span class="ignore-reason-content">${finalReason}</span>
                  `;

                  // æ’å…¥åˆ°æ­£ç¡®çš„ä½ç½®
                  const remarkElement = detailsElement.querySelector('.commit-remark');
                  if (remarkElement) {
                    detailsElement.insertBefore(reasonElement, remarkElement);
                  } else {
                    detailsElement.appendChild(reasonElement);
                  }
                }

                // ä¿å­˜å¹¶æ›´æ–°
                await saveIgnoredCommits();
                await loadIgnoredCommits(); // é‡æ–°åŠ è½½æ•°æ®
        updateCherryPickCommands();
                closeIgnoreModal();

                // æ·»åŠ æˆåŠŸæç¤º
                showSuccessMessage('å¿½ç•¥æäº¤æˆåŠŸ');
              } catch (error) {
                console.error('ä¿å­˜å¿½ç•¥æäº¤å¤±è´¥:', error);
                alert('ä¿å­˜å¿½ç•¥æäº¤å¤±è´¥: ' + error.message);
              } finally {
                hideLoading(); // éšè—loading
              }
            }

            // ä¿®æ”¹å–æ¶ˆå¿½ç•¥æµç¨‹ï¼Œæ·»åŠ loading
            function toggleIgnoreCommit(hash, element) {
              const index = ignoredCommits.findIndex(item => item.hash === hash);

              if (index === -1) {
                // æ˜¾ç¤ºå¿½ç•¥åŸå› é€‰æ‹©å¼¹çª—
                showIgnoreModal(hash, element);
              } else {
                // å–æ¶ˆå¿½ç•¥
                showLoading(); // æ˜¾ç¤ºloading

                // Save current filter state before operation
                saveCurrentFilterState();

                const commitElement = element.closest('.commit');
                ignoredCommits.splice(index, 1);
                commitElement.classList.remove('ignored');
                element.textContent = 'å¿½ç•¥';

                // ç§»é™¤å¿½ç•¥åŸå› æ˜¾ç¤º
                const reasonElement = commitElement.querySelector('.ignore-reason');
                if (reasonElement) {
                  reasonElement.remove();
                }

                // ä¿å­˜å¹¶æ›´æ–°
                saveIgnoredCommits()
                  .then(() => {
                    loadIgnoredCommits();
                    updateCherryPickCommands();

                    // æ·»åŠ æˆåŠŸæç¤º
                    showSuccessMessage('å–æ¶ˆå¿½ç•¥æˆåŠŸ');
                  })
                  .catch(error => {
                    console.error('ä¿å­˜å¿½ç•¥æäº¤å¤±è´¥:', error);
                    alert('ä¿å­˜å¿½ç•¥æäº¤å¤±è´¥: ' + error.message);
                  })
                  .finally(() => {
                    hideLoading(); // éšè—loading
                  });
              }
            }

            // ä¿®æ”¹cherry-pickå‘½ä»¤çš„ç”Ÿæˆé€»è¾‘ï¼Œæ ¹æ®commit messageæ¥åˆ¤æ–­è¿ç»­æ€§
            function updateCherryPickCommands() {
              const sourceOnlyCommits = commits.filter(commit =>
                commit.status === 'source' && !ignoredCommits.some(item => item.hash === commit.hash)
              );

              // æŒ‰æ—¶é—´å€’åºæ’åº
              sourceOnlyCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              // æ›´æ–°åŸºç¡€å‘½ä»¤ - é€ä¸ªæäº¤
              let basicCommands = '';
              basicCommands += `# åˆ‡æ¢åˆ° ${targetBranch} åˆ†æ”¯\n`;
              basicCommands += `git checkout ${targetBranch}\n\n`;
              basicCommands += '# Cherry-pick æäº¤ï¼ˆé€ä¸ªæäº¤ï¼‰\n';
              sourceOnlyCommits.forEach(commit => {
                basicCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
              });

              // æ›´æ–°ä¼˜åŒ–å‘½ä»¤ - ä½¿ç”¨commit messageè¿›è¡Œæ·±åº¦ç›¸ä¼¼æ€§åˆ†ç»„
              let optimizedCommands = '';
              optimizedCommands += `# åˆ‡æ¢åˆ° ${targetBranch} åˆ†æ”¯\n`;
              optimizedCommands += `git checkout ${targetBranch}\n\n`;

              if (sourceOnlyCommits.length > 0) {
                // å¯»æ‰¾ç›¸å…³çš„æäº¤ç»„ï¼ˆæŒ‰æ¶ˆæ¯åˆ†ç»„ï¼‰
                optimizedCommands += '# Cherry-pick æäº¤ï¼ˆä¼˜åŒ–åˆå¹¶ï¼‰\n';

                // æŒ‰ç…§æ—§åˆ°æ–°çš„é¡ºåºæ’åº
                const sortedCommits = [...sourceOnlyCommits].sort((a, b) =>
                  new Date(a.date || a.dateIso) - new Date(b.date || b.dateIso)
                );

                // åˆ›å»ºæ¶ˆæ¯æ˜ å°„ï¼Œå°†ç›¸ä¼¼æ¶ˆæ¯çš„æäº¤åˆ†ç»„
                const messageGroups = {};
                const messageKeys = [];

                // é€šè¿‡æ¶ˆæ¯å†…å®¹ç›¸ä¼¼æ€§æ¥åˆ†ç»„ï¼ˆåŠ å¼ºç›¸ä¼¼æ€§åˆ¤æ–­ï¼‰
                sortedCommits.forEach(commit => {
                  // æå–æ¶ˆæ¯å‰ç¼€ï¼Œä¾‹å¦‚ "fix: ", "feat: " ç­‰
                  let msgPrefix = commit.message.split(':')[0];

                  // å¦‚æœæ²¡æœ‰å†’å·åˆ†éš”çš„å‰ç¼€ï¼Œå°è¯•æå–ä¸»é¢˜
                  if (!msgPrefix || msgPrefix === commit.message) {
                    // ä½¿ç”¨å‰å‡ ä¸ªå•è¯ä½œä¸ºä¸»é¢˜
                    const words = commit.message.split(' ').slice(0, 3).join(' ');
                    msgPrefix = words.length > 15 ? words.substring(0, 15) : words;
                  }

                  // å¯¹äºå¸¸è§å‰ç¼€ï¼Œé¢å¤–æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡
                  if (['fix', 'feat', 'chore', 'docs', 'style', 'refactor', 'test', 'perf'].includes(msgPrefix)) {
                    // å¦‚æœæ˜¯å¸¸è§ç±»å‹ï¼Œæ·»åŠ å†’å·åçš„å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
                    const contextMatch = commit.message.match(/^[^:]+:\s*([^(]+)/);
                    if (contextMatch && contextMatch[1]) {
                      const context = contextMatch[1].trim();
                      msgPrefix = `${msgPrefix}: ${context.substring(0, 20)}`;
                    }
                  }

                  // æ·»åŠ åˆ°å¯¹åº”åˆ†ç»„
                  if (!messageGroups[msgPrefix]) {
                    messageGroups[msgPrefix] = [];
                    messageKeys.push(msgPrefix);
                  }
                  messageGroups[msgPrefix].push(commit);
                });

                // ä¸ºæ¯ä¸ªåˆ†ç»„ç”Ÿæˆå‘½ä»¤
                messageKeys.forEach(key => {
                  const group = messageGroups[key];

                  // å•ä¸ªæäº¤ç›´æ¥cherry-pick
                  if (group.length === 1) {
                    const commit = group[0];
                    optimizedCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
                    return;
                  }

                  // æ£€æŸ¥è¿™ç»„æäº¤æ˜¯å¦åœ¨æ—¶é—´ä¸Šè¿ç»­
                  const isConsecutive = group.every((commit, index) => {
                    if (index === 0) return true;

                    const currentCommitIndex = sortedCommits.findIndex(c => c.hash === commit.hash);
                    const prevCommitIndex = sortedCommits.findIndex(c => c.hash === group[index - 1].hash);

                    return currentCommitIndex - prevCommitIndex === 1;
                  });

                  if (isConsecutive && group.length > 1) {
                    // è¿ç»­å¤šä¸ªæäº¤ä½¿ç”¨èŒƒå›´è¯­æ³•
                    const oldestCommit = group[0];
                    const newestCommit = group[group.length - 1];
                    optimizedCommands += `git cherry-pick ${oldestCommit.hash}^..${newestCommit.hash}  # åŒ…å« ${group.length} ä¸ªæäº¤ (${key}...)\n`;
                  } else {
                    // ä¸è¿ç»­ï¼Œå•ç‹¬å¤„ç†æ¯ä¸ªæäº¤
                    group.forEach(commit => {
                      optimizedCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
                    });
                  }
                });
              }

              document.getElementById('basic-commands').textContent = basicCommands;
              document.getElementById('optimized-commands').textContent = optimizedCommands;
      }

      function getCommitIndicator(commit) {
        if (commit.status === 'both') return 'ğŸ”´ğŸ”µ';
        return commit.status === 'source' ? 'ğŸ”´' : 'ğŸ”µ';
      }

      function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.textContent = 'å·²å¤åˆ¶!';
          document.body.appendChild(tooltip);

          const rect = element.getBoundingClientRect();
          tooltip.style.top = rect.top - 30 + 'px';
          tooltip.style.left = rect.left + 'px';
          tooltip.style.opacity = '1';

          setTimeout(() => {
            tooltip.style.opacity = '0';
            setTimeout(() => tooltip.remove(), 200);
          }, 1000);
        });
      }

      function filterCommits(type) {
              const commitRows = document.querySelectorAll('.commit-row');
        const buttons = document.querySelectorAll('.filter-button');

        buttons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

              // Save the current filter type as a data attribute on the body
              document.body.setAttribute('data-current-filter', type);

              // Update our filter state
              currentFilterState.mainFilter = type;

              // Toggle visibility of sub-filters only for "all" filter
              const subFilterSection = document.getElementById('subFilterSection');
              if (type === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply both main filter and sub-filters
              applyFilters(type);

              // Update URL with filter state
              updateURLParams();
            }

            function applyFilters(type) {
              const commitRows = document.querySelectorAll('.commit-row');
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;

              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const status = commitElement.getAttribute('data-status');
                const hash = commitElement.getAttribute('data-hash');
          const isIgnored = ignoredCommits.some(item => item.hash === hash);
                const isCommon = status === 'both';

                // First apply the main filter
                let shouldShow = false;

          switch(type) {
            case 'all':
                    shouldShow = true;
              break;
            case 'source':
                    shouldShow = status === 'source';
              break;
            case 'target':
                    shouldShow = status === 'target';
              break;
            case 'common':
                    shouldShow = status === 'both';
              break;
            case 'ignored':
                    shouldShow = isIgnored;
              break;
          }

                // Then apply sub-filters
                if (shouldShow) {
                  // Hide based on ignored status
                  if (hideIgnored && isIgnored && type !== 'ignored') {
                    shouldShow = false;
                  }

                  // Hide based on common status
                  if (hideCommon && isCommon && type !== 'common') {
                    shouldShow = false;
                  }
                }

                row.style.display = shouldShow ? '' : 'none';
              });
            }

            function applySubFilters() {
              // Get the current main filter
              const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
              applyFilters(currentFilter);

              // Update URL with filter state
              updateURLParams();
      }

      function switchCommandTab(type) {
        document.querySelectorAll('.command-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.command-content').forEach(content => content.classList.remove('active'));

        document.querySelector(`[data-command="${type}"]`).classList.add('active');
        document.getElementById(`${type}-content`).classList.add('active');
      }

      function copyCommandBlock(type) {
        const content = document.getElementById(`${type}-commands`).textContent;
        copyToClipboard(content, document.querySelector(`.copy-${type}-button`));
      }

      // ä¿å­˜å¿½ç•¥çš„æäº¤åˆ°æœåŠ¡å™¨
      async function saveIgnoredCommits() {
        try {
          const response = await fetch('http://localhost:3000/ignore-commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ignoredCommits })
          });

          if (!response.ok) {
            throw new Error('Failed to save ignored commits');
          }
        } catch (error) {
          console.error('ä¿å­˜å¿½ç•¥æäº¤å¤±è´¥:', error);
          throw error;
        }
      }

            // æ˜¾ç¤ºæˆåŠŸæç¤ºçš„å‡½æ•°
            function showSuccessMessage(message) {
              const successToast = document.createElement('div');
              successToast.className = 'success-toast';
              successToast.textContent = message;
              document.body.appendChild(successToast);

              // æ˜¾ç¤ºå¼¹çª—
              setTimeout(() => {
                successToast.classList.add('show');
              }, 100);

              // 2ç§’åéšè—
              setTimeout(() => {
                successToast.classList.remove('show');
                // åŠ¨ç”»ç»“æŸåç§»é™¤DOM
                setTimeout(() => successToast.remove(), 500);
              }, 2000);
            }

            // æ›´æ–°æ‰€æœ‰å¤‡æ³¨çš„UI
            function updateAllRemarkUI() {
              // è·å–æ‰€æœ‰æäº¤å…ƒç´ 
              document.querySelectorAll('.commit').forEach(commitEl => {
                const hash = commitEl.getAttribute('data-hash');
                if (hash) {
                  // æ›´æ–°å¤‡æ³¨UI
                  updateRemarkUI(hash);
                }
              });
            }

            // æ›´æ–°å•ä¸ªæäº¤çš„å¤‡æ³¨UI
            function updateRemarkUI(hash) {
              const remarkElement = document.querySelector(`.remark-content[data-hash="${hash}"]`);
              if (!remarkElement) return;

              const remark = getCommitRemark(hash);

              // æ›´æ–°å¤‡æ³¨å†…å®¹
              if (remark && remark.content) {
                remarkElement.value = remark.content;
                remarkElement.classList.add('has-content');

                // æ›´æ–°æ—¶é—´æˆ³æ˜¾ç¤º
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl && remark.timestamp) {
                  const date = new Date(remark.timestamp);
                  timestampEl.textContent = `æ›´æ–°äº: ${date.toLocaleString()}`;
                  timestampEl.style.display = 'block';
                }
        } else {
                remarkElement.value = '';
                remarkElement.classList.remove('has-content');

                // éšè—æ—¶é—´æˆ³
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl) {
                  timestampEl.style.display = 'none';
                }
              }
            }

            // å…³é—­å¿½ç•¥åŸå› å¼¹çª—
            function closeIgnoreModal() {
              document.getElementById('ignoreModal').style.display = 'none';
              currentIgnoreHash = null;
              currentIgnoreElement = null;
            }

            // æ¸²æŸ“æäº¤åˆ—è¡¨ - ä½¿ç”¨èŠå¤©å¼å¸ƒå±€
            function renderCommits(shouldRestoreState = true) {
              // Remember current filter state before rendering if requested
              if (shouldRestoreState) {
                saveCurrentFilterState();
              }

              const timeline = document.getElementById('timeline');
              timeline.innerHTML = '';

              // Get current layout
              const currentLayout = document.body.getAttribute('data-layout') || 'chat';

              // æŒ‰ç…§æ—¶é—´æ’åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
              sortedCommitsArray = [...commits].sort((a, b) =>
                new Date(b.date || b.dateIso) - new Date(a.date || a.dateIso)
              );

              // ä¸ºæ¯ä¸ªæäº¤åˆ›å»ºè¡Œ
              sortedCommitsArray.forEach((commit, index) => {
                const isIgnored = ignoredCommits.some(item => item.hash === commit.hash);
                const ignoredCommit = ignoredCommits.find(item => item.hash === commit.hash);
                const hasRemarkForCommit = hasRemark(commit.hash);
                const remarkContent = getRemarkContent(commit.hash);
                const isMatchedByMessage = commit.matchedByMessage === true;

                // åˆ›å»ºæäº¤è¡Œ
                const commitRow = document.createElement('div');
                commitRow.className = 'commit-row';

                // åˆ›å»ºæäº¤å®¹å™¨
                const commitContainer = document.createElement('div');

                // æ ¹æ®æäº¤çŠ¶æ€ç¡®å®šç±»å‹å’Œä½ç½®
                if (commit.status === 'both') {
                  commitContainer.className = 'commit-container both';
                } else if (commit.status === 'source') {
                  commitContainer.className = 'commit-container source';
                } else {
                  commitContainer.className = 'commit-container target';
                }

                // åˆ›å»ºæ ‡å¿—æ–‡æœ¬ - å¢å¼ºå…±åŒæäº¤æ˜¾ç¤º
                let badgeText;
                let badgeClass = '';

                if (commit.status === 'both') {
                  badgeText = isMatchedByMessage ? 'å·²åŒæ­¥(commit æ¶ˆæ¯åŒ¹é…)' : 'å…±åŒæäº¤';
                  if (isMatchedByMessage) {
                    badgeClass = 'message-matched';
                  }
                } else if (commit.status === 'source') {
                  badgeText = sourceBranch;
                } else {
                  badgeText = targetBranch;
                }

                // åˆ›å»ºæäº¤å†…å®¹ï¼Œä¸ºæ¶ˆæ¯åŒ¹é…çš„æäº¤æ·»åŠ ç‰¹æ®ŠCSSç±»
                let commitClasses = `commit${isIgnored ? ' ignored' : ''}`;
                if (isMatchedByMessage) {
                  commitClasses += ' matched-by-message';
                }

                let hashContent = '';

                // VS Codeå›¾æ ‡SVG
                const vscodeIconSvg = `<svg t="1742888482761" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1654" width="16" height="16"><path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#FFFFFF" p-id="1655"></path><path d="M708.82304 161.9968l137.46176 67.24608c20.81792 10.62912 23.7056 18.28864 23.7056 29.29664l0.60416 506.23488c0 13.50656-7.30112 18.82112-27.42272 30.1568l-133.8368 67.08224c-5.5808 2.60096-10.04544 5.76512-43.47904 5.76512 0 0 28.93824 0.24576 28.93824-22.87616v-662.87616a25.15968 25.15968 0 0 0-24.13568-25.76384c29.6448 0 38.16448 5.7344 38.16448 5.7344z" fill="#4B9AE9" p-id="1656"></path><path d="M163.34848 613.02784a29.21472 29.21472 0 0 0 0 38.98368s35.11296 32.62464 45.4656 41.984 25.7024 5.12 35.64544-2.37568 450.29376-343.64416 450.29376-343.64416v-165.94944a25.06752 25.06752 0 0 0-24.13568-25.76384 18.11456 18.11456 0 0 0-12.3392 5.376z" fill="#2A63A4" p-id="1657"></path><path d="M208.92672 331.74528a23.17312 23.17312 0 0 1 32.45056 0l453.4272 343.61344v169.55392c0 23.25504-28.9792 22.8352-28.9792 22.8352a17.00864 17.00864 0 0 1-10.11712-5.53984l-495.77984-454.13376a22.31296 22.31296 0 0 1 0-31.54944z" fill="#3478C6" p-id="1658"></path></svg>`;

                // ä¸ºæäº¤å“ˆå¸Œæ·»åŠ "æŸ¥çœ‹å˜æ›´"æŒ‰é’®
                function getHashWithViewChangesButton(hash) {
                  const shortHash = hash.substring(0, 7);  // åªæ˜¾ç¤ºå‰7ä½
                  return `
                    <span class="commit-hash" onclick="copyToClipboard('${hash}', this)" title="${hash}">${shortHash}</span>
                    <button class="vscode-button" data-tooltip="åœ¨VS Codeä¸­æŸ¥çœ‹æ­¤æäº¤" onclick="openInVSCode('${hash}')">
                      ${vscodeIconSvg}
                    </button>
                    <button class="view-changes-btn" onclick="event.stopPropagation(); viewCommitChanges('${hash}', '${commit.message}')">
                      æŸ¥çœ‹å˜æ›´
                    </button>
                  `;
                }

                // ä¸ºæ¶ˆæ¯åŒ¹é…çš„æäº¤æ˜¾ç¤ºä¸¤ä¸ªåˆ†æ”¯çš„å“ˆå¸Œå€¼å¹¶æ·»åŠ æŒ‰é’®
                if (isMatchedByMessage && commit.targetHash) {
                  hashContent = `
                    <div class="commit-hash-pair">
                      <div class="commit-hash-branch">
                        <span class="branch-label">${sourceBranch}:</span>
                        ${getHashWithViewChangesButton(commit.hash)}
                      </div>
                      <div class="commit-hash-branch">
                        <span class="branch-label">${targetBranch}:</span>
                        ${getHashWithViewChangesButton(commit.targetHash)}
                      </div>
                      <button class="compare-in-vscode" onclick="compareCommitsInVSCode('${commit.hash}', '${commit.targetHash}')">
                        ${vscodeIconSvg} åœ¨VS Codeä¸­æ¯”è¾ƒä¸¤ä¸ªæäº¤
                      </button>
                    </div>
                  `;
                } else {
                  hashContent = getHashWithViewChangesButton(commit.hash);
                }

                // æ·»åŠ åˆ†æ”¯æŒ‡ç¤ºå™¨ï¼ˆä»…å¹³é“ºå¸ƒå±€ä½¿ç”¨ï¼‰
                const branchIndicator = `<div class="branch-indicator ${badgeClass}"></div>`;

                // åˆ›å»ºæäº¤å†…å®¹
                commitContainer.innerHTML = `
                  <div class="${commitClasses}" data-hash="${commit.hash}" data-status="${commit.status}">
                    ${currentLayout === 'flat' ? branchIndicator : ''}
                    <span class="commit-badge ${badgeClass}">${badgeText}</span>
                    <div class="commit-time">${commit.formattedDate}</div>
                    <div class="commit-info">
                      <div class="commit-message" onclick="copyToClipboard('${commit.message}', this)">${commit.message}</div>
                      <div class="commit-details">
                        <span class="commit-author">ä½œè€…: ${commit.authorName}</span>
                        ${hashContent}
                        <button class="ignore-button" onclick="toggleIgnoreCommit('${commit.hash}', this)">
                          ${isIgnored ? 'å–æ¶ˆå¿½ç•¥' : 'å¿½ç•¥'}
                        </button>
                        <button class="remark-button" onclick="showRemarkModal('${commit.hash}', this)">
                          ${hasRemarkForCommit ? 'ç¼–è¾‘å¤‡æ³¨' : 'æ·»åŠ å¤‡æ³¨'}
                        </button>
                      </div>
                      ${isIgnored && ignoredCommit ? `
                        <div class="ignore-reason">
                          <span class="ignore-reason-title">ğŸš« å¿½ç•¥åŸå› </span>
                          <span class="ignore-reason-content">${ignoredCommit.reason}</span>
                        </div>` : ''}
                      ${remarkContent ? `
                        <div class="commit-remark">
                          <span class="commit-remark-title">ğŸ“ å¤‡æ³¨</span>
                          <span class="commit-remark-content">${remarkContent}</span>
                        </div>` : ''}
                    </div>
                  </div>
                `;

                // å°†æäº¤å®¹å™¨æ·»åŠ åˆ°è¡Œä¸­
                commitRow.appendChild(commitContainer);

                // å°†è¡Œæ·»åŠ åˆ°æ—¶é—´è½´ä¸­
                timeline.appendChild(commitRow);
              });

              updateCherryPickCommands();

              // Restore filter state after rendering if requested
              if (shouldRestoreState) {
                restoreFilterState();
              }
            }

            // Helper function to save current filter state
            function saveCurrentFilterState() {
              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl) {
                console.warn('Some filter DOM elements not found, skipping state save');
                return;
              }

              currentFilterState = {
                mainFilter: document.body.getAttribute('data-current-filter') || 'all',
                hideIgnored: hideIgnoredEl.checked,
                hideCommon: hideCommonEl.checked,
                searchText: searchInputEl.value.trim(),
                searchMessage: searchMessageEl.checked,
                searchAuthor: searchAuthorEl.checked,
                searchHash: searchHashEl.checked
              };

              // Log filter state for debugging
              console.log('Saved filter state:', currentFilterState);
            }

            // Helper function to restore filter state after operations
            function restoreFilterState() {
              console.log('Restoring filter state:', currentFilterState);

              if (!currentFilterState) {
                console.warn('No filter state to restore');
                return;
              }

              // First set the main filter active state in UI
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Set body attribute
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');
              const clearButton = document.getElementById('clearSearch');
              const subFilterSection = document.getElementById('subFilterSection');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl ||
                  !clearButton || !subFilterSection) {
                console.warn('Some filter DOM elements not found, skipping state restore');
                return;
              }

              // Set the checkbox states
              hideIgnoredEl.checked = currentFilterState.hideIgnored;
              hideCommonEl.checked = currentFilterState.hideCommon;

              // Set the search input and options
              searchInputEl.value = currentFilterState.searchText;
              searchMessageEl.checked = currentFilterState.searchMessage;
              searchAuthorEl.checked = currentFilterState.searchAuthor;
              searchHashEl.checked = currentFilterState.searchHash;

              // Show or hide the clear button based on search text
              if (currentFilterState.searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // Set sub-filter visibility based on main filter
              if (currentFilterState.mainFilter === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply the saved filters
              if (currentFilterState.searchText) {
                // If there's search text, apply search filter
                searchCommits(false); // Pass false to prevent saving state again
              } else {
                // Otherwise apply normal filters
                applyFilters(currentFilterState.mainFilter);
              }
            }

            // Initialize the filter state
            function initializeFilterState() {
              // Get state from URL params
              const urlParams = getURLParams();

              // Set initial filter state from URL or defaults
              currentFilterState = {
                mainFilter: urlParams.filter,
                hideIgnored: urlParams.hideIgnored,
                hideCommon: urlParams.hideCommon,
                searchText: '',
                searchMessage: true,
                searchAuthor: true,
                searchHash: false
              };

              // Update UI elements to match URL state
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Update filter buttons
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Update checkboxes
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              if (hideIgnoredEl) hideIgnoredEl.checked = currentFilterState.hideIgnored;
              if (hideCommonEl) hideCommonEl.checked = currentFilterState.hideCommon;

              // Set sub-filter visibility
              const subFilterSection = document.getElementById('subFilterSection');
              if (subFilterSection) {
                if (currentFilterState.mainFilter === 'all') {
                  subFilterSection.classList.remove('hidden');
                } else {
                  subFilterSection.classList.add('hidden');
                }
              }

              // Apply the filters based on URL state
              applyFilters(currentFilterState.mainFilter);

              console.log('Initialized filter state from URL:', currentFilterState);
            }

            // Add function to switch between layouts
            function switchLayout(layout) {
              // Update layout buttons
              document.getElementById('chatLayoutBtn').classList.toggle('active', layout === 'chat');
              document.getElementById('flatLayoutBtn').classList.toggle('active', layout === 'flat');

              // Update timeline class
              const timeline = document.getElementById('timeline');
              if (layout === 'flat') {
                timeline.classList.add('flat-layout');
              } else {
                timeline.classList.remove('flat-layout');
              }

              // Store current layout
              document.body.setAttribute('data-layout', layout);

              // Re-render commits with new layout
              renderCommits();

              // Save preference to localStorage
              localStorage.setItem('preferredLayout', layout);
            }

            // Add code to initialize layout from localStorage
            function initializeLayout() {
              const savedLayout = localStorage.getItem('preferredLayout') || 'chat';
              switchLayout(savedLayout);
            }

            // Modify the initialization code to include layout initialization
            // åˆå§‹åŒ–é¡µé¢
            loadIgnoredCommits();
            initializeLayout();

            // Add search functionality
            function searchCommits(saveState = true) {
              const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
              const searchMessage = document.getElementById('searchMessage').checked;
              const searchAuthor = document.getElementById('searchAuthor').checked;
              const searchHash = document.getElementById('searchHash').checked;
              const clearButton = document.getElementById('clearSearch');

              // Save the filter state if requested
              if (saveState) {
                currentFilterState.searchText = searchText;
                currentFilterState.searchMessage = searchMessage;
                currentFilterState.searchAuthor = searchAuthor;
                currentFilterState.searchHash = searchHash;

                // Update URL params (we don't add search to URL as it's temporary)
                updateURLParams();
              }

              // Toggle clear button visibility
              if (searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // If no search text, show all commits based on current filter
              if (!searchText) {
                // Reapply current filter
                const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
                applyFilters(currentFilter);
          return;
        }

              // Get all commit rows
              const commitRows = document.querySelectorAll('.commit-row');

              // Reset highlights
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const messageElement = commitElement.querySelector('.commit-message');
                const authorElement = commitElement.querySelector('.commit-author');
                const hashElements = commitElement.querySelectorAll('.commit-hash');

                // Remove existing highlights
                if (messageElement) {
                  messageElement.innerHTML = messageElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                if (authorElement) {
                  authorElement.innerHTML = authorElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                hashElements.forEach(el => {
                  el.innerHTML = el.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                });
              });

              // For each commit, check if it matches the search criteria
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                let matches = false;

                // Check commit message if enabled
                if (searchMessage) {
                  const messageElement = commitElement.querySelector('.commit-message');
                  if (messageElement && messageElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(messageElement, searchText);
                  }
                }

                // Check author if enabled
                if (searchAuthor && !matches) {
                  const authorElement = commitElement.querySelector('.commit-author');
                  if (authorElement && authorElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(authorElement, searchText);
                  }
                }

                // Check hash if enabled
                if (searchHash && !matches) {
                  const hashElements = commitElement.querySelectorAll('.commit-hash');
                  hashElements.forEach(hashElement => {
                    if (hashElement.textContent.toLowerCase().includes(searchText)) {
                      matches = true;
                      // Highlight the matching text
                      highlightText(hashElement, searchText);
                    }
                  });
                }

                // Show/hide based on search match
                row.style.display = matches ? '' : 'none';
              });
            }

            // Helper function to highlight search text
            function highlightText(element, searchText) {
              // Only add highlight if not already highlighted
              if (!element.innerHTML.includes('<span class="highlight">')) {
                const innerHTML = element.innerHTML;
                const index = innerHTML.toLowerCase().indexOf(searchText.toLowerCase());
                if (index >= 0) {
                  const highlighted = innerHTML.substring(0, index) +
                                     '<span class="highlight">' +
                                     innerHTML.substring(index, index + searchText.length) +
                                     '</span>' +
                                     innerHTML.substring(index + searchText.length);
                  element.innerHTML = highlighted;
                }
              }
            }

            // Function to clear search
            function clearSearch() {
              document.getElementById('searchInput').value = '';
              // Reset highlights
              document.querySelectorAll('.highlight').forEach(el => {
                const parent = el.parentNode;
                parent.textContent = parent.textContent;
              });
              // Reapply current filter
              searchCommits();
              document.getElementById('clearSearch').classList.remove('visible');
            }

            // Modify the initialization code to set initial sub-filter visibility
      // åˆå§‹åŒ–é¡µé¢
      loadIgnoredCommits();
            initializeLayout();

            // Set initial sub-filter visibility
            const initialFilter = document.body.getAttribute('data-current-filter') || 'all';
            const subFilterSection = document.getElementById('subFilterSection');
            if (initialFilter !== 'all') {
              subFilterSection.classList.add('hidden');
            }

            // Initialize with correct filter state
            window.addEventListener('DOMContentLoaded', function() {
              // Set up initial filter state tracking
              saveCurrentFilterState();
            });

            // Restore the back to top functionality
            window.addEventListener('scroll', function() {
              const backToTopButton = document.getElementById('backToTop');
              if (backToTopButton) {
                if (window.scrollY > 300) {
                  backToTopButton.classList.add('show');
                } else {
                  backToTopButton.classList.remove('show');
                }
              }
            });

            document.getElementById('backToTop').addEventListener('click', function() {
              window.scrollTo({
                top: 0,
                behavior: 'smooth'
              });
            });

            // Add function to update URL parameters with filter state
            function updateURLParams() {
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;
              const mainFilter = document.body.getAttribute('data-current-filter') || 'all';

              const url = new URL(window.location.href);
              url.searchParams.set('filter', mainFilter);
              url.searchParams.set('hideIgnored', hideIgnored ? '1' : '0');
              url.searchParams.set('hideCommon', hideCommon ? '1' : '0');

              // Don't add search parameters to URL as they're typically temporary

              // Update browser history without refreshing the page
              window.history.replaceState({}, '', url.toString());
            }

            // Add function to get URL parameters
            function getURLParams() {
              const urlParams = new URLSearchParams(window.location.search);
              return {
                filter: urlParams.get('filter') || 'all',
                hideIgnored: urlParams.get('hideIgnored') === '1',
                hideCommon: urlParams.get('hideCommon') === '1'
              };
            }

            // æ·»åŠ åœ¨VS Code/ç»ˆç«¯ä¸­æŸ¥çœ‹æäº¤çš„å‡½æ•°
            function openInVSCode(commitHash) {
              // åˆ›å»ºä¸€ä¸ªæç¤ºæ¡†ï¼Œæä¾›Gitå‘½ä»¤ä¾›å¤åˆ¶
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = 'æŸ¥çœ‹æäº¤çš„Gitå‘½ä»¤';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              content.appendChild(title);

              // æä¾›ä¸åŒçš„Gitå‘½ä»¤é€‰é¡¹
              const commands = [
                {
                  name: 'æŸ¥çœ‹æäº¤è¯¦æƒ…',
                  command: `git show ${commitHash}`
                },
                {
                  name: 'æŸ¥çœ‹æäº¤æ›´æ”¹çš„æ–‡ä»¶',
                  command: `git show --name-only ${commitHash}`
                },
                {
                  name: 'æŸ¥çœ‹æäº¤çš„å®Œæ•´å·®å¼‚',
                  command: `git show --color-words ${commitHash}`
                }
              ];

              // ä¸ºæ¯ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªå¯å¤åˆ¶çš„åŒºåŸŸ
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'å¤åˆ¶';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = 'å·²å¤åˆ¶';
                    setTimeout(() => {
                      copyBtn.textContent = 'å¤åˆ¶';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // æä¾›VSCodeç‰¹å®šå»ºè®®
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code ä½¿ç”¨æç¤º';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                'åœ¨VS Codeä¸­ï¼Œå¯ä»¥é€šè¿‡Ctrl+Shift+P (Windows/Linux) æˆ– Cmd+Shift+P (Mac) æ‰“å¼€å‘½ä»¤é¢æ¿',
                'è¾“å…¥ "Git: Show Commit" å¹¶é€‰æ‹©ï¼Œç„¶åç²˜è´´æ­¤æäº¤å“ˆå¸Œ',
                'å¯¹äºGitLensç”¨æˆ·: å‘½ä»¤é¢æ¿ä¸­è¾“å…¥ "GitLens: Show Commit" å¯ä»¥æŸ¥çœ‹æ›´è¯¦ç»†çš„æäº¤ä¿¡æ¯',
                'å¯¹äºGit Historyç”¨æˆ·: å‘½ä»¤é¢æ¿ä¸­è¾“å…¥ "Git: View History" å¯ä»¥æŸ¥çœ‹æäº¤å†å²'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // æ·»åŠ å…³é—­æŒ‰é’®
              const closeButton = document.createElement('button');
              closeButton.textContent = 'å…³é—­';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // å…³é—­æ—¶ä¹Ÿå¯ä»¥ç‚¹å‡»èƒŒæ™¯
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // æ·»åŠ æ¯”è¾ƒä¸¤ä¸ªæäº¤çš„å‡½æ•°
            function compareCommitsInVSCode(sourceHash, targetHash) {
              // åˆ›å»ºä¸€ä¸ªæç¤ºæ¡†ï¼Œæä¾›Gitå‘½ä»¤ä¾›å¤åˆ¶
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = 'æ¯”è¾ƒä¸¤ä¸ªæäº¤çš„Gitå‘½ä»¤';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              const subtitle = document.createElement('p');
              subtitle.innerHTML = `æ¯”è¾ƒ <code>${sourceHash.substring(0, 7)}</code> å’Œ <code>${targetHash.substring(0, 7)}</code>`;
              subtitle.style.marginBottom = '20px';
              subtitle.style.color = '#666';

              content.appendChild(title);
              content.appendChild(subtitle);

              // æä¾›ä¸åŒçš„Gitå‘½ä»¤é€‰é¡¹
              const commands = [
                {
                  name: 'æ˜¾ç¤ºä¸¤ä¸ªæäº¤ä¹‹é—´çš„å·®å¼‚',
                  command: `git diff ${sourceHash} ${targetHash}`
                },
                {
                  name: 'æŸ¥çœ‹æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨',
                  command: `git diff --name-only ${sourceHash} ${targetHash}`
                },
                {
                  name: 'æŸ¥çœ‹æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯',
                  command: `git diff --stat ${sourceHash} ${targetHash}`
                },
                {
                  name: 'æŸ¥çœ‹ä¸¤ä¸ªæäº¤ä¹‹é—´çš„æ‰€æœ‰æäº¤',
                  command: `git log --oneline ${sourceHash}...${targetHash}`
                }
              ];

              // ä¸ºæ¯ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªå¯å¤åˆ¶çš„åŒºåŸŸ
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'å¤åˆ¶';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = 'å·²å¤åˆ¶';
                    setTimeout(() => {
                      copyBtn.textContent = 'å¤åˆ¶';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // æä¾›VSCodeç‰¹å®šå»ºè®®
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code ä½¿ç”¨æç¤º';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                'åœ¨VS Codeé›†æˆç»ˆç«¯ä¸­è¿è¡Œä¸Šè¿°å‘½ä»¤ä»¥æŸ¥çœ‹å·®å¼‚',
                'GitLensç”¨æˆ·: ä½¿ç”¨å‘½ä»¤é¢æ¿(Ctrl/Cmd+Shift+P)æ‰§è¡Œ"GitLens: Compare Commits"',
                'Git Graphæ‰©å±•: æä¾›å¯è§†åŒ–æ¯”è¾ƒç•Œé¢ï¼Œæ¨èå®‰è£…',
                'å¤åˆ¶æäº¤å“ˆå¸Œåï¼Œå¯ä»¥åœ¨VS Codeçš„æºä»£ç ç®¡ç†è§†å›¾ä¸­å³é”®é€‰æ‹©"Compare with Selected"'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // æ·»åŠ å…³é—­æŒ‰é’®
              const closeButton = document.createElement('button');
              closeButton.textContent = 'å…³é—­';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // å…³é—­æ—¶ä¹Ÿå¯ä»¥ç‚¹å‡»èƒŒæ™¯
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // æŸ¥çœ‹å•ä¸ªæäº¤çš„å˜æ›´å†…å®¹ï¼ˆç±»ä¼¼git showï¼‰
            function viewCommitChanges(commitHash, commitMessage) {
              console.log('æŸ¥çœ‹æäº¤å˜æ›´:', commitHash, commitMessage);

              // ä¿å­˜æµè§ˆä½ç½®
              savedScrollPosition = window.scrollY;

              // ç¦ç”¨bodyæ»šåŠ¨
              const originalBodyStyle = document.body.style.cssText;
              document.body.style.overflow = 'hidden';
              document.body.style.paddingRight = '15px'; // é˜²æ­¢æ»šåŠ¨æ¡æ¶ˆå¤±å¯¼è‡´é¡µé¢æŠ–åŠ¨

              // åˆ›å»ºæ¨¡æ€æ¡†
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              // åˆ›å»ºå†…å®¹å®¹å™¨
              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '90%';
              content.style.width = '90%';
              content.style.maxHeight = '90vh'; // æ·»åŠ æœ€å¤§é«˜åº¦é™åˆ¶
              content.style.height = 'auto'; // é«˜åº¦è‡ªé€‚åº”
              content.style.display = 'flex';
              content.style.flexDirection = 'column';
              content.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';

              // æ·»åŠ æ ‡é¢˜å’Œå¤´éƒ¨åŒºåŸŸ
              const header = document.createElement('div');
              header.style.display = 'flex';
              header.style.justifyContent = 'space-between';
              header.style.alignItems = 'center';
              header.style.marginBottom = '10px';
              header.style.borderBottom = '1px solid #e1e4e8';
              header.style.paddingBottom = '10px';
              header.style.flexShrink = '0'; // é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼©

              const titleArea = document.createElement('div');

              // æ·»åŠ æ ‡é¢˜
              const title = document.createElement('h3');
              title.textContent = 'æäº¤è¯¦æƒ…';
              title.style.margin = '0 0 5px 0';
              title.style.fontSize = '18px';

              // æ·»åŠ æäº¤ä¿¡æ¯
              const subtitle = document.createElement('p');
              subtitle.innerHTML = `<code style="font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace; background-color: #f1f1f1; padding: 2px 4px; border-radius: 3px;">${commitHash}</code> - ${commitMessage}`;
              subtitle.style.margin = '0';
              subtitle.style.color = '#586069';
              subtitle.style.fontSize = '14px';

              titleArea.appendChild(title);
              titleArea.appendChild(subtitle);

              // æ·»åŠ å…³é—­æŒ‰é’®åˆ°å¤´éƒ¨
              const closeIcon = document.createElement('button');
              closeIcon.innerHTML = '&times;';
              closeIcon.style.background = 'none';
              closeIcon.style.border = 'none';
              closeIcon.style.fontSize = '24px';
              closeIcon.style.cursor = 'pointer';
              closeIcon.style.color = '#586069';
              closeIcon.style.width = '30px';
              closeIcon.style.height = '30px';
              closeIcon.style.lineHeight = '30px';
              closeIcon.style.textAlign = 'center';
              closeIcon.style.marginLeft = '15px';

              // å…³é—­å¼¹çª—å’Œæ¢å¤æ»šåŠ¨
              const closeModal = () => {
                document.body.removeChild(modal);
                document.body.style.cssText = originalBodyStyle; // æ¢å¤bodyåŸå§‹æ ·å¼
                document.removeEventListener('keydown', handleKeyDown);
              };

              closeIcon.addEventListener('click', closeModal);

              header.appendChild(titleArea);
              header.appendChild(closeIcon);

              content.appendChild(header);

              // æ·»åŠ å·®å¼‚æŸ¥çœ‹å™¨å®¹å™¨ - å¯æ»šåŠ¨éƒ¨åˆ†
              const diffContainer = document.createElement('div');
              diffContainer.style.flex = '1';
              diffContainer.style.overflow = 'auto'; // è¿™ä¸ªå®¹å™¨å¯ä»¥æ»šåŠ¨
              diffContainer.style.minHeight = '0'; // ç¡®ä¿flexå¸ƒå±€æ­£å¸¸å·¥ä½œ
              diffContainer.style.maxHeight = 'calc(90vh - 150px)'; // è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œå‡å»headerå’Œpaddingçš„é«˜åº¦
              diffContainer.style.paddingRight = '5px'; // ç»™æ»šåŠ¨æ¡ç•™å‡ºç©ºé—´

              // æ·»åŠ å·®å¼‚æŸ¥çœ‹å™¨
              const diffViewer = document.createElement('div');
              diffViewer.className = 'diff-viewer';
              diffViewer.style.fontFamily = 'SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace';
              diffViewer.style.fontSize = '12px';
              diffViewer.style.lineHeight = '1.5';
              diffViewer.style.width = '100%';
              diffViewer.innerHTML = '<div style="padding: 20px; text-align: center; color: #586069;">æ­£åœ¨åŠ è½½å˜æ›´æ•°æ®...</div>';

              diffContainer.appendChild(diffViewer);
              content.appendChild(diffContainer);

              // ç‚¹å‡»èƒŒæ™¯å…³é—­
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  closeModal();
                }
              });

              // æ·»åŠ ESCé”®ç›˜äº‹ä»¶å…³é—­å¼¹çª—
              const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                  closeModal();
                }
              };

              document.addEventListener('keydown', handleKeyDown);

              modal.appendChild(content);
              document.body.appendChild(modal);

              // è·å–Gitå·®å¼‚æ•°æ® - ä½¿ç”¨ä¸ä¿å­˜å¤‡æ³¨ç›¸åŒçš„æœåŠ¡é€šä¿¡æ–¹å¼
              // ç›´æ¥ä½¿ç”¨å·²å¯åŠ¨çš„3000ç«¯å£æœåŠ¡
              fetch(`http://localhost:3000/git/show?hash=${encodeURIComponent(commitHash)}`, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                }
              })
              .then(response => {
                console.log('æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                if (!response.ok) {
                  throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then(responseObj => {
                console.log('è·å–åˆ°æœåŠ¡å™¨å“åº”:', responseObj);

                // æ£€æŸ¥å“åº”æ ¼å¼
                if (!responseObj.success) {
                  throw new Error(responseObj.message || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
                }

                // è·å–æ•°æ®éƒ¨åˆ†
                const data = responseObj.data;
                console.log('æå–å“åº”æ•°æ®:', data);

                // æ¸²æŸ“å·®å¼‚æ•°æ®
                renderDiffData(data, diffViewer);
              })
              .catch(error => {
                console.error('è·å–æäº¤å˜æ›´æ•°æ®å¤±è´¥:', error);
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #cb2431; background-color: #ffeef0; border-radius: 6px;">
                    <p style="margin: 0 0 10px 0;"><strong>è·å–æäº¤å˜æ›´æ•°æ®å¤±è´¥</strong></p>
                    <p style="margin: 0; font-size: 12px;">${error.message}</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px;">è¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨å¹¶æ”¯æŒè·å–Gitå·®å¼‚æ•°æ®ã€‚</p>
                  </div>
                `;
              });
            }

            // æ¸²æŸ“å·®å¼‚æ•°æ®åˆ°å·®å¼‚æŸ¥çœ‹å™¨ - GitHubé£æ ¼
            function renderDiffData(data, diffViewer) {
              console.log('æ¸²æŸ“å·®å¼‚æ•°æ®:', data);

              if (!data || !data.diff || data.diff.trim() === '') {
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    æ­¤æäº¤æ²¡æœ‰æ–‡ä»¶å˜æ›´æˆ–æ•°æ®æ ¼å¼ä¸æ­£ç¡®
                  </div>
                `;
                return;
              }

              // è§£æGitå·®å¼‚æ•°æ®
              const diffText = data.diff;

              // åˆ†å‰²ä¸ºæ–‡ä»¶å—
              const fileBlocks = parseDiffToFileBlocks(diffText);

              // æ„å»ºGitHubé£æ ¼çš„å·®å¼‚è§†å›¾HTML
              let html = '';

              // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
              if (fileBlocks.length === 0) {
                html = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    æ­¤æäº¤æ²¡æœ‰æ–‡ä»¶å˜æ›´
                  </div>
                `;
              } else {
                // ä¸ºæ¯ä¸ªæ–‡ä»¶å—åˆ›å»ºå·®å¼‚è§†å›¾
                fileBlocks.forEach(fileBlock => {
                  html += createGitHubStyleDiffHTML(fileBlock);
                });
              }

              diffViewer.innerHTML = html;
            }

            // å°†Gitå·®å¼‚æ–‡æœ¬è§£æä¸ºæ–‡ä»¶å—
            function parseDiffToFileBlocks(diffText) {
              // åˆ†å‰²ä¸ºè¡Œ
              const lines = diffText.split('\n');
              const fileBlocks = [];
              let currentFile = null;
              let inFileHeader = false;
              let currentHunk = null;
              let currentHunkContent = [];

              // éå†æ¯ä¸€è¡Œ
              lines.forEach(line => {
                // æ£€æµ‹æ–‡ä»¶å¤´
                if (line.startsWith('diff --git ')) {
                  // å¦‚æœå·²ç»æœ‰ä¸€ä¸ªå½“å‰æ–‡ä»¶ï¼Œå°†å…¶æ·»åŠ åˆ°æ–‡ä»¶å—åˆ—è¡¨
                  if (currentFile) {
                    if (currentHunk) {
                      currentFile.hunks.push({
                        header: currentHunk,
                        content: currentHunkContent
                      });
                    }
                    fileBlocks.push(currentFile);
                  }

                  // å¼€å§‹æ–°æ–‡ä»¶
                  currentFile = {
                    header: line,
                    path: extractFilePath(line),
                    hunks: []
                  };
                  inFileHeader = true;
                  currentHunk = null;
                  currentHunkContent = [];
                }
                // æ£€æµ‹æ–‡ä»¶è·¯å¾„å˜æ›´ä¿¡æ¯
                else if (inFileHeader && (line.startsWith('--- ') || line.startsWith('+++ '))) {
                  if (currentFile) {
                    currentFile.header += '\n' + line;
                  }
                }
                // æ£€æµ‹å·®å¼‚å—å¤´
                else if (line.startsWith('@@ ')) {
                  inFileHeader = false;
                  // å¦‚æœå·²ç»æœ‰ä¸€ä¸ªå½“å‰å·®å¼‚å—ï¼Œå°†å…¶æ·»åŠ åˆ°å½“å‰æ–‡ä»¶çš„å·®å¼‚å—åˆ—è¡¨
                  if (currentHunk && currentFile) {
                    currentFile.hunks.push({
                      header: currentHunk,
                      content: currentHunkContent
                    });
                  }

                  // å¼€å§‹æ–°å·®å¼‚å—
                  currentHunk = line;
                  currentHunkContent = [];
                }
                // å…¶ä»–è¡Œå±äºå½“å‰å·®å¼‚å—å†…å®¹
                else if (currentFile) {
                  if (inFileHeader) {
                    // è¿˜åœ¨æ–‡ä»¶å¤´éƒ¨
                    currentFile.header += '\n' + line;
                  } else if (currentHunk) {
                    // å·®å¼‚å—å†…å®¹
                    currentHunkContent.push(line);
                  }
                }
              });

              // æ·»åŠ æœ€åä¸€ä¸ªå·®å¼‚å—å’Œæ–‡ä»¶
              if (currentFile && currentHunk) {
                currentFile.hunks.push({
                  header: currentHunk,
                  content: currentHunkContent
                });
                fileBlocks.push(currentFile);
              }

              return fileBlocks;
            }

            // ä»diff --gitè¡Œæå–æ–‡ä»¶è·¯å¾„
            function extractFilePath(diffGitLine) {
              try {
                // æ ¼å¼é€šå¸¸æ˜¯ "diff --git a/path/to/file b/path/to/file"
                const parts = diffGitLine.split(' ');
                if (parts.length >= 4) {
                  // è·å–b/path/to/fileå¹¶ç§»é™¤å¼€å¤´çš„"b/"
                  let path = parts[3];
                  if (path.startsWith('b/')) {
                    path = path.substring(2);
                  }
                  return path;
                }
              } catch (e) {
                console.error('æå–æ–‡ä»¶è·¯å¾„å¤±è´¥:', e);
              }
              return 'unknown-file';
            }

            // åˆ›å»ºGitHubé£æ ¼çš„å·®å¼‚HTML
            function createGitHubStyleDiffHTML(fileBlock) {
              const filePath = fileBlock.path;
              const fileExtension = filePath.split('.').pop().toLowerCase();

              // æ„å»ºæ–‡ä»¶å¤´HTML
              let html = `
                <div style="margin-bottom: 16px;">
                  <div style="background-color: #f6f8fa; border: 1px solid #e1e4e8; border-bottom: none; border-top-left-radius: 6px; border-top-right-radius: 6px; padding: 8px 16px; font-weight: 600;">
                    ${escapeHtml(filePath)}
                  </div>
              `;

              // æ·»åŠ æ–‡ä»¶å·®å¼‚å—
              fileBlock.hunks.forEach(hunk => {
                html += `
                  <div style="background-color: #f8fafd; color: #586069; padding: 4px 10px; border: 1px solid #e1e4e8; border-bottom: none; font-size: 12px;">
                    ${escapeHtml(hunk.header)}
                  </div>
                  <div style="border: 1px solid #e1e4e8; border-bottom-left-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; border-bottom-right-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; overflow: hidden;">
                    <table style="border-collapse: collapse; width: 100%; tab-size: 4;">
                      <tbody>
        `;

                  // æ·»åŠ å·®å¼‚è¡Œ
                  hunk.content.forEach(line => {
                    let lineClass = '';
                    let lineStyle = '';
                    let prefix = '';

                    if (line.startsWith('+')) {
                      lineClass = 'addition';
                      lineStyle = 'background-color: #e6ffed;';
                      prefix = '+';
                    } else if (line.startsWith('-')) {
                      lineClass = 'deletion';
                      lineStyle = 'background-color: #ffeef0;';
                      prefix = '-';
                    } else {
                      lineClass = 'context';
                      lineStyle = '';
                      prefix = ' ';
                    }

                    const lineContent = line.substring(1); // ç§»é™¤å‰ç¼€

                    html += `
                      <tr class="${lineClass}" style="${lineStyle}">
                        <td style="width: 1%; padding: 0 10px; text-align: right; color: #bbb; border-right: 1px solid #e1e4e8; user-select: none;">${prefix}</td>
                        <td style="padding: 0 10px; white-space: pre-wrap; word-break: break-all;">${escapeHtml(lineContent)}</td>
                      </tr>
                    `;
                  });

                  html += `
                        </tbody>
                      </table>
                    </div>
                  `;
                });

                html += `</div>`;

                return html;
              }

              // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦çš„è¾…åŠ©å‡½æ•°
              function escapeHtml(str) {
                if (!str) return '';
                return str
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
              }
    </script>
  </body>
</html>
