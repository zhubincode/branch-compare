<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{title}}</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }
      .header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .header h1 {
        margin: 0 0 10px 0;
        color: #333;
      }
      .meta-info {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
      }
      .branch-legend {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }
      .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        padding: 5px 10px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .legend-icon {
        margin-right: 8px;
        font-size: 18px;
      }
      .timeline {
        position: relative;
        display: flex;
        flex-direction: column;
        padding: 20px 0;
        max-width: 800px;
        margin: 0 auto;
      }
      .commit-row {
        display: flex;
        margin-bottom: 30px;
        position: relative;
        width: 100%;
      }
      .commit-container {
        max-width: 80%;
        position: relative;
      }
      .commit-container.source {
        align-self: flex-start;
        margin-right: auto;
      }
      .commit-container.target {
        align-self: flex-end;
        margin-left: auto;
      }
      .commit-container.both {
        align-self: center;
        max-width: 95%;
        margin: 0 auto;
      }
      .commit-container.both .commit {
        border-top: 4px solid #28a745;
        border-left: none;
        border-right: none;
        border-radius: 8px;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
        background-color: #f0fff4;
      }
      .commit-container.both .commit.matched-by-message {
        background-color: #e6f7ff11;
        border-top: 4px solid #1890ff;
      }

      .commit {
        display: flex;
        flex-direction: column;
        padding: 20px 15px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .commit-container.source .commit {
        border-left: 4px solid #28a745; /* 改为绿色 */
        border-top-left-radius: 0;
        background-color: rgba(40, 167, 69, 0.05); /* 淡绿色背景 */
      }
      .commit-container.target .commit {
        border-right: 4px solid #ff9800; /* 改为橙色 */
        border-top-right-radius: 0;
        background-color: rgba(255, 152, 0, 0.05); /* 淡橙色背景 */
      }
      .commit-badge {
        position: absolute;
        top: -10px;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 2;
      }
      .commit-container.source .commit-badge {
        left: 10px;
        background-color: #28a745; /* 改为绿色 */
      }
      .commit-container.target .commit-badge {
        right: 10px;
        background-color: #ff9800; /* 改为橙色 */
      }
      .commit-container.both .commit-badge {
        left: 50%;
        transform: translateX(-50%);
        background-color: #28a745;
        padding: 3px 15px;
      }
      .commit-container.both .commit-badge.message-matched {
        background-color: #1890ff !important;
      }
      .commit-time {
        color: #666;
        font-size: 12px;
        margin-bottom: 5px;
        margin-top: 15px;
        display: flex;
        align-items: center;
      }
      .commit-container.source .commit-time {
        justify-content: flex-start;
      }
      .commit-container.target .commit-time {
        justify-content: flex-end;
      }
      .commit-container.both .commit-time {
        justify-content: center;
      }
      .commit-info {
        flex-grow: 1;
      }
      .commit-message {
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        cursor: pointer;
      }
      .commit-details {
        display: flex;
        flex-wrap: wrap;
        font-size: 13px;
        color: #666;
        gap: 8px;
        margin-bottom: 8px;
      }
      .commit-author {
        margin-right: 8px;
      }
      .commit-container.target .commit-details {
        justify-content: flex-end;
      }
      .commit-hash {
        font-family: monospace;
        cursor: pointer;
        background: #f1f1f1;
        padding: 2px 6px;
        border-radius: 3px;
        height: 20px;
        display: inline-flex;
        align-items: center;
      }
      .commit-hash:hover {
        background: #e1e4e8;
      }
      .commit-indicator {
        width: 50px;
        text-align: center;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ignore-button,
      .remark-button,
      .vscode-button,
      .view-changes-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        vertical-align: middle;
        margin: 0 4px;
      }
      .ignore-button,
      .remark-button {
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        opacity: 0.8;
      }
      .ignore-button {
        background: #dc3545;
        color: white;
      }
      .remark-button {
        background: #0ea5e9 !important; /* 使用天蓝色 */
        color: white;
      }
      .ignore-button:hover,
      .remark-button:hover {
        opacity: 1;
      }
      .remark-button {
        background: #17a2b8;
      }
      .ignored {
        opacity: 0.5;
        background: #f8f9fa;
      }
      /* .ignored::after {
        content: '(已忽略)';
        color: #dc3545;
        margin-left: 8px;
        font-size: 12px;
      } */
      .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }
      .filter-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .filter-button {
        padding: 5px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-button.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }
      .sub-filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 10px 0;
        padding-left: 5px;
        transition: all 0.3s ease;
        max-height: 50px;
        overflow: hidden;
      }
      .sub-filter-section.hidden {
        max-height: 0;
        margin: 0;
        opacity: 0;
      }
      .filter-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      .filter-checkbox input {
        margin-right: 5px;
      }
      .command-section {
        margin-top: 30px;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 6px;
      }
      .command-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .command-tab {
        padding: 5px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
      }
      .command-tab.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }
      .command-content {
        display: none;
      }
      .command-content.active {
        display: block;
      }
      .command-content pre {
        background: #2d2d2d;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0;
      }
      .copy-button {
        background: #0366d6;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }
      .copy-button:hover {
        background: #0256b9;
      }
      .tooltip {
        position: fixed;
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        font-size: 14px;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
      }
      .success-toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .loading-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 450px;
      }
      .modal h3 {
        margin-top: 0;
        margin-bottom: 16px;
        color: #333;
        font-size: 18px;
      }
      .reason-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
      }
      .reason-option {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 8px;
        position: relative;
      }
      .reason-option:hover {
        background: #f8f9fa;
        border-color: #aaa;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .reason-option.selected {
        background: #e3f2fd;
        border-color: #2196f3;
      }
      .reason-option input[type='radio'] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
      }
      .reason-option label {
        flex: 1;
        padding: 5px 0;
        cursor: pointer;
      }
      .custom-reason {
        display: none;
        margin-top: 16px;
      }
      .custom-reason.show {
        display: block;
      }
      .custom-reason input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 24px;
      }
      .modal-button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }
      .modal-button:hover {
        opacity: 0.9;
      }
      .modal-button.confirm {
        background: #2196f3;
        color: white;
      }
      .modal-button.cancel {
        background: #f1f1f1;
        color: #333;
      }
      .ignore-reason,
      .commit-remark {
        font-size: 13px;
        color: #666;
        margin: 8px 0 0 0;
        padding: 4px 8px;
        background: #f8f9fa;
        border-radius: 4px;
        line-height: 1.4;
      }

      /* .ignore-reason {
        border-left: 3px solid #dc3545;
      }

      .commit-remark {
        border-left: 3px solid #17a2b8;
      } */

      .ignore-reason-title,
      .commit-remark-title {
        font-weight: 500;
        color: #555;
        margin-right: 6px;
      }

      .ignore-reason-content,
      .commit-remark-content {
        display: block;
        margin-top: 4px;
        padding-left: 24px;
      }

      .remark-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .remark-modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        width: 80%;
        max-width: 420px;
        box-sizing: border-box;
      }
      .remark-modal-content h3 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: 500;
      }
      .remark-textarea {
        width: 100%;
        min-height: 120px;
        margin: 10px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        resize: vertical;
        font-size: 14px;
        line-height: 1.5;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #333;
      }
      .remark-textarea:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
      }
      .remark-modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 20px;
      }
      .remark-modal-button {
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        font-size: 14px;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .remark-modal-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .remark-save {
        background: #28a745;
        color: white;
      }
      .remark-cancel {
        background: #f1f1f1;
        color: #333;
      }
      .remark-delete {
        background: #dc3545;
        color: white;
        margin-right: auto;
      }
      @media (max-width: 768px) {
        .commit {
          flex-direction: column;
        }
        .commit-time {
          width: 100%;
          margin-bottom: 10px;
        }
        .commit-indicator {
          width: 100%;
          margin-top: 10px;
        }
      }
      /* 添加返回顶部按钮样式 */
      .back-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: #0366d6;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        font-size: 24px;
        z-index: 999;
      }

      .back-to-top.show {
        opacity: 1;
        visibility: visible;
      }

      .back-to-top:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      /* 添加时间轴图例样式 */
      .timeline-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .timeline-legend .legend-item {
        display: flex;
        align-items: center;
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        /* box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); */
      }

      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        display: inline-block;
      }

      .legend-dot.source {
        background-color: #28a745; /* 改为绿色 */
      }

      .legend-dot.target {
        background-color: #ff9800; /* 改为橙色 */
      }

      .legend-dot.both {
        background-color: #28a745;
      }

      /* 对提交哈希的展示增强，显示双分支哈希 */
      .commit-hash-container {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .commit-hash-pair {
        display: flex;
        flex-direction: column;
        gap: 3px;
        background: #f5f5f5;
        padding: 5px;
        border-radius: 4px;
        margin-top: 5px;
      }

      .commit-hash-branch {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      /* 对比分支样式 */
      .commit-hash-branch:last-child {
        background-color: rgba(255, 152, 0, 0.1); /* 淡橙色背景 */
        border: 1px solid rgba(255, 152, 0, 0.2);
      }

      .commit-hash-branch:last-child .branch-label {
        color: #ff9800; /* 橙色文字 */
        font-weight: 600;
      }

      .branch-label {
        min-width: 100px;
        display: inline-block;
      }

      .commit-hash-pair {
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      /* Add styling for the theme switcher */
      .theme-switcher {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        border-radius: 24px;
        padding: 4px;
        margin-top: 10px;
      }

      .theme-button {
        border: none;
        background: none;
        color: #666;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .theme-button.active {
        background-color: #0366d6;
        color: white;
      }

      /* Add CSS for the flat layout */
      .timeline.flat-layout .commit-row {
        justify-content: center;
      }

      .timeline.flat-layout .commit-container {
        max-width: 90%;
        width: 90%;
        margin: 0 auto;
        align-self: center;
      }

      .timeline.flat-layout .commit-container.both {
        max-width: 90%;
      }

      .timeline.flat-layout .commit {
        display: flex;
        flex-direction: column;
      }

      .timeline.flat-layout .commit-indicator {
        position: absolute;
        left: 15px;
        top: 15px;
        font-size: 16px;
      }

      /* Add branch indicator for flat layout */
      .timeline.flat-layout .branch-indicator {
        position: absolute;
        top: 10px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .timeline.flat-layout .commit-container.source .branch-indicator {
        right: 10px; /* 改为right */
        left: auto; /* 清除left */
        background-color: #28a745;
      }

      .timeline.flat-layout .commit-container.target .branch-indicator {
        left: 10px;
        background-color: #ff9800;
      }

      .timeline.flat-layout .commit-container.both .branch-indicator {
        background: linear-gradient(135deg, #28a745 50%, #ff9800 50%); /* 改为绿色和橙色 */
      }

      /* Adjust content padding in flat layout */
      .timeline.flat-layout .commit-time,
      .timeline.flat-layout .commit-info {
        padding-left: 25px;
      }

      /* Add styling for the search box */
      .search-section {
        margin-top: 10px;
        padding: 0 5px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .search-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .search-checkbox {
        display: flex;
        align-items: center;
        margin-right: 10px;
      }

      .search-checkbox label {
        margin-left: 5px;
        font-size: 13px;
        color: #666;
      }

      .highlight {
        background-color: #ffffc0;
        border-radius: 2px;
        padding: 0 2px;
      }

      /* Add a clear button for the search input */
      .search-container {
        position: relative;
        width: 100%;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      /* Set width for search input to make room for checkboxes */
      .search-container .search-input {
        width: calc(100% - 320px);
        margin-bottom: 0;
        margin-right: 10px;
      }

      /* Place checkboxes on the same line */
      .search-container .search-options {
        flex: 1;
        margin: 0;
        justify-content: flex-end;
      }

      .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #999;
        cursor: pointer;
        font-size: 16px;
        display: none;
      }

      .clear-search.visible {
        display: block;
      }

      /* Add VS Code icon button styles */
      .vscode-button {
        width: 20px;
        background: #0066b8;
        color: white;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        padding: 0;
      }

      .vscode-button:hover {
        background: #005ca3;
        transform: translateY(-1px);
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
      }

      .vscode-button svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* Add tooltip for VS Code buttons */
      .vscode-button::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 8px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 10;
      }

      .vscode-button:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: calc(100% + 5px);
      }

      /* Add style for compare buttons for matched commits */
      .compare-in-vscode {
        background: #0066b8;
        color: white;
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 5px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .compare-in-vscode:hover {
        background: #005ca3;
        transform: translateY(-1px);
      }

      .compare-in-vscode svg {
        width: 12px;
        height: 12px;
        fill: white;
      }

      /* 查看提交变更按钮样式 */
      .view-changes-btn {
        padding: 2px 8px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        color: #333;
      }

      .view-changes-btn:hover {
        background-color: #e0e0e0;
      }

      /* 差异查看器样式 */
      .diff-viewer {
        width: 100%;
        max-height: 80vh;
        overflow: auto;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
        line-height: 1.5;
        margin-top: 15px;
      }

      .diff-file {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }

      .diff-file-header {
        background-color: #f1f1f1;
        padding: 10px;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
      }

      .diff-hunk-header {
        background-color: #e8eaed;
        padding: 5px 10px;
        color: #666;
        border-bottom: 1px solid #ddd;
      }

      .diff-line {
        padding: 0 5px;
        white-space: pre;
      }

      .diff-line-addition {
        background-color: #e6ffed;
        border-left: 4px solid #34d058;
      }

      .diff-line-deletion {
        background-color: #ffeef0;
        border-left: 4px solid #d73a49;
      }

      .diff-line-context {
        background-color: #fff;
        border-left: 4px solid transparent;
      }

      .diff-line-num {
        display: inline-block;
        width: 40px;
        color: #999;
        text-align: right;
        padding-right: 10px;
        user-select: none;
      }

      .diff-empty-msg {
        padding: 20px;
        color: #666;
        text-align: center;
      }

      .diff-stats {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
        font-size: 14px;
      }

      .diff-stats-additions {
        color: #28a745;
        margin-right: 15px;
      }

      .diff-stats-deletions {
        color: #d73a49;
      }

      .diff-loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* 修改共同提交的按钮布局 */
      .commit-container.both .commit-details {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      /* 调整按钮样式，让它们在同一行 */
      .ignore-button,
      .remark-button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 2px 6px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        margin: 0;
        opacity: 0.8;
        display: inline-flex;
        align-items: center;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <!-- 添加忽略原因选择弹窗 -->
    <div id="ignoreModal" class="modal">
      <div class="modal-content">
        <h3>选择忽略原因</h3>
        <div class="reason-list" id="reasonList">
          <!-- 原因选项将通过 JavaScript 动态添加 -->
        </div>
        <div id="customReasonInput" class="custom-reason">
          <input type="text" placeholder="请输入忽略原因" id="customReasonText" />
        </div>
        <div class="modal-buttons">
          <button class="modal-button cancel" onclick="closeIgnoreModal()">取消</button>
          <button class="modal-button confirm" onclick="confirmIgnore()">确认</button>
        </div>
      </div>
    </div>

    <!-- 添加备注弹窗 -->
    <div id="remarkModal" class="remark-modal">
      <div class="remark-modal-content">
        <h3>编辑备注</h3>
        <textarea id="remarkText" class="remark-textarea" placeholder="请输入备注内容..."></textarea>
        <div class="remark-modal-buttons">
          <button class="remark-modal-button remark-delete" id="deleteRemarkBtn" onclick="deleteRemark()">删除备注</button>
          <button class="remark-modal-button remark-cancel" onclick="closeRemarkModal()">取消</button>
          <button class="remark-modal-button remark-save" onclick="confirmRemark()">保存</button>
        </div>
      </div>
    </div>

    <!-- 添加loading覆盖层 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- 添加返回顶部按钮 -->
    <div id="backToTop" class="back-to-top">↑</div>

    <div class="container">
      <div class="header">
        <div>
          <h1>分支提交对比</h1>
          <div class="meta-info">
            <div>生成时间: {{generatedTime}}</div>
            <div id="authorInfo" style="display: none">提交者: {{author}}</div>
            <div id="timeRangeInfo" style="display: none">时间范围: {{timeRange}}</div>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="legend-item"><span class="legend-dot source"></span> {{sourceBranch}} (基准分支)</div>
          <div class="legend-item"><span class="legend-dot target"></span> {{targetBranch}}</div>
          <div class="legend-item"><span class="legend-dot both" style="background-color: #1890ff"></span> 消息相同的共同提交</div>
        </div>

        <div class="theme-switcher">
          <button id="chatLayoutBtn" class="theme-button active" onclick="switchLayout('chat')">
            <span>聊天布局</span>
            <span class="layout-icon">💬</span>
          </button>
          <button id="flatLayoutBtn" class="theme-button" onclick="switchLayout('flat')">
            <span>列表布局</span>
            <span class="layout-icon">📑</span>
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-buttons">
          <button class="filter-button active" data-filter="all" onclick="filterCommits('all')">全部提交</button>
          <button class="filter-button" data-filter="source" onclick="filterCommits('source')">仅{{sourceBranch}}分支</button>
          <button class="filter-button" data-filter="target" onclick="filterCommits('target')">仅{{targetBranch}}分支</button>
          <button class="filter-button" data-filter="common" onclick="filterCommits('common')">共同提交</button>
          <button class="filter-button" data-filter="ignored" onclick="filterCommits('ignored')">已忽略提交</button>
        </div>

        <div class="sub-filter-section" id="subFilterSection">
          <label class="filter-checkbox">
            <input type="checkbox" id="hideIgnoredCommits" checked onchange="applySubFilters()" />
            <span>隐藏已忽略提交</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="hideCommonCommits" onchange="applySubFilters()" />
            <span>隐藏共同提交</span>
          </label>
        </div>

        <div class="search-section">
          <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="搜索提交信息、作者或哈希..." oninput="searchCommits()" />
            <button class="clear-search" id="clearSearch" onclick="clearSearch()">✕</button>
            <div class="search-options">
              <label class="search-checkbox">
                <input type="checkbox" id="searchMessage" checked onchange="searchCommits()" />
                <span>提交信息</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchAuthor" checked onchange="searchCommits()" />
                <span>作者</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchHash" onchange="searchCommits()" />
                <span>哈希</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="timeline" id="timeline"></div>

      <div class="command-section">
        <div class="command-tabs">
          <button class="command-tab active" data-command="basic" onclick="switchCommandTab('basic')">基础命令</button>
          <button class="command-tab" data-command="optimized" onclick="switchCommandTab('optimized')">优化命令</button>
        </div>

        <div id="basic-content" class="command-content active">
          <h3>
            Cherry-pick 基础指令
            <button class="copy-button copy-basic-button" onclick="copyCommandBlock('basic')">复制全部</button>
          </h3>
          <pre><code id="basic-commands"></code></pre>
        </div>

        <div id="optimized-content" class="command-content">
          <h3>
            Cherry-pick 优化指令
            <button class="copy-button copy-optimized-button" onclick="copyCommandBlock('optimized')">复制全部</button>
          </h3>
          <pre><code id="optimized-commands"></code></pre>
        </div>
      </div>
    </div>

    <script>
            // Create a global variable to track current filter state correctly placed at the top
            // Create a global variable at the beginning of the script
            let currentFilterState = {
              mainFilter: 'all',
              hideIgnored: true,
              hideCommon: false,
              searchText: '',
              searchMessage: true,
              searchAuthor: true,
              searchHash: false
            };

      // 初始化数据
      const commits = {{commits}};
      const sourceBranch = {{sourceBranch}};
      const targetBranch = {{targetBranch}};
      let ignoredCommits = {{ignoredCommits}} || [];  // 确保有默认值

      // 确保备注数据是数组格式
      let commitRemarks = [];
      try {
        const rawRemarks = {{commitRemarks}};
        if (Array.isArray(rawRemarks)) {
          // 已经是数组格式
          commitRemarks = rawRemarks;
          console.log('初始化: 备注数据已经是数组格式, 条数:', commitRemarks.length);
        } else if (typeof rawRemarks === 'object' && rawRemarks !== null) {
          // 转换对象格式为数组
          for (const hash in rawRemarks) {
            commitRemarks.push({
              hash: hash,
              content: rawRemarks[hash],
              timestamp: new Date().toISOString()
            });
          }
          console.log('初始化: 已将对象格式备注转换为数组, 条数:', commitRemarks.length);
        } else {
          console.warn('初始化: 无效的备注数据格式, 使用空数组');
        }
      } catch (e) {
        console.error('初始化备注数据时出错:', e);
      }

      const author = {{author}};
      const timeRange = {{timeRange}};

      // 忽略原因选项
      const IGNORE_REASONS = [
        '已手动合并',
        '不需要合并',
        '存在冲突',
        '待进一步确认',
        '其他原因'
      ];

      let currentIgnoreHash = null;
      let currentIgnoreElement = null;
      let currentCommitHash = null;

      // 页面加载时获取最新的已忽略提交和备注
      async function loadIgnoredCommits() {
        console.log('正在加载已忽略提交和备注数据...');
        try {
          // 单独处理每个请求，避免一个失败影响另一个
          try {
            const ignoreResponse = await fetch('http://localhost:3000/ignored-commits');
            if (ignoreResponse.ok) {
              const ignoreData = await ignoreResponse.json();
              if (Array.isArray(ignoreData.ignoredCommits)) {
                ignoredCommits = ignoreData.ignoredCommits;
                console.log('已忽略提交加载成功, 数量:', ignoredCommits.length);
              }
            } else {
              console.error('加载已忽略提交失败:', ignoreResponse.status);
            }
          } catch (ignoreError) {
            console.error('获取已忽略提交出错:', ignoreError);
          }

          // 加载备注数据
          try {
            console.log('开始加载备注数据...');
            const remarkResponse = await fetch('http://localhost:3000/commit-remarks');
            if (remarkResponse.ok) {
              const remarkData = await remarkResponse.json();
              console.log('收到备注数据响应:', remarkData);

              if (remarkData.commitRemarks) {
                if (Array.isArray(remarkData.commitRemarks)) {
                  commitRemarks = remarkData.commitRemarks;
                  console.log('备注数据加载成功(数组格式), 数量:', commitRemarks.length);

                  if (commitRemarks.length > 0) {
                    console.log('备注内容示例:');
                    commitRemarks.slice(0, 3).forEach((remark) => {
                      console.log(`- 哈希: ${remark.hash}, 内容: ${remark.content}`);
                    });
                  }
                } else {
                  console.warn('服务器返回的备注不是数组格式, 正在转换...');
                  const tempArray = [];
                  for (const hash in remarkData.commitRemarks) {
                    tempArray.push({
                      hash: hash,
                      content: remarkData.commitRemarks[hash],
                      timestamp: new Date().toISOString()
                    });
                  }
                  commitRemarks = tempArray;
                  console.log('对象格式备注转换为数组成功, 数量:', commitRemarks.length);
                }
              } else {
                console.warn('服务器返回的数据中没有commitRemarks字段');
              }
            } else {
              console.error('加载备注数据失败:', remarkResponse.status);
            }
          } catch (remarkError) {
            console.error('获取备注出错:', remarkError);
          }

          // 重新渲染提交列表
                renderCommits(false); // Don't save filter state on initial load
          console.log('提交列表渲染完成');

                // Initialize filter state after data is loaded
                initializeFilterState();
        } catch (error) {
          console.error('加载数据失败:', error);
          // 如果加载失败，使用初始数据
                renderCommits(false);
        }
      }

      // 显示作者和时间范围信息（如果有）
      if (author) {
        document.getElementById('authorInfo').style.display = 'block';
      }
      if (timeRange) {
        document.getElementById('timeRangeInfo').style.display = 'block';
      }

      // 显示忽略原因选择弹窗
      function showIgnoreModal(hash, element) {
        currentIgnoreHash = hash;
        currentIgnoreElement = element;

              // 生成忽略原因选项
              const reasonListElement = document.getElementById('reasonList');
              reasonListElement.innerHTML = '';

              IGNORE_REASONS.forEach((reason, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'reason-option';

                // 创建radio输入
                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `reason-${index}`;
                radioInput.name = 'ignoreReason';
                radioInput.value = reason;
                if (index === 0) {
                  radioInput.checked = true;
                }

                // 创建label
                const label = document.createElement('label');
                label.htmlFor = `reason-${index}`;
                label.textContent = reason;

                // 添加到选项元素
                optionElement.appendChild(radioInput);
                optionElement.appendChild(label);

                // 使整个选项可点击
                optionElement.addEventListener('click', function(e) {
                  if (e.target !== radioInput) {
                    radioInput.checked = true;

                    // 处理自定义原因输入框显示逻辑
                    if (reason === '其他原因') {
                      document.getElementById('customReasonInput').classList.add('show');
                    } else {
                      document.getElementById('customReasonInput').classList.remove('show');
                    }

                    // 更新选中样式
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                  }
                });

                // 特殊处理自定义原因选项
                if (reason === '其他原因') {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.add('show');
                    // 更新选中样式
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                } else {
                  radioInput.addEventListener('change', function() {
                    document.getElementById('customReasonInput').classList.remove('show');
                    // 更新选中样式
                    document.querySelectorAll('.reason-option').forEach(opt => {
                      opt.classList.remove('selected');
                    });
                    optionElement.classList.add('selected');
                  });
                }

                reasonListElement.appendChild(optionElement);
              });

              // 重置自定义原因输入框
              document.getElementById('customReasonText').value = '';
              document.getElementById('customReasonInput').classList.remove('show');

              // 显示弹窗
              document.getElementById('ignoreModal').style.display = 'block';
      }

      // 获取备注内容
      function getRemarkContent(hash) {
        const remark = commitRemarks.find(r => r.hash === hash);
        return remark ? remark.content : '';
      }

      // 判断是否有备注
      function hasRemark(hash) {
        return commitRemarks.some(r => r.hash === hash);
      }

            // 获取提交的备注对象
            function getCommitRemark(hash) {
              return commitRemarks.find(r => r.hash === hash);
      }

      // 保存备注到服务器
      async function saveCommitRemarks() {
        try {
          console.log('准备保存备注数据, 备注总数:', commitRemarks.length);

          // 确保commitRemarks是数组
          if (!Array.isArray(commitRemarks)) {
            console.error('ERROR: commitRemarks不是数组!', typeof commitRemarks, commitRemarks);
                  // 重置为空数组
                  commitRemarks = [];
                  console.warn('已将commitRemarks重置为空数组');
                }

                // 验证并清理备注数据
                const validRemarks = commitRemarks.filter(remark =>
                  remark &&
                  remark.hash &&
                  typeof remark.hash === 'string' &&
                  remark.hash.trim().length > 0
                );

                if (validRemarks.length !== commitRemarks.length) {
                  console.warn(`过滤了 ${commitRemarks.length - validRemarks.length} 条无效备注`);
                  commitRemarks = validRemarks;
                }

                // 打印备注内容
          if (commitRemarks.length === 0) {
            console.log('没有备注需要保存');
          } else {
                  console.log('备注详情:');
            for (const remark of commitRemarks) {
                    console.log(`- 哈希: ${remark.hash}, 内容: ${remark.content || '(无内容)'}`);
            }
          }

          console.log('发送POST请求到/commit-remarks...');
          const postData = { commitRemarks: commitRemarks };
                console.log('POST数据格式检查:',
                  '是数组:', Array.isArray(commitRemarks),
                  '长度:', commitRemarks.length);

                // 添加重试逻辑
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;
                let lastError = null;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
          const response = await fetch('http://localhost:3000/commit-remarks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(postData),
                      cache: 'no-cache' // 禁用缓存
          });

          if (!response.ok) {
            const errorText = await response.text();
                      console.error(`尝试 ${attempts}/${maxAttempts} 失败:`, response.status, errorText);
                      lastError = new Error(`服务器返回错误: ${response.status} ${response.statusText}`);

                      if (attempts < maxAttempts) {
                        // 延迟一点再重试
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      } else {
                        throw lastError;
                      }
          }

          // 读取响应
          const data = await response.json();
          console.log('服务器保存备注成功, 响应:', data);

          if (data.count) {
            console.log(`服务器确认保存了 ${data.count} 条备注`);
          }

                    success = true;

          // 重新获取最新备注
          console.log('正在重新加载最新备注...');
          await loadLatestRemarks();

          return data;
                  } catch (attemptError) {
                    console.error(`尝试 ${attempts}/${maxAttempts} 出错:`, attemptError);
                    lastError = attemptError;

                    // 延迟一点再重试
                    if (attempts < maxAttempts) {
                      await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                    }
                  }
                }

                if (!success && lastError) {
                  console.error('保存备注失败，已达到最大重试次数');
                  alert('保存备注失败，请检查控制台日志');
                  throw lastError;
                }

                return null;
        } catch (error) {
          console.error('保存备注失败:', error);
                alert('保存备注失败: ' + error.message);
          throw error;
        }
      }

      // 单独加载最新备注
      async function loadLatestRemarks() {
        try {
          console.log('开始加载最新备注...');

                // 添加重试逻辑
                let attempts = 0;
                const maxAttempts = 3;
                let success = false;

                while (attempts < maxAttempts && !success) {
                  attempts++;
                  try {
                    const response = await fetch('http://localhost:3000/commit-remarks', {
                      cache: 'no-store', // 强制不使用缓存
                      headers: {
                        'X-Requested-With': 'fetch',
                        'Cache-Control': 'no-cache, no-store',
                        'Pragma': 'no-cache'
                      }
                    });

          if (!response.ok) {
                      console.error(`加载备注尝试 ${attempts}/${maxAttempts} 失败:`, response.status);
                      if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                        continue;
                      }
                      throw new Error(`无法获取备注: ${response.status} ${response.statusText}`);
                    }

                    // 解析响应数据
          const data = await response.json();
                    console.log('获取备注响应:', data);

                    // 处理备注数据
          if (data.commitRemarks) {
            // 确保commitRemarks是数组
            if (Array.isArray(data.commitRemarks)) {
              commitRemarks = data.commitRemarks;
              console.log('刷新备注数据成功, 数组长度:', commitRemarks.length);
                        if (commitRemarks.length > 0) {
                          console.log('备注内容示例:');
                          for (let i = 0; i < Math.min(3, commitRemarks.length); i++) {
                            const remark = commitRemarks[i];
                            console.log(`- 哈希: ${remark.hash}, 内容: ${remark.content || '(无内容)'}`);
                          }
              }
            } else {
              console.error('服务器返回的备注不是数组格式!', data.commitRemarks);

                        if (typeof data.commitRemarks === 'object' && data.commitRemarks !== null) {
                const tempArray = [];
                for (const hash in data.commitRemarks) {
                            if (Object.prototype.hasOwnProperty.call(data.commitRemarks, hash)) {
                  tempArray.push({
                    hash: hash,
                                content: data.commitRemarks[hash] || '',
                    timestamp: new Date().toISOString()
                  });
                            }
                }
                commitRemarks = tempArray;
                console.log('已转换对象格式为数组, 长度:', commitRemarks.length);
                        } else {
                          console.warn('服务器返回了无法处理的备注格式，使用空数组');
                          commitRemarks = [];
              }
            }
          } else {
            console.warn('服务器返回的数据中没有commitRemarks字段');
                      commitRemarks = [];
                    }

                    // 更新UI
                    updateAllRemarkUI();

                    success = true;
                    return true;
                  } catch (attemptError) {
                    console.error(`加载备注尝试 ${attempts}/${maxAttempts} 出错:`, attemptError);
                    if (attempts >= maxAttempts) {
                      throw attemptError;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * attempts));
                  }
                }

                if (!success) {
                  console.error('加载备注失败，已达到最大重试次数');
                  return false;
                }

          return true;
        } catch (error) {
                console.error('加载备注失败:', error);
          return false;
        }
      }

      // 显示备注弹窗
      function showRemarkModal(hash, element) {
        currentCommitHash = hash;
        currentCommitElement = element;

        const remarkText = document.getElementById('remarkText');
        remarkText.value = getRemarkContent(hash);

              // 根据是否有备注决定是否显示删除按钮
              const deleteButton = document.getElementById('deleteRemarkBtn');
              if (hasRemark(hash)) {
                deleteButton.style.display = 'block';
              } else {
                deleteButton.style.display = 'none';
              }

        document.getElementById('remarkModal').style.display = 'block';
      }

      // 关闭备注弹窗
      function closeRemarkModal() {
        document.getElementById('remarkModal').style.display = 'none';
        currentCommitHash = null;
        currentCommitElement = null;
      }

            // 添加显示和隐藏loading的函数
            function showLoading() {
              document.getElementById('loadingOverlay').classList.add('show');
            }

            function hideLoading() {
              document.getElementById('loadingOverlay').classList.remove('show');
            }

            // 修改确认备注函数，添加loading
      async function confirmRemark() {
        const remarkText = document.getElementById('remarkText').value.trim();
        console.log('开始保存备注，哈希值:', currentCommitHash, '内容:', remarkText);

        try {
                showLoading(); // 显示loading

                // Save current filter state before operation
                saveCurrentFilterState();

          // 查找现有备注
          const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

          if (remarkText) {
            // 有备注内容则更新或添加
            if (existingIndex >= 0) {
              // 更新现有备注
              commitRemarks[existingIndex].content = remarkText;
              commitRemarks[existingIndex].timestamp = new Date().toISOString();
              console.log('已更新现有备注');
            } else {
              // 添加新备注
              commitRemarks.push({
                hash: currentCommitHash,
                content: remarkText,
                timestamp: new Date().toISOString()
              });
              console.log('已添加新备注');
            }
            console.log('当前备注总数:', commitRemarks.length);
          } else if (existingIndex >= 0) {
            // 无备注内容且存在备注则删除
            commitRemarks.splice(existingIndex, 1);
            console.log('已删除备注');
          }

          // 保存备注到服务器
          console.log('正在向服务器保存所有备注...');
          await saveCommitRemarks();
          console.log('服务器保存备注完成');

          // 关闭备注弹窗
          closeRemarkModal();

          // 重新渲染提交列表以显示新备注
          renderCommits();
          console.log('提交列表重新渲染完成');

                // 显示成功消息
                showSuccessMessage('备注已保存');
        } catch (error) {
          console.error('保存备注操作失败:', error);
          alert('保存备注失败: ' + error.message);
              } finally {
                hideLoading(); // 隐藏loading
              }
            }

            // 修改删除备注函数，添加loading
            async function deleteRemark() {
              if (!currentCommitHash) return;

              try {
                showLoading(); // 显示loading

                // Save current filter state before operation
                saveCurrentFilterState();

                // 查找现有备注
                const existingIndex = commitRemarks.findIndex(r => r.hash === currentCommitHash);

                if (existingIndex >= 0) {
                  // 从数组中删除备注
                  commitRemarks.splice(existingIndex, 1);
                  console.log('已删除备注');

                  // 保存到服务器
                  await saveCommitRemarks();

                  // 更新UI
                  closeRemarkModal();
                  renderCommits();

                  // 显示成功消息
                  showSuccessMessage('备注已删除');
                }
              } catch (error) {
                console.error('删除备注失败:', error);
                alert('删除备注失败: ' + error.message);
              } finally {
                hideLoading(); // 隐藏loading
              }
            }

            // 修改确认忽略函数，添加loading
            async function confirmIgnore() {
              const selectedReason = document.querySelector('input[name="ignoreReason"]:checked').value;
              const customReason = document.getElementById('customReasonText').value.trim();
              const finalReason = selectedReason === '其他原因' ? customReason : selectedReason;

              if (selectedReason === '其他原因' && !customReason) {
                alert('请输入自定义的忽略原因');
                return;
              }

              showLoading(); // 显示loading

              // Save current filter state before operation
              saveCurrentFilterState();

              try {
                const commitElement = currentIgnoreElement.closest('.commit');

                // 更新忽略列表
                const index = ignoredCommits.findIndex(item => item.hash === currentIgnoreHash);
                if (index === -1) {
                  ignoredCommits.push({
                    hash: currentIgnoreHash,
                    reason: finalReason,
                    timestamp: new Date().toISOString()
                  });
                  commitElement.classList.add('ignored');
                  currentIgnoreElement.textContent = '取消忽略';

                  // 移除现有忽略原因元素（如果有）
                  const existingReason = commitElement.querySelector('.ignore-reason');
                  if (existingReason) {
                    existingReason.remove();
                  }

                  // 添加新的忽略原因展示
                  const detailsElement = currentIgnoreElement.closest('.commit-info');
                  const reasonElement = document.createElement('div');
                  reasonElement.className = 'ignore-reason';
                  reasonElement.innerHTML = `
                    <span class="ignore-reason-title">🚫 忽略原因</span>
                    <span class="ignore-reason-content">${finalReason}</span>
                  `;

                  // 插入到正确的位置
                  const remarkElement = detailsElement.querySelector('.commit-remark');
                  if (remarkElement) {
                    detailsElement.insertBefore(reasonElement, remarkElement);
                  } else {
                    detailsElement.appendChild(reasonElement);
                  }
                }

                // 保存并更新
                await saveIgnoredCommits();
                await loadIgnoredCommits(); // 重新加载数据
        updateCherryPickCommands();
                closeIgnoreModal();

                // 添加成功提示
                showSuccessMessage('忽略提交成功');
              } catch (error) {
                console.error('保存忽略提交失败:', error);
                alert('保存忽略提交失败: ' + error.message);
              } finally {
                hideLoading(); // 隐藏loading
              }
            }

            // 修改取消忽略流程，添加loading
            function toggleIgnoreCommit(hash, element) {
              const index = ignoredCommits.findIndex(item => item.hash === hash);

              if (index === -1) {
                // 显示忽略原因选择弹窗
                showIgnoreModal(hash, element);
              } else {
                // 取消忽略
                showLoading(); // 显示loading

                // Save current filter state before operation
                saveCurrentFilterState();

                const commitElement = element.closest('.commit');
                ignoredCommits.splice(index, 1);
                commitElement.classList.remove('ignored');
                element.textContent = '忽略';

                // 移除忽略原因显示
                const reasonElement = commitElement.querySelector('.ignore-reason');
                if (reasonElement) {
                  reasonElement.remove();
                }

                // 保存并更新
                saveIgnoredCommits()
                  .then(() => {
                    loadIgnoredCommits();
                    updateCherryPickCommands();

                    // 添加成功提示
                    showSuccessMessage('取消忽略成功');
                  })
                  .catch(error => {
                    console.error('保存忽略提交失败:', error);
                    alert('保存忽略提交失败: ' + error.message);
                  })
                  .finally(() => {
                    hideLoading(); // 隐藏loading
                  });
              }
            }

            // 修改cherry-pick命令的生成逻辑，根据commit message来判断连续性
            function updateCherryPickCommands() {
              const sourceOnlyCommits = commits.filter(commit =>
                commit.status === 'source' && !ignoredCommits.some(item => item.hash === commit.hash)
              );

              // 按时间倒序排序
              sourceOnlyCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

              // 更新基础命令 - 逐个提交
              let basicCommands = '';
              basicCommands += `# 切换到 ${targetBranch} 分支\n`;
              basicCommands += `git checkout ${targetBranch}\n\n`;
              basicCommands += '# Cherry-pick 提交（逐个提交）\n';
              sourceOnlyCommits.forEach(commit => {
                basicCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
              });

              // 更新优化命令 - 使用commit message进行深度相似性分组
              let optimizedCommands = '';
              optimizedCommands += `# 切换到 ${targetBranch} 分支\n`;
              optimizedCommands += `git checkout ${targetBranch}\n\n`;

              if (sourceOnlyCommits.length > 0) {
                // 寻找相关的提交组（按消息分组）
                optimizedCommands += '# Cherry-pick 提交（优化合并）\n';

                // 按照旧到新的顺序排序
                const sortedCommits = [...sourceOnlyCommits].sort((a, b) =>
                  new Date(a.date || a.dateIso) - new Date(b.date || b.dateIso)
                );

                // 创建消息映射，将相似消息的提交分组
                const messageGroups = {};
                const messageKeys = [];

                // 通过消息内容相似性来分组（加强相似性判断）
                sortedCommits.forEach(commit => {
                  // 提取消息前缀，例如 "fix: ", "feat: " 等
                  let msgPrefix = commit.message.split(':')[0];

                  // 如果没有冒号分隔的前缀，尝试提取主题
                  if (!msgPrefix || msgPrefix === commit.message) {
                    // 使用前几个单词作为主题
                    const words = commit.message.split(' ').slice(0, 3).join(' ');
                    msgPrefix = words.length > 15 ? words.substring(0, 15) : words;
                  }

                  // 对于常见前缀，额外添加更多上下文
                  if (['fix', 'feat', 'chore', 'docs', 'style', 'refactor', 'test', 'perf'].includes(msgPrefix)) {
                    // 如果是常见类型，添加冒号后的内容作为上下文
                    const contextMatch = commit.message.match(/^[^:]+:\s*([^(]+)/);
                    if (contextMatch && contextMatch[1]) {
                      const context = contextMatch[1].trim();
                      msgPrefix = `${msgPrefix}: ${context.substring(0, 20)}`;
                    }
                  }

                  // 添加到对应分组
                  if (!messageGroups[msgPrefix]) {
                    messageGroups[msgPrefix] = [];
                    messageKeys.push(msgPrefix);
                  }
                  messageGroups[msgPrefix].push(commit);
                });

                // 为每个分组生成命令
                messageKeys.forEach(key => {
                  const group = messageGroups[key];

                  // 单个提交直接cherry-pick
                  if (group.length === 1) {
                    const commit = group[0];
                    optimizedCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
                    return;
                  }

                  // 检查这组提交是否在时间上连续
                  const isConsecutive = group.every((commit, index) => {
                    if (index === 0) return true;

                    const currentCommitIndex = sortedCommits.findIndex(c => c.hash === commit.hash);
                    const prevCommitIndex = sortedCommits.findIndex(c => c.hash === group[index - 1].hash);

                    return currentCommitIndex - prevCommitIndex === 1;
                  });

                  if (isConsecutive && group.length > 1) {
                    // 连续多个提交使用范围语法
                    const oldestCommit = group[0];
                    const newestCommit = group[group.length - 1];
                    optimizedCommands += `git cherry-pick ${oldestCommit.hash}^..${newestCommit.hash}  # 包含 ${group.length} 个提交 (${key}...)\n`;
                  } else {
                    // 不连续，单独处理每个提交
                    group.forEach(commit => {
                      optimizedCommands += `git cherry-pick ${commit.hash}  # ${commit.message}\n`;
                    });
                  }
                });
              }

              document.getElementById('basic-commands').textContent = basicCommands;
              document.getElementById('optimized-commands').textContent = optimizedCommands;
      }

      function getCommitIndicator(commit) {
        if (commit.status === 'both') return '🔴🔵';
        return commit.status === 'source' ? '🔴' : '🔵';
      }

      function copyToClipboard(text, element) {
        navigator.clipboard.writeText(text).then(() => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          tooltip.textContent = '已复制!';
          document.body.appendChild(tooltip);

          const rect = element.getBoundingClientRect();
          tooltip.style.top = rect.top - 30 + 'px';
          tooltip.style.left = rect.left + 'px';
          tooltip.style.opacity = '1';

          setTimeout(() => {
            tooltip.style.opacity = '0';
            setTimeout(() => tooltip.remove(), 200);
          }, 1000);
        });
      }

      function filterCommits(type) {
              const commitRows = document.querySelectorAll('.commit-row');
        const buttons = document.querySelectorAll('.filter-button');

        buttons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');

              // Save the current filter type as a data attribute on the body
              document.body.setAttribute('data-current-filter', type);

              // Update our filter state
              currentFilterState.mainFilter = type;

              // Toggle visibility of sub-filters only for "all" filter
              const subFilterSection = document.getElementById('subFilterSection');
              if (type === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply both main filter and sub-filters
              applyFilters(type);

              // Update URL with filter state
              updateURLParams();
            }

            function applyFilters(type) {
              const commitRows = document.querySelectorAll('.commit-row');
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;

              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const status = commitElement.getAttribute('data-status');
                const hash = commitElement.getAttribute('data-hash');
          const isIgnored = ignoredCommits.some(item => item.hash === hash);
                const isCommon = status === 'both';

                // First apply the main filter
                let shouldShow = false;

          switch(type) {
            case 'all':
                    shouldShow = true;
              break;
            case 'source':
                    shouldShow = status === 'source';
              break;
            case 'target':
                    shouldShow = status === 'target';
              break;
            case 'common':
                    shouldShow = status === 'both';
              break;
            case 'ignored':
                    shouldShow = isIgnored;
              break;
          }

                // Then apply sub-filters
                if (shouldShow) {
                  // Hide based on ignored status
                  if (hideIgnored && isIgnored && type !== 'ignored') {
                    shouldShow = false;
                  }

                  // Hide based on common status
                  if (hideCommon && isCommon && type !== 'common') {
                    shouldShow = false;
                  }
                }

                row.style.display = shouldShow ? '' : 'none';
              });
            }

            function applySubFilters() {
              // Get the current main filter
              const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
              applyFilters(currentFilter);

              // Update URL with filter state
              updateURLParams();
      }

      function switchCommandTab(type) {
        document.querySelectorAll('.command-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.command-content').forEach(content => content.classList.remove('active'));

        document.querySelector(`[data-command="${type}"]`).classList.add('active');
        document.getElementById(`${type}-content`).classList.add('active');
      }

      function copyCommandBlock(type) {
        const content = document.getElementById(`${type}-commands`).textContent;
        copyToClipboard(content, document.querySelector(`.copy-${type}-button`));
      }

      // 保存忽略的提交到服务器
      async function saveIgnoredCommits() {
        try {
          const response = await fetch('http://localhost:3000/ignore-commit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ignoredCommits })
          });

          if (!response.ok) {
            throw new Error('Failed to save ignored commits');
          }
        } catch (error) {
          console.error('保存忽略提交失败:', error);
          throw error;
        }
      }

            // 显示成功提示的函数
            function showSuccessMessage(message) {
              const successToast = document.createElement('div');
              successToast.className = 'success-toast';
              successToast.textContent = message;
              document.body.appendChild(successToast);

              // 显示弹窗
              setTimeout(() => {
                successToast.classList.add('show');
              }, 100);

              // 2秒后隐藏
              setTimeout(() => {
                successToast.classList.remove('show');
                // 动画结束后移除DOM
                setTimeout(() => successToast.remove(), 500);
              }, 2000);
            }

            // 更新所有备注的UI
            function updateAllRemarkUI() {
              // 获取所有提交元素
              document.querySelectorAll('.commit').forEach(commitEl => {
                const hash = commitEl.getAttribute('data-hash');
                if (hash) {
                  // 更新备注UI
                  updateRemarkUI(hash);
                }
              });
            }

            // 更新单个提交的备注UI
            function updateRemarkUI(hash) {
              const remarkElement = document.querySelector(`.remark-content[data-hash="${hash}"]`);
              if (!remarkElement) return;

              const remark = getCommitRemark(hash);

              // 更新备注内容
              if (remark && remark.content) {
                remarkElement.value = remark.content;
                remarkElement.classList.add('has-content');

                // 更新时间戳显示
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl && remark.timestamp) {
                  const date = new Date(remark.timestamp);
                  timestampEl.textContent = `更新于: ${date.toLocaleString()}`;
                  timestampEl.style.display = 'block';
                }
        } else {
                remarkElement.value = '';
                remarkElement.classList.remove('has-content');

                // 隐藏时间戳
                const timestampEl = remarkElement.parentElement.querySelector('.remark-timestamp');
                if (timestampEl) {
                  timestampEl.style.display = 'none';
                }
              }
            }

            // 关闭忽略原因弹窗
            function closeIgnoreModal() {
              document.getElementById('ignoreModal').style.display = 'none';
              currentIgnoreHash = null;
              currentIgnoreElement = null;
            }

            // 渲染提交列表 - 使用聊天式布局
            function renderCommits(shouldRestoreState = true) {
              // Remember current filter state before rendering if requested
              if (shouldRestoreState) {
                saveCurrentFilterState();
              }

              const timeline = document.getElementById('timeline');
              timeline.innerHTML = '';

              // Get current layout
              const currentLayout = document.body.getAttribute('data-layout') || 'chat';

              // 按照时间排序（从新到旧）
              sortedCommitsArray = [...commits].sort((a, b) =>
                new Date(b.date || b.dateIso) - new Date(a.date || a.dateIso)
              );

              // 为每个提交创建行
              sortedCommitsArray.forEach((commit, index) => {
                const isIgnored = ignoredCommits.some(item => item.hash === commit.hash);
                const ignoredCommit = ignoredCommits.find(item => item.hash === commit.hash);
                const hasRemarkForCommit = hasRemark(commit.hash);
                const remarkContent = getRemarkContent(commit.hash);
                const isMatchedByMessage = commit.matchedByMessage === true;

                // 创建提交行
                const commitRow = document.createElement('div');
                commitRow.className = 'commit-row';

                // 创建提交容器
                const commitContainer = document.createElement('div');

                // 根据提交状态确定类型和位置
                if (commit.status === 'both') {
                  commitContainer.className = 'commit-container both';
                } else if (commit.status === 'source') {
                  commitContainer.className = 'commit-container source';
                } else {
                  commitContainer.className = 'commit-container target';
                }

                // 创建标志文本 - 增强共同提交显示
                let badgeText;
                let badgeClass = '';

                if (commit.status === 'both') {
                  badgeText = isMatchedByMessage ? '已同步(commit 消息匹配)' : '共同提交';
                  if (isMatchedByMessage) {
                    badgeClass = 'message-matched';
                  }
                } else if (commit.status === 'source') {
                  badgeText = sourceBranch;
                } else {
                  badgeText = targetBranch;
                }

                // 创建提交内容，为消息匹配的提交添加特殊CSS类
                let commitClasses = `commit${isIgnored ? ' ignored' : ''}`;
                if (isMatchedByMessage) {
                  commitClasses += ' matched-by-message';
                }

                let hashContent = '';

                // VS Code图标SVG
                const vscodeIconSvg = `<svg t="1742888482761" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1654" width="16" height="16"><path d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z" fill="#FFFFFF" p-id="1655"></path><path d="M708.82304 161.9968l137.46176 67.24608c20.81792 10.62912 23.7056 18.28864 23.7056 29.29664l0.60416 506.23488c0 13.50656-7.30112 18.82112-27.42272 30.1568l-133.8368 67.08224c-5.5808 2.60096-10.04544 5.76512-43.47904 5.76512 0 0 28.93824 0.24576 28.93824-22.87616v-662.87616a25.15968 25.15968 0 0 0-24.13568-25.76384c29.6448 0 38.16448 5.7344 38.16448 5.7344z" fill="#4B9AE9" p-id="1656"></path><path d="M163.34848 613.02784a29.21472 29.21472 0 0 0 0 38.98368s35.11296 32.62464 45.4656 41.984 25.7024 5.12 35.64544-2.37568 450.29376-343.64416 450.29376-343.64416v-165.94944a25.06752 25.06752 0 0 0-24.13568-25.76384 18.11456 18.11456 0 0 0-12.3392 5.376z" fill="#2A63A4" p-id="1657"></path><path d="M208.92672 331.74528a23.17312 23.17312 0 0 1 32.45056 0l453.4272 343.61344v169.55392c0 23.25504-28.9792 22.8352-28.9792 22.8352a17.00864 17.00864 0 0 1-10.11712-5.53984l-495.77984-454.13376a22.31296 22.31296 0 0 1 0-31.54944z" fill="#3478C6" p-id="1658"></path></svg>`;

                // 为提交哈希添加"查看变更"按钮
                function getHashWithViewChangesButton(hash) {
                  const shortHash = hash.substring(0, 7);  // 只显示前7位
                  return `
                    <span class="commit-hash" onclick="copyToClipboard('${hash}', this)" title="${hash}">${shortHash}</span>
                    <button class="vscode-button" data-tooltip="在VS Code中查看此提交" onclick="openInVSCode('${hash}')">
                      ${vscodeIconSvg}
                    </button>
                    <button class="view-changes-btn" onclick="event.stopPropagation(); viewCommitChanges('${hash}', '${commit.message}')">
                      查看变更
                    </button>
                  `;
                }

                // 为消息匹配的提交显示两个分支的哈希值并添加按钮
                if (isMatchedByMessage && commit.targetHash) {
                  hashContent = `
                    <div class="commit-hash-pair">
                      <div class="commit-hash-branch">
                        <span class="branch-label">${sourceBranch}:</span>
                        ${getHashWithViewChangesButton(commit.hash)}
                      </div>
                      <div class="commit-hash-branch">
                        <span class="branch-label">${targetBranch}:</span>
                        ${getHashWithViewChangesButton(commit.targetHash)}
                      </div>
                      <button class="compare-in-vscode" onclick="compareCommitsInVSCode('${commit.hash}', '${commit.targetHash}')">
                        ${vscodeIconSvg} 在VS Code中比较两个提交
                      </button>
                    </div>
                  `;
                } else {
                  hashContent = getHashWithViewChangesButton(commit.hash);
                }

                // 添加分支指示器（仅平铺布局使用）
                const branchIndicator = `<div class="branch-indicator ${badgeClass}"></div>`;

                // 创建提交内容
                commitContainer.innerHTML = `
                  <div class="${commitClasses}" data-hash="${commit.hash}" data-status="${commit.status}">
                    ${currentLayout === 'flat' ? branchIndicator : ''}
                    <span class="commit-badge ${badgeClass}">${badgeText}</span>
                    <div class="commit-time">${commit.formattedDate}</div>
                    <div class="commit-info">
                      <div class="commit-message" onclick="copyToClipboard('${commit.message}', this)">${commit.message}</div>
                      <div class="commit-details">
                        <span class="commit-author">作者: ${commit.authorName}</span>
                        ${hashContent}
                        <button class="ignore-button" onclick="toggleIgnoreCommit('${commit.hash}', this)">
                          ${isIgnored ? '取消忽略' : '忽略'}
                        </button>
                        <button class="remark-button" onclick="showRemarkModal('${commit.hash}', this)">
                          ${hasRemarkForCommit ? '编辑备注' : '添加备注'}
                        </button>
                      </div>
                      ${isIgnored && ignoredCommit ? `
                        <div class="ignore-reason">
                          <span class="ignore-reason-title">🚫 忽略原因</span>
                          <span class="ignore-reason-content">${ignoredCommit.reason}</span>
                        </div>` : ''}
                      ${remarkContent ? `
                        <div class="commit-remark">
                          <span class="commit-remark-title">📝 备注</span>
                          <span class="commit-remark-content">${remarkContent}</span>
                        </div>` : ''}
                    </div>
                  </div>
                `;

                // 将提交容器添加到行中
                commitRow.appendChild(commitContainer);

                // 将行添加到时间轴中
                timeline.appendChild(commitRow);
              });

              updateCherryPickCommands();

              // Restore filter state after rendering if requested
              if (shouldRestoreState) {
                restoreFilterState();
              }
            }

            // Helper function to save current filter state
            function saveCurrentFilterState() {
              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl) {
                console.warn('Some filter DOM elements not found, skipping state save');
                return;
              }

              currentFilterState = {
                mainFilter: document.body.getAttribute('data-current-filter') || 'all',
                hideIgnored: hideIgnoredEl.checked,
                hideCommon: hideCommonEl.checked,
                searchText: searchInputEl.value.trim(),
                searchMessage: searchMessageEl.checked,
                searchAuthor: searchAuthorEl.checked,
                searchHash: searchHashEl.checked
              };

              // Log filter state for debugging
              console.log('Saved filter state:', currentFilterState);
            }

            // Helper function to restore filter state after operations
            function restoreFilterState() {
              console.log('Restoring filter state:', currentFilterState);

              if (!currentFilterState) {
                console.warn('No filter state to restore');
                return;
              }

              // First set the main filter active state in UI
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Set body attribute
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Check if all the DOM elements are available
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              const searchInputEl = document.getElementById('searchInput');
              const searchMessageEl = document.getElementById('searchMessage');
              const searchAuthorEl = document.getElementById('searchAuthor');
              const searchHashEl = document.getElementById('searchHash');
              const clearButton = document.getElementById('clearSearch');
              const subFilterSection = document.getElementById('subFilterSection');

              if (!hideIgnoredEl || !hideCommonEl || !searchInputEl ||
                  !searchMessageEl || !searchAuthorEl || !searchHashEl ||
                  !clearButton || !subFilterSection) {
                console.warn('Some filter DOM elements not found, skipping state restore');
                return;
              }

              // Set the checkbox states
              hideIgnoredEl.checked = currentFilterState.hideIgnored;
              hideCommonEl.checked = currentFilterState.hideCommon;

              // Set the search input and options
              searchInputEl.value = currentFilterState.searchText;
              searchMessageEl.checked = currentFilterState.searchMessage;
              searchAuthorEl.checked = currentFilterState.searchAuthor;
              searchHashEl.checked = currentFilterState.searchHash;

              // Show or hide the clear button based on search text
              if (currentFilterState.searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // Set sub-filter visibility based on main filter
              if (currentFilterState.mainFilter === 'all') {
                subFilterSection.classList.remove('hidden');
              } else {
                subFilterSection.classList.add('hidden');
              }

              // Apply the saved filters
              if (currentFilterState.searchText) {
                // If there's search text, apply search filter
                searchCommits(false); // Pass false to prevent saving state again
              } else {
                // Otherwise apply normal filters
                applyFilters(currentFilterState.mainFilter);
              }
            }

            // Initialize the filter state
            function initializeFilterState() {
              // Get state from URL params
              const urlParams = getURLParams();

              // Set initial filter state from URL or defaults
              currentFilterState = {
                mainFilter: urlParams.filter,
                hideIgnored: urlParams.hideIgnored,
                hideCommon: urlParams.hideCommon,
                searchText: '',
                searchMessage: true,
                searchAuthor: true,
                searchHash: false
              };

              // Update UI elements to match URL state
              document.body.setAttribute('data-current-filter', currentFilterState.mainFilter);

              // Update filter buttons
              document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === currentFilterState.mainFilter);
              });

              // Update checkboxes
              const hideIgnoredEl = document.getElementById('hideIgnoredCommits');
              const hideCommonEl = document.getElementById('hideCommonCommits');
              if (hideIgnoredEl) hideIgnoredEl.checked = currentFilterState.hideIgnored;
              if (hideCommonEl) hideCommonEl.checked = currentFilterState.hideCommon;

              // Set sub-filter visibility
              const subFilterSection = document.getElementById('subFilterSection');
              if (subFilterSection) {
                if (currentFilterState.mainFilter === 'all') {
                  subFilterSection.classList.remove('hidden');
                } else {
                  subFilterSection.classList.add('hidden');
                }
              }

              // Apply the filters based on URL state
              applyFilters(currentFilterState.mainFilter);

              console.log('Initialized filter state from URL:', currentFilterState);
            }

            // Add function to switch between layouts
            function switchLayout(layout) {
              // Update layout buttons
              document.getElementById('chatLayoutBtn').classList.toggle('active', layout === 'chat');
              document.getElementById('flatLayoutBtn').classList.toggle('active', layout === 'flat');

              // Update timeline class
              const timeline = document.getElementById('timeline');
              if (layout === 'flat') {
                timeline.classList.add('flat-layout');
              } else {
                timeline.classList.remove('flat-layout');
              }

              // Store current layout
              document.body.setAttribute('data-layout', layout);

              // Re-render commits with new layout
              renderCommits();

              // Save preference to localStorage
              localStorage.setItem('preferredLayout', layout);
            }

            // Add code to initialize layout from localStorage
            function initializeLayout() {
              const savedLayout = localStorage.getItem('preferredLayout') || 'chat';
              switchLayout(savedLayout);
            }

            // Modify the initialization code to include layout initialization
            // 初始化页面
            loadIgnoredCommits();
            initializeLayout();

            // Add search functionality
            function searchCommits(saveState = true) {
              const searchText = document.getElementById('searchInput').value.trim().toLowerCase();
              const searchMessage = document.getElementById('searchMessage').checked;
              const searchAuthor = document.getElementById('searchAuthor').checked;
              const searchHash = document.getElementById('searchHash').checked;
              const clearButton = document.getElementById('clearSearch');

              // Save the filter state if requested
              if (saveState) {
                currentFilterState.searchText = searchText;
                currentFilterState.searchMessage = searchMessage;
                currentFilterState.searchAuthor = searchAuthor;
                currentFilterState.searchHash = searchHash;

                // Update URL params (we don't add search to URL as it's temporary)
                updateURLParams();
              }

              // Toggle clear button visibility
              if (searchText) {
                clearButton.classList.add('visible');
              } else {
                clearButton.classList.remove('visible');
              }

              // If no search text, show all commits based on current filter
              if (!searchText) {
                // Reapply current filter
                const currentFilter = document.body.getAttribute('data-current-filter') || 'all';
                applyFilters(currentFilter);
          return;
        }

              // Get all commit rows
              const commitRows = document.querySelectorAll('.commit-row');

              // Reset highlights
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                const messageElement = commitElement.querySelector('.commit-message');
                const authorElement = commitElement.querySelector('.commit-author');
                const hashElements = commitElement.querySelectorAll('.commit-hash');

                // Remove existing highlights
                if (messageElement) {
                  messageElement.innerHTML = messageElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                if (authorElement) {
                  authorElement.innerHTML = authorElement.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                }
                hashElements.forEach(el => {
                  el.innerHTML = el.innerHTML.replace(/<span class="highlight">([^<]+)<\/span>/g, '$1');
                });
              });

              // For each commit, check if it matches the search criteria
              commitRows.forEach(row => {
                const commitElement = row.querySelector('.commit');
                if (!commitElement) return;

                let matches = false;

                // Check commit message if enabled
                if (searchMessage) {
                  const messageElement = commitElement.querySelector('.commit-message');
                  if (messageElement && messageElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(messageElement, searchText);
                  }
                }

                // Check author if enabled
                if (searchAuthor && !matches) {
                  const authorElement = commitElement.querySelector('.commit-author');
                  if (authorElement && authorElement.textContent.toLowerCase().includes(searchText)) {
                    matches = true;
                    // Highlight the matching text
                    highlightText(authorElement, searchText);
                  }
                }

                // Check hash if enabled
                if (searchHash && !matches) {
                  const hashElements = commitElement.querySelectorAll('.commit-hash');
                  hashElements.forEach(hashElement => {
                    if (hashElement.textContent.toLowerCase().includes(searchText)) {
                      matches = true;
                      // Highlight the matching text
                      highlightText(hashElement, searchText);
                    }
                  });
                }

                // Show/hide based on search match
                row.style.display = matches ? '' : 'none';
              });
            }

            // Helper function to highlight search text
            function highlightText(element, searchText) {
              // Only add highlight if not already highlighted
              if (!element.innerHTML.includes('<span class="highlight">')) {
                const innerHTML = element.innerHTML;
                const index = innerHTML.toLowerCase().indexOf(searchText.toLowerCase());
                if (index >= 0) {
                  const highlighted = innerHTML.substring(0, index) +
                                     '<span class="highlight">' +
                                     innerHTML.substring(index, index + searchText.length) +
                                     '</span>' +
                                     innerHTML.substring(index + searchText.length);
                  element.innerHTML = highlighted;
                }
              }
            }

            // Function to clear search
            function clearSearch() {
              document.getElementById('searchInput').value = '';
              // Reset highlights
              document.querySelectorAll('.highlight').forEach(el => {
                const parent = el.parentNode;
                parent.textContent = parent.textContent;
              });
              // Reapply current filter
              searchCommits();
              document.getElementById('clearSearch').classList.remove('visible');
            }

            // Modify the initialization code to set initial sub-filter visibility
      // 初始化页面
      loadIgnoredCommits();
            initializeLayout();

            // Set initial sub-filter visibility
            const initialFilter = document.body.getAttribute('data-current-filter') || 'all';
            const subFilterSection = document.getElementById('subFilterSection');
            if (initialFilter !== 'all') {
              subFilterSection.classList.add('hidden');
            }

            // Initialize with correct filter state
            window.addEventListener('DOMContentLoaded', function() {
              // Set up initial filter state tracking
              saveCurrentFilterState();
            });

            // Restore the back to top functionality
            window.addEventListener('scroll', function() {
              const backToTopButton = document.getElementById('backToTop');
              if (backToTopButton) {
                if (window.scrollY > 300) {
                  backToTopButton.classList.add('show');
                } else {
                  backToTopButton.classList.remove('show');
                }
              }
            });

            document.getElementById('backToTop').addEventListener('click', function() {
              window.scrollTo({
                top: 0,
                behavior: 'smooth'
              });
            });

            // Add function to update URL parameters with filter state
            function updateURLParams() {
              const hideIgnored = document.getElementById('hideIgnoredCommits').checked;
              const hideCommon = document.getElementById('hideCommonCommits').checked;
              const mainFilter = document.body.getAttribute('data-current-filter') || 'all';

              const url = new URL(window.location.href);
              url.searchParams.set('filter', mainFilter);
              url.searchParams.set('hideIgnored', hideIgnored ? '1' : '0');
              url.searchParams.set('hideCommon', hideCommon ? '1' : '0');

              // Don't add search parameters to URL as they're typically temporary

              // Update browser history without refreshing the page
              window.history.replaceState({}, '', url.toString());
            }

            // Add function to get URL parameters
            function getURLParams() {
              const urlParams = new URLSearchParams(window.location.search);
              return {
                filter: urlParams.get('filter') || 'all',
                hideIgnored: urlParams.get('hideIgnored') === '1',
                hideCommon: urlParams.get('hideCommon') === '1'
              };
            }

            // 添加在VS Code/终端中查看提交的函数
            function openInVSCode(commitHash) {
              // 创建一个提示框，提供Git命令供复制
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = '查看提交的Git命令';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              content.appendChild(title);

              // 提供不同的Git命令选项
              const commands = [
                {
                  name: '查看提交详情',
                  command: `git show ${commitHash}`
                },
                {
                  name: '查看提交更改的文件',
                  command: `git show --name-only ${commitHash}`
                },
                {
                  name: '查看提交的完整差异',
                  command: `git show --color-words ${commitHash}`
                }
              ];

              // 为每个命令创建一个可复制的区域
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = '复制';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = '已复制';
                    setTimeout(() => {
                      copyBtn.textContent = '复制';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // 提供VSCode特定建议
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code 使用提示';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                '在VS Code中，可以通过Ctrl+Shift+P (Windows/Linux) 或 Cmd+Shift+P (Mac) 打开命令面板',
                '输入 "Git: Show Commit" 并选择，然后粘贴此提交哈希',
                '对于GitLens用户: 命令面板中输入 "GitLens: Show Commit" 可以查看更详细的提交信息',
                '对于Git History用户: 命令面板中输入 "Git: View History" 可以查看提交历史'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // 添加关闭按钮
              const closeButton = document.createElement('button');
              closeButton.textContent = '关闭';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // 关闭时也可以点击背景
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // 添加比较两个提交的函数
            function compareCommitsInVSCode(sourceHash, targetHash) {
              // 创建一个提示框，提供Git命令供复制
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '500px';
              content.style.width = '90%';

              const title = document.createElement('h3');
              title.textContent = '比较两个提交的Git命令';
              title.style.marginTop = '0';
              title.style.marginBottom = '15px';

              const subtitle = document.createElement('p');
              subtitle.innerHTML = `比较 <code>${sourceHash.substring(0, 7)}</code> 和 <code>${targetHash.substring(0, 7)}</code>`;
              subtitle.style.marginBottom = '20px';
              subtitle.style.color = '#666';

              content.appendChild(title);
              content.appendChild(subtitle);

              // 提供不同的Git命令选项
              const commands = [
                {
                  name: '显示两个提交之间的差异',
                  command: `git diff ${sourceHash} ${targetHash}`
                },
                {
                  name: '查看更改的文件列表',
                  command: `git diff --name-only ${sourceHash} ${targetHash}`
                },
                {
                  name: '查看汇总统计信息',
                  command: `git diff --stat ${sourceHash} ${targetHash}`
                },
                {
                  name: '查看两个提交之间的所有提交',
                  command: `git log --oneline ${sourceHash}...${targetHash}`
                }
              ];

              // 为每个命令创建一个可复制的区域
              commands.forEach(cmd => {
                const section = document.createElement('div');
                section.style.marginBottom = '15px';

                const label = document.createElement('div');
                label.textContent = cmd.name;
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '5px';

                const commandArea = document.createElement('div');
                commandArea.style.display = 'flex';
                commandArea.style.marginBottom = '10px';

                const cmdText = document.createElement('code');
                cmdText.textContent = cmd.command;
                cmdText.style.padding = '8px';
                cmdText.style.backgroundColor = '#f1f1f1';
                cmdText.style.borderRadius = '4px';
                cmdText.style.fontFamily = 'monospace';
                cmdText.style.flex = '1';
                cmdText.style.overflowX = 'auto';
                cmdText.style.whiteSpace = 'nowrap';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = '复制';
                copyBtn.style.marginLeft = '10px';
                copyBtn.style.padding = '0 10px';
                copyBtn.style.backgroundColor = '#0066b8';
                copyBtn.style.color = 'white';
                copyBtn.style.border = 'none';
                copyBtn.style.borderRadius = '4px';
                copyBtn.style.cursor = 'pointer';

                copyBtn.addEventListener('click', () => {
                  navigator.clipboard.writeText(cmd.command).then(() => {
                    copyBtn.textContent = '已复制';
                    setTimeout(() => {
                      copyBtn.textContent = '复制';
                    }, 2000);
                  });
                });

                commandArea.appendChild(cmdText);
                commandArea.appendChild(copyBtn);

                section.appendChild(label);
                section.appendChild(commandArea);
                content.appendChild(section);
              });

              // 提供VSCode特定建议
              const vscodeSection = document.createElement('div');
              vscodeSection.style.marginTop = '20px';
              vscodeSection.style.padding = '10px';
              vscodeSection.style.backgroundColor = '#f8f9fa';
              vscodeSection.style.borderRadius = '4px';

              const vscodeTitle = document.createElement('div');
              vscodeTitle.textContent = 'VS Code 使用提示';
              vscodeTitle.style.fontWeight = 'bold';
              vscodeTitle.style.marginBottom = '10px';

              const vscodeText = document.createElement('ul');
              vscodeText.style.margin = '0';
              vscodeText.style.paddingLeft = '20px';

              const tips = [
                '在VS Code集成终端中运行上述命令以查看差异',
                'GitLens用户: 使用命令面板(Ctrl/Cmd+Shift+P)执行"GitLens: Compare Commits"',
                'Git Graph扩展: 提供可视化比较界面，推荐安装',
                '复制提交哈希后，可以在VS Code的源代码管理视图中右键选择"Compare with Selected"'
              ];

              tips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                li.style.marginBottom = '5px';
                vscodeText.appendChild(li);
              });

              vscodeSection.appendChild(vscodeTitle);
              vscodeSection.appendChild(vscodeText);
              content.appendChild(vscodeSection);

              // 添加关闭按钮
              const closeButton = document.createElement('button');
              closeButton.textContent = '关闭';
              closeButton.style.display = 'block';
              closeButton.style.width = '100%';
              closeButton.style.padding = '10px';
              closeButton.style.marginTop = '15px';
              closeButton.style.backgroundColor = '#f1f1f1';
              closeButton.style.color = '#333';
              closeButton.style.border = 'none';
              closeButton.style.borderRadius = '4px';
              closeButton.style.cursor = 'pointer';

              closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
              });

              content.appendChild(closeButton);

              // 关闭时也可以点击背景
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  document.body.removeChild(modal);
                }
              });

              modal.appendChild(content);
              document.body.appendChild(modal);
            }

            // 查看单个提交的变更内容（类似git show）
            function viewCommitChanges(commitHash, commitMessage) {
              console.log('查看提交变更:', commitHash, commitMessage);

              // 保存浏览位置
              savedScrollPosition = window.scrollY;

              // 禁用body滚动
              const originalBodyStyle = document.body.style.cssText;
              document.body.style.overflow = 'hidden';
              document.body.style.paddingRight = '15px'; // 防止滚动条消失导致页面抖动

              // 创建模态框
              const modal = document.createElement('div');
              modal.style.position = 'fixed';
              modal.style.top = '0';
              modal.style.left = '0';
              modal.style.width = '100%';
              modal.style.height = '100%';
              modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
              modal.style.display = 'flex';
              modal.style.alignItems = 'center';
              modal.style.justifyContent = 'center';
              modal.style.zIndex = '9999';

              // 创建内容容器
              const content = document.createElement('div');
              content.style.backgroundColor = 'white';
              content.style.padding = '20px';
              content.style.borderRadius = '8px';
              content.style.maxWidth = '90%';
              content.style.width = '90%';
              content.style.maxHeight = '90vh'; // 添加最大高度限制
              content.style.height = 'auto'; // 高度自适应
              content.style.display = 'flex';
              content.style.flexDirection = 'column';
              content.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';

              // 添加标题和头部区域
              const header = document.createElement('div');
              header.style.display = 'flex';
              header.style.justifyContent = 'space-between';
              header.style.alignItems = 'center';
              header.style.marginBottom = '10px';
              header.style.borderBottom = '1px solid #e1e4e8';
              header.style.paddingBottom = '10px';
              header.style.flexShrink = '0'; // 防止头部被压缩

              const titleArea = document.createElement('div');

              // 添加标题
              const title = document.createElement('h3');
              title.textContent = '提交详情';
              title.style.margin = '0 0 5px 0';
              title.style.fontSize = '18px';

              // 添加提交信息
              const subtitle = document.createElement('p');
              subtitle.innerHTML = `<code style="font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace; background-color: #f1f1f1; padding: 2px 4px; border-radius: 3px;">${commitHash}</code> - ${commitMessage}`;
              subtitle.style.margin = '0';
              subtitle.style.color = '#586069';
              subtitle.style.fontSize = '14px';

              titleArea.appendChild(title);
              titleArea.appendChild(subtitle);

              // 添加关闭按钮到头部
              const closeIcon = document.createElement('button');
              closeIcon.innerHTML = '&times;';
              closeIcon.style.background = 'none';
              closeIcon.style.border = 'none';
              closeIcon.style.fontSize = '24px';
              closeIcon.style.cursor = 'pointer';
              closeIcon.style.color = '#586069';
              closeIcon.style.width = '30px';
              closeIcon.style.height = '30px';
              closeIcon.style.lineHeight = '30px';
              closeIcon.style.textAlign = 'center';
              closeIcon.style.marginLeft = '15px';

              // 关闭弹窗和恢复滚动
              const closeModal = () => {
                document.body.removeChild(modal);
                document.body.style.cssText = originalBodyStyle; // 恢复body原始样式
                document.removeEventListener('keydown', handleKeyDown);
              };

              closeIcon.addEventListener('click', closeModal);

              header.appendChild(titleArea);
              header.appendChild(closeIcon);

              content.appendChild(header);

              // 添加差异查看器容器 - 可滚动部分
              const diffContainer = document.createElement('div');
              diffContainer.style.flex = '1';
              diffContainer.style.overflow = 'auto'; // 这个容器可以滚动
              diffContainer.style.minHeight = '0'; // 确保flex布局正常工作
              diffContainer.style.maxHeight = 'calc(90vh - 150px)'; // 设置最大高度，减去header和padding的高度
              diffContainer.style.paddingRight = '5px'; // 给滚动条留出空间

              // 添加差异查看器
              const diffViewer = document.createElement('div');
              diffViewer.className = 'diff-viewer';
              diffViewer.style.fontFamily = 'SFMono-Regular, Consolas, Liberation Mono, Menlo, monospace';
              diffViewer.style.fontSize = '12px';
              diffViewer.style.lineHeight = '1.5';
              diffViewer.style.width = '100%';
              diffViewer.innerHTML = '<div style="padding: 20px; text-align: center; color: #586069;">正在加载变更数据...</div>';

              diffContainer.appendChild(diffViewer);
              content.appendChild(diffContainer);

              // 点击背景关闭
              modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                  closeModal();
                }
              });

              // 添加ESC键盘事件关闭弹窗
              const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                  closeModal();
                }
              };

              document.addEventListener('keydown', handleKeyDown);

              modal.appendChild(content);
              document.body.appendChild(modal);

              // 获取Git差异数据 - 使用与保存备注相同的服务通信方式
              // 直接使用已启动的3000端口服务
              fetch(`http://localhost:3000/git/show?hash=${encodeURIComponent(commitHash)}`, {
                method: 'GET',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                }
              })
              .then(response => {
                console.log('服务器响应状态:', response.status);
                if (!response.ok) {
                  throw new Error(`服务器返回错误: ${response.status} ${response.statusText}`);
                }
                return response.json();
              })
              .then(responseObj => {
                console.log('获取到服务器响应:', responseObj);

                // 检查响应格式
                if (!responseObj.success) {
                  throw new Error(responseObj.message || '服务器返回错误');
                }

                // 获取数据部分
                const data = responseObj.data;
                console.log('提取响应数据:', data);

                // 渲染差异数据
                renderDiffData(data, diffViewer);
              })
              .catch(error => {
                console.error('获取提交变更数据失败:', error);
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #cb2431; background-color: #ffeef0; border-radius: 6px;">
                    <p style="margin: 0 0 10px 0;"><strong>获取提交变更数据失败</strong></p>
                    <p style="margin: 0; font-size: 12px;">${error.message}</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px;">请确保服务器已启动并支持获取Git差异数据。</p>
                  </div>
                `;
              });
            }

            // 渲染差异数据到差异查看器 - GitHub风格
            function renderDiffData(data, diffViewer) {
              console.log('渲染差异数据:', data);

              if (!data || !data.diff || data.diff.trim() === '') {
                diffViewer.innerHTML = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    此提交没有文件变更或数据格式不正确
                  </div>
                `;
                return;
              }

              // 解析Git差异数据
              const diffText = data.diff;

              // 分割为文件块
              const fileBlocks = parseDiffToFileBlocks(diffText);

              // 构建GitHub风格的差异视图HTML
              let html = '';

              // 检查是否有文件变更
              if (fileBlocks.length === 0) {
                html = `
                  <div style="padding: 20px; text-align: center; color: #586069; background-color: #f6f8fa; border-radius: 6px;">
                    此提交没有文件变更
                  </div>
                `;
              } else {
                // 为每个文件块创建差异视图
                fileBlocks.forEach(fileBlock => {
                  html += createGitHubStyleDiffHTML(fileBlock);
                });
              }

              diffViewer.innerHTML = html;
            }

            // 将Git差异文本解析为文件块
            function parseDiffToFileBlocks(diffText) {
              // 分割为行
              const lines = diffText.split('\n');
              const fileBlocks = [];
              let currentFile = null;
              let inFileHeader = false;
              let currentHunk = null;
              let currentHunkContent = [];

              // 遍历每一行
              lines.forEach(line => {
                // 检测文件头
                if (line.startsWith('diff --git ')) {
                  // 如果已经有一个当前文件，将其添加到文件块列表
                  if (currentFile) {
                    if (currentHunk) {
                      currentFile.hunks.push({
                        header: currentHunk,
                        content: currentHunkContent
                      });
                    }
                    fileBlocks.push(currentFile);
                  }

                  // 开始新文件
                  currentFile = {
                    header: line,
                    path: extractFilePath(line),
                    hunks: []
                  };
                  inFileHeader = true;
                  currentHunk = null;
                  currentHunkContent = [];
                }
                // 检测文件路径变更信息
                else if (inFileHeader && (line.startsWith('--- ') || line.startsWith('+++ '))) {
                  if (currentFile) {
                    currentFile.header += '\n' + line;
                  }
                }
                // 检测差异块头
                else if (line.startsWith('@@ ')) {
                  inFileHeader = false;
                  // 如果已经有一个当前差异块，将其添加到当前文件的差异块列表
                  if (currentHunk && currentFile) {
                    currentFile.hunks.push({
                      header: currentHunk,
                      content: currentHunkContent
                    });
                  }

                  // 开始新差异块
                  currentHunk = line;
                  currentHunkContent = [];
                }
                // 其他行属于当前差异块内容
                else if (currentFile) {
                  if (inFileHeader) {
                    // 还在文件头部
                    currentFile.header += '\n' + line;
                  } else if (currentHunk) {
                    // 差异块内容
                    currentHunkContent.push(line);
                  }
                }
              });

              // 添加最后一个差异块和文件
              if (currentFile && currentHunk) {
                currentFile.hunks.push({
                  header: currentHunk,
                  content: currentHunkContent
                });
                fileBlocks.push(currentFile);
              }

              return fileBlocks;
            }

            // 从diff --git行提取文件路径
            function extractFilePath(diffGitLine) {
              try {
                // 格式通常是 "diff --git a/path/to/file b/path/to/file"
                const parts = diffGitLine.split(' ');
                if (parts.length >= 4) {
                  // 获取b/path/to/file并移除开头的"b/"
                  let path = parts[3];
                  if (path.startsWith('b/')) {
                    path = path.substring(2);
                  }
                  return path;
                }
              } catch (e) {
                console.error('提取文件路径失败:', e);
              }
              return 'unknown-file';
            }

            // 创建GitHub风格的差异HTML
            function createGitHubStyleDiffHTML(fileBlock) {
              const filePath = fileBlock.path;
              const fileExtension = filePath.split('.').pop().toLowerCase();

              // 构建文件头HTML
              let html = `
                <div style="margin-bottom: 16px;">
                  <div style="background-color: #f6f8fa; border: 1px solid #e1e4e8; border-bottom: none; border-top-left-radius: 6px; border-top-right-radius: 6px; padding: 8px 16px; font-weight: 600;">
                    ${escapeHtml(filePath)}
                  </div>
              `;

              // 添加文件差异块
              fileBlock.hunks.forEach(hunk => {
                html += `
                  <div style="background-color: #f8fafd; color: #586069; padding: 4px 10px; border: 1px solid #e1e4e8; border-bottom: none; font-size: 12px;">
                    ${escapeHtml(hunk.header)}
                  </div>
                  <div style="border: 1px solid #e1e4e8; border-bottom-left-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; border-bottom-right-radius: ${hunk === fileBlock.hunks[fileBlock.hunks.length - 1] ? '6px' : '0'}; overflow: hidden;">
                    <table style="border-collapse: collapse; width: 100%; tab-size: 4;">
                      <tbody>
        `;

                  // 添加差异行
                  hunk.content.forEach(line => {
                    let lineClass = '';
                    let lineStyle = '';
                    let prefix = '';

                    if (line.startsWith('+')) {
                      lineClass = 'addition';
                      lineStyle = 'background-color: #e6ffed;';
                      prefix = '+';
                    } else if (line.startsWith('-')) {
                      lineClass = 'deletion';
                      lineStyle = 'background-color: #ffeef0;';
                      prefix = '-';
                    } else {
                      lineClass = 'context';
                      lineStyle = '';
                      prefix = ' ';
                    }

                    const lineContent = line.substring(1); // 移除前缀

                    html += `
                      <tr class="${lineClass}" style="${lineStyle}">
                        <td style="width: 1%; padding: 0 10px; text-align: right; color: #bbb; border-right: 1px solid #e1e4e8; user-select: none;">${prefix}</td>
                        <td style="padding: 0 10px; white-space: pre-wrap; word-break: break-all;">${escapeHtml(lineContent)}</td>
                      </tr>
                    `;
                  });

                  html += `
                        </tbody>
                      </table>
                    </div>
                  `;
                });

                html += `</div>`;

                return html;
              }

              // 转义HTML特殊字符的辅助函数
              function escapeHtml(str) {
                if (!str) return '';
                return str
                  .replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#039;');
              }
    </script>
  </body>
</html>
