<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>分支对比: main vs feature/test</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
    <style>
      /**
 * Playful Geometric Design Tokens
 * Punchy, High-Saturation Palette with Hard Shadows
 */

@import url("https://fonts.googleapis.com/css2?family=Outfit:wght@700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap");

:root {
  /* ========== Colors - Playful Geometric ========== */

  /* Base Surface */
  --color-bg: #fffdf5; /* Warm Cream/Off-White (Paper feel) */

  /* Text Colors - WCAG Compliant */
  --color-fg: #1e293b; /* Slate 800 (Softer than black) - AAA */
  --color-muted: #64748b; /* Slate 500 - AA */

  /* Accent Colors - Playful Palette */
  --color-accent: #8b5cf6; /* Vivid Violet (Primary Brand) */
  --color-accent-light: #a78bfa; /* Lighter violet for hover */
  --color-secondary: #f472b6; /* Hot Pink (Playful pop) */
  --color-tertiary: #fbbf24; /* Amber/Yellow (Optimism) */
  --color-quaternary: #34d399; /* Emerald/Mint (Freshness) */

  /* Semantic Colors */
  --color-success: #34d399;
  --color-warning: #fbbf24;
  --color-danger: #f472b6;
  --color-info: #8b5cf6;

  /* Neutral Colors */
  --color-border: #e2e8f0; /* Slate 200 */
  --color-card: #ffffff; /* White */
  --color-input: #ffffff; /* White */

  /* ========== Shadows - Hard "Pop" Shadows ========== */

  /* The "Pop" Shadow (Hard Shadow) - No blur, solid offset */
  --shadow-pop: 4px 4px 0px 0px var(--color-fg);
  --shadow-pop-hover: 6px 6px 0px 0px var(--color-fg);
  --shadow-pop-active: 2px 2px 0px 0px var(--color-fg);

  /* Card Shadows - Colored for different states */
  --shadow-card: 8px 8px 0px 0px var(--color-border);
  --shadow-card-hover: 10px 10px 0px 0px var(--color-border);
  --shadow-card-success: 8px 8px 0px 0px var(--color-success);
  --shadow-card-warning: 8px 8px 0px 0px var(--color-warning);
  --shadow-card-accent: 8px 8px 0px 0px var(--color-accent);

  /* Small Shadows */
  --shadow-small: 2px 2px 0px 0px var(--color-fg);
  --shadow-small-hover: 3px 3px 0px 0px var(--color-fg);

  /* ========== Border Radius - Playful & Varied ========== */

  --radius-sm: 8px; /* Small elements */
  --radius-md: 16px; /* Medium elements */
  --radius-lg: 24px; /* Large elements */
  --radius-xl: 32px; /* Extra large containers */
  --radius-full: 9999px; /* Pills and circles */

  /* ========== Typography ========== */

  --font-display: "Outfit", system-ui, sans-serif; /* Geometric, friendly headings */
  --font-body: "Plus Jakarta Sans", system-ui, sans-serif; /* Legible, modern body */
  --font-mono: "SF Mono", "Monaco", "Inconsolata", "Fira Code", monospace;

  /* Font Weights */
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  --font-weight-extrabold: 800;

  /* Font Sizes - Balanced scale (Major Third 1.25) */
  --font-size-xs: 0.75rem; /* 12px */
  --font-size-sm: 0.875rem; /* 14px */
  --font-size-base: 1rem; /* 16px */
  --font-size-lg: 1.125rem; /* 18px */
  --font-size-xl: 1.25rem; /* 20px */
  --font-size-2xl: 1.563rem; /* 25px */
  --font-size-3xl: 1.953rem; /* 31px */
  --font-size-4xl: 2.441rem; /* 39px */
  --font-size-5xl: 3.052rem; /* 49px */

  /* Line Heights */
  --line-height-tight: 1.25;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.75;

  /* ========== Spacing ========== */

  --spacing-1: 0.25rem; /* 4px */
  --spacing-2: 0.5rem; /* 8px */
  --spacing-3: 0.75rem; /* 12px */
  --spacing-4: 1rem; /* 16px */
  --spacing-5: 1.25rem; /* 20px */
  --spacing-6: 1.5rem; /* 24px */
  --spacing-8: 2rem; /* 32px */
  --spacing-10: 2.5rem; /* 40px */
  --spacing-12: 3rem; /* 48px */
  --spacing-16: 4rem; /* 64px */
  --spacing-20: 5rem; /* 80px */
  --spacing-24: 6rem; /* 96px */

  /* ========== Borders ========== */

  --border-width: 2px; /* Chunky borders by default */
  --border-color: var(--color-fg);

  /* ========== Transitions - Bouncy & Elastic ========== */

  --transition-fast: 150ms cubic-bezier(0.34, 1.56, 0.64, 1);
  --transition-base: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
  --transition-slow: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* ========== Z-Index ========== */

  --z-base: 1;
  --z-dropdown: 10;
  --z-sticky: 20;
  --z-fixed: 30;
  --z-modal-backdrop: 40;
  --z-modal: 50;
  --z-tooltip: 60;

  /* ========== Breakpoints (for reference) ========== */

  --breakpoint-sm: 640px;
  --breakpoint-md: 768px;
  --breakpoint-lg: 1024px;
  --breakpoint-xl: 1280px;
}

/**
 * Base Styles - Global Resets and Typography
 * Playful Geometric Design System
 */

/* ========== Global Reset ========== */

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: var(--font-body);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-normal);
  line-height: var(--line-height-normal);
  color: var(--color-fg);
  background: var(--color-bg);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  padding: var(--spacing-4);
  min-height: 100vh;
  position: relative;
}

/* Playful dot grid background pattern */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: radial-gradient(
    circle,
    var(--color-border) 1px,
    transparent 1px
  );
  background-size: 24px 24px;
  opacity: 0.4;
  pointer-events: none;
  z-index: 0;
}

body > * {
  position: relative;
  z-index: 1;
}

/* ========== Typography ========== */

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: var(--font-display);
  font-weight: var(--font-weight-extrabold);
  line-height: var(--line-height-tight);
  color: var(--color-fg);
  margin-bottom: var(--spacing-4);
}

h1 {
  font-size: var(--font-size-4xl);
  position: relative;
  display: inline-block;
}

/* Squiggle decoration under h1 */
h1::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 100%;
  height: 4px;
  background-image: url("data:image/svg+xml,%3Csvg width='100' height='4' viewBox='0 0 100 4' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 2 Q 5 0, 10 2 T 20 2 T 30 2 T 40 2 T 50 2 T 60 2 T 70 2 T 80 2 T 90 2 T 100 2' stroke='%238B5CF6' stroke-width='2' fill='none'/%3E%3C/svg%3E");
  background-repeat: repeat-x;
  background-size: 100px 4px;
}

h2 {
  font-size: var(--font-size-3xl);
}

h3 {
  font-size: var(--font-size-2xl);
}

p {
  margin-bottom: var(--spacing-4);
}

/* ========== Links ========== */

a {
  color: var(--color-accent);
  text-decoration: none;
  transition: color var(--transition-fast);
}

a:hover {
  color: var(--color-accent-light);
}

a:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
  border-radius: var(--radius-small);
}

/* ========== Buttons Reset ========== */

button {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  cursor: pointer;
  border: none;
  background: none;
}

button:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* ========== Inputs Reset ========== */

input,
textarea,
select {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  color: inherit;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
}

/* ========== Accessibility ========== */

/* Focus visible for keyboard navigation */
:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

/* Skip to content link */
.skip-to-content {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--color-accent);
  color: white;
  padding: var(--spacing-2) var(--spacing-4);
  border-radius: var(--radius-base);
  z-index: var(--z-tooltip);
}

.skip-to-content:focus {
  top: var(--spacing-2);
}

/* Screen reader only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* ========== Scrollbar Styling - Playful ========== */

::-webkit-scrollbar {
  width: 14px;
  height: 14px;
}

::-webkit-scrollbar-track {
  background: var(--color-bg);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb {
  background: var(--color-accent);
  border-radius: var(--radius-sm);
  border: 2px solid var(--color-fg);
  box-shadow: var(--shadow-small);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--color-accent-light);
  box-shadow: var(--shadow-small-hover);
}

/* ========== Selection ========== */

::selection {
  background: var(--color-tertiary);
  color: var(--color-fg);
}

::-moz-selection {
  background: var(--color-tertiary);
  color: var(--color-fg);
}

/* ========== Reduced Motion ========== */

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }

  html {
    scroll-behavior: auto;
  }
}

/**
 * Layout Styles 布局样式
 * Playful Geometric Design System - Layout Components
 */

/* ========== Container 容器 ========== */

.container {
  max-width: 1280px;
  margin: 0 auto;
  background: var(--color-card);
  border-radius: var(--radius-xl);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-card);
  padding: var(--spacing-8);
}

/* ========== Header 头部 ========== */

.header {
  margin-bottom: var(--spacing-8);
  padding-bottom: var(--spacing-6);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: var(--spacing-6);
  border-bottom: 3px dashed var(--color-border);
}

.header h1 {
  margin: 0 0 var(--spacing-4) 0;
  color: var(--color-fg);
  font-family: var(--font-display);
  font-size: var(--font-size-4xl);
  font-weight: var(--font-weight-extrabold);
  letter-spacing: -0.02em;
  position: relative;
  display: inline-block;
}

.meta-info {
  color: var(--color-muted);
  font-size: var(--font-size-sm);
  line-height: 1.8;
  font-weight: var(--font-weight-medium);
}

.meta-info > div {
  margin-bottom: var(--spacing-2);
}

/* ========== Legend 图例 ========== */

.timeline-legend {
  display: flex;
  justify-content: flex-start;
  flex-wrap: wrap;
  gap: var(--spacing-4);
  margin-top: var(--spacing-5);
}

.legend-item {
  display: inline-flex;
  align-items: center;
  background: var(--color-bg);
  padding: var(--spacing-1) var(--spacing-3);
  border-radius: var(--radius-full);
  box-shadow: var(--shadow-extruded-small);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-fg);
  transition: all var(--transition-base);
  min-height: 36px;
}

.legend-item:hover {
  transform: translateY(-2px);
  box-shadow: 8px 8px 16px rgba(163, 177, 198, 0.5),
    -8px -8px 16px rgba(255, 255, 255, 0.8);
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: var(--spacing-2);
  display: inline-block;
  box-shadow: inset 2px 2px 4px rgba(163, 177, 198, 0.3),
    inset -2px -2px 4px rgba(255, 255, 255, 0.5);
}

.legend-dot.source {
  background-color: var(--color-success);
}

.legend-dot.target {
  background-color: var(--color-warning);
}

.legend-dot.both {
  background-color: var(--color-info);
}

/* ========== Theme Switcher 主题切换器 ========== */

.theme-switcher {
  display: flex;
  align-items: center;
  background: var(--color-bg);
  border-radius: var(--radius-full);
  padding: var(--spacing-1);
  box-shadow: var(--shadow-inset);
  gap: var(--spacing-1);
}

.theme-button {
  border: none;
  background: transparent;
  color: var(--color-muted);
  padding: var(--spacing-2) var(--spacing-4);
  border-radius: var(--radius-full);
  cursor: pointer;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-semibold);
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  transition: all var(--transition-base);
  min-height: 36px;
  white-space: nowrap;
}

.theme-button:hover:not(.active) {
  color: var(--color-fg);
}

.theme-button.active {
  background: var(--color-accent);
  color: white;
  box-shadow: var(--shadow-extruded-small);
}

.theme-button .layout-icon {
  font-size: var(--font-size-base);
}

/* ========== Timeline 时间线 ========== */

.timeline {
  position: relative;
  display: flex;
  flex-direction: column;
  padding: var(--spacing-4) 0;
  width: 100%;
}

.commit-row {
  display: flex;
  margin-bottom: var(--spacing-4);
  position: relative;
  width: 100%;
  animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

/* ========== Commit Container 提交容器 ========== */

.commit-container {
  max-width: 75%;
  width: 75%;
  position: relative;
}

.commit-container.source {
  align-self: flex-start;
  margin-right: auto;
}

.commit-container.target {
  align-self: flex-end;
  margin-left: auto;
}

.commit-container.both {
  align-self: center;
  max-width: 90%;
  width: 90%;
  margin: 0 auto;
}

/* ========== Flat Layout 平铺布局 ========== */

body[data-layout="flat"] .timeline .commit-row {
  justify-content: center;
}

body[data-layout="flat"] .timeline .commit-container {
  max-width: 100%;
  width: 100%;
  margin: 0 auto;
  align-self: center;
}

body[data-layout="flat"] .timeline .commit-container.both {
  max-width: 100%;
}

/* ========== Filter Section 筛选区域 ========== */

.filter-section {
  margin-bottom: var(--spacing-6);
  padding: var(--spacing-6);
  background: var(--color-card);
  border-radius: var(--radius-xl);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-card);
}

.filter-buttons {
  display: flex;
  gap: var(--spacing-3);
  margin-bottom: var(--spacing-6);
  flex-wrap: wrap;
}

.sub-filter-section {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-5);
  margin: var(--spacing-5) 0 0 0;
  padding: var(--spacing-5);
  background: rgba(139, 92, 246, 0.05);
  border-radius: var(--radius-md);
  border: 2px dashed var(--color-accent);
  transition: all var(--transition-base);
  max-height: 200px;
  overflow: hidden;
}

.sub-filter-section.hidden {
  max-height: 0;
  margin: 0;
  padding: 0;
  opacity: 0;
  border: none;
}

/* ========== Search Section 搜索区域 ========== */

.search-section {
  margin-top: var(--spacing-6);
  padding: var(--spacing-5);
  background: rgba(251, 191, 36, 0.08);
  border-radius: var(--radius-md);
  border: 2px dashed var(--color-tertiary);
}

.search-container {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
  margin-bottom: var(--spacing-5);
  gap: var(--spacing-3);
  flex-wrap: wrap;
}

.search-input {
  flex: 1 1 280px;
  min-width: 200px;
  max-width: 100%;
  padding-right: 44px;
}

.clear-search {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  flex-shrink: 0;
  width: 32px;
  height: 32px;
  min-width: 32px;
  min-height: 32px;
  border-radius: 50%;
  background: var(--color-secondary);
  color: white;
  border: var(--border-width) solid var(--color-fg);
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: var(--font-weight-extrabold);
  box-shadow: var(--shadow-small);
  transition: all var(--transition-base);
  z-index: 10;
  opacity: 0;
  visibility: hidden;
}

.clear-search.visible {
  display: flex;
  opacity: 1;
  visibility: visible;
}

.clear-search:hover {
  background: var(--color-danger);
  transform: translateY(-50%) translate(-2px, -2px) rotate(-5deg);
  box-shadow: var(--shadow-small-hover);
}

.clear-search:active {
  transform: translateY(-50%) translate(1px, 1px) rotate(0deg);
  box-shadow: var(--shadow-pop-active);
}

.search-options {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-4);
  align-items: center;
  width: 100%;
}

/* ========== Command Section 命令区域 ========== */

.command-section {
  margin-top: var(--spacing-8);
  background: var(--color-card);
  padding: var(--spacing-8);
  border-radius: var(--radius-xl);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-card);
}

.command-section h3 {
  margin: 0 0 var(--spacing-5) 0;
  color: var(--color-fg);
  font-family: var(--font-display);
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-extrabold);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-4);
  flex-wrap: nowrap;
}

.command-section h3 > span:first-child {
  white-space: nowrap;
}

.copy-button {
  flex-shrink: 0;
  white-space: nowrap;
}

.command-tabs {
  display: flex;
  gap: var(--spacing-2);
  margin-bottom: var(--spacing-6);
  background: var(--color-bg);
  padding: var(--spacing-2);
  border-radius: var(--radius-full);
  border: var(--border-width) solid var(--color-border);
}

.command-content {
  display: none;
}

.command-content.active {
  display: block;
}

.command-line {
  display: flex;
  align-items: center;
  margin: var(--spacing-3) 0;
  gap: var(--spacing-3);
  padding: var(--spacing-4) var(--spacing-5);
  background: linear-gradient(
    135deg,
    rgba(30, 41, 59, 0.98) 0%,
    rgba(15, 23, 42, 0.98) 100%
  );
  border-radius: var(--radius-md);
  border-left: 4px solid var(--color-accent);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
  transition: all var(--transition-fast);
}

.command-line:hover {
  border-left-color: var(--color-accent-light);
  transform: translate(-1px, -1px);
  box-shadow: var(--shadow-small-hover);
}

.command-line pre {
  margin: 0;
  flex-grow: 1;
  font-family: var(--font-mono);
  font-size: var(--font-size-sm);
  white-space: pre-wrap;
  overflow-x: auto;
  color: #e2e8f0;
  line-height: 1.7;
  font-weight: var(--font-weight-medium);
}

.command-line pre code {
  color: #8b5cf6;
  text-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
  font-weight: var(--font-weight-bold);
}

/* Git 命令语法高亮 */
.git-keyword {
  color: #f472b6;
  font-weight: var(--font-weight-extrabold);
  text-shadow: 0 0 8px rgba(244, 114, 182, 0.5);
}

.git-subcommand {
  color: #8b5cf6;
  font-weight: var(--font-weight-bold);
  text-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
}

.git-hash {
  color: #fbbf24;
  font-weight: var(--font-weight-bold);
  text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
}

.git-branch {
  color: #34d399;
  font-weight: var(--font-weight-semibold);
  text-shadow: 0 0 8px rgba(52, 211, 153, 0.3);
}

.git-comment {
  color: #94a3b8;
  font-style: italic;
  font-weight: var(--font-weight-normal);
}

#source-to-target-commands-container,
#target-to-source-commands-container {
  max-height: 450px;
  overflow-y: auto;
  padding: var(--spacing-4);
  background: rgba(139, 92, 246, 0.03);
  border-radius: var(--radius-md);
  border: 2px dashed var(--color-border);
}

/* ========== Responsive Design 响应式设计 ========== */

@media (max-width: 1024px) {
  .container {
    padding: var(--spacing-6);
  }

  .commit-container {
    max-width: 85%;
  }

  body[data-layout="flat"] .timeline .commit-container {
    max-width: 100%;
  }
}

@media (max-width: 768px) {
  body {
    padding: var(--spacing-3);
  }

  .container {
    padding: var(--spacing-5);
    border-radius: var(--radius-md);
  }

  .header {
    flex-direction: column;
    gap: var(--spacing-5);
    padding-bottom: var(--spacing-5);
  }

  .header h1 {
    font-size: var(--font-size-3xl);
  }

  .header h1::after {
    display: none;
  }

  .timeline-legend {
    gap: var(--spacing-3);
    justify-content: flex-start;
  }

  .legend-item {
    font-size: var(--font-size-xs);
    padding: var(--spacing-2) var(--spacing-4);
  }

  .theme-switcher {
    width: 100%;
  }

  .theme-button {
    flex: 1;
    justify-content: center;
    padding: var(--spacing-3) var(--spacing-4);
  }

  .timeline {
    padding: var(--spacing-4) 0;
  }

  .commit-container,
  .commit-container.source,
  .commit-container.target,
  .commit-container.both {
    max-width: 100%;
  }

  body[data-layout="flat"] .timeline .commit-container {
    max-width: 100%;
  }

  .filter-section {
    padding: var(--spacing-5);
  }

  .filter-buttons {
    gap: var(--spacing-2);
  }

  .search-container {
    flex-direction: column;
    align-items: stretch;
    gap: var(--spacing-3);
  }

  .search-input {
    flex: 1;
    max-width: 100%;
    min-width: 100%;
  }

  .clear-search {
    right: 8px;
  }

  .search-options {
    gap: var(--spacing-3);
    flex-wrap: wrap;
  }

  .command-section {
    padding: var(--spacing-5);
    margin-top: var(--spacing-6);
  }

  .command-section h3 {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-3);
    font-size: var(--font-size-xl);
  }

  .command-tabs {
    flex-direction: column;
    width: 100%;
  }
}

@media (max-width: 480px) {
  .container {
    padding: var(--spacing-4);
  }

  .header h1 {
    font-size: var(--font-size-2xl);
  }

  .filter-section,
  .command-section {
    padding: var(--spacing-4);
  }

  .legend-item {
    padding: var(--spacing-2) var(--spacing-3);
  }

  .legend-dot {
    width: 12px;
    height: 12px;
  }
}

/**
 * Utility Classes 工具类
 * Neumorphism Design System - Utility Classes
 */

/* ========== Display 显示 ========== */

.hidden {
  display: none !important;
}

.block {
  display: block !important;
}

.inline-block {
  display: inline-block !important;
}

.flex {
  display: flex !important;
}

.inline-flex {
  display: inline-flex !important;
}

/* ========== Visibility 可见性 ========== */

.invisible {
  visibility: hidden !important;
}

.visible {
  visibility: visible !important;
}

/* ========== Flex Direction 弹性方向 ========== */

.flex-row {
  flex-direction: row !important;
}

.flex-col {
  flex-direction: column !important;
}

/* ========== Flex Wrap 弹性换行 ========== */

.flex-wrap {
  flex-wrap: wrap !important;
}

.flex-nowrap {
  flex-wrap: nowrap !important;
}

/* ========== Justify Content 主轴对齐 ========== */

.justify-start {
  justify-content: flex-start !important;
}

.justify-center {
  justify-content: center !important;
}

.justify-end {
  justify-content: flex-end !important;
}

.justify-between {
  justify-content: space-between !important;
}

/* ========== Align Items 交叉轴对齐 ========== */

.items-start {
  align-items: flex-start !important;
}

.items-center {
  align-items: center !important;
}

.items-end {
  align-items: flex-end !important;
}

/* ========== Text Alignment 文本对齐 ========== */

.text-left {
  text-align: left !important;
}

.text-center {
  text-align: center !important;
}

.text-right {
  text-align: right !important;
}

/* ========== Text Transform 文本转换 ========== */

.uppercase {
  text-transform: uppercase !important;
}

.lowercase {
  text-transform: lowercase !important;
}

.capitalize {
  text-transform: capitalize !important;
}

/* ========== Font Weight 字体粗细 ========== */

.font-normal {
  font-weight: var(--font-weight-normal) !important;
}

.font-medium {
  font-weight: var(--font-weight-medium) !important;
}

.font-semibold {
  font-weight: var(--font-weight-semibold) !important;
}

.font-bold {
  font-weight: var(--font-weight-bold) !important;
}

.font-extrabold {
  font-weight: var(--font-weight-extrabold) !important;
}

/* ========== Font Size 字体大小 ========== */

.text-xs {
  font-size: var(--font-size-xs) !important;
}

.text-sm {
  font-size: var(--font-size-sm) !important;
}

.text-base {
  font-size: var(--font-size-base) !important;
}

.text-lg {
  font-size: var(--font-size-lg) !important;
}

.text-xl {
  font-size: var(--font-size-xl) !important;
}

/* ========== Color 颜色 ========== */

.text-muted {
  color: var(--color-muted) !important;
}

.text-fg {
  color: var(--color-fg) !important;
}

.text-success {
  color: var(--color-success) !important;
}

.text-warning {
  color: var(--color-warning) !important;
}

.text-danger {
  color: var(--color-danger) !important;
}

.text-info {
  color: var(--color-info) !important;
}

/* ========== Margin 外边距 ========== */

.m-0 {
  margin: 0 !important;
}
.m-1 {
  margin: var(--spacing-1) !important;
}
.m-2 {
  margin: var(--spacing-2) !important;
}
.m-3 {
  margin: var(--spacing-3) !important;
}
.m-4 {
  margin: var(--spacing-4) !important;
}
.m-5 {
  margin: var(--spacing-5) !important;
}
.m-6 {
  margin: var(--spacing-6) !important;
}
.m-8 {
  margin: var(--spacing-8) !important;
}

.mt-0 {
  margin-top: 0 !important;
}
.mt-2 {
  margin-top: var(--spacing-2) !important;
}
.mt-3 {
  margin-top: var(--spacing-3) !important;
}
.mt-4 {
  margin-top: var(--spacing-4) !important;
}
.mt-6 {
  margin-top: var(--spacing-6) !important;
}
.mt-8 {
  margin-top: var(--spacing-8) !important;
}

.mb-0 {
  margin-bottom: 0 !important;
}
.mb-2 {
  margin-bottom: var(--spacing-2) !important;
}
.mb-3 {
  margin-bottom: var(--spacing-3) !important;
}
.mb-4 {
  margin-bottom: var(--spacing-4) !important;
}
.mb-6 {
  margin-bottom: var(--spacing-6) !important;
}
.mb-8 {
  margin-bottom: var(--spacing-8) !important;
}

.ml-0 {
  margin-left: 0 !important;
}
.ml-2 {
  margin-left: var(--spacing-2) !important;
}
.ml-3 {
  margin-left: var(--spacing-3) !important;
}
.ml-4 {
  margin-left: var(--spacing-4) !important;
}
.ml-auto {
  margin-left: auto !important;
}

.mr-0 {
  margin-right: 0 !important;
}
.mr-2 {
  margin-right: var(--spacing-2) !important;
}
.mr-3 {
  margin-right: var(--spacing-3) !important;
}
.mr-4 {
  margin-right: var(--spacing-4) !important;
}
.mr-auto {
  margin-right: auto !important;
}

/* ========== Padding 内边距 ========== */

.p-0 {
  padding: 0 !important;
}
.p-2 {
  padding: var(--spacing-2) !important;
}
.p-3 {
  padding: var(--spacing-3) !important;
}
.p-4 {
  padding: var(--spacing-4) !important;
}
.p-5 {
  padding: var(--spacing-5) !important;
}
.p-6 {
  padding: var(--spacing-6) !important;
}
.p-8 {
  padding: var(--spacing-8) !important;
}

.pt-2 {
  padding-top: var(--spacing-2) !important;
}
.pt-3 {
  padding-top: var(--spacing-3) !important;
}
.pt-4 {
  padding-top: var(--spacing-4) !important;
}
.pt-6 {
  padding-top: var(--spacing-6) !important;
}

.pb-2 {
  padding-bottom: var(--spacing-2) !important;
}
.pb-3 {
  padding-bottom: var(--spacing-3) !important;
}
.pb-4 {
  padding-bottom: var(--spacing-4) !important;
}
.pb-6 {
  padding-bottom: var(--spacing-6) !important;
}

.pl-2 {
  padding-left: var(--spacing-2) !important;
}
.pl-3 {
  padding-left: var(--spacing-3) !important;
}
.pl-4 {
  padding-left: var(--spacing-4) !important;
}
.pl-6 {
  padding-left: var(--spacing-6) !important;
}

.pr-2 {
  padding-right: var(--spacing-2) !important;
}
.pr-3 {
  padding-right: var(--spacing-3) !important;
}
.pr-4 {
  padding-right: var(--spacing-4) !important;
}
.pr-6 {
  padding-right: var(--spacing-6) !important;
}

/* ========== Gap 间距 ========== */

.gap-1 {
  gap: var(--spacing-1) !important;
}
.gap-2 {
  gap: var(--spacing-2) !important;
}
.gap-3 {
  gap: var(--spacing-3) !important;
}
.gap-4 {
  gap: var(--spacing-4) !important;
}
.gap-5 {
  gap: var(--spacing-5) !important;
}
.gap-6 {
  gap: var(--spacing-6) !important;
}

/* ========== Width 宽度 ========== */

.w-full {
  width: 100% !important;
}

.w-auto {
  width: auto !important;
}

/* ========== Height 高度 ========== */

.h-full {
  height: 100% !important;
}

.h-auto {
  height: auto !important;
}

/* ========== Cursor 光标 ========== */

.cursor-pointer {
  cursor: pointer !important;
}

.cursor-not-allowed {
  cursor: not-allowed !important;
}

.cursor-default {
  cursor: default !important;
}

/* ========== Opacity 透明度 ========== */

.opacity-0 {
  opacity: 0 !important;
}
.opacity-50 {
  opacity: 0.5 !important;
}
.opacity-75 {
  opacity: 0.75 !important;
}
.opacity-100 {
  opacity: 1 !important;
}

/* ========== Overflow 溢出 ========== */

.overflow-hidden {
  overflow: hidden !important;
}

.overflow-auto {
  overflow: auto !important;
}

.overflow-scroll {
  overflow: scroll !important;
}

/* ========== Position 定位 ========== */

.relative {
  position: relative !important;
}

.absolute {
  position: absolute !important;
}

.fixed {
  position: fixed !important;
}

.sticky {
  position: sticky !important;
}

/* ========== Z-Index 层级 ========== */

.z-10 {
  z-index: 10 !important;
}

.z-20 {
  z-index: 20 !important;
}

.z-50 {
  z-index: 50 !important;
}

.z-100 {
  z-index: 100 !important;
}

/* ========== Border Radius 圆角 ========== */

.rounded-none {
  border-radius: 0 !important;
}

.rounded-sm {
  border-radius: var(--radius-sm) !important;
}

.rounded {
  border-radius: var(--radius-md) !important;
}

.rounded-lg {
  border-radius: var(--radius-lg) !important;
}

.rounded-xl {
  border-radius: var(--radius-xl) !important;
}

.rounded-full {
  border-radius: var(--radius-full) !important;
}

/* ========== Transitions 过渡 ========== */

.transition-all {
  transition: all var(--transition-base) !important;
}

.transition-fast {
  transition: all var(--transition-fast) !important;
}

.transition-none {
  transition: none !important;
}

/* ========== Transform 变换 ========== */

.scale-95 {
  transform: scale(0.95) !important;
}

.scale-100 {
  transform: scale(1) !important;
}

.scale-105 {
  transform: scale(1.05) !important;
}

/* ========== Pointer Events 指针事件 ========== */

.pointer-events-none {
  pointer-events: none !important;
}

.pointer-events-auto {
  pointer-events: auto !important;
}

/* ========== User Select 用户选择 ========== */

.select-none {
  user-select: none !important;
}

.select-text {
  user-select: text !important;
}

.select-all {
  user-select: all !important;
}

/* ========== Highlight 高亮 ========== */

.highlight {
  background: var(--color-tertiary);
  border-radius: var(--radius-sm);
  padding: 2px 6px;
  border: 1px solid var(--color-fg);
  box-shadow: var(--shadow-small);
  font-weight: var(--font-weight-bold);
  color: var(--color-fg);
  display: inline;
}

/* 可选的高亮样式 */
.highlight-accent {
  background: var(--color-accent);
  color: white;
  border-radius: var(--radius-sm);
  padding: 2px 6px;
  border: 1px solid var(--color-fg);
  box-shadow: var(--shadow-small);
  font-weight: var(--font-weight-bold);
  display: inline;
}

.highlight-secondary {
  background: var(--color-secondary);
  color: white;
  border-radius: var(--radius-sm);
  padding: 2px 6px;
  border: 1px solid var(--color-fg);
  box-shadow: var(--shadow-small);
  font-weight: var(--font-weight-bold);
  display: inline;
}

.highlight-underline {
  background: transparent;
  border-bottom: 3px solid var(--color-tertiary);
  padding: 0 2px;
  font-weight: var(--font-weight-bold);
  color: var(--color-fg);
  display: inline;
}

/* ========== Scrollbar Styling 滚动条样式 ========== */

.custom-scrollbar::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: var(--color-bg);
  border-radius: var(--radius-full);
  border: 1px solid var(--color-border);
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: var(--color-accent);
  border-radius: var(--radius-full);
  border: 1px solid var(--color-fg);
  transition: background var(--transition-fast);
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--color-accent-light);
}

/* ========== Playful Animations 趣味动画 ========== */

.bounce-in {
  animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
  }
}

.wiggle {
  animation: wiggle 0.5s ease-in-out;
}

@keyframes wiggle {
  0%,
  100% {
    transform: rotate(0deg);
  }
  25% {
    transform: rotate(3deg);
  }
  75% {
    transform: rotate(-3deg);
  }
}

.float {
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%,
  100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

/**
 * Component Styles - Playful Geometric Design System
 * All UI components with hard "pop" shadows and playful interactions
 */

/* ========== Buttons - "Candy Button" Style ========== */

.btn,
.filter-button,
.command-tab,
.copy-button,
.copy-line-button,
.modal-button,
.remark-modal-button,
.theme-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-3) var(--spacing-5);
  border-radius: var(--radius-full);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-bold);
  font-family: var(--font-body);
  background: var(--color-card);
  color: var(--color-fg);
  border: var(--border-width) solid var(--color-fg);
  cursor: pointer;
  box-shadow: var(--shadow-pop);
  transition: all var(--transition-base);
  min-height: 40px;
  min-width: 40px;
  position: relative;
}

.btn:hover,
.filter-button:hover,
.copy-button:hover,
.copy-line-button:hover,
.modal-button:hover,
.remark-modal-button:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-pop-hover);
}

.btn:active,
.filter-button:active,
.copy-button:active,
.modal-button:active,
.remark-modal-button:active {
  transform: translate(2px, 2px);
  box-shadow: var(--shadow-pop-active);
}

/* Primary Button (Accent) - The "Candy Button" */
.btn-primary,
.filter-button.active,
.command-tab.active,
.theme-button.active,
.modal-button.confirm,
.remark-save {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-fg);
}

.btn-primary:hover,
.filter-button.active:hover,
.modal-button.confirm:hover,
.remark-save:hover {
  background: var(--color-accent-light);
}

/* Secondary Button - Fills with yellow on hover */
.btn-secondary,
.filter-button {
  background: transparent;
  color: var(--color-fg);
  border: var(--border-width) solid var(--color-fg);
}

.btn-secondary:hover,
.filter-button:hover:not(.active) {
  background: var(--color-tertiary);
  color: var(--color-fg);
}

/* Success Button */
.btn-success {
  background: var(--color-success);
  color: var(--color-fg);
  border-color: var(--color-fg);
}

/* Danger Button */
.btn-danger,
.remark-delete {
  background: var(--color-secondary);
  color: white;
  border-color: var(--color-fg);
}

/* Info Button */
.btn-info {
  background: var(--color-info);
  color: white;
  border-color: var(--color-fg);
}

/* Small Buttons */
.btn-small,
.ignore-button,
.remark-button,
.vscode-button,
.view-changes-btn,
.compare-in-vscode,
.copy-line-button {
  padding: var(--spacing-2) var(--spacing-3);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-bold);
  min-height: 32px;
  border-radius: var(--radius-md);
  white-space: nowrap;
  flex-shrink: 0;
}

.ignore-button {
  background: var(--color-secondary);
  color: white;
  border-color: var(--color-fg);
}

.remark-button {
  background: var(--color-info);
  color: white;
  border-color: var(--color-fg);
}

.ignore-button:hover,
.remark-button:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-pop-hover);
}

.vscode-button,
.compare-in-vscode {
  background: #0066b8;
  color: white;
  border-color: var(--color-fg);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-1);
  flex-shrink: 0;
}

.vscode-button svg,
.compare-in-vscode svg {
  width: 14px;
  height: 14px;
  min-width: 14px;
  min-height: 14px;
  fill: currentColor;
  display: block;
  flex-shrink: 0;
  stroke-width: 2.5px;
}

.view-changes-btn {
  background: var(--color-card);
  color: var(--color-fg);
  border-color: var(--color-fg);
}

/* Command Tab - Lightweight with SVG Icons */
.command-tab {
  background: transparent;
  box-shadow: none;
  color: var(--color-muted);
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  padding: var(--spacing-2) var(--spacing-4);
  min-height: 36px;
  font-weight: var(--font-weight-medium);
  transition: all var(--transition-fast);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-2);
  white-space: nowrap;
}

.command-tab:hover:not(.active) {
  color: var(--color-fg);
  background: rgba(251, 191, 36, 0.1);
  border-color: var(--color-border);
}

.command-tab.active {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
  font-weight: var(--font-weight-semibold);
  box-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
}

/* Branch Badge in Command Tab */
.branch-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.8125rem;
  font-weight: var(--font-weight-semibold);
  border: 1px solid transparent;
  white-space: nowrap;
  transition: all var(--transition-fast);
}

.branch-badge.source {
  background: rgba(52, 211, 153, 0.15);
  color: #059669;
}

.branch-badge.target {
  background: rgba(251, 191, 36, 0.15);
  color: #d97706;
}

.command-tab.active .branch-badge {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border-color: rgba(255, 255, 255, 0.3);
}

/* Branch Icon SVG */
.branch-icon {
  width: 12px;
  height: 12px;
  fill: currentColor;
  flex-shrink: 0;
  opacity: 0.8;
}

/* Arrow Icon SVG */
.arrow-icon {
  width: 14px;
  height: 14px;
  fill: currentColor;
  flex-shrink: 0;
  opacity: 0.6;
  transition: all var(--transition-fast);
}

.command-tab:hover .arrow-icon {
  opacity: 1;
  transform: translateX(2px);
}

.command-tab.active .arrow-icon {
  opacity: 1;
}

/* Theme/Layout Switcher */
.theme-switcher {
  display: inline-flex;
  align-items: center;
  background: var(--color-card);
  border-radius: var(--radius-full);
  padding: var(--spacing-1);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-pop);
  gap: var(--spacing-1);
}

.theme-button {
  border-radius: var(--radius-full);
  padding: var(--spacing-2) var(--spacing-4);
  min-height: 36px;
  gap: var(--spacing-2);
  box-shadow: none;
  background: transparent;
  color: var(--color-muted);
  border: var(--border-width) solid transparent;
}

.theme-button.active {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-fg);
  box-shadow: var(--shadow-small);
}

.theme-button:hover:not(.active) {
  color: var(--color-fg);
  background: var(--color-tertiary);
  transform: none;
  box-shadow: none;
}

/* ========== Cards - "Sticker" Style ========== */

.card,
.container {
  background: var(--color-card);
  border-radius: var(--radius-xl);
  padding: var(--spacing-8);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-card);
  transition: all var(--transition-base);
}

.card:hover {
  transform: rotate(-1deg) scale(1.02);
  box-shadow: var(--shadow-card-hover);
}

/* ========== Commit Cards - Playful Stickers ========== */

.commit {
  display: flex;
  flex-direction: column;
  padding: var(--spacing-4) var(--spacing-5);
  border-radius: var(--radius-md);
  background: var(--color-card);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-card);
  position: relative;
  transition: all var(--transition-base);
  margin-bottom: var(--spacing-4);
}

.commit:hover {
  transform: rotate(-0.5deg) scale(1.01);
  box-shadow: var(--shadow-card-hover);
}

.commit-container.source .commit {
  border-left: 4px solid var(--color-success);
  box-shadow: var(--shadow-card-success);
}

.commit-container.target .commit {
  border-right: 4px solid var(--color-warning);
  box-shadow: var(--shadow-card-warning);
}

.commit-container.both .commit {
  border-top: 4px solid var(--color-success);
  box-shadow: var(--shadow-card-success);
}

.commit-container.both .commit.matched-by-message {
  border-top-color: var(--color-info);
  box-shadow: var(--shadow-card-accent);
}

.commit.ignored {
  opacity: 0.5;
  filter: grayscale(0.7);
  box-shadow: var(--shadow-small);
  position: relative;
  background: repeating-linear-gradient(
    45deg,
    var(--color-card),
    var(--color-card) 10px,
    rgba(100, 116, 139, 0.05) 10px,
    rgba(100, 116, 139, 0.05) 20px
  );
}

.commit.ignored::before {
  content: "已忽略";
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(244, 114, 182, 0.15);
  color: #be185d;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: var(--font-weight-semibold);
  border: 1px solid rgba(244, 114, 182, 0.3);
  z-index: 10;
}

.commit.ignored:hover {
  opacity: 0.7;
  transform: none;
}

/* Commit Badge - Colorful sticker labels */
.commit-badge {
  position: absolute;
  top: -12px;
  padding: var(--spacing-1) var(--spacing-4);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-extrabold);
  color: white;
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
  z-index: var(--z-base);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  transform: rotate(-2deg);
  transition: transform var(--transition-fast);
}

.commit:hover .commit-badge {
  transform: rotate(2deg);
}

.commit-container.source .commit-badge {
  left: var(--spacing-4);
  background: var(--color-success);
}

.commit-container.target .commit-badge {
  right: var(--spacing-4);
  background: var(--color-warning);
}

.commit-container.both .commit-badge {
  left: 50%;
  transform: translateX(-50%) rotate(-2deg);
  background: var(--color-success);
}

.commit-container.both .commit-badge.message-matched {
  background: var(--color-info);
}

.commit:hover .commit-container.both .commit-badge {
  transform: translateX(-50%) rotate(2deg);
}

/* Commit Content */
.commit-time {
  color: var(--color-muted);
  font-size: var(--font-size-xs);
  margin-bottom: var(--spacing-2);
  margin-top: var(--spacing-3);
  font-weight: var(--font-weight-medium);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.commit-message {
  font-weight: var(--font-weight-bold);
  color: var(--color-fg);
  margin-bottom: var(--spacing-3);
  cursor: pointer;
  transition: color var(--transition-fast);
  font-size: var(--font-size-base);
  line-height: 1.6;
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap;
}

.commit-message:hover {
  color: var(--color-accent);
}

.commit-details {
  display: flex;
  flex-wrap: wrap;
  font-size: var(--font-size-xs);
  color: var(--color-muted);
  gap: var(--spacing-2);
  margin-bottom: var(--spacing-3);
  align-items: center;
}

.commit-author {
  margin-right: var(--spacing-1);
  font-weight: var(--font-weight-bold);
  color: var(--color-fg);
}

.commit-hash {
  font-family: var(--font-mono);
  cursor: pointer;
  background: var(--color-bg);
  padding: var(--spacing-1) var(--spacing-3);
  border-radius: var(--radius-sm);
  border: 1px solid var(--color-border);
  transition: all var(--transition-fast);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.commit-hash:hover {
  border-color: var(--color-accent);
  color: var(--color-accent);
  transform: translateY(-1px);
  box-shadow: var(--shadow-small);
}

.commit-hash-pair {
  background: var(--color-bg);
  padding: var(--spacing-4);
  border-radius: var(--radius-md);
  border: var(--border-width) solid var(--color-border);
  margin-top: var(--spacing-3);
}

.commit-hash-branch {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  padding: var(--spacing-2);
  margin-bottom: var(--spacing-2);
}

.commit-hash-branch:last-child {
  background: rgba(251, 191, 36, 0.1);
  border-radius: var(--radius-sm);
  border: 1px dashed var(--color-warning);
}

.branch-label {
  min-width: 90px;
  font-weight: var(--font-weight-extrabold);
  color: var(--color-fg);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* ========== Inputs - Clean with Hard Shadow on Focus ========== */

.input,
.search-input,
.remark-textarea {
  width: 100%;
  padding: var(--spacing-3) var(--spacing-4);
  border: var(--border-width) solid var(--color-border);
  border-radius: var(--radius-md);
  font-size: var(--font-size-sm);
  font-family: var(--font-body);
  background: var(--color-input);
  color: var(--color-fg);
  box-shadow: none;
  transition: all var(--transition-base);
}

.input:focus,
.search-input:focus,
.remark-textarea:focus {
  border-color: var(--color-accent);
  box-shadow: var(--shadow-pop);
  outline: none;
  transform: translate(-2px, -2px);
}

.input::placeholder,
.search-input::placeholder,
.remark-textarea::placeholder {
  color: var(--color-muted);
  opacity: 0.7;
}

.remark-textarea {
  min-height: 140px;
  resize: vertical;
  line-height: var(--line-height-relaxed);
}

/* Input Labels - Bold, uppercase, tracking */
.input-label {
  display: block;
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-xs);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: var(--spacing-2);
  color: var(--color-fg);
}

/* ========== Checkboxes - Playful Toggle ========== */

.filter-checkbox,
.search-checkbox {
  display: flex;
  align-items: center;
  cursor: pointer;
  font-size: var(--font-size-sm);
  color: var(--color-fg);
  gap: var(--spacing-2);
  white-space: nowrap;
  flex-shrink: 0;
  font-weight: var(--font-weight-medium);
}

.filter-checkbox input[type="checkbox"],
.search-checkbox input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  width: 22px;
  height: 22px;
  min-width: 22px;
  min-height: 22px;
  flex-shrink: 0;
  border-radius: var(--radius-sm);
  background: var(--color-card);
  border: var(--border-width) solid var(--color-fg);
  position: relative;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-small);
}

.filter-checkbox input[type="checkbox"]:hover,
.search-checkbox input[type="checkbox"]:hover {
  transform: translate(-1px, -1px);
  box-shadow: var(--shadow-small-hover);
}

.filter-checkbox input[type="checkbox"]:checked,
.search-checkbox input[type="checkbox"]:checked {
  background: var(--color-accent);
  border-color: var(--color-fg);
  box-shadow: var(--shadow-pop);
}

.filter-checkbox input[type="checkbox"]:checked::after,
.search-checkbox input[type="checkbox"]:checked::after {
  content: "✓";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 16px;
  font-weight: var(--font-weight-extrabold);
}

.filter-checkbox span,
.search-checkbox span {
  white-space: nowrap;
  user-select: none;
}

/* ========== Modals - Playful Pop-up ========== */

.modal,
.remark-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(30, 41, 59, 0.7);
  backdrop-filter: blur(12px);
  z-index: var(--z-modal-backdrop);
  align-items: center;
  justify-content: center;
}

.modal.show,
.remark-modal.show {
  display: flex;
  animation: fadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

.modal-content,
.remark-modal-content {
  position: relative;
  background: var(--color-bg);
  padding: var(--spacing-8);
  border-radius: var(--radius-xl);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: 16px 16px 0px var(--color-fg);
  width: 90%;
  max-width: 520px;
  max-height: 90vh;
  overflow: auto;
  z-index: var(--z-modal);
  animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popIn {
  from {
    transform: scale(0.8) rotate(-5deg);
    opacity: 0;
  }
  to {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

.modal h3,
.remark-modal-content h3 {
  margin-top: 0;
  margin-bottom: var(--spacing-6);
  color: var(--color-fg);
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-extrabold);
  font-family: var(--font-display);
}

/* Reason List */
.reason-list {
  margin: var(--spacing-4) 0;
  max-height: 320px;
  overflow-y: auto;
  overflow-x: hidden;
  padding: var(--spacing-1);
}

.reason-option {
  display: flex;
  align-items: center;
  padding: var(--spacing-3) var(--spacing-4);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-3);
  cursor: pointer;
  background: var(--color-card);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
  transition: all var(--transition-base);
  width: 100%;
  box-sizing: border-box;
  word-wrap: break-word;
  word-break: break-word;
}

.reason-option:hover {
  transform: translate(-2px, -2px);
  box-shadow: var(--shadow-small-hover);
}

.reason-option.selected {
  background: var(--color-tertiary);
  box-shadow: var(--shadow-pop);
  transform: translate(-2px, -2px);
}

.reason-option input[type="radio"] {
  margin-right: var(--spacing-3);
  width: 20px;
  height: 20px;
  min-width: 20px;
  min-height: 20px;
  cursor: pointer;
  accent-color: var(--color-accent);
  flex-shrink: 0;
}

.reason-option label {
  flex: 1;
  cursor: pointer;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  word-wrap: break-word;
  word-break: break-word;
  overflow-wrap: break-word;
}

.custom-reason {
  display: none;
  margin-top: var(--spacing-4);
}

.custom-reason.show {
  display: block;
}

/* Modal Buttons */
.modal-buttons,
.remark-modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: var(--spacing-3);
  margin-top: var(--spacing-8);
}

.remark-delete {
  margin-right: auto;
}

/* ========== Info Displays - Colorful Callouts ========== */

.ignore-reason,
.commit-remark {
  font-size: var(--font-size-xs);
  color: var(--color-fg);
  margin: var(--spacing-3) 0 0 0;
  padding: var(--spacing-3) var(--spacing-4);
  background: var(--color-card);
  border-radius: var(--radius-md);
  border: var(--border-width) solid var(--color-secondary);
  box-shadow: var(--shadow-small);
  line-height: var(--line-height-relaxed);
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-2);
}

.commit-remark {
  border-color: var(--color-info);
  background: rgba(139, 92, 246, 0.05);
}

.ignore-reason-title,
.commit-remark-title {
  font-weight: var(--font-weight-extrabold);
  color: var(--color-fg);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-size: var(--font-size-xs);
}

.cherry-pick-time {
  margin-top: var(--spacing-3);
  padding: var(--spacing-3) var(--spacing-4);
  background: rgba(251, 191, 36, 0.1);
  border-left: 4px solid var(--color-warning);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
}

.cherry-pick-label {
  font-weight: var(--font-weight-extrabold);
  color: var(--color-warning);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* ========== Loading & Toast - Playful Feedback ========== */

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(30, 41, 59, 0.5);
  backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: var(--z-modal);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-base);
}

.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}

.loading-spinner {
  width: 64px;
  height: 64px;
  border: 6px solid var(--color-card);
  border-radius: 50%;
  border-top-color: var(--color-accent);
  border-right-color: var(--color-secondary);
  border-bottom-color: var(--color-tertiary);
  animation: spin 1s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.success-toast {
  position: fixed;
  top: var(--spacing-8);
  right: var(--spacing-8);
  background: var(--color-success);
  color: var(--color-fg);
  padding: var(--spacing-4) var(--spacing-6);
  border-radius: var(--radius-md);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-pop);
  z-index: var(--z-tooltip);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-bold);
  opacity: 0;
  transform: translateY(-20px) rotate(-2deg);
  transition: all var(--transition-base);
}

.success-toast.show {
  opacity: 1;
  transform: translateY(0) rotate(0deg);
}

/* ========== Back to Top - Floating Candy Button ========== */

.back-to-top {
  position: fixed;
  bottom: var(--spacing-8);
  right: var(--spacing-8);
  width: 60px;
  height: 60px;
  background: var(--color-accent);
  color: white;
  border-radius: 50%;
  border: var(--border-width) solid var(--color-fg);
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  box-shadow: var(--shadow-pop);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-base);
  font-size: var(--font-size-2xl);
  z-index: var(--z-fixed);
  font-weight: var(--font-weight-extrabold);
}

.back-to-top.show {
  opacity: 1;
  visibility: visible;
}

.back-to-top:hover {
  transform: translate(-3px, -3px) rotate(-5deg);
  box-shadow: var(--shadow-pop-hover);
  background: var(--color-accent-light);
}

.back-to-top:active {
  transform: translate(1px, 1px) rotate(0deg);
  box-shadow: var(--shadow-pop-active);
}

/* ========== Legend - Colorful Badges ========== */

.legend-item {
  display: inline-flex;
  align-items: center;
  background: var(--color-card);
  padding: var(--spacing-2) var(--spacing-5);
  border-radius: var(--radius-full);
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  transition: all var(--transition-fast);
  gap: var(--spacing-2);
}

.legend-item:hover {
  transform: translate(-1px, -1px) rotate(-1deg);
  box-shadow: var(--shadow-small-hover);
}

.legend-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
}

.legend-dot.source {
  background: var(--color-success);
}

.legend-dot.target {
  background: var(--color-warning);
}

.legend-dot.both {
  background: var(--color-info);
}

/* ========== Branch Indicator (Flat Layout) - Playful Dots ========== */

.timeline.flat-layout .branch-indicator {
  position: absolute;
  top: var(--spacing-5);
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: var(--border-width) solid var(--color-fg);
  box-shadow: var(--shadow-small);
  transition: transform var(--transition-fast);
}

.commit:hover .timeline.flat-layout .branch-indicator {
  transform: scale(1.2);
}

.timeline.flat-layout .commit-container.source .branch-indicator {
  right: var(--spacing-5);
  background: var(--color-success);
}

.timeline.flat-layout .commit-container.target .branch-indicator {
  left: var(--spacing-5);
  background: var(--color-warning);
}

.timeline.flat-layout .commit-container.both .branch-indicator {
  background: linear-gradient(
    135deg,
    var(--color-success) 50%,
    var(--color-warning) 50%
  );
}

/* ========== Responsive - Mobile Optimizations ========== */

@media (max-width: 768px) {
  body {
    padding: var(--spacing-2);
  }

  /* Reduce shadow sizes on mobile */
  .btn,
  .filter-button,
  .modal-button,
  .remark-modal-button {
    min-height: 48px;
    padding: var(--spacing-3) var(--spacing-5);
    box-shadow: var(--shadow-small);
  }

  .btn:hover,
  .filter-button:hover,
  .modal-button:hover,
  .remark-modal-button:hover {
    box-shadow: var(--shadow-small-hover);
  }

  .commit {
    box-shadow: var(--shadow-small);
  }

  .commit:hover {
    transform: none;
    box-shadow: var(--shadow-small);
  }

  .card,
  .container {
    box-shadow: var(--shadow-small);
  }

  .card:hover {
    transform: none;
    box-shadow: var(--shadow-small);
  }

  .modal-content,
  .remark-modal-content {
    width: 95%;
    padding: var(--spacing-6);
    box-shadow: 8px 8px 0px var(--color-fg);
  }

  .back-to-top {
    bottom: var(--spacing-6);
    right: var(--spacing-6);
    width: 52px;
    height: 52px;
  }

  /* Hide decorative background on mobile */
  body::before {
    opacity: 0.2;
  }

  h1::after {
    display: none;
  }

  /* Command Tab Mobile Adjustments */
  .command-tab {
    flex-direction: column;
    gap: 6px;
    padding: var(--spacing-2) var(--spacing-3);
    min-height: auto;
  }

  .branch-badge {
    font-size: 0.75rem;
    padding: 2px 6px;
  }

  .branch-icon {
    width: 11px;
    height: 11px;
  }

  .arrow-icon {
    width: 12px;
    height: 12px;
    transform: rotate(90deg);
  }

  .command-tab:hover .arrow-icon {
    transform: rotate(90deg) translateX(2px);
  }
}

/* ========== Wiggle Animation for Icons ========== */

@keyframes wiggle {
  0%,
  100% {
    transform: rotate(0deg);
  }
  25% {
    transform: rotate(3deg);
  }
  75% {
    transform: rotate(-3deg);
  }
}

.vscode-button:hover svg,
.compare-in-vscode:hover svg {
  animation: wiggle 0.5s ease-in-out;
}

/* ========== Accessibility - Respect Reduced Motion ========== */

@media (prefers-reduced-motion: reduce) {
  .commit:hover,
  .card:hover,
  .back-to-top:hover,
  .legend-item:hover,
  .commit-badge {
    transform: none !important;
    animation: none !important;
  }

  .modal-content,
  .remark-modal-content {
    animation: none !important;
  }

  .loading-spinner {
    animation: spin 2s linear infinite !important;
  }
}


    </style>
  </head>
  <body data-layout="flat">
    <!-- 添加忽略原因选择弹窗 -->
    <div id="ignoreModal" class="modal">
      <div class="modal-content">
        <h3>选择忽略原因</h3>
        <div class="reason-list" id="reasonList">
          <!-- 原因选项将通过 JavaScript 动态添加 -->
        </div>
        <div id="customReasonInput" class="custom-reason">
          <input
            type="text"
            placeholder="请输入忽略原因"
            id="customReasonText"
          />
        </div>
        <div class="modal-buttons">
          <button class="modal-button cancel">取消</button>
          <button class="modal-button confirm">确认</button>
        </div>
      </div>
    </div>

    <!-- 添加备注弹窗 -->
    <div id="remarkModal" class="remark-modal">
      <div class="remark-modal-content">
        <h3>编辑备注</h3>
        <textarea
          id="remarkText"
          class="remark-textarea"
          placeholder="请输入备注内容..."
        ></textarea>
        <div class="remark-modal-buttons">
          <button
            class="remark-modal-button remark-delete"
            id="deleteRemarkBtn"
          >
            删除备注
          </button>
          <button class="remark-modal-button remark-cancel">取消</button>
          <button class="remark-modal-button remark-save">保存</button>
        </div>
      </div>
    </div>

    <!-- 添加loading覆盖层 -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <!-- 添加返回顶部按钮 -->
    <div id="backToTop" class="back-to-top">↑</div>

    <div class="container">
      <div class="header">
        <div>
          <h1>分支提交对比</h1>
          <div class="meta-info">
            <div>生成时间: 2026/01/22 10:51</div>
            <div id="authorInfo" style="display: none">提交者: "全部"</div>
            <div id="timeRangeInfo" style="display: none">
              时间范围: "全部时间"
            </div>
          </div>
        </div>
        <div class="timeline-legend">
          <div class="legend-item">
            <span class="legend-dot source"></span> "main" (基准分支)
          </div>
          <div class="legend-item">
            <span class="legend-dot target"></span> "feature/test"
          </div>
          <div class="legend-item">
            <span
              class="legend-dot both"
              style="background-color: #1890ff"
            ></span>
            消息相同的共同提交
          </div>
        </div>

        <div class="theme-switcher">
          <button id="chatLayoutBtn" class="theme-button">
            <span>聊天布局</span>
            <span class="layout-icon">💬</span>
          </button>
          <button id="flatLayoutBtn" class="theme-button active">
            <span>列表布局</span>
            <span class="layout-icon">📑</span>
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-buttons">
          <button class="filter-button active" data-filter="all">
            全部提交
          </button>
          <button class="filter-button" data-filter="source">
            仅"main"分支
          </button>
          <button class="filter-button" data-filter="target">
            仅"feature/test"分支
          </button>
          <button class="filter-button" data-filter="common">共同提交</button>
          <button class="filter-button" data-filter="ignored">
            已忽略提交
          </button>
        </div>

        <div class="sub-filter-section" id="subFilterSection">
          <label class="filter-checkbox">
            <input type="checkbox" id="hideIgnoredCommits" />
            <span>隐藏已忽略提交</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="hideCommonCommits" />
            <span>隐藏共同提交</span>
          </label>
        </div>

        <div class="search-section">
          <div class="search-container">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="搜索提交信息、作者或哈希..."
            />
            <button class="clear-search" id="clearSearch">✕</button>
            <div class="search-options">
              <label class="search-checkbox">
                <input type="checkbox" id="searchMessage" checked />
                <span>提交信息</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchAuthor" checked />
                <span>作者</span>
              </label>
              <label class="search-checkbox">
                <input type="checkbox" id="searchHash" />
                <span>哈希</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="timeline" id="timeline"></div>

      <div class="command-section">
        <div class="command-tabs">
          <button class="command-tab active" data-command="source-to-target">
            <span class="branch-badge source">
              <svg
                class="branch-icon"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122V6A2.5 2.5 0 0110 8.5H6a1 1 0 00-1 1v1.128a2.251 2.251 0 11-1.5 0V5.372a2.25 2.25 0 111.5 0v1.836A2.492 2.492 0 016 7h4a1 1 0 001-1v-.628A2.25 2.25 0 019.5 3.25zM4.25 12a.75.75 0 100 1.5.75.75 0 000-1.5zM3.5 3.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0z"
                />
              </svg>
              "main"
            </span>
            <svg
              class="arrow-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M5 12H19M19 12L12 5M19 12L12 19"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span class="branch-badge target">
              <svg
                class="branch-icon"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122V6A2.5 2.5 0 0110 8.5H6a1 1 0 00-1 1v1.128a2.251 2.251 0 11-1.5 0V5.372a2.25 2.25 0 111.5 0v1.836A2.492 2.492 0 016 7h4a1 1 0 001-1v-.628A2.25 2.25 0 019.5 3.25zM4.25 12a.75.75 0 100 1.5.75.75 0 000-1.5zM3.5 3.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0z"
                />
              </svg>
              "feature/test"
            </span>
          </button>
          <button class="command-tab" data-command="target-to-source">
            <span class="branch-badge target">
              <svg
                class="branch-icon"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122V6A2.5 2.5 0 0110 8.5H6a1 1 0 00-1 1v1.128a2.251 2.251 0 11-1.5 0V5.372a2.25 2.25 0 111.5 0v1.836A2.492 2.492 0 016 7h4a1 1 0 001-1v-.628A2.25 2.25 0 019.5 3.25zM4.25 12a.75.75 0 100 1.5.75.75 0 000-1.5zM3.5 3.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0z"
                />
              </svg>
              "feature/test"
            </span>
            <svg
              class="arrow-icon"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M5 12H19M19 12L12 5M19 12L12 19"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <span class="branch-badge source">
              <svg
                class="branch-icon"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122V6A2.5 2.5 0 0110 8.5H6a1 1 0 00-1 1v1.128a2.251 2.251 0 11-1.5 0V5.372a2.25 2.25 0 111.5 0v1.836A2.492 2.492 0 016 7h4a1 1 0 001-1v-.628A2.25 2.25 0 019.5 3.25zM4.25 12a.75.75 0 100 1.5.75.75 0 000-1.5zM3.5 3.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0z"
                />
              </svg>
              "main"
            </span>
          </button>
        </div>

        <div id="source-to-target-content" class="command-content active">
          <h3>
            Cherry-pick 指令 ("main" → "feature/test")
            <button class="copy-button copy-source-to-target-button">
              复制全部
            </button>
          </h3>
          <div id="source-to-target-commands-container"></div>
          <pre
            style="display: none"
          ><code id="source-to-target-commands"></code></pre>
        </div>

        <div id="target-to-source-content" class="command-content">
          <h3>
            Cherry-pick 指令 ("feature/test" → "main")
            <button class="copy-button copy-target-to-source-button">
              复制全部
            </button>
          </h3>
          <div id="target-to-source-commands-container"></div>
          <pre
            style="display: none"
          ><code id="target-to-source-commands"></code></pre>
        </div>
      </div>
    </div>

    <script>
      // 全局配置和数据注入
      const PORT = '3002';
      const API_BASE = `http://localhost:${PORT}`;

      // 从模板注入的数据
      const commits = [{"hash":"abc123","message":"测试提交1","authorName":"张三","date":"2026-01-22T02:51:16.092Z","status":"source","formattedDate":"2026/01/22 10:51"},{"hash":"def456","message":"测试提交2","authorName":"李四","date":"2026-01-22T02:51:16.092Z","status":"target","formattedDate":"2026/01/22 10:51"},{"hash":"ghi789","message":"共同提交","authorName":"王五","date":"2026-01-22T02:51:16.092Z","status":"both","formattedDate":"2026/01/22 10:51"}];
      const sourceBranch = "main";
      const targetBranch = "feature/test";
      let ignoredCommits = [{"hash":"089bb9c51ec8331e83bdbe9989efb7487a19c700","reason":"已手动合并","timestamp":"2026-01-22T02:50:38.679Z"}] || [];
      let commitRemarks = [] || [];
      const author = "全部";
      const timeRange = "全部时间";

      // 忽略原因选项
      const IGNORE_REASONS = [
        '已手动合并',
        '不需要合并',
        '存在冲突',
        '待进一步确认',
        '其他原因'
      ];
    </script>

    <script>
      /**
 * Utility Functions 工具函数
 * 通用的辅助函数
 */

/**
 * 复制命令块
 * @param {string} direction - 方向标识 ('source-to-target' 或 'target-to-source')
 */
function copyCommandBlock(direction) {
  const commandsElement = document.getElementById(`${direction}-commands`);
  if (commandsElement) {
    const text = commandsElement.textContent;
    const button = document.querySelector(`.copy-${direction}-button`);
    copyToClipboard(text, button);
  }
}

/**
 * 复制文本到剪贴板
 * @param {string} text - 要复制的文本
 * @param {HTMLElement} element - 触发复制的元素（用于显示提示）
 */
function copyToClipboard(text, element) {
  navigator.clipboard
    .writeText(text)
    .then(() => {
      // 创建Neumorphism风格的toast提示
      const toast = document.createElement("div");
      toast.className = "copy-toast";
      toast.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="flex-shrink: 0;">
          <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M6 10L9 13L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>已复制到剪贴板</span>
      `;

      // 设置样式
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--color-bg);
        color: var(--color-success);
        padding: var(--spacing-4) var(--spacing-5);
        border-radius: var(--radius-base);
        box-shadow: 
          8px 8px 16px rgba(163, 177, 198, 0.5),
          -8px -8px 16px rgba(255, 255, 255, 0.8),
          inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        font-family: var(--font-body);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: var(--spacing-3);
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      `;

      document.body.appendChild(toast);

      // 触发动画
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          toast.style.opacity = "1";
          toast.style.transform = "translateY(0) scale(1)";
        });
      });

      // 2秒后淡出并移除
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-20px) scale(0.9)";
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 2000);
    })
    .catch((err) => {
      console.error("复制失败:", err);

      // 显示错误提示
      const errorToast = document.createElement("div");
      errorToast.className = "copy-toast error";
      errorToast.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="flex-shrink: 0;">
          <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M10 6V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="10" cy="14" r="1" fill="currentColor"/>
        </svg>
        <span>复制失败</span>
      `;

      errorToast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: var(--color-bg);
        color: var(--color-danger);
        padding: var(--spacing-4) var(--spacing-5);
        border-radius: var(--radius-base);
        box-shadow: 
          8px 8px 16px rgba(163, 177, 198, 0.5),
          -8px -8px 16px rgba(255, 255, 255, 0.8),
          inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-medium);
        font-family: var(--font-body);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: var(--spacing-3);
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      `;

      document.body.appendChild(errorToast);

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          errorToast.style.opacity = "1";
          errorToast.style.transform = "translateY(0) scale(1)";
        });
      });

      setTimeout(() => {
        errorToast.style.opacity = "0";
        errorToast.style.transform = "translateY(-20px) scale(0.9)";
        setTimeout(() => {
          if (errorToast.parentNode) {
            document.body.removeChild(errorToast);
          }
        }, 300);
      }, 2000);
    });
}

/**
 * HTML转义，防止XSS攻击
 * @param {string} str - 要转义的字符串
 * @returns {string} 转义后的字符串
 */
function escapeHtml(str) {
  if (!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/**
 * 格式化日期
 * @param {string|Date} date - 日期对象或字符串
 * @returns {string} 格式化后的日期字符串
 */
function formatDate(date) {
  const d = new Date(date);
  return d.toLocaleString("zh-CN", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

/**
 * 从diff --git行提取文件路径
 * @param {string} diffGitLine - diff --git行
 * @returns {string} 文件路径
 */
function extractFilePath(diffGitLine) {
  try {
    const parts = diffGitLine.split(" ");
    if (parts.length >= 4) {
      let path = parts[3];
      if (path.startsWith("b/")) {
        path = path.substring(2);
      }
      return path;
    }
  } catch (e) {
    console.error("提取文件路径失败:", e);
  }
  return "unknown-file";
}

/**
 * 将Git差异文本解析为文件块
 * @param {string} diffText - Git diff文本
 * @returns {Array} 文件块数组
 */
function parseDiffToFileBlocks(diffText) {
  const lines = diffText.split("\n");
  const fileBlocks = [];
  let currentFile = null;
  let inFileHeader = false;
  let currentHunk = null;
  let currentHunkContent = [];

  lines.forEach((line) => {
    if (line.startsWith("diff --git ")) {
      if (currentFile) {
        if (currentHunk) {
          currentFile.hunks.push({
            header: currentHunk,
            content: currentHunkContent,
          });
        }
        fileBlocks.push(currentFile);
      }

      currentFile = {
        header: line,
        path: extractFilePath(line),
        hunks: [],
      };
      inFileHeader = true;
      currentHunk = null;
      currentHunkContent = [];
    } else if (
      inFileHeader &&
      (line.startsWith("--- ") || line.startsWith("+++ "))
    ) {
      if (currentFile) {
        currentFile.header += "\n" + line;
      }
    } else if (line.startsWith("@@ ")) {
      inFileHeader = false;
      if (currentHunk && currentFile) {
        currentFile.hunks.push({
          header: currentHunk,
          content: currentHunkContent,
        });
      }
      currentHunk = line;
      currentHunkContent = [];
    } else if (currentFile) {
      if (inFileHeader) {
        currentFile.header += "\n" + line;
      } else if (currentHunk) {
        currentHunkContent.push(line);
      }
    }
  });

  if (currentFile && currentHunk) {
    currentFile.hunks.push({
      header: currentHunk,
      content: currentHunkContent,
    });
    fileBlocks.push(currentFile);
  }

  return fileBlocks;
}

/**
 * 创建GitHub风格的差异HTML
 * @param {Object} fileBlock - 文件块对象
 * @returns {string} HTML字符串
 */
function createGitHubStyleDiffHTML(fileBlock) {
  const filePath = fileBlock.path;

  let html = `
    <div style="margin-bottom: 16px;">
      <div style="background-color: #f6f8fa; border: 1px solid #e1e4e8; border-bottom: none; border-top-left-radius: 6px; border-top-right-radius: 6px; padding: 8px 16px; font-weight: 600;">
        ${escapeHtml(filePath)}
      </div>
  `;

  fileBlock.hunks.forEach((hunk, index) => {
    const isLast = index === fileBlock.hunks.length - 1;
    html += `
      <div style="background-color: #f8fafd; color: #586069; padding: 4px 10px; border: 1px solid #e1e4e8; border-bottom: none; font-size: 12px;">
        ${escapeHtml(hunk.header)}
      </div>
      <div style="border: 1px solid #e1e4e8; border-bottom-left-radius: ${
        isLast ? "6px" : "0"
      }; border-bottom-right-radius: ${
      isLast ? "6px" : "0"
    }; overflow: hidden;">
        <table style="border-collapse: collapse; width: 100%; tab-size: 4;">
          <tbody>
    `;

    hunk.content.forEach((line) => {
      let lineClass = "";
      let lineStyle = "";
      let prefix = "";

      if (line.startsWith("+")) {
        lineClass = "addition";
        lineStyle = "background-color: #e6ffed;";
        prefix = "+";
      } else if (line.startsWith("-")) {
        lineClass = "deletion";
        lineStyle = "background-color: #ffeef0;";
        prefix = "-";
      } else {
        lineClass = "context";
        lineStyle = "";
        prefix = " ";
      }

      const lineContent = line.substring(1);

      html += `
        <tr class="${lineClass}" style="${lineStyle}">
          <td style="width: 1%; padding: 0 10px; text-align: right; color: #bbb; border-right: 1px solid #e1e4e8; user-select: none;">${prefix}</td>
          <td style="padding: 0 10px; white-space: pre-wrap; word-break: break-all;">${escapeHtml(
            lineContent
          )}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

/**
 * 防抖函数
 * @param {Function} func - 要防抖的函数
 * @param {number} wait - 等待时间（毫秒）
 * @returns {Function} 防抖后的函数
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/**
 * 节流函数
 * @param {Function} func - 要节流的函数
 * @param {number} limit - 时间限制（毫秒）
 * @returns {Function} 节流后的函数
 */
function throttle(func, limit) {
  let inThrottle;
  return function (...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => (inThrottle = false), limit);
    }
  };
}

/**
 * API Communication Module API通信模块
 * 处理所有与后端的数据交互
 */

// API_BASE 由HTML模板的数据注入脚本定义

/**
 * 加载已忽略的提交列表
 * @returns {Promise<Array>} 忽略的提交数组
 */
async function loadIgnoredCommits() {
  try {
    const response = await fetch(`${API_BASE}/ignored-commits`, {
      cache: "no-store",
      headers: {
        "Cache-Control": "no-cache, no-store",
        Pragma: "no-cache",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    return Array.isArray(data.ignoredCommits) ? data.ignoredCommits : [];
  } catch (error) {
    console.error("加载忽略的提交失败:", error);
    return [];
  }
}

/**
 * 保存已忽略的提交列表
 * @param {Array} commits - 忽略的提交数组
 * @returns {Promise<boolean>} 是否保存成功
 */
async function saveIgnoredCommits(commits) {
  try {
    const response = await fetch(`${API_BASE}/ignore-commit`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ ignoredCommits: commits }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    return true;
  } catch (error) {
    console.error("保存忽略的提交失败:", error);
    throw error;
  }
}

/**
 * 加载提交备注
 * @returns {Promise<Array>} 备注数组
 */
async function loadCommitRemarks() {
  try {
    const response = await fetch(`${API_BASE}/commit-remarks`, {
      cache: "no-store",
      headers: {
        "Cache-Control": "no-cache, no-store",
        Pragma: "no-cache",
      },
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();

    // 处理数据格式转换（向后兼容）
    if (data.commitRemarks) {
      if (Array.isArray(data.commitRemarks)) {
        return data.commitRemarks;
      } else if (typeof data.commitRemarks === "object") {
        // 转换旧格式（对象）为新格式（数组）
        const remarksArray = [];
        for (const hash in data.commitRemarks) {
          remarksArray.push({
            hash: hash,
            content: data.commitRemarks[hash],
            timestamp: new Date().toISOString(),
          });
        }
        console.log("已将对象格式备注转换为数组格式");
        return remarksArray;
      }
    }

    return [];
  } catch (error) {
    console.error("加载提交备注失败:", error);
    return [];
  }
}

/**
 * 保存提交备注
 * @param {Array} remarks - 备注数组
 * @returns {Promise<Object>} 保存结果
 */
async function saveCommitRemarks(remarks) {
  try {
    // 验证数据格式
    if (!Array.isArray(remarks)) {
      console.error("备注数据必须是数组格式");
      remarks = [];
    }

    // 过滤无效数据
    const validRemarks = remarks.filter(
      (remark) =>
        remark &&
        remark.hash &&
        typeof remark.hash === "string" &&
        remark.hash.trim().length > 0
    );

    if (validRemarks.length !== remarks.length) {
      console.warn(`过滤了 ${remarks.length - validRemarks.length} 条无效备注`);
    }

    const response = await fetch(`${API_BASE}/commit-remarks`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ commitRemarks: validRemarks }),
      cache: "no-cache",
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`服务器返回错误: ${response.status} ${errorText}`);
    }

    const data = await response.json();
    console.log("备注保存成功:", data);
    return data;
  } catch (error) {
    console.error("保存备注失败:", error);
    throw error;
  }
}

/**
 * 获取Git提交的diff内容
 * @param {string} commitHash - 提交哈希值
 * @returns {Promise<Object>} diff数据
 */
async function fetchGitDiff(commitHash) {
  try {
    const response = await fetch(
      `${API_BASE}/git/show?hash=${encodeURIComponent(commitHash)}`,
      {
        method: "GET",
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
      }
    );

    if (!response.ok) {
      throw new Error(
        `服务器返回错误: ${response.status} ${response.statusText}`
      );
    }

    const responseObj = await response.json();

    if (!responseObj.success) {
      throw new Error(responseObj.message || "服务器返回错误");
    }

    return responseObj.data;
  } catch (error) {
    console.error("获取Git diff失败:", error);
    throw error;
  }
}

/**
 * 通用的fetch重试包装器
 * @param {Function} fetchFunc - fetch函数
 * @param {number} retries - 重试次数
 * @returns {Promise} fetch结果
 */
async function fetchWithRetry(fetchFunc, retries = 1) {
  try {
    return await fetchFunc();
  } catch (error) {
    if (retries > 0) {
      console.log(`请求失败，${retries}次重试后重新尝试...`);
      await new Promise((resolve) => setTimeout(resolve, 1000));
      return fetchWithRetry(fetchFunc, retries - 1);
    }
    throw error;
  }
}

/**
 * State Management Module 状态管理模块
 * 管理应用的全局状态
 */

// 全局状态对象
const appState = {
  commits: [],
  ignoredCommits: [],
  commitRemarks: [],
  filterState: {
    mainFilter: "all",
    hideIgnored: true,
    hideCommon: false,
    searchText: "",
    searchMessage: true,
    searchAuthor: true,
    searchHash: false,
  },
  layout: "flat",
  sourceBranch: "",
  targetBranch: "",
};

/**
 * 更新筛选状态
 * @param {Object} updates - 要更新的状态字段
 */
function updateFilterState(updates) {
  appState.filterState = {
    ...appState.filterState,
    ...updates,
  };
}

/**
 * 获取当前筛选状态
 * @returns {Object} 筛选状态对象
 */
function getFilterState() {
  return { ...appState.filterState };
}

/**
 * 保存筛选状态到URL
 */
function saveFilterStateToURL() {
  const url = new URL(window.location.href);
  url.searchParams.set("filter", appState.filterState.mainFilter);
  url.searchParams.set(
    "hideIgnored",
    appState.filterState.hideIgnored ? "1" : "0"
  );
  url.searchParams.set(
    "hideCommon",
    appState.filterState.hideCommon ? "1" : "0"
  );
  window.history.replaceState({}, "", url.toString());
}

/**
 * 从URL加载筛选状态
 * @returns {Object} 从URL解析的筛选状态
 */
function loadFilterStateFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    mainFilter: urlParams.get("filter") || "all",
    hideIgnored: urlParams.get("hideIgnored") === "1",
    hideCommon: urlParams.get("hideCommon") === "1",
  };
}

/**
 * 保存当前筛选状态（用于操作前保存）
 */
function saveCurrentFilterState() {
  const hideIgnoredEl = document.getElementById("hideIgnoredCommits");
  const hideCommonEl = document.getElementById("hideCommonCommits");
  const searchInputEl = document.getElementById("searchInput");
  const searchMessageEl = document.getElementById("searchMessage");
  const searchAuthorEl = document.getElementById("searchAuthor");
  const searchHashEl = document.getElementById("searchHash");

  if (
    !hideIgnoredEl ||
    !hideCommonEl ||
    !searchInputEl ||
    !searchMessageEl ||
    !searchAuthorEl ||
    !searchHashEl
  ) {
    console.warn("部分筛选DOM元素未找到，跳过状态保存");
    return;
  }

  appState.filterState = {
    mainFilter: document.body.getAttribute("data-current-filter") || "all",
    hideIgnored: hideIgnoredEl.checked,
    hideCommon: hideCommonEl.checked,
    searchText: searchInputEl.value.trim(),
    searchMessage: searchMessageEl.checked,
    searchAuthor: searchAuthorEl.checked,
    searchHash: searchHashEl.checked,
  };

  console.log("已保存筛选状态:", appState.filterState);
}

/**
 * 恢复筛选状态（用于操作后恢复）
 */
function restoreFilterState() {
  console.log("正在恢复筛选状态:", appState.filterState);

  if (!appState.filterState) {
    console.warn("没有筛选状态可恢复");
    return;
  }

  // 使用 requestAnimationFrame 确保 DOM 完全渲染后再恢复状态
  requestAnimationFrame(() => {
    // 设置主筛选按钮状态
    document.querySelectorAll(".filter-button").forEach((btn) => {
      btn.classList.toggle(
        "active",
        btn.getAttribute("data-filter") === appState.filterState.mainFilter
      );
    });

    document.body.setAttribute(
      "data-current-filter",
      appState.filterState.mainFilter
    );

    // 获取DOM元素
    const hideIgnoredEl = document.getElementById("hideIgnoredCommits");
    const hideCommonEl = document.getElementById("hideCommonCommits");
    const searchInputEl = document.getElementById("searchInput");
    const searchMessageEl = document.getElementById("searchMessage");
    const searchAuthorEl = document.getElementById("searchAuthor");
    const searchHashEl = document.getElementById("searchHash");
    const clearButton = document.getElementById("clearSearch");
    const subFilterSection = document.getElementById("subFilterSection");

    if (
      !hideIgnoredEl ||
      !hideCommonEl ||
      !searchInputEl ||
      !searchMessageEl ||
      !searchAuthorEl ||
      !searchHashEl ||
      !clearButton ||
      !subFilterSection
    ) {
      console.warn("部分筛选DOM元素未找到，跳过状态恢复");
      return;
    }

    // 恢复复选框状态
    hideIgnoredEl.checked = appState.filterState.hideIgnored;
    hideCommonEl.checked = appState.filterState.hideCommon;

    // 恢复搜索状态
    searchInputEl.value = appState.filterState.searchText;
    searchMessageEl.checked = appState.filterState.searchMessage;
    searchAuthorEl.checked = appState.filterState.searchAuthor;
    searchHashEl.checked = appState.filterState.searchHash;

    // 显示/隐藏清除按钮
    if (appState.filterState.searchText) {
      clearButton.classList.add("visible");
    } else {
      clearButton.classList.remove("visible");
    }

    // 设置子筛选器可见性
    if (appState.filterState.mainFilter === "all") {
      subFilterSection.classList.remove("hidden");
    } else {
      subFilterSection.classList.add("hidden");
    }

    // 应用筛选 - 使用另一个 requestAnimationFrame 确保所有 DOM 更新完成
    requestAnimationFrame(() => {
      if (appState.filterState.searchText) {
        searchCommits(false);
      } else {
        applyFilters(appState.filterState.mainFilter);
      }
    });
  });
}

/**
 * 初始化筛选状态（从URL）
 */
function initializeFilterState() {
  const urlParams = loadFilterStateFromURL();

  appState.filterState = {
    ...appState.filterState,
    mainFilter: urlParams.mainFilter,
    hideIgnored: urlParams.hideIgnored,
    hideCommon: urlParams.hideCommon,
  };

  document.body.setAttribute(
    "data-current-filter",
    appState.filterState.mainFilter
  );

  // 更新UI
  document.querySelectorAll(".filter-button").forEach((btn) => {
    btn.classList.toggle(
      "active",
      btn.getAttribute("data-filter") === appState.filterState.mainFilter
    );
  });

  const hideIgnoredEl = document.getElementById("hideIgnoredCommits");
  const hideCommonEl = document.getElementById("hideCommonCommits");
  if (hideIgnoredEl) hideIgnoredEl.checked = appState.filterState.hideIgnored;
  if (hideCommonEl) hideCommonEl.checked = appState.filterState.hideCommon;

  const subFilterSection = document.getElementById("subFilterSection");
  if (subFilterSection) {
    if (appState.filterState.mainFilter === "all") {
      subFilterSection.classList.remove("hidden");
    } else {
      subFilterSection.classList.add("hidden");
    }
  }

  console.log("已从URL初始化筛选状态:", appState.filterState);
}

/**
 * 设置布局模式
 * @param {string} layout - 布局模式 ('chat' 或 'flat')
 */
function setLayout(layout) {
  appState.layout = layout;
  localStorage.setItem("preferredLayout", layout);
}

/**
 * 获取布局模式
 * @returns {string} 当前布局模式
 */
function getLayout() {
  return appState.layout;
}

/**
 * 从localStorage加载布局偏好
 * @returns {string} 保存的布局模式
 */
function loadLayoutPreference() {
  return localStorage.getItem("preferredLayout") || "flat";
}

/**
 * Render Module 渲染模块
 * 负责UI的渲染和更新
 */

/**
 * 渲染提交列表
 * @param {boolean} shouldRestoreState - 是否恢复筛选状态（默认不恢复）
 */
function renderCommits(shouldRestoreState = false) {
  console.log("渲染提交列表, shouldRestoreState:", shouldRestoreState);

  const timeline = document.getElementById("timeline");
  timeline.innerHTML = "";

  const currentLayout = document.body.getAttribute("data-layout") || "flat";

  // 按时间排序（从新到旧）
  const sortedCommits = [...appState.commits].sort(
    (a, b) => new Date(b.date || b.dateIso) - new Date(a.date || a.dateIso)
  );

  sortedCommits.forEach((commit) => {
    const commitRow = renderCommitCard(commit, currentLayout);
    timeline.appendChild(commitRow);
  });

  updateCherryPickCommands();

  console.log("提交列表渲染完成");
}

/**
 * 渲染单个提交卡片
 * @param {Object} commit - 提交对象
 * @param {string} layout - 布局模式
 * @returns {HTMLElement} 提交行元素
 */
function renderCommitCard(commit, layout) {
  const isIgnored = appState.ignoredCommits.some(
    (item) => item.hash === commit.hash
  );
  const ignoredCommit = appState.ignoredCommits.find(
    (item) => item.hash === commit.hash
  );
  const hasRemarkForCommit = hasRemark(commit.hash);
  const remarkContent = getRemarkContent(commit.hash);
  const isMatchedByMessage = commit.matchedByMessage === true;

  const commitRow = document.createElement("div");
  commitRow.className = "commit-row";

  const commitContainer = document.createElement("div");

  if (commit.status === "both") {
    commitContainer.className = "commit-container both";
  } else if (commit.status === "source") {
    commitContainer.className = "commit-container source";
  } else {
    commitContainer.className = "commit-container target";
  }

  let badgeText;
  let badgeClass = "";

  if (commit.status === "both") {
    badgeText = isMatchedByMessage ? "已同步(commit 消息匹配)" : "共同提交";
    if (isMatchedByMessage) {
      badgeClass = "message-matched";
    }
  } else if (commit.status === "source") {
    badgeText = appState.sourceBranch;
  } else {
    badgeText = appState.targetBranch;
  }

  let commitClasses = `commit${isIgnored ? " ignored" : ""}`;
  if (isMatchedByMessage) {
    commitClasses += " matched-by-message";
  }

  let hashContent = "";
  const vscodeIconSvg = `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M21.29 4.1L17.47.28a1 1 0 0 0-.71-.28h-.09a1 1 0 0 0-.67.3l-10.48 9.5-4.23-3.2a.67.67 0 0 0-.89.01l-.8.72a.67.67 0 0 0 0 .99l3.45 3.12L.6 14.56a.67.67 0 0 0 0 .99l.8.72a.67.67 0 0 0 .89.01l4.23-3.2 10.48 9.5a1 1 0 0 0 .67.3h.09a1 1 0 0 0 .71-.28l3.82-3.82a1 1 0 0 0 .3-.71V4.81a1 1 0 0 0-.3-.71zM17 18.5l-9-6.75L17 5v13.5z"/></svg>`;

  function getHashWithButtons(hash) {
    const shortHash = hash.substring(0, 7);
    return `
      <span class="commit-hash" title="${hash}">${shortHash}</span>
      <button class="vscode-button" title="在VS Code中查看">
        ${vscodeIconSvg}
      </button>
      <button class="view-changes-btn">
        查看变更
      </button>
    `;
  }

  if (isMatchedByMessage && commit.targetHash) {
    const cherryPickTimeHtml = commit.cherryPickTime
      ? `
      <div class="cherry-pick-time">
        <span class="cherry-pick-label">🍒 Cherry-pick 时间:</span>
        <span class="cherry-pick-timestamp">${formatDate(
          commit.cherryPickTime
        )}</span>
      </div>
    `
      : "";

    hashContent = `
      <div class="commit-hash-pair">
        <div class="commit-hash-branch">
          <span class="branch-label">${appState.sourceBranch}:</span>
          ${getHashWithButtons(commit.hash)}
        </div>
        <div class="commit-hash-branch">
          <span class="branch-label">${appState.targetBranch}:</span>
          ${getHashWithButtons(commit.targetHash)}
        </div>
        ${cherryPickTimeHtml}
        <button class="compare-in-vscode">
          ${vscodeIconSvg} 在VS Code中比较两个提交
        </button>
      </div>
    `;
  } else {
    hashContent = getHashWithButtons(commit.hash);
  }

  const branchIndicator =
    layout === "flat"
      ? `<div class="branch-indicator ${badgeClass}"></div>`
      : "";

  commitContainer.innerHTML = `
    <div class="${commitClasses}" data-hash="${commit.hash}" data-status="${
    commit.status
  }">
      ${branchIndicator}
      <span class="commit-badge ${badgeClass}">${badgeText}</span>
      <div class="commit-time">${commit.formattedDate}</div>
      <div class="commit-info">
        <div class="commit-message">${escapeHtml(commit.message)}</div>
        <div class="commit-details">
          <span class="commit-author">作者: ${escapeHtml(
            commit.authorName
          )}</span>
          ${hashContent}
          <button class="ignore-button">
            ${isIgnored ? "取消忽略" : "忽略"}
          </button>
          <button class="remark-button">
            ${hasRemarkForCommit ? "编辑备注" : "添加备注"}
          </button>
        </div>
        ${
          isIgnored && ignoredCommit
            ? `
          <div class="ignore-reason">
            <span class="ignore-reason-title">🚫 忽略原因</span>
            <span class="ignore-reason-content">${escapeHtml(
              ignoredCommit.reason
            )}</span>
          </div>`
            : ""
        }
        ${
          remarkContent
            ? `
          <div class="commit-remark">
            <span class="commit-remark-title">📝 备注</span>
            <span class="commit-remark-content">${escapeHtml(
              remarkContent
            )}</span>
          </div>`
            : ""
        }
      </div>
    </div>
  `;

  commitRow.appendChild(commitContainer);
  return commitRow;
}

/**
 * 更新cherry-pick命令
 */
function updateCherryPickCommands() {
  const sourceOnlyCommits = appState.commits.filter(
    (commit) =>
      commit.status === "source" &&
      !appState.ignoredCommits.some((item) => item.hash === commit.hash)
  );

  const targetOnlyCommits = appState.commits.filter(
    (commit) =>
      commit.status === "target" &&
      !appState.ignoredCommits.some((item) => item.hash === commit.hash)
  );

  updateDirectionalCommands(
    sourceOnlyCommits,
    appState.sourceBranch,
    appState.targetBranch,
    "source-to-target"
  );
  updateDirectionalCommands(
    targetOnlyCommits,
    appState.targetBranch,
    appState.sourceBranch,
    "target-to-source"
  );
}

/**
 * 生成特定方向的cherry-pick命令
 * @param {Array} directionCommits - 提交列表
 * @param {string} fromBranch - 源分支
 * @param {string} toBranch - 目标分支
 * @param {string} direction - 方向标识
 */
function updateDirectionalCommands(
  directionCommits,
  fromBranch,
  toBranch,
  direction
) {
  directionCommits.sort((a, b) => new Date(b.date) - new Date(a.date));

  let commandsArray = [];
  commandsArray.push(`# 切换到 ${toBranch} 分支`);
  commandsArray.push(`git checkout ${toBranch}`);
  commandsArray.push("");
  commandsArray.push(`# Cherry-pick 从 ${fromBranch} 分支的提交`);

  directionCommits.forEach((commit) => {
    commandsArray.push(`git cherry-pick ${commit.hash}  # ${commit.message}`);
  });

  const commands = commandsArray.join("\n");

  const commandsContainer = document.getElementById(
    `${direction}-commands-container`
  );
  commandsContainer.innerHTML = "";

  commandsArray.forEach((cmd) => {
    // 跳过空行，不渲染
    if (!cmd || cmd.trim() === "") {
      return;
    }

    const cmdLine = document.createElement("div");
    cmdLine.className = "command-line";

    const cmdText = document.createElement("pre");
    cmdText.innerHTML = highlightGitCommand(cmd);
    cmdLine.appendChild(cmdText);

    if (cmd && !cmd.startsWith("#")) {
      const copyBtn = document.createElement("button");
      copyBtn.className = "copy-line-button";
      copyBtn.textContent = "复制";
      copyBtn.onclick = function () {
        copyToClipboard(cmd, this);
      };
      cmdLine.appendChild(copyBtn);
    }

    commandsContainer.appendChild(cmdLine);
  });

  document.getElementById(`${direction}-commands`).textContent = commands;
}

/**
 * Git 命令语法高亮
 * @param {string} command - Git 命令字符串
 * @returns {string} 高亮后的 HTML
 */
function highlightGitCommand(command) {
  // 如果是注释行
  if (command.startsWith("#")) {
    return `<span class="git-comment">${escapeHtml(command)}</span>`;
  }

  // 分离命令和注释
  const commentIndex = command.indexOf("#");
  let cmdPart = command;
  let commentPart = "";

  if (commentIndex !== -1) {
    cmdPart = command.substring(0, commentIndex);
    commentPart = command.substring(commentIndex);
  }

  // 转义 HTML 特殊字符
  cmdPart = escapeHtml(cmdPart);

  // 高亮 git 关键字
  cmdPart = cmdPart.replace(
    /\b(git)\b/g,
    '<span class="git-keyword">$1</span>'
  );

  // 高亮子命令 (checkout, cherry-pick, etc.)
  cmdPart = cmdPart.replace(
    /\b(checkout|cherry-pick|commit|push|pull|merge|rebase|branch|status|log|diff|add|reset|stash)\b/g,
    '<span class="git-subcommand">$1</span>'
  );

  // 高亮哈希值 (7位或更长的十六进制字符串)
  cmdPart = cmdPart.replace(
    /\b([0-9a-f]{7,40})\b/g,
    '<span class="git-hash">$1</span>'
  );

  // 添加注释部分
  if (commentPart) {
    cmdPart += `  <span class="git-comment">${escapeHtml(commentPart)}</span>`;
  }

  return cmdPart;
}

/**
 * 更新备注UI
 * @param {string} hash - 提交哈希
 */
function updateRemarkUI(hash) {
  const remarkElement = document.querySelector(
    `.remark-content[data-hash="${hash}"]`
  );
  if (!remarkElement) return;

  const remark = getCommitRemark(hash);

  if (remark && remark.content) {
    remarkElement.value = remark.content;
    remarkElement.classList.add("has-content");
  } else {
    remarkElement.value = "";
    remarkElement.classList.remove("has-content");
  }
}

/**
 * 更新所有备注UI
 */
function updateAllRemarkUI() {
  document.querySelectorAll(".commit").forEach((commitEl) => {
    const hash = commitEl.getAttribute("data-hash");
    if (hash) {
      updateRemarkUI(hash);
    }
  });
}

/**
 * 获取备注内容
 * @param {string} hash - 提交哈希
 * @returns {string} 备注内容
 */
function getRemarkContent(hash) {
  const remark = appState.commitRemarks.find((r) => r.hash === hash);
  return remark ? remark.content : "";
}

/**
 * 判断是否有备注
 * @param {string} hash - 提交哈希
 * @returns {boolean} 是否有备注
 */
function hasRemark(hash) {
  return appState.commitRemarks.some((r) => r.hash === hash);
}

/**
 * 获取提交的备注对象
 * @param {string} hash - 提交哈希
 * @returns {Object|undefined} 备注对象
 */
function getCommitRemark(hash) {
  return appState.commitRemarks.find((r) => r.hash === hash);
}

/**
 * Filter Module 筛选模块
 * 处理提交的筛选和搜索功能
 */

/**
 * 筛选提交
 * @param {string} type - 筛选类型 ('all', 'source', 'target', 'common', 'ignored')
 */
function filterCommits(type) {
  const buttons = document.querySelectorAll(".filter-button");
  buttons.forEach((btn) => btn.classList.remove("active"));
  document.querySelector(`[data-filter="${type}"]`).classList.add("active");

  document.body.setAttribute("data-current-filter", type);
  updateFilterState({ mainFilter: type });

  const subFilterSection = document.getElementById("subFilterSection");
  if (type === "all") {
    subFilterSection.classList.remove("hidden");
  } else {
    subFilterSection.classList.add("hidden");
  }

  applyFilters(type);
  saveFilterStateToURL();
}

/**
 * 应用筛选
 * @param {string} type - 筛选类型
 */
function applyFilters(type) {
  const commitRows = document.querySelectorAll(".commit-row");
  const hideIgnored = document.getElementById("hideIgnoredCommits").checked;
  const hideCommon = document.getElementById("hideCommonCommits").checked;

  commitRows.forEach((row) => {
    const commitElement = row.querySelector(".commit");
    if (!commitElement) return;

    const status = commitElement.getAttribute("data-status");
    const hash = commitElement.getAttribute("data-hash");
    const isIgnored = appState.ignoredCommits.some(
      (item) => item.hash === hash
    );
    const isCommon = status === "both";

    let shouldShow = false;

    switch (type) {
      case "all":
        shouldShow = true;
        break;
      case "source":
        shouldShow = status === "source";
        break;
      case "target":
        shouldShow = status === "target";
        break;
      case "common":
        shouldShow = status === "both";
        break;
      case "ignored":
        shouldShow = isIgnored;
        break;
    }

    if (shouldShow) {
      if (hideIgnored && isIgnored && type !== "ignored") {
        shouldShow = false;
      }
      if (hideCommon && isCommon && type !== "common") {
        shouldShow = false;
      }
    }

    row.style.display = shouldShow ? "" : "none";
  });
}

/**
 * 应用子筛选器
 */
function applySubFilters() {
  const currentFilter =
    document.body.getAttribute("data-current-filter") || "all";
  applyFilters(currentFilter);
  saveFilterStateToURL();
}

/**
 * 搜索提交
 * @param {boolean} saveState - 是否保存状态
 */
function searchCommits(saveState = true) {
  const searchText = document
    .getElementById("searchInput")
    .value.trim()
    .toLowerCase();
  const searchMessage = document.getElementById("searchMessage").checked;
  const searchAuthor = document.getElementById("searchAuthor").checked;
  const searchHash = document.getElementById("searchHash").checked;
  const clearButton = document.getElementById("clearSearch");

  if (saveState) {
    updateFilterState({
      searchText,
      searchMessage,
      searchAuthor,
      searchHash,
    });
  }

  if (searchText) {
    clearButton.classList.add("visible");
  } else {
    clearButton.classList.remove("visible");
  }

  if (!searchText) {
    const currentFilter =
      document.body.getAttribute("data-current-filter") || "all";
    applyFilters(currentFilter);
    return;
  }

  const commitRows = document.querySelectorAll(".commit-row");

  // 清除现有高亮
  commitRows.forEach((row) => {
    const commitElement = row.querySelector(".commit");
    if (!commitElement) return;

    const messageElement = commitElement.querySelector(".commit-message");
    const authorElement = commitElement.querySelector(".commit-author");
    const hashElements = commitElement.querySelectorAll(".commit-hash");

    if (messageElement) {
      messageElement.innerHTML = messageElement.innerHTML.replace(
        /<span class="highlight">([^<]+)<\/span>/g,
        "$1"
      );
    }
    if (authorElement) {
      authorElement.innerHTML = authorElement.innerHTML.replace(
        /<span class="highlight">([^<]+)<\/span>/g,
        "$1"
      );
    }
    hashElements.forEach((el) => {
      el.innerHTML = el.innerHTML.replace(
        /<span class="highlight">([^<]+)<\/span>/g,
        "$1"
      );
    });
  });

  // 搜索并高亮
  commitRows.forEach((row) => {
    const commitElement = row.querySelector(".commit");
    if (!commitElement) return;

    let matches = false;

    if (searchMessage) {
      const messageElement = commitElement.querySelector(".commit-message");
      if (
        messageElement &&
        messageElement.textContent.toLowerCase().includes(searchText)
      ) {
        matches = true;
        highlightText(messageElement, searchText);
      }
    }

    if (searchAuthor && !matches) {
      const authorElement = commitElement.querySelector(".commit-author");
      if (
        authorElement &&
        authorElement.textContent.toLowerCase().includes(searchText)
      ) {
        matches = true;
        highlightText(authorElement, searchText);
      }
    }

    if (searchHash && !matches) {
      const hashElements = commitElement.querySelectorAll(".commit-hash");
      hashElements.forEach((hashElement) => {
        if (hashElement.textContent.toLowerCase().includes(searchText)) {
          matches = true;
          highlightText(hashElement, searchText);
        }
      });
    }

    row.style.display = matches ? "" : "none";
  });
}

/**
 * 高亮文本
 * @param {HTMLElement} element - 要高亮的元素
 * @param {string} searchText - 搜索文本
 */
function highlightText(element, searchText) {
  if (!element.innerHTML.includes('<span class="highlight">')) {
    const innerHTML = element.innerHTML;
    const index = innerHTML.toLowerCase().indexOf(searchText.toLowerCase());
    if (index >= 0) {
      const highlighted =
        innerHTML.substring(0, index) +
        '<span class="highlight">' +
        innerHTML.substring(index, index + searchText.length) +
        "</span>" +
        innerHTML.substring(index + searchText.length);
      element.innerHTML = highlighted;
    }
  }
}

/**
 * 清除搜索
 */
function clearSearch() {
  document.getElementById("searchInput").value = "";

  // 清除高亮
  document.querySelectorAll(".highlight").forEach((el) => {
    const parent = el.parentNode;
    parent.textContent = parent.textContent;
  });

  searchCommits();
  document.getElementById("clearSearch").classList.remove("visible");
}

/**
 * Modal Module 模态框模块
 * 处理所有模态框相关的功能
 */

// IGNORE_REASONS 由HTML模板的数据注入脚本定义

let currentIgnoreHash = null;
let currentIgnoreElement = null;
let currentCommitHash = null;
let currentCommitElement = null;

/**
 * 显示忽略原因模态框
 * @param {string} hash - 提交哈希
 * @param {HTMLElement} element - 触发元素
 */
function showIgnoreModal(hash, element) {
  currentIgnoreHash = hash;
  currentIgnoreElement = element;

  const reasonListElement = document.getElementById("reasonList");
  reasonListElement.innerHTML = "";

  IGNORE_REASONS.forEach((reason, index) => {
    const optionElement = document.createElement("div");
    optionElement.className = "reason-option";

    const radioInput = document.createElement("input");
    radioInput.type = "radio";
    radioInput.id = `reason-${index}`;
    radioInput.name = "ignoreReason";
    radioInput.value = reason;
    if (index === 0) {
      radioInput.checked = true;
      optionElement.classList.add("selected");
    }

    const label = document.createElement("label");
    label.htmlFor = `reason-${index}`;
    label.textContent = reason;

    optionElement.appendChild(radioInput);
    optionElement.appendChild(label);

    optionElement.addEventListener("click", function (e) {
      if (e.target !== radioInput) {
        radioInput.checked = true;

        if (reason === "其他原因") {
          document.getElementById("customReasonInput").classList.add("show");
        } else {
          document.getElementById("customReasonInput").classList.remove("show");
        }

        document.querySelectorAll(".reason-option").forEach((opt) => {
          opt.classList.remove("selected");
        });
        this.classList.add("selected");
      }
    });

    if (reason === "其他原因") {
      radioInput.addEventListener("change", function () {
        document.getElementById("customReasonInput").classList.add("show");
        document.querySelectorAll(".reason-option").forEach((opt) => {
          opt.classList.remove("selected");
        });
        optionElement.classList.add("selected");
      });
    } else {
      radioInput.addEventListener("change", function () {
        document.getElementById("customReasonInput").classList.remove("show");
        document.querySelectorAll(".reason-option").forEach((opt) => {
          opt.classList.remove("selected");
        });
        optionElement.classList.add("selected");
      });
    }

    reasonListElement.appendChild(optionElement);
  });

  document.getElementById("customReasonText").value = "";
  document.getElementById("customReasonInput").classList.remove("show");
  const modal = document.getElementById("ignoreModal");
  modal.style.display = "flex";
  modal.classList.add("show");
}

/**
 * 关闭忽略原因模态框
 */
function closeIgnoreModal() {
  const modal = document.getElementById("ignoreModal");
  modal.style.display = "none";
  modal.classList.remove("show");
  currentIgnoreHash = null;
  currentIgnoreElement = null;
}

/**
 * 确认忽略
 */
async function confirmIgnore() {
  const selectedReason = document.querySelector(
    'input[name="ignoreReason"]:checked'
  ).value;
  const customReason = document.getElementById("customReasonText").value.trim();
  const finalReason =
    selectedReason === "其他原因" ? customReason : selectedReason;

  if (selectedReason === "其他原因" && !customReason) {
    alert("请输入自定义的忽略原因");
    return;
  }

  showLoading();
  saveCurrentFilterState();

  try {
    // 先加载最新的完整数据
    const latestIgnoredCommits = await loadIgnoredCommits();

    // 检查是否已存在
    const index = latestIgnoredCommits.findIndex(
      (item) => item.hash === currentIgnoreHash
    );

    // 如果不存在，添加新的忽略记录
    if (index === -1) {
      latestIgnoredCommits.push({
        hash: currentIgnoreHash,
        reason: finalReason,
        timestamp: new Date().toISOString(),
      });
    } else {
      // 如果已存在，更新原因和时间戳
      latestIgnoredCommits[index].reason = finalReason;
      latestIgnoredCommits[index].timestamp = new Date().toISOString();
    }

    // 保存更新后的完整数据
    await saveIgnoredCommits(latestIgnoredCommits);

    // 重新加载数据到应用状态
    appState.ignoredCommits = await loadIgnoredCommits();

    renderCommits(false);
    restoreFilterState();
    closeIgnoreModal();
    showSuccessMessage("忽略提交成功");
  } catch (error) {
    console.error("保存忽略提交失败:", error);
    alert("保存忽略提交失败: " + error.message);
  } finally {
    hideLoading();
  }
}

/**
 * 切换忽略状态
 * @param {string} hash - 提交哈希
 * @param {HTMLElement} element - 触发元素
 */
async function toggleIgnoreCommit(hash, element) {
  try {
    // 先加载最新的完整数据来检查状态
    const latestIgnoredCommits = await loadIgnoredCommits();
    const index = latestIgnoredCommits.findIndex((item) => item.hash === hash);

    if (index === -1) {
      // 不存在，显示模态框添加忽略
      showIgnoreModal(hash, element);
    } else {
      // 已存在，直接删除（取消忽略）
      showLoading();
      saveCurrentFilterState();

      const updatedCommits = latestIgnoredCommits.filter(
        (item) => item.hash !== hash
      );

      await saveIgnoredCommits(updatedCommits);

      // 重新加载数据到应用状态
      appState.ignoredCommits = await loadIgnoredCommits();

      renderCommits(false);
      restoreFilterState();
      showSuccessMessage("取消忽略成功");
      hideLoading();
    }
  } catch (error) {
    console.error("切换忽略状态失败:", error);
    alert("操作失败: " + error.message);
    hideLoading();
  }
}

/**
 * 显示备注模态框
 * @param {string} hash - 提交哈希
 * @param {HTMLElement} element - 触发元素
 */
function showRemarkModal(hash, element) {
  currentCommitHash = hash;
  currentCommitElement = element;

  const remarkText = document.getElementById("remarkText");
  remarkText.value = getRemarkContent(hash);

  const deleteButton = document.getElementById("deleteRemarkBtn");
  if (hasRemark(hash)) {
    deleteButton.style.display = "block";
  } else {
    deleteButton.style.display = "none";
  }

  const modal = document.getElementById("remarkModal");
  modal.style.display = "flex";
  modal.classList.add("show");
}

/**
 * 关闭备注模态框
 */
function closeRemarkModal() {
  const modal = document.getElementById("remarkModal");
  modal.style.display = "none";
  modal.classList.remove("show");
  currentCommitHash = null;
  currentCommitElement = null;
}

/**
 * 确认备注
 */
async function confirmRemark() {
  const remarkText = document.getElementById("remarkText").value.trim();
  console.log("开始保存备注，哈希值:", currentCommitHash, "内容:", remarkText);

  try {
    showLoading();
    saveCurrentFilterState();

    // 先加载最新的完整数据
    const latestRemarks = await loadCommitRemarks();

    const existingIndex = latestRemarks.findIndex(
      (r) => r.hash === currentCommitHash
    );

    if (remarkText) {
      if (existingIndex >= 0) {
        // 更新现有备注
        latestRemarks[existingIndex].content = remarkText;
        latestRemarks[existingIndex].timestamp = new Date().toISOString();
        console.log("已更新现有备注");
      } else {
        // 添加新备注
        latestRemarks.push({
          hash: currentCommitHash,
          content: remarkText,
          timestamp: new Date().toISOString(),
        });
        console.log("已添加新备注");
      }
    } else if (existingIndex >= 0) {
      // 删除备注
      latestRemarks.splice(existingIndex, 1);
      console.log("已删除备注");
    }

    // 保存更新后的完整数据
    await saveCommitRemarks(latestRemarks);
    console.log("服务器保存备注完成");

    // 重新加载数据到应用状态
    appState.commitRemarks = await loadCommitRemarks();

    closeRemarkModal();
    renderCommits(false);
    restoreFilterState();
    showSuccessMessage("备注已保存");
  } catch (error) {
    console.error("保存备注操作失败:", error);
    alert("保存备注失败: " + error.message);
  } finally {
    hideLoading();
  }
}

/**
 * 删除备注
 */
async function deleteRemark() {
  if (!currentCommitHash) return;

  try {
    showLoading();
    saveCurrentFilterState();

    // 先加载最新的完整数据
    const latestRemarks = await loadCommitRemarks();

    const existingIndex = latestRemarks.findIndex(
      (r) => r.hash === currentCommitHash
    );

    if (existingIndex >= 0) {
      // 从完整数据中移除该备注
      latestRemarks.splice(existingIndex, 1);
      console.log("已删除备注");

      // 保存更新后的完整数据
      await saveCommitRemarks(latestRemarks);

      // 重新加载数据到应用状态
      appState.commitRemarks = await loadCommitRemarks();

      closeRemarkModal();
      renderCommits(false);
      restoreFilterState();
      showSuccessMessage("备注已删除");
    }
  } catch (error) {
    console.error("删除备注失败:", error);
    alert("删除备注失败: " + error.message);
  } finally {
    hideLoading();
  }
}

/**
 * 显示加载动画
 */
function showLoading() {
  document.getElementById("loadingOverlay").classList.add("show");
}

/**
 * 隐藏加载动画
 */
function hideLoading() {
  document.getElementById("loadingOverlay").classList.remove("show");
}

/**
 * 显示成功消息
 * @param {string} message - 消息内容
 */
function showSuccessMessage(message) {
  const successToast = document.createElement("div");
  successToast.className = "success-toast";
  successToast.textContent = message;
  document.body.appendChild(successToast);

  setTimeout(() => {
    successToast.classList.add("show");
  }, 100);

  setTimeout(() => {
    successToast.classList.remove("show");
    setTimeout(() => successToast.remove(), 500);
  }, 2000);
}

/**
 * 在VS Code中查看提交
 * @param {string} commitHash - 提交哈希
 */
function openInVSCode(commitHash) {
  const modal = document.createElement("div");
  modal.style.cssText =
    "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999";

  const content = document.createElement("div");
  content.style.cssText =
    "background:var(--color-bg);padding:var(--spacing-6);border-radius:var(--radius-container);max-width:500px;width:90%;box-shadow:var(--shadow-extruded-hover)";

  const title = document.createElement("h3");
  title.textContent = "查看提交的Git命令";
  title.style.marginTop = "0";
  title.style.marginBottom = "var(--spacing-4)";

  content.appendChild(title);

  const commands = [
    { name: "查看提交详情", command: `git show ${commitHash}` },
    {
      name: "查看提交更改的文件",
      command: `git show --name-only ${commitHash}`,
    },
    {
      name: "查看提交的完整差异",
      command: `git show --color-words ${commitHash}`,
    },
  ];

  commands.forEach((cmd) => {
    const section = document.createElement("div");
    section.style.marginBottom = "var(--spacing-4)";

    const label = document.createElement("div");
    label.textContent = cmd.name;
    label.style.fontWeight = "var(--font-weight-semibold)";
    label.style.marginBottom = "var(--spacing-2)";

    const commandArea = document.createElement("div");
    commandArea.style.display = "flex";
    commandArea.style.gap = "var(--spacing-2)";

    const cmdText = document.createElement("code");
    cmdText.textContent = cmd.command;
    cmdText.style.cssText =
      "padding:var(--spacing-2);background:rgba(163,177,198,0.1);border-radius:var(--radius-small);font-family:var(--font-mono);flex:1;overflow-x:auto";

    const copyBtn = document.createElement("button");
    copyBtn.textContent = "复制";
    copyBtn.className = "btn btn-small";
    copyBtn.onclick = () => {
      copyToClipboard(cmd.command, copyBtn);
    };

    commandArea.appendChild(cmdText);
    commandArea.appendChild(copyBtn);

    section.appendChild(label);
    section.appendChild(commandArea);
    content.appendChild(section);
  });

  const closeButton = document.createElement("button");
  closeButton.textContent = "关闭";
  closeButton.className = "btn";
  closeButton.style.width = "100%";
  closeButton.style.marginTop = "var(--spacing-4)";
  closeButton.onclick = () => document.body.removeChild(modal);

  content.appendChild(closeButton);

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });

  modal.appendChild(content);
  document.body.appendChild(modal);
}

/**
 * 在VS Code中比较两个提交
 * @param {string} sourceHash - 源提交哈希
 * @param {string} targetHash - 目标提交哈希
 */
function compareCommitsInVSCode(sourceHash, targetHash) {
  const modal = document.createElement("div");
  modal.style.cssText =
    "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999";

  const content = document.createElement("div");
  content.style.cssText =
    "background:var(--color-bg);padding:var(--spacing-6);border-radius:var(--radius-container);max-width:500px;width:90%;box-shadow:var(--shadow-extruded-hover)";

  const title = document.createElement("h3");
  title.textContent = "比较两个提交的Git命令";
  title.style.marginTop = "0";
  title.style.marginBottom = "var(--spacing-4)";

  content.appendChild(title);

  const commands = [
    {
      name: "显示两个提交之间的差异",
      command: `git diff ${sourceHash} ${targetHash}`,
    },
    {
      name: "查看更改的文件列表",
      command: `git diff --name-only ${sourceHash} ${targetHash}`,
    },
    {
      name: "查看汇总统计信息",
      command: `git diff --stat ${sourceHash} ${targetHash}`,
    },
  ];

  commands.forEach((cmd) => {
    const section = document.createElement("div");
    section.style.marginBottom = "var(--spacing-4)";

    const label = document.createElement("div");
    label.textContent = cmd.name;
    label.style.fontWeight = "var(--font-weight-semibold)";
    label.style.marginBottom = "var(--spacing-2)";

    const commandArea = document.createElement("div");
    commandArea.style.display = "flex";
    commandArea.style.gap = "var(--spacing-2)";

    const cmdText = document.createElement("code");
    cmdText.textContent = cmd.command;
    cmdText.style.cssText =
      "padding:var(--spacing-2);background:rgba(163,177,198,0.1);border-radius:var(--radius-small);font-family:var(--font-mono);flex:1;overflow-x:auto;white-space:nowrap";

    const copyBtn = document.createElement("button");
    copyBtn.textContent = "复制";
    copyBtn.className = "btn btn-small";
    copyBtn.onclick = () => {
      copyToClipboard(cmd.command, copyBtn);
    };

    commandArea.appendChild(cmdText);
    commandArea.appendChild(copyBtn);

    section.appendChild(label);
    section.appendChild(commandArea);
    content.appendChild(section);
  });

  const closeButton = document.createElement("button");
  closeButton.textContent = "关闭";
  closeButton.className = "btn";
  closeButton.style.width = "100%";
  closeButton.style.marginTop = "var(--spacing-4)";
  closeButton.onclick = () => document.body.removeChild(modal);

  content.appendChild(closeButton);

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });

  modal.appendChild(content);
  document.body.appendChild(modal);
}

/**
 * 查看提交变更
 * @param {string} commitHash - 提交哈希
 * @param {string} commitMessage - 提交消息
 */
function viewCommitChanges(commitHash, commitMessage) {
  console.log("查看提交变更:", commitHash, commitMessage);

  const originalBodyStyle = document.body.style.cssText;
  document.body.style.overflow = "hidden";
  document.body.style.paddingRight = "15px";

  const modal = document.createElement("div");
  modal.style.cssText =
    "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999";

  const content = document.createElement("div");
  content.style.cssText =
    "background:#ffffff;padding:var(--spacing-5);border-radius:var(--radius-container);max-width:90%;width:90%;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-extruded-hover)";

  const header = document.createElement("div");
  header.style.cssText =
    "display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-3);border-bottom:1px solid rgba(163,177,198,0.2);padding-bottom:var(--spacing-3)";

  const titleArea = document.createElement("div");
  const title = document.createElement("h3");
  title.textContent = "提交详情";
  title.style.margin = "0 0 var(--spacing-2) 0";

  const subtitle = document.createElement("p");
  subtitle.innerHTML = `<code style="font-family:var(--font-mono);background:rgba(163,177,198,0.15);padding:2px var(--spacing-2);border-radius:var(--radius-small)">${commitHash}</code> - ${escapeHtml(
    commitMessage
  )}`;
  subtitle.style.margin = "0";
  subtitle.style.color = "var(--color-muted)";
  subtitle.style.fontSize = "var(--font-size-sm)";

  titleArea.appendChild(title);
  titleArea.appendChild(subtitle);

  const closeIcon = document.createElement("button");
  closeIcon.innerHTML = "✕";
  closeIcon.className = "modal-close-button";
  closeIcon.style.cssText = `
    width: 44px;
    height: 44px;
    min-width: 44px;
    min-height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--color-bg);
    color: var(--color-muted);
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-extruded-small);
    transition: all var(--transition-base);
    flex-shrink: 0;
  `;

  closeIcon.addEventListener("mouseenter", () => {
    closeIcon.style.color = "var(--color-danger)";
    closeIcon.style.transform = "scale(1.05)";
  });

  closeIcon.addEventListener("mouseleave", () => {
    closeIcon.style.color = "var(--color-muted)";
    closeIcon.style.transform = "scale(1)";
  });

  const closeModal = () => {
    document.body.removeChild(modal);
    document.body.style.cssText = originalBodyStyle;
    document.removeEventListener("keydown", handleKeyDown);
  };

  closeIcon.addEventListener("click", closeModal);

  header.appendChild(titleArea);
  header.appendChild(closeIcon);
  content.appendChild(header);

  const diffContainer = document.createElement("div");
  diffContainer.style.cssText =
    "flex:1;overflow:auto;min-height:0;max-height:calc(90vh - 100px);padding-right:var(--spacing-2)";

  const diffViewer = document.createElement("div");
  diffViewer.className = "diff-viewer";
  diffViewer.innerHTML =
    '<div style="padding:var(--spacing-5);text-align:center;color:var(--color-muted)">正在加载变更数据...</div>';

  diffContainer.appendChild(diffViewer);
  content.appendChild(diffContainer);

  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  const handleKeyDown = (e) => {
    if (e.key === "Escape") {
      closeModal();
    }
  };

  document.addEventListener("keydown", handleKeyDown);

  modal.appendChild(content);
  document.body.appendChild(modal);

  // 获取diff数据
  fetchGitDiff(commitHash)
    .then((data) => {
      console.log("获取到diff数据:", data);
      renderDiffData(data, diffViewer);
    })
    .catch((error) => {
      console.error("获取提交变更数据失败:", error);
      diffViewer.innerHTML = `
        <div style="padding:var(--spacing-5);text-align:center;color:var(--color-danger);background-color:rgba(220,53,69,0.1);border-radius:var(--radius-base)">
          <p style="margin:0 0 var(--spacing-2) 0;font-weight:var(--font-weight-semibold)">获取提交变更数据失败</p>
          <p style="margin:0;font-size:var(--font-size-sm)">${escapeHtml(
            error.message
          )}</p>
        </div>
      `;
    });
}

/**
 * 使用Diff2Html渲染差异数据
 * @param {Object} data - diff数据
 * @param {HTMLElement} diffViewer - 差异查看器元素
 */
function renderDiffData(data, diffViewer) {
  console.log("渲染差异数据:", data);
  if (!data || !data.diff || data.diff.trim() === "") {
    diffViewer.innerHTML = `
      <div style="padding:var(--spacing-5);text-align:center;color:var(--color-muted);background-color:rgba(163,177,198,0.1);border-radius:var(--radius-base)">
        此提交没有文件变更或数据格式不正确
      </div>
    `;
    return;
  }

  const diffText = data.diff;
  diffViewer.innerHTML = "";

  try {
    const ui = new Diff2HtmlUI(diffViewer, diffText, {
      drawFileList: true,
      matching: "lines",
      outputFormat: "side-by-side",
      highlight: true,
    });
    ui.draw();
    ui.highlightCode();

    // 只隐藏行号，不添加任何其他样式
    const style = document.createElement("style");
    style.textContent = `
      /* 隐藏所有行号 */
      .d2h-code-line-prefix,
      .d2h-code-linenumber,
      .d2h-code-side-linenumber,
      .d2h-line-num1,
      .d2h-line-num2,
      .line-num1,
      .line-num2 {
        display: none !important;
      }
    `;
    diffViewer.appendChild(style);
  } catch (e) {
    console.error("Diff2Html 渲染失败:", e);
    diffViewer.innerHTML = `
      <div style="padding:var(--spacing-5);text-align:center;color:var(--color-danger);background-color:rgba(220,53,69,0.1);border-radius:var(--radius-base)">
        无法渲染差异视图：${escapeHtml(e.message)}
      </div>
    `;
  }
}

// 主入口文件 - 初始化应用和事件绑定

/**
 * 初始化应用
 */
async function initApp() {
  console.log("初始化应用...");

  // 初始化appState中的数据（从HTML模板注入的全局变量）
  appState.commits = commits || [];
  appState.sourceBranch = sourceBranch || "";
  appState.targetBranch = targetBranch || "";
  appState.ignoredCommits = ignoredCommits || [];
  appState.commitRemarks = commitRemarks || [];

  console.log("已加载提交数据:", appState.commits.length, "条");
  console.log("已加载忽略提交:", appState.ignoredCommits.length, "条");
  console.log("已加载备注:", appState.commitRemarks.length, "条");

  // 从服务器加载最新的已忽略提交和备注数据
  try {
    const [loadedIgnored, loadedRemarks] = await Promise.all([
      loadIgnoredCommits(),
      loadCommitRemarks(),
    ]);

    appState.ignoredCommits = loadedIgnored;
    appState.commitRemarks = loadedRemarks;

    console.log("从服务器更新忽略提交:", appState.ignoredCommits.length, "条");
    console.log("从服务器更新备注:", appState.commitRemarks.length, "条");
  } catch (error) {
    console.error("加载服务器数据失败:", error);
  }

  // 渲染提交列表
  renderCommits(false);

  // 初始化布局
  initializeLayout();

  // 初始化筛选状态
  initializeFilterState();

  // 设置初始子筛选器可见性
  const initialFilter =
    document.body.getAttribute("data-current-filter") || "all";
  const subFilterSection = document.getElementById("subFilterSection");
  if (initialFilter !== "all") {
    subFilterSection.classList.add("hidden");
  }

  console.log("应用初始化完成");
}

/**
 * 绑定全局事件（使用事件委托）
 */
function bindEvents() {
  // 全局点击事件委托
  document.addEventListener("click", handleGlobalClick);

  // 全局输入事件委托
  document.addEventListener("input", handleGlobalInput);

  // 全局change事件委托
  document.addEventListener("change", handleGlobalChange);

  // 滚动事件
  window.addEventListener("scroll", handleScroll);

  // 浏览器前进后退事件
  window.addEventListener("popstate", handlePopState);

  // 键盘事件
  document.addEventListener("keydown", handleGlobalKeydown);
}

/**
 * 处理全局点击事件
 */
function handleGlobalClick(event) {
  const target = event.target;

  // 处理筛选按钮点击
  if (target.classList.contains("filter-button")) {
    const filterType = target.getAttribute("data-filter");
    if (filterType) {
      filterCommits(filterType);
    }
    return;
  }

  // 处理忽略按钮点击
  if (target.classList.contains("ignore-button")) {
    const commitElement = target.closest(".commit");
    const hash = commitElement.getAttribute("data-hash");
    toggleIgnoreCommit(hash, target);
    return;
  }

  // 处理备注按钮点击
  if (target.classList.contains("remark-button")) {
    const commitElement = target.closest(".commit");
    const hash = commitElement.getAttribute("data-hash");
    showRemarkModal(hash, target);
    return;
  }

  // 处理提交消息复制
  if (target.classList.contains("commit-message")) {
    copyToClipboard(target.textContent, target);
    return;
  }

  // 处理提交哈希复制
  if (target.classList.contains("commit-hash")) {
    const fullHash = target.getAttribute("title") || target.textContent;
    copyToClipboard(fullHash, target);
    return;
  }

  // 处理VS Code按钮点击
  if (
    target.classList.contains("vscode-button") ||
    target.closest(".vscode-button")
  ) {
    const button = target.classList.contains("vscode-button")
      ? target
      : target.closest(".vscode-button");
    const commitElement = button.closest(".commit");
    if (commitElement) {
      const hash = commitElement.getAttribute("data-hash");
      openInVSCode(hash);
    }
    event.stopPropagation();
    return;
  }

  // 处理查看变更按钮点击
  if (target.classList.contains("view-changes-btn")) {
    const commitElement = target.closest(".commit");
    if (commitElement) {
      const hash = commitElement.getAttribute("data-hash");
      const status = commitElement.getAttribute("data-status");
      viewCommitChanges(hash, status);
    }
    event.stopPropagation();
    return;
  }

  // 处理比较提交按钮点击
  if (
    target.classList.contains("compare-in-vscode") ||
    target.closest(".compare-in-vscode")
  ) {
    const button = target.classList.contains("compare-in-vscode")
      ? target
      : target.closest(".compare-in-vscode");
    const commitElement = button.closest(".commit");
    if (commitElement) {
      const hash = commitElement.getAttribute("data-hash");
      // 从commit-hash-pair中找到两个hash
      const hashPair = button.closest(".commit-hash-pair");
      if (hashPair) {
        const hashBranches = hashPair.querySelectorAll(".commit-hash");
        if (hashBranches.length >= 2) {
          const hash1 = hashBranches[0].getAttribute("title");
          const hash2 = hashBranches[1].getAttribute("title");
          compareCommitsInVSCode(hash1, hash2);
        }
      }
    }
    event.stopPropagation();
    return;
  }

  // 处理命令标签切换
  if (target.classList.contains("command-tab")) {
    const tab = target.getAttribute("data-command");
    switchCommandTab(tab);
    return;
  }

  // 处理复制按钮点击
  if (target.classList.contains("copy-button")) {
    // 检查是哪个复制按钮
    if (target.classList.contains("copy-source-to-target-button")) {
      copyCommandBlock("source-to-target");
    } else if (target.classList.contains("copy-target-to-source-button")) {
      copyCommandBlock("target-to-source");
    }
    return;
  }

  // 处理单行复制按钮点击
  if (target.classList.contains("copy-line-button")) {
    const cmdText = target.previousElementSibling.textContent;
    copyToClipboard(cmdText, target);
    return;
  }

  // 处理清除搜索按钮点击
  if (target.id === "clearSearch") {
    clearSearch();
    return;
  }

  // 处理返回顶部按钮点击
  if (target.id === "backToTop") {
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
    return;
  }

  // 处理布局切换按钮
  if (target.id === "chatLayoutBtn" || target.closest("#chatLayoutBtn")) {
    switchLayout("chat");
    return;
  }

  if (target.id === "flatLayoutBtn" || target.closest("#flatLayoutBtn")) {
    switchLayout("flat");
    return;
  }

  // 处理模态框关闭
  if (target.id === "ignoreModal" || target.classList.contains("modal")) {
    if (target === event.target) {
      closeIgnoreModal();
    }
    return;
  }

  if (
    target.id === "remarkModal" ||
    target.classList.contains("remark-modal")
  ) {
    if (target === event.target) {
      closeRemarkModal();
    }
    return;
  }

  // 处理模态框按钮
  if (target.classList.contains("modal-button")) {
    if (target.classList.contains("confirm")) {
      confirmIgnore();
    } else if (target.classList.contains("cancel")) {
      closeIgnoreModal();
    }
    return;
  }

  if (target.classList.contains("remark-modal-button")) {
    if (target.classList.contains("remark-save")) {
      confirmRemark();
    } else if (target.classList.contains("remark-cancel")) {
      closeRemarkModal();
    } else if (target.classList.contains("remark-delete")) {
      deleteRemark();
    }
    return;
  }

  // 处理忽略原因选项点击
  if (
    target.classList.contains("reason-option") ||
    target.closest(".reason-option")
  ) {
    const option = target.classList.contains("reason-option")
      ? target
      : target.closest(".reason-option");
    const radio = option.querySelector('input[type="radio"]');
    if (radio && event.target !== radio) {
      radio.checked = true;

      // 处理自定义原因输入框显示逻辑
      const customReasonInput = document.getElementById("customReasonInput");
      if (radio.value === "其他原因") {
        customReasonInput.classList.add("show");
      } else {
        customReasonInput.classList.remove("show");
      }

      // 更新选中样式
      document.querySelectorAll(".reason-option").forEach((opt) => {
        opt.classList.remove("selected");
      });
      option.classList.add("selected");
    }
    return;
  }
}

/**
 * 处理全局输入事件
 */
function handleGlobalInput(event) {
  const target = event.target;

  // 处理搜索输入
  if (target.id === "searchInput") {
    searchCommits();
    return;
  }
}

/**
 * 处理全局change事件
 */
function handleGlobalChange(event) {
  const target = event.target;

  // 处理子筛选器复选框变化
  if (target.id === "hideIgnoredCommits" || target.id === "hideCommonCommits") {
    applySubFilters();
    return;
  }

  // 处理搜索选项复选框变化
  if (
    target.id === "searchMessage" ||
    target.id === "searchAuthor" ||
    target.id === "searchHash"
  ) {
    searchCommits();
    return;
  }

  // 处理忽略原因单选按钮变化
  if (target.name === "ignoreReason") {
    const customReasonInput = document.getElementById("customReasonInput");
    if (target.value === "其他原因") {
      customReasonInput.classList.add("show");
    } else {
      customReasonInput.classList.remove("show");
    }

    // 更新选中样式
    document.querySelectorAll(".reason-option").forEach((opt) => {
      opt.classList.remove("selected");
    });
    target.closest(".reason-option").classList.add("selected");
    return;
  }
}

/**
 * 处理滚动事件
 */
function handleScroll() {
  const backToTopButton = document.getElementById("backToTop");
  if (backToTopButton) {
    if (window.scrollY > 300) {
      backToTopButton.classList.add("show");
    } else {
      backToTopButton.classList.remove("show");
    }
  }
}

/**
 * 处理浏览器前进后退事件
 */
function handlePopState() {
  // 从URL恢复筛选状态
  initializeFilterState();
}

/**
 * 处理全局键盘事件
 */
function handleGlobalKeydown(event) {
  // ESC 键关闭模态框
  if (event.key === "Escape" || event.keyCode === 27) {
    const ignoreModal = document.getElementById("ignoreModal");
    const remarkModal = document.getElementById("remarkModal");

    // 检查忽略原因模态框是否打开
    if (ignoreModal && ignoreModal.classList.contains("show")) {
      closeIgnoreModal();
      event.preventDefault();
      return;
    }

    // 检查备注模态框是否打开
    if (remarkModal && remarkModal.classList.contains("show")) {
      closeRemarkModal();
      event.preventDefault();
      return;
    }
  }
}

/**
 * 初始化布局
 */
function initializeLayout() {
  const savedLayout = localStorage.getItem("preferredLayout") || "flat";
  switchLayout(savedLayout);
}

/**
 * 切换布局
 */
function switchLayout(layout) {
  console.log("切换布局到:", layout);

  // 保存当前筛选状态
  saveCurrentFilterState();

  // 更新布局按钮
  document
    .getElementById("chatLayoutBtn")
    .classList.toggle("active", layout === "chat");
  document
    .getElementById("flatLayoutBtn")
    .classList.toggle("active", layout === "flat");

  // 更新时间轴类
  const timeline = document.getElementById("timeline");
  if (layout === "flat") {
    timeline.classList.add("flat-layout");
  } else {
    timeline.classList.remove("flat-layout");
  }

  // 存储当前布局
  document.body.setAttribute("data-layout", layout);

  // 保存偏好到localStorage
  localStorage.setItem("preferredLayout", layout);

  // 重新渲染提交 - 明确传递 false 避免重复保存状态
  renderCommits(false);

  // 恢复筛选状态
  restoreFilterState();

  console.log("布局切换完成");
}

/**
 * 切换命令标签
 */
function switchCommandTab(tab) {
  document.querySelectorAll(".command-tab").forEach((item) => {
    item.classList.toggle("active", item.getAttribute("data-command") === tab);
  });
  document.querySelectorAll(".command-content").forEach((item) => {
    item.classList.toggle("active", item.id === `${tab}-content`);
  });
}

// 页面加载时初始化
document.addEventListener("DOMContentLoaded", () => {
  // 检查URL是否有参数
  const urlParams = new URLSearchParams(window.location.search);
  if (
    !urlParams.has("filter") &&
    !urlParams.has("hideIgnored") &&
    !urlParams.has("hideCommon")
  ) {
    // 设置默认URL参数
    const url = new URL(window.location.href);
    url.searchParams.set("filter", "all");
    url.searchParams.set("hideIgnored", "0");
    url.searchParams.set("hideCommon", "1");
    window.history.replaceState({}, "", url.toString());
  }

  // 设置初始筛选状态跟踪
  saveCurrentFilterState();

  // 绑定事件
  bindEvents();

  // 初始化应用
  initApp();
});


    </script>
  </body>
</html>
